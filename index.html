<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£è¡Œæ—¥å¿— - ä¸“ä¸šæ˜ç»†ç‰ˆ</title>
    <style>
        /* === åŸºç¡€æ ·å¼ === */
        :root { --primary: #2563eb; --primary-dark: #1e40af; --bg: #f1f5f9; --accent: #db2777; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg); color: #334155;
            padding: 20px; min-height: 100vh;
        }
        
        .container {
            max-width: 1100px; margin: 0 auto;
            display: flex; flex-direction: column; gap: 20px;
        }

        /* é€šç”¨å¡ç‰‡ */
        .card {
            background: white; border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden; border: 1px solid #e2e8f0;
        }
        .card-header {
            padding: 15px 20px; background: linear-gradient(to right, #f8fafc, #fff);
            border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;
        }
        .card-header h2 { font-size: 1.1rem; color: #1e293b; font-weight: 700; }
        .card-body { padding: 20px; }

        /* é¡¶éƒ¨æ  */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--primary); color: white; padding: 15px 25px;
            border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3);
        }

        /* === æ¨¡å— 1: ç»Ÿè®¡æŠ¥è¡¨ (ä¿æŒç®€æ´) === */
        .table-scroll { overflow-x: auto; border-radius: 8px; border: 1px solid #cbd5e1; }
        .excel-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 900px; }
        .excel-table th, .excel-table td { border: 1px solid #cbd5e1; padding: 8px 6px; text-align: center; }
        .excel-table th { background: #f1f5f9; font-weight: 600; color: #475569; }
        .bg-sub { background-color: #fdf4ff; color: #86198f; font-weight: bold; } 

        /* === æ¨¡å— 2: å½•å…¥ (å¢å¼º) === */
        .ai-input-area { position: relative; }
        .key-input { 
            position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9);
            padding: 5px 10px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 0.8rem; width: 200px;
        }
        textarea {
            width: 100%; height: 100px; padding: 15px; border: 2px dashed #cbd5e1;
            border-radius: 12px; resize: vertical; font-family: monospace; transition: 0.3s;
            background: #f8fafc;
        }
        textarea:focus { border-color: var(--primary); outline: none; background: white; }
        
        .edit-form { background: #f8fafc; padding: 20px; border-radius: 12px; margin-top: 15px; border: 1px solid #e2e8f0; }
        
        /* è¡¨å•å¸ƒå±€ä¼˜åŒ– */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
        .form-full-width { grid-column: 1 / -1; } /* å æ®æ•´è¡Œ */
        
        .form-group label { display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 4px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; }
        
        /* æ—¶é—´è¾“å…¥ç»„æ ·å¼ */
        .time-group { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; 
            background: white; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0;
        }
        .time-group div { text-align: center; }
        .time-group label { font-size: 0.7rem; color: #94a3b8; margin-bottom: 2px; }
        .time-group input { border: none; background: #f1f5f9; text-align: center; font-family: monospace; padding: 4px; }

        /* === æ¨¡å— 3: å†å²è®°å½• (è¯¦ç»†ç‰ˆ) === */
        .log-list { max-height: 600px; overflow-y: auto; }
        .log-item {
            background: white; border: 1px solid #e2e8f0; border-radius: 10px;
            margin-bottom: 12px; padding: 15px; transition: 0.2s;
            position: relative;
        }
        .log-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.05); transform: translateY(-1px); }

        /* å†å²å¡ç‰‡å†…éƒ¨å¸ƒå±€ */
        .log-header { display: flex; justify-content: space-between; border-bottom: 1px dashed #e2e8f0; padding-bottom: 8px; margin-bottom: 8px; }
        .log-route { font-weight: 700; color: #1e293b; font-size: 1rem; }
        .log-date { font-family: monospace; color: #64748b; }
        
        .log-crew { font-size: 0.85rem; color: #475569; margin-bottom: 8px; display: flex; gap: 5px; align-items: center; }
        
        /* æ—¶é—´è½´æ ·å¼ */
        .log-times { 
            display: flex; background: #f8fafc; padding: 8px; border-radius: 6px; 
            font-family: monospace; font-size: 0.85rem; justify-content: space-between; color: #334155;
            margin-bottom: 8px;
        }
        .time-point { text-align: center; }
        .time-label { font-size: 0.7rem; color: #94a3b8; display: block; }
        
        .log-stats { display: flex; gap: 15px; font-size: 0.85rem; color: #1e293b; font-weight: 500; align-items: center; }
        .stat-box { background: #eff6ff; padding: 4px 8px; border-radius: 4px; color: #1d4ed8; }
        
        .tags { display: flex; gap: 5px; margin-left: auto; }
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; background: #e2e8f0; }
        .tag-special { background: #fce7f3; color: #be185d; }
        .tag-holiday { background: #fee2e2; color: #b91c1c; }

        .btn-del { position: absolute; top: 15px; right: 15px; background: none; border: none; cursor: pointer; opacity: 0.3; }
        .btn-del:hover { opacity: 1; color: red; }

        /* æŒ‰é’® */
        .btn { padding: 8px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        
        /* ç™»å½•å±‚ */
        .login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            display: flex; justify-content: center; align-items: center; z-index: 999;
        }
        .login-box { background: white; padding: 40px; border-radius: 20px; text-align: center; width: 320px; }
    </style>
</head>
<body>

    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <h2 style="color: var(--primary); margin-bottom: 20px;">âœˆï¸ é£è¡Œæ—¥å¿—</h2>
            <button class="btn btn-primary" style="width: 100%; padding: 12px;" onclick="loginWithGoogle()">Google è´¦å·ç™»å½•</button>
        </div>
    </div>

    <div id="app" class="container" style="display: none;">
        <div class="top-bar">
            <div><h1 style="font-size: 1.25rem;">é£è¡Œå‘˜æ§åˆ¶å°</h1><span id="userInfo" style="font-size: 0.8rem; opacity: 0.9;">æœªç™»å½•</span></div>
            <button class="btn" style="background: rgba(255,255,255,0.2); color: white;" onclick="doLogout()">é€€å‡º</button>
        </div>

        <!-- 1. æŠ¥è¡¨ (ä¿æŒåŸæ ·) -->
        <section class="card">
            <div class="card-header">
                <h2>ğŸ“Š è–ªé…¬ç»Ÿè®¡æŠ¥è¡¨</h2>
                <input type="month" id="reportMonth" onchange="renderReport()" style="border: 1px solid #cbd5e1; padding: 4px; border-radius: 4px;">
            </div>
            <div class="card-body">
                <div class="table-scroll">
                    <table class="excel-table" id="reportTable"></table>
                </div>
            </div>
        </section>

        <!-- 2. å½•å…¥ (å¤§å¹…å¢å¼º) -->
        <section class="card">
            <div class="card-header">
                <h2>ğŸ“ æ™ºèƒ½å½•å…¥</h2>
                <span style="font-size: 0.8rem; color: #64748b;">AI è‡ªåŠ¨æå–æ—¶é—´èŠ‚ç‚¹ä¸æœºç»„</span>
            </div>
            <div class="card-body">
                <div class="ai-input-area">
                    <input type="password" id="innerApiKey" class="key-input" placeholder="DeepSeek Key">
                    <textarea id="ocrInput" placeholder="ä¾‹ï¼š5æœˆ20æ—¥ PEK-SHA æœºé•¿å¼ ä¸‰ å‰¯é©¾é©¶æå››&#10;å¼€è½¦10:00 èµ·é£10:20 è½åœ°12:20 å…³è½¦12:30&#10;ç©ºä¸­2.0h ç‰¹æ®Šæœºåœº è¿‡å¤œ2å¤©"></textarea>
                </div>
                <div style="text-align: right; margin-top: 10px;">
                    <button id="aiBtn" class="btn btn-primary" onclick="processAI()">âœ¨ AI è¯¦ç»†è¯†åˆ«</button>
                </div>

                <div id="editForm" class="edit-form" style="display: none;">
                    <div class="form-grid">
                        <!-- åŸºæœ¬ä¿¡æ¯ -->
                        <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="f_date"></div>
                        <div class="form-group"><label>èµ·é£</label><input type="text" id="f_dep"></div>
                        <div class="form-group"><label>è½åœ°</label><input type="text" id="f_arr"></div>
                        <div class="form-group"><label>åŒºåŸŸ</label>
                            <select id="f_cat">
                                <option value="å›½å†…">å›½å†…</option>
                                <option value="æ¸¯æ¾³å°">æ¸¯æ¾³å°</option>
                                <option value="äºšæ´²å›½é™…">äºšæ´²å›½é™…</option>
                                <option value="æ´²é™…">æ´²é™…</option>
                            </select>
                        </div>
                        
                        <!-- æœºç»„äººå‘˜ (æ–°) -->
                        <div class="form-group form-full-width">
                            <label>ğŸ‘¨â€âœˆï¸ é£è¡Œäººå‘˜ (æœºç»„åå•)</label>
                            <input type="text" id="f_crew" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰(PIC), æå››(FO)">
                        </div>

                        <!-- è¯¦ç»†æ—¶é—´èŠ‚ç‚¹ (æ–°) -->
                        <div class="form-group form-full-width">
                            <label>â±ï¸ è¿è¡Œæ—¶é—´èŠ‚ç‚¹ (HH:MM)</label>
                            <div class="time-group">
                                <div><label>å¼€è½¦(Off)</label><input type="time" id="f_block_off"></div>
                                <div><label>èµ·é£(Takeoff)</label><input type="time" id="f_takeoff"></div>
                                <div><label>è½åœ°(Landing)</label><input type="time" id="f_landing"></div>
                                <div><label>å…³è½¦(On)</label><input type="time" id="f_block_on"></div>
                            </div>
                        </div>

                        <!-- æ—¶é•¿æ•°æ® (æ–°) -->
                        <div class="form-group"><label>â˜ï¸ ç©ºä¸­æ—¶é—´(h)</label><input type="number" step="0.1" id="f_air"></div>
                        <div class="form-group"><label>âŒš æ€»æ—¶é—´(h)</label><input type="number" step="0.1" id="f_total_time" placeholder="Block Time"></div>
                        <div class="form-group"><label>ğŸšœ åœ°é¢æ—¶é—´(h)</label><input type="number" step="0.1" id="f_ground_time"></div>
                        
                        <!-- ç»Ÿè®¡è¾…åŠ©æ•°æ® -->
                        <div class="form-group"><label>æ»‘è¡Œ(æ¬¡/å¤©)</label><input type="number" id="f_block_days" value="1"></div>
                        <div class="form-group"><label>å¤œèˆª(18:30+)</label><input type="number" step="0.1" id="f_night1"></div>
                        <div class="form-group"><label>å¤œèˆª(00:00+)</label><input type="number" step="0.1" id="f_night2"></div>
                        
                        <div class="form-group"><label>é©»å¤–ç±»å‹</label>
                            <select id="f_overnight">
                                <option value="å›½å†…æ— è¿‡å¤œ">å›½å†…æ— è¿‡å¤œ</option>
                                <option value="å›½å†…æœ‰è¿‡å¤œ">å›½å†…æœ‰è¿‡å¤œ</option>
                                <option value="å›½é™…æ— è¿‡å¤œ">å›½é™…æ— è¿‡å¤œ</option>
                                <option value="å›½é™…æœ‰è¿‡å¤œ">å›½é™…æœ‰è¿‡å¤œ</option>
                            </select>
                        </div>
                        <div class="form-group"><label>é©»å¤–å¤©æ•°</label><input type="number" id="f_overnight_days" value="0"></div>
                        
                        <div class="form-group"><label>ç‰¹æ®Šæœºåœº(æ¬¡)</label><input type="number" id="f_special" value="0"></div>
                        <div class="form-group"><label>æ³•å®šå‡æ—¥(å¤©)</label><input type="number" id="f_holiday" value="0"></div>
                    </div>
                    <div style="margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">
                        <button class="btn" style="background: #e2e8f0;" onclick="document.getElementById('editForm').style.display='none'">å–æ¶ˆ</button>
                        <button class="btn btn-primary" style="background: #10b981;" onclick="saveRecord()">ğŸ’¾ ä¿å­˜è®°å½•</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. å†å²è®°å½• (è¯¦ç»†å¡ç‰‡ç‰ˆ) -->
        <section class="card">
            <div class="card-header"><h2>ğŸ“‹ å†å²è®°å½•æ˜ç»†</h2></div>
            <div class="card-body">
                <div id="logList" class="log-list"></div>
            </div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCFk4f7bKUHlb3d1Cg1jyS1EM-SPC4pr40",
            authDomain: "myflightlog-1f4cb.firebaseapp.com",
            projectId: "myflightlog-1f4cb",
            storageBucket: "myflightlog-1f4cb.firebasestorage.app",
            messagingSenderId: "181072044112",
            appId: "1:181072044112:web:ca312da2d4780227cef155"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        let currentUser = null, allRecords = [];

        window.loginWithGoogle = async () => { try { await signInWithPopup(auth, provider); } catch (e) { alert(e.message); } };
        window.doLogout = async () => { await signOut(auth); };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userInfo').textContent = `ğŸ‘¨â€âœˆï¸ ${user.displayName}`;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                document.getElementById('reportMonth').value = new Date().toISOString().slice(0, 7);
                if(localStorage.getItem("openai_key")) document.getElementById("innerApiKey").value = localStorage.getItem("openai_key");

                onSnapshot(query(collection(db, `users/${user.uid}/logs`), orderBy("date", "desc")), (snapshot) => {
                    allRecords = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    renderList(); renderReport();
                });
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
        });

        // AI å¤„ç† (å¢å¼º Prompt)
        window.processAI = async () => {
            const text = document.getElementById('ocrInput').value;
            const apiKey = document.getElementById('innerApiKey').value;
            if (!apiKey) return alert("è¯·è¾“å…¥ API Key");
            localStorage.setItem("openai_key", apiKey);

            const btn = document.getElementById('aiBtn');
            btn.textContent = "â³ åˆ†æè¯¦ç»†æ•°æ®..."; btn.disabled = true;

            // æç¤ºè¯ï¼šå¢åŠ æœºç»„ã€æ—¶é—´ç‚¹ã€æ€»æ—¶é—´ã€åœ°é¢æ—¶é—´
            const prompt = `
            åˆ†æé£è¡Œä»»åŠ¡ï¼Œè¿”å›JSONã€‚
            å­—æ®µ: 
            date, dep, arr, category("å›½å†…"|"æ¸¯æ¾³å°"|"äºšæ´²å›½é™…"|"æ´²é™…"),
            crew(string, æ‰€æœ‰æœºç»„äººå‘˜åå•),
            time_off(HH:MM, å¼€è½¦), time_takeoff(HH:MM, èµ·é£), time_landing(HH:MM, è½åœ°), time_on(HH:MM, å…³è½¦),
            air_time(float, ç©ºä¸­æ—¶é—´), total_time(float, æ€»æ—¶é—´/BlockTime), ground_time(float, åœ°é¢/æ»‘è¡Œæ—¶é—´),
            block_days(int, æ»‘è¡Œå¤©æ•°/æ¬¡æ•°), night1(18:30-24:00), night2(00:00-06:30),
            overnight, overnight_days(int),
            special_airport(int, 1/0), holiday(int, å¤©æ•°)
            æ–‡æœ¬: ${text}
            `;

            try {
                const res = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: "deepseek-chat", messages: [{role: "user", content: prompt}], temperature: 0.1 })
                });
                const data = await res.json();
                let content = data.choices[0].message.content;
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                const r = JSON.parse(jsonMatch ? jsonMatch[0] : content);

                // å¡«å……è¡¨å•
                const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
                setVal('f_date', r.date); setVal('f_dep', r.dep); setVal('f_arr', r.arr);
                setVal('f_cat', r.category || 'å›½å†…'); 
                // æ–°å­—æ®µ
                setVal('f_crew', r.crew);
                setVal('f_block_off', r.time_off); setVal('f_takeoff', r.time_takeoff);
                setVal('f_landing', r.time_landing); setVal('f_block_on', r.time_on);
                setVal('f_air', r.air_time); setVal('f_total_time', r.total_time); setVal('f_ground_time', r.ground_time);
                
                setVal('f_block_days', r.block_days || 1); 
                setVal('f_night1', r.night1 || 0); setVal('f_night2', r.night2 || 0);
                setVal('f_overnight', r.overnight || 'å›½å†…æ— è¿‡å¤œ'); setVal('f_overnight_days', r.overnight_days || 0);
                setVal('f_special', r.special_airport || 0); setVal('f_holiday', r.holiday || 0);

                document.getElementById('editForm').style.display = 'block';
            } catch (e) { alert("AI Error: " + e.message); } 
            finally { btn.textContent = "âœ¨ AI è¯¦ç»†è¯†åˆ«"; btn.disabled = false; }
        };

        // ä¿å­˜ (ä¿å­˜æ‰€æœ‰å­—æ®µ)
        window.saveRecord = async () => {
            const getNum = (id) => parseFloat(document.getElementById(id).value) || 0;
            const getStr = (id) => document.getElementById(id).value;
            const record = {
                date: getStr('f_date'), dep: getStr('f_dep'), arr: getStr('f_arr'), category: getStr('f_cat'),
                // è¯¦æƒ…å­—æ®µ
                crew: getStr('f_crew'),
                block_off: getStr('f_block_off'), takeoff: getStr('f_takeoff'), 
                landing: getStr('f_landing'), block_on: getStr('f_block_on'),
                air_time: getNum('f_air'), total_time: getNum('f_total_time'), ground_time: getNum('f_ground_time'),
                // ç»Ÿè®¡å­—æ®µ
                block_days: getNum('f_block_days'),
                night1: getNum('f_night1'), night2: getNum('f_night2'),
                overnight: getStr('f_overnight'), overnight_days: getNum('f_overnight_days'),
                special_airport: getNum('f_special'), holiday: getNum('f_holiday'),
                timestamp: new Date()
            };
            await addDoc(collection(db, `users/${currentUser.uid}/logs`), record);
            document.getElementById('editForm').style.display = 'none';
            document.getElementById('ocrInput').value = '';
        };

        window.deleteItem = async (id) => { if(confirm("åˆ é™¤æ­¤è®°å½•ï¼Ÿ")) await deleteDoc(doc(db, `users/${currentUser.uid}/logs`, id)); };

        // æ¸²æŸ“åˆ—è¡¨ (å…¨æ–°è¯¦ç»†å¡ç‰‡è®¾è®¡)
        window.renderList = () => {
            const el = document.getElementById('logList');
            el.innerHTML = allRecords.length ? allRecords.map(r => `
                <div class="log-item">
                    <div class="log-header">
                        <span class="log-date">${r.date}</span>
                        <span class="log-route">${r.dep} â” ${r.arr}</span>
                        <button class="btn-del" onclick="deleteItem('${r.id}')">ğŸ—‘ï¸</button>
                    </div>
                    
                    <div class="log-crew">ğŸ‘¨â€âœˆï¸ ${r.crew || 'æœªè®°å½•æœºç»„'}</div>
                    
                    <div class="log-times">
                        <div class="time-point"><span class="time-label">å¼€è½¦</span>${r.block_off || '--:--'}</div>
                        <div class="time-point"><span class="time-label">èµ·é£</span>${r.takeoff || '--:--'}</div>
                        <div class="time-point"><span class="time-label">è½åœ°</span>${r.landing || '--:--'}</div>
                        <div class="time-point"><span class="time-label">å…³è½¦</span>${r.block_on || '--:--'}</div>
                    </div>

                    <div class="log-stats">
                        <span class="stat-box" title="ç©ºä¸­æ—¶é—´">â˜ï¸ ${r.air_time}h</span>
                        <span class="stat-box" style="background:#f0fdf4; color:#15803d" title="æ€»æ—¶é—´">âŒš ${r.total_time || 0}h</span>
                        <span style="color:#64748b; font-size:0.8rem;" title="åœ°é¢æ—¶é—´">ğŸšœ ${r.ground_time || 0}h</span>
                        
                        <div class="tags">
                            <span class="tag">${r.category}</span>
                            ${r.special_airport > 0 ? `<span class="tag tag-special">ç‰¹</span>` : ''}
                            ${r.holiday > 0 ? `<span class="tag tag-holiday">èŠ‚</span>` : ''}
                        </div>
                    </div>
                </div>
            `).join('') : '<div style="text-align:center;color:#ccc;padding:20px">æ— è®°å½•</div>';
        };

        // æ¸²æŸ“æŠ¥è¡¨ (ä¿æŒä¸å˜ï¼Œä»…ç»Ÿè®¡è–ªé…¬ç›¸å…³)
        window.renderReport = () => {
            const mStr = document.getElementById('reportMonth').value;
            const data = allRecords.filter(r => r.date.startsWith(mStr));
            const s = { 
                d_air:0, d_bk:0, h_air:0, h_bk:0, a_air:0, a_bk:0, i_air:0, i_bk:0, 
                n1:0, n2:0, o_d0:0, o_d1:0, o_i0:0, o_i1:0, spec:0, hol:0 
            };
            
            data.forEach(r => {
                // æ³¨æ„ï¼šç»Ÿè®¡æŠ¥è¡¨ä¾ç„¶ä½¿ç”¨ block_days (æ»‘è¡Œæ¬¡æ•°/å¤©æ•°) è€Œä¸æ˜¯ total_time
                if(r.category==='å›½å†…') { s.d_air+=r.air_time; s.d_bk+=r.block_days; }
                else if(r.category==='æ¸¯æ¾³å°') { s.h_air+=r.air_time; s.h_bk+=r.block_days; }
                else if(r.category==='äºšæ´²å›½é™…') { s.a_air+=r.air_time; s.a_bk+=r.block_days; }
                else { s.i_air+=r.air_time; s.i_bk+=r.block_days; }

                s.n1 += r.night1; s.n2 += r.night2;
                const days = r.overnight_days || 0;
                if(r.overnight==='å›½å†…æ— è¿‡å¤œ') s.o_d0+=days; else if(r.overnight==='å›½å†…æœ‰è¿‡å¤œ') s.o_d1+=days;
                else if(r.overnight==='å›½é™…æ— è¿‡å¤œ') s.o_i0+=days; else s.o_i1+=days;
                s.spec += (r.special_airport || 0); s.hol += (r.holiday || 0);
            });

            document.getElementById('reportTable').innerHTML = `
                <thead>
                    <tr><th rowspan="2">ç±»å‹</th><th colspan="2">å›½å†…</th><th colspan="2">æ¸¯æ¾³å°</th><th colspan="2">äºšæ´²</th><th colspan="2">æ´²é™…</th></tr>
                    <tr><th>ç©º</th><th>æ»‘</th><th>ç©º</th><th>æ»‘</th><th>ç©º</th><th>æ»‘</th><th>ç©º</th><th>æ»‘</th></tr>
                </thead>
                <tbody>
                    <tr>
                        <td>é£è¡Œ</td>
                        <td>${s.d_air.toFixed(1)}</td><td>${s.d_bk}</td>
                        <td>${s.h_air.toFixed(1)}</td><td>${s.h_bk}</td>
                        <td>${s.a_air.toFixed(1)}</td><td>${s.a_bk}</td>
                        <td>${s.i_air.toFixed(1)}</td><td>${s.i_bk}</td>
                    </tr>
                    <tr><td colspan="9" style="background:#f8fafc;height:8px;padding:0"></td></tr>
                    <tr><th rowspan="2">è¡¥åŠ©</th><th colspan="2">å¤œèˆª</th><th colspan="2">ç‰¹æ®Š/èŠ‚å‡</th><th colspan="2">é©»å¤–(æœ‰)</th><th colspan="2">å…¶ä»–</th></tr>
                    <tr><th>18:30</th><th>00:00</th><th class="bg-sub">ç‰¹æ®Š</th><th class="bg-sub">å‡æ—¥</th><th>å›½æœ‰</th><th>å¤–æœ‰</th><th>-</th><th>-</th></tr>
                    <tr>
                        <td>ç»Ÿè®¡</td>
                        <td>${s.n1.toFixed(1)}</td><td>${s.n2.toFixed(1)}</td>
                        <td class="bg-sub">${s.spec}</td><td class="bg-sub">${s.hol}</td>
                        <td>${s.o_d1}</td><td>${s.o_i1}</td>
                        <td>-</td><td>-</td>
                    </tr>
                </tbody>
            `;
        };
    </script>
</body>
</html>
