<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£è¡Œæ—¥å¿— - 2025 æ——èˆ°ç‰ˆ</title>
    <style>
        /* === åŸºç¡€æ ·å¼ === */
        :root { --primary: #2563eb; --bg: #f1f5f9; --base-color: #64748b; --overnight-color: #d97706; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg); color: #334155;
            padding: 20px; min-height: 100vh;
        }
        .container { max-width: 1100px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }

        /* å¡ç‰‡é€šç”¨ */
        .card {
            background: white; border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            overflow: hidden; border: 1px solid #e2e8f0;
        }
        .card-header {
            padding: 15px 20px; background: linear-gradient(to right, #f8fafc, #fff);
            border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;
        }
        .card-header h2 { font-size: 1.1rem; color: #1e293b; font-weight: 700; }
        .card-body { padding: 20px; }

        /* é¡¶éƒ¨æ  */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--primary); color: white; padding: 15px 25px;
            border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3);
        }

        /* è¡¨æ ¼ä¸æ»šåŠ¨ */
        .table-scroll { overflow-x: auto; border-radius: 8px; border: 1px solid #cbd5e1; }
        .excel-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 900px; }
        .excel-table th, .excel-table td { border: 1px solid #cbd5e1; padding: 8px 6px; text-align: center; }
        .excel-table th { background: #f1f5f9; font-weight: 600; }
        .bg-sub { background-color: #fdf4ff; color: #86198f; font-weight: bold; }

        /* AI è¾“å…¥åŒº */
        .ai-input-area { position: relative; }
        .key-input { 
            position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9);
            padding: 5px 10px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 0.8rem; width: 200px;
        }
        textarea {
            width: 100%; height: 100px; padding: 15px; border: 2px dashed #cbd5e1;
            border-radius: 12px; resize: vertical; font-family: monospace; background: #f8fafc;
        }
        
        /* è¡¨å•æ ·å¼ */
        .edit-form { background: #f8fafc; padding: 20px; border-radius: 12px; margin-top: 15px; border: 1px solid #e2e8f0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
        .form-full-width { grid-column: 1 / -1; }
        .form-group label { display: block; font-size: 0.75rem; margin-bottom: 4px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; }
        
        .time-group { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; background: white; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .time-group input { border: none; background: #f1f5f9; text-align: center; padding: 4px; width: 100%; }
        .time-group label { font-size: 0.7rem; color: #94a3b8; text-align: center; display: block;}

        /* === ğŸ“… æ—¥å†ç»„ä»¶æ ·å¼ === */
        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;
            margin-top: 10px;
        }
        .cal-header { text-align: center; font-weight: bold; color: #64748b; font-size: 0.8rem; padding-bottom: 5px; }
        .cal-day {
            border: 1px solid #e2e8f0; border-radius: 8px; min-height: 70px; background: white;
            padding: 5px; display: flex; flex-direction: column; cursor: pointer; transition: 0.2s;
        }
        .cal-day:hover { border-color: var(--primary); box-shadow: 0 2px 8px rgba(37,99,235,0.1); }
        .cal-date-num { font-size: 0.8rem; font-weight: bold; color: #334155; margin-bottom: 4px; }
        .cal-content { flex: 1; display: flex; flex-direction: column; gap: 2px; }
        .cal-flight-dot { height: 4px; width: 4px; background: var(--primary); border-radius: 50%; display: inline-block; }
        .cal-status { 
            font-size: 0.7rem; padding: 2px 4px; border-radius: 4px; text-align: center; font-weight: 500;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .status-base { background: #f1f5f9; color: #64748b; } /* åŸºåœ°æ²ˆé˜³ */
        .status-overnight { background: #fef3c7; color: #d97706; border: 1px solid #fcd34d; } /* é©»å¤– */

        /* === å†å²è®°å½•æ ·å¼ === */
        .log-list { max-height: 500px; overflow-y: auto; }
        .log-item {
            background: white; border: 1px solid #e2e8f0; border-radius: 10px;
            margin-bottom: 12px; padding: 15px;
        }
        .log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .log-route { font-weight: 700; color: #1e293b; }
        .btn-del {
            background: #fee2e2; color: #dc2626; border: 1px solid #fecaca;
            padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: bold;
        }
        .log-info-row { display: flex; gap: 15px; font-size: 0.85rem; color: #475569; flex-wrap: wrap; align-items: center; }
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; background: #e2e8f0; }
        .tag-city { background: #e0f2fe; color: #0284c7; font-weight: bold; }

        /* æŒ‰é’®ä¸ç™»å½• */
        .btn { padding: 8px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
        .btn-primary { background: var(--primary); color: white; }
        .login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            display: flex; justify-content: center; align-items: center; z-index: 999;
        }
        .login-box { background: white; padding: 40px; border-radius: 20px; text-align: center; width: 320px; }
    </style>
</head>
<body>

    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <h2 style="color: var(--primary); margin-bottom: 20px;">âœˆï¸ é£è¡Œæ—¥å¿—</h2>
            <button class="btn btn-primary" style="width: 100%; padding: 12px;" onclick="loginWithGoogle()">Google è´¦å·ç™»å½•</button>
        </div>
    </div>

    <div id="app" class="container" style="display: none;">
        <div class="top-bar">
            <div><h1 style="font-size: 1.25rem;">é£è¡Œå‘˜æ§åˆ¶å°</h1><span id="userInfo" style="font-size: 0.8rem; opacity: 0.9;">æœªç™»å½•</span></div>
            <button class="btn" style="background: rgba(255,255,255,0.2); color: white;" onclick="doLogout()">é€€å‡º</button>
        </div>

        <!-- 1. ç»Ÿè®¡æŠ¥è¡¨ -->
        <section class="card">
            <div class="card-header">
                <h2>ğŸ“Š è–ªé…¬ç»Ÿè®¡</h2>
                <input type="month" id="reportMonth" onchange="refreshAll()" style="border: 1px solid #cbd5e1; padding: 4px; border-radius: 4px;">
            </div>
            <div class="card-body">
                <div class="table-scroll">
                    <table class="excel-table" id="reportTable"></table>
                </div>
            </div>
        </section>

        <!-- 2. æ™ºèƒ½å½•å…¥ (å«æ—¥å†æŒ‡ä»¤) -->
        <section class="card">
            <div class="card-header">
                <h2>ğŸ“ æ™ºèƒ½å½•å…¥</h2>
                <span style="font-size: 0.8rem; color: #64748b;">æ”¯æŒé£è¡Œè®°å½• æˆ– "7,8 æ²ˆé˜³" æ’ç­æŒ‡ä»¤</span>
            </div>
            <div class="card-body">
                <div class="ai-input-area">
                    <input type="password" id="innerApiKey" class="key-input" placeholder="DeepSeek Key">
                    <textarea id="ocrInput" placeholder="é£è¡Œæ¨¡å¼ï¼š5æœˆ1æ—¥ PEK-SHA é©»å¤–ä¸Šæµ·...&#10;æ’ç­æ¨¡å¼ï¼š7,8 æ²ˆé˜³ (æ›´æ–°æ—¥å†çŠ¶æ€)"></textarea>
                </div>
                <div style="text-align: right; margin-top: 10px;">
                    <button id="aiBtn" class="btn btn-primary" onclick="processAI()">âœ¨ AI è¯†åˆ« / æ›´æ–°æ—¥å†</button>
                </div>

                <!-- é£è¡Œè®°å½•ç¼–è¾‘è¡¨å• -->
                <div id="editForm" class="edit-form" style="display: none;">
                    <div style="margin-bottom:10px; font-weight:bold; color:#2563eb">âœˆï¸ ç¡®è®¤é£è¡Œè®°å½•</div>
                    <div class="form-grid">
                        <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="f_date"></div>
                        <div class="form-group"><label>èµ·é£</label><input type="text" id="f_dep"></div>
                        <div class="form-group"><label>è½åœ°</label><input type="text" id="f_arr"></div>
                        <div class="form-group"><label>åŒºåŸŸ</label>
                            <select id="f_cat"><option value="å›½å†…">å›½å†…</option><option value="æ¸¯æ¾³å°">æ¸¯æ¾³å°</option><option value="äºšæ´²å›½é™…">äºšæ´²å›½é™…</option><option value="æ´²é™…">æ´²é™…</option></select>
                        </div>
                        <div class="form-group form-full-width"><label>æœºç»„</label><input type="text" id="f_crew"></div>
                        
                        <div class="form-group form-full-width">
                            <label>è¿è¡Œæ—¶åˆ» (HH:MM)</label>
                            <div class="time-group">
                                <div><label>å¼€è½¦</label><input type="time" id="f_block_off"></div>
                                <div><label>èµ·é£</label><input type="time" id="f_takeoff"></div>
                                <div><label>è½åœ°</label><input type="time" id="f_landing"></div>
                                <div><label>å…³è½¦</label><input type="time" id="f_block_on"></div>
                            </div>
                        </div>

                        <div class="form-group"><label>ç©ºä¸­æ—¶é—´</label><input type="number" step="0.1" id="f_air"></div>
                        <div class="form-group"><label>æ€»æ—¶é—´</label><input type="number" step="0.1" id="f_total_time"></div>
                        
                        <div class="form-group"><label>å¤œèˆª18:30+</label><input type="number" step="0.1" id="f_night1"></div>
                        <div class="form-group"><label>å¤œèˆª00:00+</label><input type="number" step="0.1" id="f_night2"></div>
                        
                        <!-- é©»å¤–å¢å¼º -->
                        <div class="form-group"><label>é©»å¤–ç±»å‹</label>
                            <select id="f_overnight">
                                <option value="æ— ">æ—  (æœ¬æ¡ä¸è®¡)</option>
                                <option value="å›½å†…æ— è¿‡å¤œ">å›½å†…æ— è¿‡å¤œ</option><option value="å›½å†…æœ‰è¿‡å¤œ">å›½å†…æœ‰è¿‡å¤œ</option>
                                <option value="å›½é™…æ— è¿‡å¤œ">å›½é™…æ— è¿‡å¤œ</option><option value="å›½é™…æœ‰è¿‡å¤œ">å›½é™…æœ‰è¿‡å¤œ</option>
                            </select>
                        </div>
                        <div class="form-group"><label>é©»å¤–åŸå¸‚</label><input type="text" id="f_overnight_city" placeholder="é»˜è®¤èµ·é£åœ°"></div>
                        <div class="form-group"><label>é©»å¤–å¤©æ•°</label><input type="number" id="f_overnight_days" value="0"></div>
                        
                        <div class="form-group"><label>ç‰¹æ®Šæœºåœº</label><input type="number" id="f_special" value="0"></div>
                        <div class="form-group"><label>èŠ‚å‡æ—¥</label><input type="number" id="f_holiday" value="0"></div>
                        <div class="form-group"><label>æ»‘è¡Œ(æ¬¡)</label><input type="number" id="f_block_days" value="1"></div>
                    </div>
                    <div style="margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">
                        <button class="btn" style="background: #e2e8f0;" onclick="document.getElementById('editForm').style.display='none'">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="saveRecord()">ğŸ’¾ ä¿å­˜è®°å½•</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. ğŸ“… æ‰§å‹¤æ—¥å† (æ–°) -->
        <section class="card">
            <div class="card-header">
                <h2>ğŸ“… æ‰§å‹¤æ—¥å†</h2>
                <span style="font-size: 0.8rem; color: #64748b;">ç‚¹å‡»æ—¥æœŸä¿®æ”¹é©»å¤–åœ°</span>
            </div>
            <div class="card-body">
                <div class="calendar-grid" style="margin-bottom: 5px;">
                    <div class="cal-header">å‘¨æ—¥</div><div class="cal-header">å‘¨ä¸€</div><div class="cal-header">å‘¨äºŒ</div><div class="cal-header">å‘¨ä¸‰</div><div class="cal-header">å‘¨å››</div><div class="cal-header">å‘¨äº”</div><div class="cal-header">å‘¨å…­</div>
                </div>
                <div id="calendarGrid" class="calendar-grid"></div>
            </div>
        </section>

        <!-- 4. å†å²è®°å½• -->
        <section class="card">
            <div class="card-header"><h2>ğŸ“‹ å†å²è®°å½•</h2></div>
            <div class="card-body">
                <div id="logList" class="log-list"></div>
            </div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCFk4f7bKUHlb3d1Cg1jyS1EM-SPC4pr40",
            authDomain: "myflightlog-1f4cb.firebaseapp.com",
            projectId: "myflightlog-1f4cb",
            storageBucket: "myflightlog-1f4cb.firebasestorage.app",
            messagingSenderId: "181072044112",
            appId: "1:181072044112:web:ca312da2d4780227cef155"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        let currentUser = null;
        let allRecords = []; // é£è¡Œè®°å½•
        let calendarData = {}; // æ—¥å†çŠ¶æ€æ•°æ® { "2025-05-01": "æ²ˆé˜³" }

        window.loginWithGoogle = async () => { try { await signInWithPopup(auth, provider); } catch (e) { alert(e.message); } };
        window.doLogout = async () => { await signOut(auth); };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userInfo').textContent = `ğŸ‘¨â€âœˆï¸ ${user.displayName}`;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                document.getElementById('reportMonth').value = new Date().toISOString().slice(0, 7);
                if(localStorage.getItem("openai_key")) document.getElementById("innerApiKey").value = localStorage.getItem("openai_key");

                // 1. ç›‘å¬é£è¡Œè®°å½•
                onSnapshot(query(collection(db, `users/${user.uid}/logs`), orderBy("date", "desc")), (snapshot) => {
                    allRecords = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    refreshAll();
                });
                
                // 2. ç›‘å¬æ—¥å†çŠ¶æ€æ•°æ® (å•ç‹¬çš„ collection å­˜æ”¾æ’ç­)
                onSnapshot(collection(db, `users/${user.uid}/calendar_status`), (snapshot) => {
                    calendarData = {};
                    snapshot.docs.forEach(doc => calendarData[doc.id] = doc.data().status);
                    renderCalendar();
                });

            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
        });

        window.refreshAll = () => {
            renderList();
            renderReport();
            renderCalendar();
        };

        // === AI å¤„ç†é€»è¾‘ (å«æ—¥å†æŒ‡ä»¤) ===
        window.processAI = async () => {
            const text = document.getElementById('ocrInput').value;
            const apiKey = document.getElementById('innerApiKey').value;
            if (!apiKey) return alert("è¯·è¾“å…¥ Key");
            localStorage.setItem("openai_key", apiKey);

            const btn = document.getElementById('aiBtn');
            btn.textContent = "â³ æ€è€ƒä¸­..."; btn.disabled = true;

            // å¢å¼º Promptï¼šåŒºåˆ†â€œé£è¡Œè®°å½•â€å’Œâ€œæ—¥å†æ’ç­â€
            const prompt = `
            ç”¨æˆ·è¾“å…¥å¯èƒ½æ˜¯é£è¡Œä»»åŠ¡ï¼Œä¹Ÿå¯èƒ½æ˜¯æ’ç­æŒ‡ä»¤ã€‚
            1. è‹¥æ˜¯é£è¡Œä»»åŠ¡ï¼Œè¿”å› type="flight" å’Œé£è¡Œå­—æ®µã€‚
               overnight_city(str): é©»å¤–åŸå¸‚ã€‚è‹¥æ–‡æœ¬æœªæåŠï¼Œé»˜è®¤è®¾ä¸ºdep(èµ·é£æœºåœº)ã€‚
               overnight(str): è‹¥æ— é©»å¤–ä¿¡æ¯æˆ–æœ¬æ®µä¸è®¡ï¼Œè®¾ä¸º"æ— "ã€‚
            2. è‹¥æ˜¯æ’ç­æŒ‡ä»¤(å¦‚"7,8 æ²ˆé˜³", "20-22 ä¼‘æ¯"), è¿”å› type="calendar", dates=[YYYY-MM-DD...], status="æ²ˆé˜³/ä¼‘æ¯"ã€‚
            
            å½“å‰æœˆä»½: ${document.getElementById('reportMonth').value}
            æ–‡æœ¬: ${text}
            
            è¯·è¿”å›çº¯JSONã€‚
            é£è¡Œå­—æ®µ: date, dep, arr, category, crew, time_off, time_takeoff, time_landing, time_on, air_time, total_time, block_days, night1, night2, overnight, overnight_city, overnight_days, special_airport, holiday.
            `;

            try {
                const res = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: "deepseek-chat", messages: [{role: "user", content: prompt}], temperature: 0.1 })
                });
                const data = await res.json();
                const content = data.choices[0].message.content;
                const r = JSON.parse(content.match(/\{[\s\S]*\}/)[0]);

                if (r.type === 'calendar') {
                    // === å¤„ç†æ—¥å†æ’ç­ ===
                    const batchPromises = r.dates.map(date => 
                        setDoc(doc(db, `users/${currentUser.uid}/calendar_status`, date), { status: r.status })
                    );
                    await Promise.all(batchPromises);
                    alert(`âœ… å·²æ›´æ–°æ—¥å†: ${r.dates.length} å¤©è®¾ä¸º ${r.status}`);
                    document.getElementById('ocrInput').value = '';
                } else {
                    // === å¤„ç†é£è¡Œè®°å½• ===
                    const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
                    setVal('f_date', r.date); setVal('f_dep', r.dep); setVal('f_arr', r.arr);
                    setVal('f_cat', r.category || 'å›½å†…'); setVal('f_crew', r.crew);
                    setVal('f_block_off', r.time_off); setVal('f_takeoff', r.time_takeoff);
                    setVal('f_landing', r.time_landing); setVal('f_block_on', r.time_on);
                    setVal('f_air', r.air_time); setVal('f_total_time', r.total_time);
                    setVal('f_block_days', r.block_days || 1); 
                    setVal('f_night1', r.night1); setVal('f_night2', r.night2);
                    
                    // é©»å¤–é€»è¾‘ï¼šé»˜è®¤æ— ï¼Œè‹¥æœ‰åˆ™å¡«
                    setVal('f_overnight', r.overnight || 'æ— '); 
                    setVal('f_overnight_days', r.overnight_days || 0);
                    // é»˜è®¤é©»å¤–åŸå¸‚é€»è¾‘ï¼šè‹¥AIæœªè§£æå‡ºï¼Œåˆ™é»˜è®¤èµ·é£åœ°
                    setVal('f_overnight_city', r.overnight_city || r.dep); 

                    setVal('f_special', r.special_airport); setVal('f_holiday', r.holiday);

                    document.getElementById('editForm').style.display = 'block';
                }
            } catch (e) { alert("å¤„ç†å¤±è´¥: " + e.message); } 
            finally { btn.textContent = "âœ¨ AI è¯†åˆ« / æ›´æ–°æ—¥å†"; btn.disabled = false; }
        };

        // ä¿å­˜è®°å½•
        window.saveRecord = async () => {
            const getNum = (id) => parseFloat(document.getElementById(id).value) || 0;
            const getStr = (id) => document.getElementById(id).value;
            
            // è·å–é©»å¤–åŸå¸‚ï¼Œè‹¥ä¸ºç©ºåˆ™é»˜è®¤èµ·é£åœ°
            let ovCity = getStr('f_overnight_city');
            if(!ovCity && getStr('f_overnight') !== 'æ— ') ovCity = getStr('f_dep');

            const record = {
                date: getStr('f_date'), dep: getStr('f_dep'), arr: getStr('f_arr'), category: getStr('f_cat'), crew: getStr('f_crew'),
                block_off: getStr('f_block_off'), takeoff: getStr('f_takeoff'), landing: getStr('f_landing'), block_on: getStr('f_block_on'),
                air_time: getNum('f_air'), total_time: getNum('f_total_time'),
                block_days: getNum('f_block_days'), night1: getNum('f_night1'), night2: getNum('f_night2'),
                overnight: getStr('f_overnight'), overnight_city: ovCity, overnight_days: getNum('f_overnight_days'),
                special_airport: getNum('f_special'), holiday: getNum('f_holiday'),
                timestamp: new Date()
            };
            await addDoc(collection(db, `users/${currentUser.uid}/logs`), record);
            document.getElementById('editForm').style.display = 'none';
            document.getElementById('ocrInput').value = '';
        };

        window.deleteItem = async (id) => {
            if(confirm("âš ï¸ ç¡®å®šåˆ é™¤ï¼Ÿ")) try { await deleteDoc(doc(db, `users/${currentUser.uid}/logs`, id)); } catch(e) { alert(e.message); }
        };

        // === æ¸²æŸ“æ—¥å† (æ ¸å¿ƒé€»è¾‘) ===
        window.renderCalendar = () => {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            const mStr = document.getElementById('reportMonth').value;
            const [y, m] = mStr.split('-').map(Number);
            const daysInMonth = new Date(y, m, 0).getDate();
            const firstDay = new Date(y, m - 1, 1).getDay(); // 0=å‘¨æ—¥

            // ç©ºç™½å¡«å……
            for(let i=0; i<firstDay; i++) grid.innerHTML += '<div></div>';

            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                
                // 1. è·å–å½“å¤©é£è¡Œè®°å½•
                const flights = allRecords.filter(r => r.date === dateStr);
                const hasFlight = flights.length > 0;
                
                // 2. ç¡®å®šé©»å¤–åŸå¸‚çŠ¶æ€
                // ä¼˜å…ˆçº§: æ‰‹åŠ¨æ—¥å†è®¾ç½®(calendarData) > é£è¡Œè®°å½•é‡Œçš„é©»å¤–åŸå¸‚ > åŸºåœ°(æ²ˆé˜³)
                let statusText = "æ²ˆé˜³"; // é»˜è®¤åŸºåœ°
                let isBase = true;

                // æ£€æŸ¥é£è¡Œè®°å½•é‡Œæ˜¯å¦æœ‰æ˜ç¡®çš„é©»å¤–åŸå¸‚
                const flightWithStay = flights.find(r => r.overnight !== 'æ— ' && r.overnight_city);
                if (flightWithStay) {
                    statusText = flightWithStay.overnight_city;
                    isBase = false;
                }

                // æ£€æŸ¥æ˜¯å¦æœ‰æ‰‹åŠ¨æ’ç­è¦†ç›–
                if (calendarData[dateStr]) {
                    statusText = calendarData[dateStr];
                    isBase = false; // æ‰‹åŠ¨è®¾ç½®çš„é»˜è®¤è§†ä¸ºéåŸºåœ°ï¼Œé™¤éæ˜¯æ²ˆé˜³
                }

                // ç»Ÿä¸€åˆ¤æ–­æ˜¯å¦æ˜¯åŸºåœ° (æ²ˆé˜³/SHE/Base)
                if (['æ²ˆé˜³', 'SHE', 'åŸºåœ°', 'æ— '].includes(statusText)) {
                    isBase = true;
                    statusText = "æ²ˆé˜³";
                }

                const cell = document.createElement('div');
                cell.className = 'cal-day';
                cell.onclick = () => editCalendarDay(dateStr, statusText);
                
                cell.innerHTML = `
                    <div class="cal-date-num">${d}</div>
                    <div class="cal-content">
                        ${hasFlight ? '<div style="text-align:center"><span class="cal-flight-dot"></span></div>' : ''}
                        <div class="cal-status ${isBase ? 'status-base' : 'status-overnight'}">${statusText}</div>
                    </div>
                `;
                grid.appendChild(cell);
            }
        };

        // ä¿®æ”¹æ—¥å†æŸå¤©çŠ¶æ€
        window.editCalendarDay = async (date, currentStatus) => {
            const newStatus = prompt(`ä¿®æ”¹ ${date} çš„é©»å¤–åœ°ç‚¹/çŠ¶æ€ï¼š\n(è¾“å…¥ 'æ²ˆé˜³' ä¸ºåŸºåœ°/ä¼‘æ¯)`, currentStatus);
            if (newStatus !== null && newStatus !== currentStatus) {
                await setDoc(doc(db, `users/${currentUser.uid}/calendar_status`, date), { status: newStatus });
            }
        };

        window.renderList = () => {
            const el = document.getElementById('logList');
            el.innerHTML = allRecords.length ? allRecords.map(r => `
                <div class="log-item">
                    <div class="log-header">
                        <div style="font-family:monospace;color:#64748b">${r.date}</div>
                        <div class="log-route">${r.dep} â” ${r.arr}</div>
                        <button class="btn-del" onclick="deleteItem('${r.id}')">åˆ é™¤</button>
                    </div>
                    <div class="log-info-row">
                        <span>â˜ï¸${r.air_time}h</span> <span>âŒš${r.total_time||0}h</span>
                        <span>${r.category}</span>
                        ${r.overnight !== 'æ— ' ? `<span class="tag tag-city">ğŸ  ${r.overnight_city || r.dep}</span>` : ''}
                        ${r.special_airport>0?'<span class="tag" style="color:purple">ç‰¹</span>':''}
                    </div>
                </div>
            `).join('') : '<div style="text-align:center;color:#ccc">æ— è®°å½•</div>';
        };

        window.renderReport = () => {
            const mStr = document.getElementById('reportMonth').value;
            const data = allRecords.filter(r => r.date.startsWith(mStr));
            const s = { d_air:0, d_bk:0, h_air:0, h_bk:0, a_air:0, a_bk:0, i_air:0, i_bk:0, n1:0, n2:0, o_d0:0, o_d1:0, o_i0:0, o_i1:0, spec:0, hol:0 };
            
            data.forEach(r => {
                if(r.category==='å›½å†…') { s.d_air+=r.air_time; s.d_bk+=r.block_days; }
                else if(r.category==='æ¸¯æ¾³å°') { s.h_air+=r.air_time; s.h_bk+=r.block_days; }
                else if(r.category==='äºšæ´²å›½é™…') { s.a_air+=r.air_time; s.a_bk+=r.block_days; }
                else { s.i_air+=r.air_time; s.i_bk+=r.block_days; }
                
                s.n1 += r.night1; s.n2 += r.night2;
                s.spec += (r.special_airport || 0); s.hol += (r.holiday || 0);

                // é©»å¤–ç»Ÿè®¡ (åªç»Ÿè®¡æœ‰é©»å¤–ç±»å‹çš„)
                if(r.overnight !== 'æ— ') {
                    const days = r.overnight_days || 0;
                    if(r.overnight==='å›½å†…æ— è¿‡å¤œ') s.o_d0+=days; else if(r.overnight==='å›½å†…æœ‰è¿‡å¤œ') s.o_d1+=days;
                    else if(r.overnight==='å›½é™…æ— è¿‡å¤œ') s.o_i0+=days; else s.o_i1+=days;
                }
            });

            document.getElementById('reportTable').innerHTML = `
                <thead>
                    <tr><th rowspan="2">ç±»å‹</th><th colspan="2">å›½å†…</th><th colspan="2">æ¸¯æ¾³å°</th><th colspan="2">äºšæ´²</th><th colspan="2">æ´²é™…</th></tr>
                    <tr><th>ç©º</th><th>æ»‘</th><th>ç©º</th><th>æ»‘</th><th>ç©º</th><th>æ»‘</th><th>ç©º</th><th>æ»‘</th></tr>
                </thead>
                <tbody>
                    <tr><td>é£è¡Œ</td>
                        <td>${s.d_air.toFixed(1)}</td><td>${s.d_bk}</td><td>${s.h_air.toFixed(1)}</td><td>${s.h_bk}</td>
                        <td>${s.a_air.toFixed(1)}</td><td>${s.a_bk}</td><td>${s.i_air.toFixed(1)}</td><td>${s.i_bk}</td>
                    </tr>
                    <tr><td colspan="9" style="background:#f8fafc;height:8px;padding:0"></td></tr>
                    <tr><th rowspan="2">è¡¥åŠ©</th><th colspan="2">å¤œèˆª</th><th colspan="2">ç‰¹æ®Š/èŠ‚å‡</th><th colspan="2">é©»å¤–(æœ‰)</th><th colspan="2">å…¶ä»–</th></tr>
                    <tr><th>18:30</th><th>00:00</th><th class="bg-sub">ç‰¹æ®Š</th><th class="bg-sub">å‡æ—¥</th><th>å›½æœ‰</th><th>å¤–æœ‰</th><th>-</th><th>-</th></tr>
                    <tr><td>ç»Ÿè®¡</td>
                        <td>${s.n1.toFixed(1)}</td><td>${s.n2.toFixed(1)}</td><td class="bg-sub">${s.spec}</td><td class="bg-sub">${s.hol}</td>
                        <td>${s.o_d1}</td><td>${s.o_i1}</td><td>-</td><td>-</td>
                    </tr>
                </tbody>
            `;
        };
    </script>
</body>
</html>
