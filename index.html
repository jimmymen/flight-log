<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é£è¡Œæ—¥å¿— Pro - æœºé•¿å…¨èƒ½ç»“ç®—ç‰ˆ</title>
    <style>
        /* === æ ¸å¿ƒå˜é‡ === */
        :root {
            --primary: #1d4ed8; --primary-light: #dbeafe;
            --bg: #f8fafc; --text: #1e293b; --text-light: #64748b;
            --border: #e2e8f0;
            --tax-red: #ef4444; --money-green: #10b981;
            --tag-dom-bg: #e0f2fe; --tag-dom-text: #0369a1;
            --tag-int-bg: #f3e8ff; --tag-int-text: #7e22ce;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg); color: var(--text);
            padding: 15px; padding-bottom: 80px; max-width: 800px; margin: 0 auto;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .app-title { font-size: 1.4rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .btn-icon { background: white; border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px; font-size: 0.9rem; color: var(--text); cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        /* å¡ç‰‡å®¹å™¨ */
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid var(--border); overflow: hidden; margin-bottom: 15px; }
        .card-header { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .card-title { font-weight: 700; font-size: 1rem; color: var(--text); }
        .card-body { padding: 15px; }

        /* === 1. å®å‘å¤§å±æ ·å¼ === */
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid var(--border); }
        .sum-item { text-align: center; }
        .sum-label { font-size: 0.7rem; color: var(--text-light); margin-bottom: 4px; }
        .sum-val { font-size: 1rem; font-weight: 800; font-family: monospace; }
        .sum-total { grid-column: 1 / -1; border-top: 2px dashed #e2e8f0; margin-top: 5px; padding-top: 10px; }
        .total-money { font-size: 1.8rem; color: var(--primary); font-weight: 900; letter-spacing: -1px; }

        /* === 2. è–ªèµ„æ˜ç»†è¡¨ (å«è¿‡ç¨‹) === */
        .salary-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .salary-table th { text-align: left; color: var(--text-light); padding: 10px 5px; border-bottom: 2px solid var(--border); font-size: 0.75rem; background: #f9fafb; }
        .salary-table td { padding: 12px 5px; border-bottom: 1px dashed var(--border); vertical-align: top; }
        .salary-table tr:last-child td { border-bottom: none; }
        
        .col-name { width: 25%; font-weight: 600; color: var(--text); }
        .col-proc { width: 50%; font-family: "Menlo", monospace; color: var(--text-light); font-size: 0.75rem; line-height: 1.4; }
        .col-amt { width: 25%; text-align: right; font-family: "Menlo", monospace; font-weight: 700; font-size: 0.9rem; color: var(--text); }
        
        .proc-tag { display: inline-block; background: #eff6ff; border: 1px solid #bfdbfe; color: var(--primary); padding: 1px 4px; border-radius: 3px; margin-right: 3px; margin-bottom: 2px; }
        .proc-op { color: #94a3b8; margin: 0 2px; }
        .val-red { color: var(--tax-red); }
        .val-green { color: var(--money-green); }

        /* === 3. æ—¥å†æ ·å¼ === */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .cal-head { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 0.75rem; color: var(--text-light); padding: 10px 0; font-weight: bold; }
        .cal-day { background: white; border: 1px solid var(--border); border-radius: 8px; min-height: 80px; padding: 4px; display: flex; flex-direction: column; position: relative; cursor: pointer; }
        .cal-day.today { border: 2px solid var(--primary); background: #eff6ff; }
        .cal-num { font-size: 0.8rem; font-weight: 700; color: #cbd5e1; margin-bottom: 2px; display: flex; justify-content: space-between; }
        .cal-day.today .cal-num { color: var(--primary); }
        
        .flight-dot { font-size: 0.65rem; padding: 2px 4px; border-radius: 3px; margin-bottom: 2px; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .dot-dom { background: #3b82f6; }
        .dot-int { background: #8b5cf6; }
        
        .status-badge { font-size: 0.6rem; text-align: center; border-radius: 3px; padding: 1px; margin-top: auto; font-weight: bold; border: 1px solid transparent; }
        .st-dom-stay { background: #dbeafe; color: #1e40af; border-color: #bfdbfe; }
        .st-dom-no { background: #d1fae5; color: #065f46; border-color: #a7f3d0; }
        .st-int-stay { background: #f3e8ff; color: #6b21a8; border-color: #e9d5ff; }
        .st-int-no { background: #fef3c7; color: #92400e; border-color: #fde68a; }
        
        .night-badge { position: absolute; top: 4px; right: 4px; font-size: 0.6rem; }

        /* === 4. è¾“å…¥ä¸è¡¨å• === */
        .ai-box { position: relative; border: 2px dashed var(--border); padding: 10px; border-radius: 10px; background: #f9fafb; transition: 0.2s; }
        .ai-box:focus-within { border-color: var(--primary); background: white; }
        .ai-input { width: 100%; height: 80px; border: none; background: transparent; resize: none; font-size: 0.9rem; }
        .api-key-input { position: absolute; bottom: 10px; right: 10px; font-size: 0.7rem; padding: 4px; border: 1px solid var(--border); border-radius: 4px; width: 100px; opacity: 0.7; }
        
        .edit-form { display: none; margin-top: 15px; border-top: 1px dashed var(--border); padding-top: 15px; animation: slideDown 0.3s; }
        @keyframes slideDown { from {opacity:0; transform:translateY(-10px)} to {opacity:1; transform:translateY(0)} }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .form-full { grid-column: 1 / -1; }
        .input-label { display: block; font-size: 0.75rem; color: var(--text-light); margin-bottom: 4px; font-weight: 600; }
        .input-field { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: white; font-size: 0.9rem; }
        .input-field:focus { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-light); }

        .btn { border: none; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; font-size: 0.9rem; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-ghost { background: white; border: 1px solid var(--border); color: var(--text-light); }
        .btn-danger { background: #fee2e2; color: #ef4444; width: auto; padding: 4px 8px; font-size: 0.8rem; }

        /* === 5. æ¨¡æ€æ¡† === */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-card { background: white; width: 90%; max-width: 400px; border-radius: 16px; padding: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: popUp 0.2s; }
        @keyframes popUp { from {transform:scale(0.9); opacity:0} to {transform:scale(1); opacity:1} }
        
        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
        .st-btn { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.85rem; transition: 0.1s; }
        .st-btn:active { transform: scale(0.98); }
        
        .night-section { margin-top: 15px; border-top: 1px solid var(--border); padding-top: 10px; }
        .night-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .night-btn { background: #0f172a; color: #fcd34d; border: 1px solid #334155; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.8rem; }

        /* åˆ—è¡¨é¡¹ */
        .log-list { margin-top: 0; }
        .log-item { background: white; padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .log-date { font-family: monospace; font-weight: bold; color: var(--text); background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; margin-right: 8px; }
        .log-details { font-size: 0.8rem; color: var(--text-light); margin-top: 2px; }
        .log-money { font-weight: bold; font-size: 0.9rem; text-align: right; }
        .log-sub { font-size: 0.7rem; color: var(--money-green); display: block; }

        /* ç™»å½•å± */
        .login-overlay { position: fixed; inset: 0; background: linear-gradient(135deg, #2563eb, #1e40af); z-index: 200; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 20px; text-align: center; width: 90%; max-width: 320px; box-shadow: 0 25px 50px rgba(0,0,0,0.25); }
        
        /* Loading */
        .loader { position: absolute; inset: 0; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; border-radius: 10px; z-index: 10; }
        .spinner { width: 24px; height: 24px; border: 3px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginScreen" class="login-overlay">
        <div class="login-box">
            <div style="font-size: 3rem; margin-bottom: 10px;">âœˆï¸</div>
            <h2 style="color: var(--primary); margin-bottom: 20px;">é£è¡Œæ—¥å¿— Pro<br><span style="font-size:0.9rem; color:var(--text-light); font-weight:normal;">2025 æœºé•¿å¹´è–ªç‰ˆ</span></h2>
            <button class="btn btn-primary" onclick="loginWithGoogle()">Google ç™»å½•</button>
        </div>
    </div>

    <!-- è®¾ç½®å¼¹çª— -->
    <div id="settingsModal" class="modal-overlay" onclick="if(event.target===this) this.style.display='none'">
        <div class="modal-card">
            <h3 style="text-align:center; margin-bottom:15px;">âš™ï¸ ç¨åŠ¡ä¸è–ªèµ„è®¾ç½®</h3>
            <div style="background:var(--primary-light); padding:10px; border-radius:8px; margin-bottom:15px;">
                <p style="font-size:0.75rem; color:var(--primary); font-weight:bold;">âš ï¸ å¿…å¡«ï¼šç”¨äºè®¡ç®—è¡¥ç¨</p>
                <div style="margin-top:8px;">
                    <label class="input-label">å¹´åˆè‡³ä»Šç´¯è®¡åº”çº³ç¨æ‰€å¾—é¢</label>
                    <input type="number" id="set_cum_income" class="input-field" placeholder="ä¾‹: 942692">
                </div>
                <div style="margin-top:8px;">
                    <label class="input-label">å¹´åˆè‡³ä»Šå·²ç”³æŠ¥ç¨é¢</label>
                    <input type="number" id="set_cum_tax" class="input-field" placeholder="ä¾‹: 244022">
                </div>
            </div>
            <div class="form-grid">
                <div><label class="input-label">èŒçº§</label><select id="set_rank" class="input-field"><option value="æœºé•¿">æœºé•¿</option><option value="æ•™å‘˜">æ•™å‘˜</option></select></div>
                <div><label class="input-label">ICAO4</label><select id="set_icao" class="input-field"><option value="signed">å·²ç­¾</option><option value="unsigned">æœªç­¾</option></select></div>
            </div>
            <button class="btn btn-primary" style="margin-top:20px;" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
        </div>
    </div>

    <!-- æ—¥å†çŠ¶æ€å¼¹çª— (æ‰¾å›äº†å¤œèˆªåŠŸèƒ½) -->
    <div id="statusModal" class="modal-overlay" onclick="if(event.target===this) this.style.display='none'">
        <div class="modal-card">
            <h3 style="text-align:center;">ä¿®æ”¹ <span id="modalDateStr" style="color:var(--primary)"></span></h3>
            <div style="margin-top:15px;">
                <input type="text" id="modalCity" class="input-field" style="text-align:center" placeholder="è¾“å…¥é©»å¤–åŸå¸‚ (å¦‚: æ›¼è°·)">
            </div>
            <div class="status-grid">
                <button class="st-btn" style="background:#dbeafe; color:#1e40af;" onclick="saveCalStatus('å›½å†…æœ‰è¿‡å¤œ')">ğŸ”µ å›½å†…è¿‡å¤œ</button>
                <button class="st-btn" style="background:#d1fae5; color:#065f46;" onclick="saveCalStatus('å›½å†…æ— è¿‡å¤œ')">ğŸŸ¢ å›½å†…æ— è¿‡</button>
                <button class="st-btn" style="background:#f3e8ff; color:#6b21a8;" onclick="saveCalStatus('å›½é™…æœ‰è¿‡å¤œ')">ğŸŸ£ å›½é™…è¿‡å¤œ</button>
                <button class="st-btn" style="background:#fef3c7; color:#92400e;" onclick="saveCalStatus('å›½é™…æ— è¿‡å¤œ')">ğŸŸ¡ å›½é™…æ— è¿‡</button>
                <button class="st-btn" style="grid-column:1/-1; background:#f1f5f9; color:#64748b;" onclick="saveCalStatus(null)">ğŸ  å›å®¶/æ¸…é™¤çŠ¶æ€</button>
            </div>
            
            <div class="night-section">
                <p style="font-size:0.75rem; color:#64748b; margin-bottom:5px; font-weight:bold;">ğŸŒ™ æ ‡è®°å¤œèˆªæœºå‹</p>
                <div class="night-grid">
                    <button class="night-btn" onclick="saveNightStatus('CL850')">CL850</button>
                    <button class="night-btn" onclick="saveNightStatus('G650')">G650</button>
                    <button class="night-btn" style="background:#f1f5f9; color:#64748b; border-color:#cbd5e1" onclick="saveNightStatus(null)">æ¸…é™¤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="app" class="container" style="display:none;">
        <div class="top-bar">
            <div class="app-title">ğŸ‘¨â€âœˆï¸ é£è¡Œæ—¥å¿— Pro</div>
            <div>
                <button class="btn-icon" onclick="document.getElementById('settingsModal').style.display='flex'">âš™ï¸ è®¾ç½®</button>
                <button class="btn-icon" onclick="doLogout()">é€€å‡º</button>
            </div>
        </div>

        <!-- 1. è–ªèµ„ç»“ç®—å¤§å± -->
        <section class="card">
            <div class="card-header">
                <div class="card-title">ğŸ’° æœ¬æœˆå®å‘ç»“ç®— (ç¨å)</div>
                <div id="taxBadge" style="font-size:0.7rem; background:#fee2e2; color:#b91c1c; padding:2px 6px; border-radius:4px; font-weight:bold;">ç¨ç‡è®¡ç®—ä¸­</div>
            </div>
            <div class="card-body">
                <div class="summary-grid">
                    <div class="sum-item">
                        <div class="sum-label">å›ºå®šå·¥èµ„</div>
                        <div class="sum-val" style="color:#0f172a">96,080</div>
                    </div>
                    <div class="sum-item">
                        <div class="sum-label">å˜åŠ¨å®å‘</div>
                        <div class="sum-val val-red" id="disp_var_net">0</div>
                    </div>
                    <div class="sum-item">
                        <div class="sum-label">è¡¥åŠ©å®å‘</div>
                        <div class="sum-val val-green" id="disp_allow_net">0</div>
                    </div>
                    <div class="sum-item sum-total">
                        <div class="sum-label">æœ¬æœˆé“¶è¡Œå¡åˆè®¡</div>
                        <div class="total-money" id="disp_total_net">Â¥0.00</div>
                    </div>
                </div>

                <div style="overflow-x:auto;">
                    <table class="salary-table">
                        <thead><tr><th class="col-name">é¡¹ç›®</th><th class="col-proc">è®¡ç®—è¿‡ç¨‹</th><th class="col-amt">é‡‘é¢</th></tr></thead>
                        <tbody id="salaryBody">
                            <!-- JS å¡«å…… -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- 2. æœˆåº¦ç»Ÿè®¡ -->
        <section class="card">
            <div class="card-header">
                <div class="card-title">ğŸ“Š ç»Ÿè®¡æŠ¥è¡¨</div>
                <input type="month" id="reportMonth" style="border:1px solid var(--border); padding:4px; border-radius:6px;" onchange="refreshAll()">
            </div>
            <div class="card-body" style="padding:0">
                <div class="table-wrapper"><table class="excel-table" id="reportTable"></table></div>
            </div>
        </section>

        <!-- 3. æ—¥å† -->
        <section class="card">
            <div class="card-header">
                <div class="card-title">ğŸ“… æ‰§å‹¤æ—¥å†</div>
                <span id="calTotalHours" style="font-size:0.8rem; color:var(--text-light); font-weight:bold;"></span>
            </div>
            <div class="card-body user-select-none">
                <div class="cal-head"><div>å‘¨æ—¥</div><div>å‘¨ä¸€</div><div>å‘¨äºŒ</div><div>å‘¨ä¸‰</div><div>å‘¨å››</div><div>å‘¨äº”</div><div>å‘¨å…­</div></div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
        </section>

        <!-- 4. æ™ºèƒ½å½•å…¥ -->
        <section class="card">
            <div class="card-header">
                <div class="card-title">ğŸ“ æ™ºèƒ½å½•å…¥</div>
                <button class="btn-icon" style="color:var(--primary); border-color:var(--primary);" onclick="processAI()" id="aiBtn">âœ¨ AI è¯†åˆ«</button>
            </div>
            <div class="card-body">
                <div class="ai-box">
                    <div id="aiLoader" class="loader"><div class="spinner"></div></div>
                    <input type="password" id="apiKey" class="api-key-input" placeholder="API Key">
                    <textarea id="aiInput" class="ai-input" placeholder="åœ¨æ­¤ç²˜è´´...&#10;ä¾‹: 11.15 æ²ˆé˜³-ä¸œäº¬ å›½é™…æœ‰è¿‡å¤œ æ»‘è¡Œ2å¤©&#10;ä¾‹: 10.1 å›½åº†åŠ ç­ 4å¤©"></textarea>
                </div>

                <div id="editForm" class="edit-form">
                    <input type="hidden" id="editId">
                    <div class="form-grid">
                        <div><label class="input-label">æ—¥æœŸ</label><input type="date" id="f_date" class="input-field"></div>
                        <div><label class="input-label">ç±»å‹</label><select id="f_cat" class="input-field"><option value="å›½å†…">å›½å†…</option><option value="æ¸¯æ¾³å°">æ¸¯æ¾³å°</option><option value="äºšæ´²å›½é™…">äºšæ´²å›½é™…</option><option value="æ´²é™…">æ´²é™…</option></select></div>
                        <div><label class="input-label">èµ·é£åœ°</label><input type="text" id="f_dep" class="input-field"></div>
                        <div><label class="input-label">è½åœ°åœ°</label><input type="text" id="f_arr" class="input-field"></div>
                        <div><label class="input-label">ç©ºæ—¶ (h)</label><input type="number" step="0.1" id="f_air" class="input-field"></div>
                        <div><label class="input-label">æ€»æ—¶ (h)</label><input type="number" step="0.1" id="f_total" class="input-field"></div>
                    </div>
                    
                    <div class="form-grid" style="margin-top:10px; background:#eff6ff; padding:10px; border-radius:8px;">
                        <div><label class="input-label" style="color:#1e40af">æ»‘è¡Œå¤©æ•° (Block)</label><input type="number" id="f_block" class="input-field" value="1"></div>
                        <div><label class="input-label" style="color:#b91c1c">èŠ‚å‡æ—¥å¤©æ•° (3å€)</label><input type="number" id="f_hol" class="input-field" value="0"></div>
                    </div>

                    <div class="form-grid" style="margin-top:10px;">
                        <div><label class="input-label">é©»å¤–ç±»å‹</label><select id="f_over_type" class="input-field"><option value="æ— ">æ— </option><option value="å›½å†…æœ‰è¿‡å¤œ">å›½å†…æœ‰è¿‡å¤œ</option><option value="å›½å†…æ— è¿‡å¤œ">å›½å†…æ— è¿‡å¤œ</option><option value="å›½é™…æœ‰è¿‡å¤œ">å›½é™…æœ‰è¿‡å¤œ</option><option value="å›½é™…æ— è¿‡å¤œ">å›½é™…æ— è¿‡å¤œ</option></select></div>
                        <div><label class="input-label">é©»å¤–å¤©æ•°</label><input type="number" id="f_over_days" class="input-field" value="0"></div>
                        <div><label class="input-label">å›½å†…é¤ (60)</label><input type="number" id="f_meal_d" class="input-field" value="0"></div>
                        <div><label class="input-label">å›½é™…é¤ (180)</label><input type="number" id="f_meal_i" class="input-field" value="0"></div>
                        <div class="form-full"><label class="input-label">å¤œèˆª/ç‰¹æ®Š (å°æ—¶/æ¬¡)</label><div style="display:flex; gap:5px;"><input type="number" id="f_n1" placeholder="å‰å¤œ" class="input-field"><input type="number" id="f_n2" placeholder="åå¤œ" class="input-field"><input type="number" id="f_spec" placeholder="ç‰¹æ®Š" class="input-field"></div></div>
                    </div>

                    <div style="display:flex; gap:10px; margin-top:15px;">
                        <button class="btn btn-ghost" onclick="document.getElementById('editForm').style.display='none'">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="saveRecord()">ğŸ’¾ ä¿å­˜</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 5. è®°å½•åˆ—è¡¨ -->
        <section class="card" style="border:none; box-shadow:none; background:transparent;">
            <div id="logList" class="log-list"></div>
        </section>
    </div>

    <!-- Firebase SDK & Logic -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, setDoc, deleteDoc, addDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = { 
            apiKey: "AIzaSyCFk4f7bKUHlb3d1Cg1jyS1EM-SPC4pr40", 
            authDomain: "myflightlog-1f4cb.firebaseapp.com", 
            projectId: "myflightlog-1f4cb", 
            storageBucket: "myflightlog-1f4cb.firebasestorage.app", 
            messagingSenderId: "181072044112", 
            appId: "1:181072044112:web:ca312da2d4780227cef155" 
        };

        const app = initializeApp(firebaseConfig); 
        const db = getFirestore(app); 
        const auth = getAuth(app); 
        
        let currentUser = null;
        let allRecords = [];
        let calendarData = {};
        let currentModalDate = '';

        // === 2025 æœºé•¿å¹´è–ªåˆ¶å‚æ•° ===
        const FIXED_NET = 96080.65;
        const FIXED_GROSS = 101740.00;
        const SOCIAL = 5217.09;
        const HOLIDAY_RATE = 7262; 
        
        const RATES = {
            "æœºé•¿": { 
                hk: {s:640, u:460}, asia: {s:640, u:480}, out: {s:720, u:480},
                n1:80, n2:200, spec:1000,
                stay: {d:500, dn:200, i:900, in:400}
            },
            "æ•™å‘˜": { 
                hk: {s:720, u:518}, asia: {s:720, u:540}, out: {s:810, u:540},
                n1:80, n2:200, spec:1000,
                stay: {d:500, dn:200, i:900, in:400}
            }
        };

        const TAX_TABLE = [
            { l: 36000, r: 0.03, q: 0 },
            { l: 144000, r: 0.10, q: 2520 },
            { l: 300000, r: 0.20, q: 16920 },
            { l: 420000, r: 0.25, q: 31920 },
            { l: 660000, r: 0.30, q: 52920 },
            { l: 960000, r: 0.35, q: 85920 },
            { l: Infinity, r: 0.45, q: 181920 }
        ];

        function calcTax(amount) {
            for(let t of TAX_TABLE) if(amount <= t.l) return amount * t.r - t.q;
            return amount * 0.45 - 181920;
        }

        window.loginWithGoogle = () => signInWithPopup(auth, new GoogleAuthProvider());
        window.doLogout = () => signOut(auth).then(()=>location.reload());

        onAuthStateChanged(auth, u => {
            if(u) {
                currentUser = u;
                document.getElementById('loginScreen').style.display='none';
                document.getElementById('app').style.display='block';
                document.getElementById('reportMonth').value = new Date().toISOString().slice(0,7);
                document.getElementById('apiKey').value = localStorage.getItem('ai_key')||'';
                ['set_rank','set_icao','set_cum_income','set_cum_tax'].forEach(k => {
                    if(localStorage.getItem(k)) document.getElementById(k).value = localStorage.getItem(k);
                });
                onSnapshot(query(collection(db, `users/${u.uid}/logs`), orderBy("date","desc")), s => {
                    allRecords = s.docs.map(d=>({id:d.id, ...d.data()}));
                    refreshAll();
                });
                onSnapshot(collection(db, `users/${u.uid}/cal_status`), s => {
                    calendarData = {}; s.docs.forEach(d=>calendarData[d.id]=d.data());
                    refreshAll();
                });
            } else {
                document.getElementById('loginScreen').style.display='flex';
            }
        });

        window.saveSettings = () => {
            ['set_rank','set_icao','set_cum_income','set_cum_tax'].forEach(k => {
                localStorage.setItem(k, document.getElementById(k).value);
            });
            document.getElementById('settingsModal').style.display='none';
            refreshAll();
        };

        window.refreshAll = () => {
            renderSalary();
            renderReport();
            renderCalendar();
            renderList();
        };

        function renderSalary() {
            const mStr = document.getElementById('reportMonth').value;
            const rank = document.getElementById('set_rank').value || 'æœºé•¿';
            const signed = document.getElementById('set_icao').value === 'signed';
            const rate = RATES[rank] || RATES['æœºé•¿'];
            
            const data = allRecords.filter(r => r.date.startsWith(mStr));
            let stats = { hk_h:0, asia_h:0, out_h:0, hk_b:0, asia_b:0, out_b:0, hol:0, n1:0, n2:0, spec:0, meal:0 };
            
            data.forEach(r => {
                if(r.category === 'æ¸¯æ¾³å°') { stats.hk_h += r.air_time||0; stats.hk_b += r.block_days||0; }
                else if(r.category === 'äºšæ´²å›½é™…') { stats.asia_h += r.air_time||0; stats.asia_b += r.block_days||0; }
                else if(r.category === 'æ´²é™…') { stats.out_h += r.air_time||0; stats.out_b += r.block_days||0; }
                stats.hol += r.holiday||0;
                stats.n1 += r.night1||0; stats.n2 += r.night2||0;
                stats.spec += r.special||0;
                stats.meal += (r.meal_d||0)*60 + (r.meal_i||0)*180;
            });

            let stay = { d:0, dn:0, i:0, in:0 };
            const [y,m] = mStr.split('-').map(Number);
            const daysInMonth = new Date(y, m, 0).getDate();
            
            for(let d=1; d<=daysInMonth; d++) {
                const dStr = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                let type = null;
                if(calendarData[dStr] && calendarData[dStr].type) type = calendarData[dStr].type;
                if(type==='å›½å†…æœ‰è¿‡å¤œ') stay.d++;
                else if(type==='å›½å†…æ— è¿‡å¤œ') stay.dn++;
                else if(type==='å›½é™…æœ‰è¿‡å¤œ') stay.i++;
                else if(type==='å›½é™…æ— è¿‡å¤œ') stay.in++;
            }

            let rows = '';
            const fmt = n => n.toLocaleString('zh-CN', {style:'currency', currency:'CNY'});
            
            rows += `<tr><td class="col-name">å›ºå®šå·¥èµ„</td><td class="col-proc">å«å›½å†…é£/ç¨/ç¤¾ä¿</td><td class="col-amt">${fmt(FIXED_NET)}</td></tr>`;

            let gross_var = 0;
            const r_hk = signed ? rate.hk.s : rate.hk.u;
            const r_asia = signed ? rate.asia.s : rate.asia.u;
            const r_out = signed ? rate.out.s : rate.out.u;

            if(stats.hk_h > 0) {
                const amt = stats.hk_h * r_hk; gross_var += amt;
                rows += `<tr><td class="col-name">æ¸¯æ¾³å°ç©ºæ—¶</td><td class="col-proc"><span class="proc-tag">${stats.hk_h.toFixed(1)}h</span><span class="proc-op">Ã—</span>${r_hk}</td><td class="col-amt">${fmt(amt)}</td></tr>`;
            }
            if(stats.asia_h > 0) {
                const amt = stats.asia_h * r_asia; gross_var += amt;
                rows += `<tr><td class="col-name">äºšæ´²ç©ºæ—¶</td><td class="col-proc"><span class="proc-tag">${stats.asia_h.toFixed(1)}h</span><span class="proc-op">Ã—</span>${r_asia}</td><td class="col-amt">${fmt(amt)}</td></tr>`;
            }
            if(stats.out_h > 0) {
                const amt = stats.out_h * r_out; gross_var += amt;
                rows += `<tr><td class="col-name">æ´²é™…ç©ºæ—¶</td><td class="col-proc"><span class="proc-tag">${stats.out_h.toFixed(1)}h</span><span class="proc-op">Ã—</span>${r_out}</td><td class="col-amt">${fmt(amt)}</td></tr>`;
            }

            if(stats.hk_b > 0) {
                const amt = stats.hk_b * r_hk * 0.6; gross_var += amt;
                rows += `<tr><td class="col-name">æ¸¯æ¾³å°æ»‘è¡Œ</td><td class="col-proc"><span class="proc-tag">${stats.hk_b}å¤©</span>Ã— ${r_hk} Ã— 0.6</td><td class="col-amt">${fmt(amt)}</td></tr>`;
            }
            if(stats.asia_b > 0) {
                const amt = stats.asia_b * r_asia * 0.6; gross_var += amt;
                rows += `<tr><td class="col-name">äºšæ´²æ»‘è¡Œ</td><td class="col-proc"><span class="proc-tag">${stats.asia_b}å¤©</span>Ã— ${r_asia} Ã— 0.6</td><td class="col-amt">${fmt(amt)}</td></tr>`;
            }
            if(stats.out_b > 0) {
                const amt = stats.out_b * r_out * 0.6; gross_var += amt;
                rows += `<tr><td class="col-name">æ´²é™…æ»‘è¡Œ</td><td class="col-proc"><span class="proc-tag">${stats.out_b}å¤©</span>Ã— ${r_out} Ã— 0.6</td><td class="col-amt">${fmt(amt)}</td></tr>`;
            }

            if(stats.hol > 0) {
                const amt = stats.hol * HOLIDAY_RATE; gross_var += amt;
                rows += `<tr><td class="col-name">èŠ‚å‡æ—¥åŠ ç­</td><td class="col-proc"><span class="proc-tag">${stats.hol}å¤©</span>Ã— ${HOLIDAY_RATE}</td><td class="col-amt">${fmt(amt)}</td></tr>`;
            }
            if(stats.n1>0) { const amt = stats.n1*rate.n1; gross_var+=amt; rows+=`<tr><td class="col-name">å¤œèˆª(å‰)</td><td class="col-proc">${stats.n1}h Ã— ${rate.n1}</td><td class="col-amt">${fmt(amt)}</td></tr>`; }
            if(stats.n2>0) { const amt = stats.n2*rate.n2; gross_var+=amt; rows+=`<tr><td class="col-name">å¤œèˆª(å)</td><td class="col-proc">${stats.n2}h Ã— ${rate.n2}</td><td class="col-amt">${fmt(amt)}</td></tr>`; }
            if(stats.spec>0) { const amt = stats.spec*rate.spec; gross_var+=amt; rows+=`<tr><td class="col-name">ç‰¹æ®Šæœºåœº</td><td class="col-proc">${stats.spec}æ¬¡ Ã— ${rate.spec}</td><td class="col-amt">${fmt(amt)}</td></tr>`; }

            const sub_stay = (stay.d*rate.stay.d) + (stay.dn*rate.stay.dn) + (stay.i*rate.stay.i) + (stay.in*rate.stay.in);
            const total_allow = stats.meal + sub_stay;
            
            if(total_allow > 0) {
                let p = `é¤è¡¥: ${stats.meal}`;
                if(sub_stay>0) p += `, é©»å¤–: ${sub_stay}`;
                rows += `<tr><td class="col-name val-green">å…ç¨è¡¥åŠ©</td><td class="col-proc">${p}</td><td class="col-amt val-green">+${fmt(total_allow)}</td></tr>`;
            }

            const cumInc = parseFloat(document.getElementById('set_cum_income').value)||942692;
            const cumTax = parseFloat(document.getElementById('set_cum_tax').value)||244022;
            
            const monthBaseTaxable = FIXED_GROSS - SOCIAL - 5000;
            const newTotalInc = cumInc + monthBaseTaxable + gross_var;
            const totalTaxNeeded = calcTax(newTotalInc);
            const monthTotalTax = totalTaxNeeded - cumTax;
            const baseTotalInc = cumInc + monthBaseTaxable;
            const compTax = calcTax(baseTotalInc) - cumTax;
            
            let selfTax = monthTotalTax - compTax;
            if(selfTax < 0) selfTax = 0;

            const curRate = newTotalInc>960000?0.45 : (newTotalInc>660000?0.35 : 0.30);
            
            if(selfTax > 0) {
                const normTax = gross_var * curRate;
                const catchUp = selfTax - normTax;
                let desc = `å˜åŠ¨ Ã— ${(curRate*100).toFixed(0)}% + è·¨æ¡£è¡¥ç¨`;
                if(catchUp > 50) desc += `<br><span class="tax-highlight">è¡¥ç¨ Â¥${catchUp.toFixed(0)}</span>`;
                
                rows += `<tr><td class="col-name val-red">ä¸ªäººæ‰¿æ‹…ä¸ªç¨</td><td class="col-proc">${desc}</td><td class="col-amt val-red">-${fmt(selfTax)}</td></tr>`;
            }

            document.getElementById('salaryBody').innerHTML = rows;
            const netVar = gross_var - selfTax;
            const final = FIXED_NET + total_allow + netVar;
            
            document.getElementById('disp_var_net').innerText = fmt(netVar);
            document.getElementById('disp_allow_net').innerText = fmt(total_allow);
            document.getElementById('disp_total_net').innerText = fmt(final);
            
            const badge = document.getElementById('taxBadge');
            badge.innerText = `ç´¯è®¡ç¨ç‡ ${(curRate*100).toFixed(0)}%`;
            badge.style.background = curRate>=0.45 ? '#fee2e2' : '#f3e8ff';
            badge.style.color = curRate>=0.45 ? '#b91c1c' : '#7e22ce';
        }

        function renderCalendar() {
            const el = document.getElementById('calendarGrid'); el.innerHTML = '';
            const mStr = document.getElementById('reportMonth').value;
            const [y,m] = mStr.split('-').map(Number);
            const days = new Date(y, m, 0).getDate();
            const first = new Date(y, m-1, 1).getDay();
            for(let i=0; i<first; i++) el.innerHTML+=`<div></div>`;
            for(let d=1; d<=days; d++) {
                const date = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const st = calendarData[date] || {};
                const flights = allRecords.filter(r => r.date === date);
                let dot = '';
                flights.forEach(f => {
                    const cls = (f.category.includes('å›½é™…')||f.category.includes('æ´²é™…')) ? 'dot-int' : 'dot-dom';
                    dot += `<div class="flight-dot ${cls}">${f.dep}-${f.arr}</div>`;
                });
                let stCls = '';
                if(st.type==='å›½å†…æœ‰è¿‡å¤œ') stCls='st-dom-stay';
                else if(st.type==='å›½å†…æ— è¿‡å¤œ') stCls='st-dom-no';
                else if(st.type==='å›½é™…æœ‰è¿‡å¤œ') stCls='st-int-stay';
                else if(st.type==='å›½é™…æ— è¿‡å¤œ') stCls='st-int-no';
                const nightIcon = st.night_ac ? `<div class="night-badge">ğŸŒ™${st.night_ac}</div>` : '';
                const cell = document.createElement('div');
                cell.className = `cal-day ${date===new Date().toISOString().slice(0,10)?'today':''}`;
                cell.onclick = () => openCalModal(date);
                cell.innerHTML = `<div class="cal-num"><span>${d}</span></div>${nightIcon}<div style="flex:1">${dot}</div><div class="status-badge ${stCls}">${st.city||st.type||''}</div>`;
                el.appendChild(cell);
            }
        }

        window.openCalModal = (date) => {
            currentModalDate = date;
            document.getElementById('modalDateStr').innerText = date;
            document.getElementById('modalCity').value = (calendarData[date]?.city) || '';
            document.getElementById('statusModal').style.display='flex';
        };

        window.saveCalStatus = (type) => {
            if(!currentUser) return;
            const city = document.getElementById('modalCity').value;
            setDoc(doc(db, `users/${currentUser.uid}/cal_status`, currentModalDate), 
                { type: type, city: city }, { merge: true }
            ).then(() => document.getElementById('statusModal').style.display='none');
        };

        window.saveNightStatus = (ac) => {
            if(!currentUser) return;
            setDoc(doc(db, `users/${currentUser.uid}/cal_status`, currentModalDate), 
                { night_ac: ac }, { merge: true }
            ).then(() => document.getElementById('statusModal').style.display='none');
        };

        window.processAI = async () => {
            const txt = document.getElementById('aiInput').value;
            const key = document.getElementById('apiKey').value;
            if(!txt || !key) return alert('è¯·è¾“å…¥å†…å®¹å’ŒKey');
            localStorage.setItem('ai_key', key);
            document.getElementById('aiBtn').disabled=true;
            document.getElementById('aiLoader').style.display='flex';
            try {
                const prompt = `è§£æé£è¡Œã€‚è§„åˆ™:å›½å†…cat=å›½å†…ã€‚block_daysé»˜è®¤ä¸º1ã€‚èŠ‚å‡æ—¥éœ€è¯†åˆ«holiday(å¤©æ•°)ã€‚å­—æ®µ:date, dep, arr, cat(å›½å†…/æ¸¯æ¾³å°/äºšæ´²å›½é™…/æ´²é™…), air, block_days, hol, n1, n2, spec, meal_d, meal_i, over_type, over_days.`;
                const res = await fetch("https://api.deepseek.com/chat/completions", {
                    method:"POST", headers:{"Content-Type":"application/json","Authorization":`Bearer ${key}`},
                    body:JSON.stringify({model:"deepseek-chat", messages:[{role:"system",content:prompt},{role:"user",content:txt}], response_format:{type:"json_object"}})
                });
                
                if (!res.ok) throw new Error((await res.json()).error?.message || "API Error");
                const json = await res.json();
                if (!json.choices || !json.choices[0]) throw new Error("Empty AI Response");
                
                const data = JSON.parse(json.choices[0].message.content);
                document.getElementById('editForm').style.display='block';
                for(let k in data) {
                    const id = 'f_'+k.replace('cat','cat').replace('air','air').replace('block_days','block').replace('hol','hol').replace('over_type','over_type').replace('over_days','over_days').replace('meal_d','meal_d').replace('meal_i','meal_i').replace('n1','n1').replace('n2','n2').replace('spec','spec');
                    const el = document.getElementById(id);
                    if(el) el.value = data[k];
                }
                if(data.date) document.getElementById('f_date').value = data.date;
            } catch(e) { alert('è¯†åˆ«å¤±è´¥: '+e.message); }
            document.getElementById('aiBtn').disabled=false;
            document.getElementById('aiLoader').style.display='none';
        };

        window.saveRecord = () => {
            const getVal = id => document.getElementById(id).value;
            const getNum = id => parseFloat(getVal(id))||0;
            const rec = {
                date: getVal('f_date'), category: getVal('f_cat'),
                dep: getVal('f_dep'), arr: getVal('f_arr'),
                air_time: getNum('f_air'), block_days: getNum('f_block'),
                holiday: getNum('f_hol'), meal_d: getNum('f_meal_d'), meal_i: getNum('f_meal_i'),
                over_days: getNum('f_over_days'), night1: getNum('f_n1'), night2: getNum('f_n2'), special: getNum('f_spec'),
                created: new Date().toISOString()
            };
            addDoc(collection(db, `users/${currentUser.uid}/logs`), rec).then(()=>{
                document.getElementById('editForm').style.display='none';
                document.getElementById('aiInput').value='';
            });
        };

        window.renderReport = () => {
            const mStr = document.getElementById('reportMonth').value;
            const data = allRecords.filter(r => r.date.startsWith(mStr));
            let s = { dh:0, db:0, ih:0, ib:0, hol:0, meal:0 };
            data.forEach(r => {
                if(r.category==='å›½å†…') { s.dh+=r.air_time; s.db+=r.block_days; }
                else { s.ih+=r.air_time; s.ib+=r.block_days; }
                s.hol+=r.holiday; s.meal+=(r.meal_d+r.meal_i);
            });
            document.getElementById('reportTable').innerHTML = `
                <tr><th>ç±»åˆ«</th><th>ç©ºæ—¶</th><th>æ»‘è¡Œå¤©</th></tr>
                <tr><td>å›½å†…</td><td>${s.dh.toFixed(1)}</td><td>${s.db}</td></tr>
                <tr><td>å›½é™…</td><td>${s.ih.toFixed(1)}</td><td>${s.ib}</td></tr>
                <tr><td colspan="3" style="text-align:right; font-size:0.75rem; color:#64748b">èŠ‚å‡æ—¥:${s.hol}å¤© | é¤è¡¥:${s.meal}ä»½</td></tr>
            `;
        };

        window.renderList = () => {
            const list = document.getElementById('logList'); list.innerHTML='';
            const mStr = document.getElementById('reportMonth').value;
            const data = allRecords.filter(r => r.date.startsWith(mStr)).sort((a,b)=>b.date.localeCompare(a.date));
            data.forEach(r => {
                const div = document.createElement('div'); div.className='log-item';
                div.innerHTML = `
                    <div>
                        <span class="log-date">${r.date.slice(5)}</span>
                        <span style="font-weight:bold; font-size:0.85rem">${r.dep}-${r.arr}</span>
                        <div class="log-details">${r.category} Â· ${r.air_time}h Â· æ»‘${r.block_days}</div>
                    </div>
                    <div><button onclick="delLog('${r.id}')" style="color:#ef4444; border:none; background:none; font-weight:bold;">Ã—</button></div>
                `;
                list.appendChild(div);
            });
        };
        
        window.delLog = (id) => { if(confirm('åˆ é™¤?')) deleteDoc(doc(db, `users/${currentUser.uid}/logs`, id)); };
        window.recalcTimes = () => {}; 
    </script>
</body>
</html>
