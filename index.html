<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£è¡Œæ—¥å¿— Pro - 2025 å¢å¼ºç‰ˆ</title>
    <style>
        /* === åŸºç¡€å˜é‡ === */
        :root {
            --primary: #2563eb; --primary-dark: #1e40af;
            --bg: #f8fafc; --text: #334155; --border: #e2e8f0;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg); color: var(--text);
            padding: 10px; min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; padding-bottom: 40px; }

        /* é€šç”¨ç»„ä»¶ */
        .card {
            background: white; border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid var(--border); overflow: hidden;
        }
        .card-header {
            padding: 15px 20px; background: #fff; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;
        }
        .card-header h2 { font-size: 1.1rem; color: #0f172a; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .card-body { padding: 20px; }
        
        /* é¡¶éƒ¨æ  */
        .top-bar {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; padding: 16px 24px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }
        .user-pill { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; }

        /* æŠ¥è¡¨è¡¨æ ¼ */
        .table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); }
        .excel-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 800px; }
        .excel-table th, .excel-table td { border: 1px solid var(--border); padding: 10px 8px; text-align: center; }
        .excel-table th { background: #f1f5f9; font-weight: 600; color: #475569; }
        .bg-sub { background-color: #fdf4ff; color: #86198f; font-weight: bold; }

        /* AI è¾“å…¥åŒº */
        .ai-box { position: relative; border: 2px dashed var(--border); border-radius: 12px; padding: 10px; background: #f8fafc; transition: 0.2s; }
        .ai-box:focus-within { border-color: var(--primary); background: #eff6ff; }
        .key-input { 
            position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.95);
            padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); font-size: 0.75rem; width: 180px;
        }
        textarea {
            width: 100%; height: 100px; padding: 15px; border: none; background: transparent;
            font-family: monospace; font-size: 0.95rem; resize: none; outline: none;
        }

        /* è¡¨å• */
        .edit-form { background: #fff; padding: 20px; border-radius: 12px; margin-top: 20px; border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .form-full { grid-column: 1 / -1; }
        .form-group label { display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select { 
            width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px; 
            font-size: 0.9rem; outline: none; transition: 0.2s;
        }
        .form-group input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37,99,235,0.1); }
        
        /* === å¢å¼ºæ—¥å† === */
        .calendar-wrapper { user-select: none; }
        .calendar-header { 
            display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; 
            font-size: 0.8rem; color: #94a3b8; font-weight: 600; padding: 10px 0;
        }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .cal-day {
            background: #fff; border: 1px solid var(--border); border-radius: 8px; min-height: 90px;
            padding: 4px; display: flex; flex-direction: column; position: relative; cursor: pointer;
            transition: all 0.2s ease;
        }
        .cal-day:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); z-index: 10; }
        .cal-day.today { border: 2px solid var(--primary); background: #eff6ff; }
        
        .cal-num { 
            font-size: 0.85rem; font-weight: 700; color: #cbd5e1; margin-left: 4px; 
            display: flex; justify-content: space-between; 
        }
        .cal-day.today .cal-num { color: var(--primary); }
        
        /* é£è¡Œæ¡ç›® */
        .cal-flights { flex: 1; display: flex; flex-direction: column; gap: 3px; margin: 4px 0; overflow: hidden; }
        .flight-tag {
            padding: 2px 5px; border-radius: 4px; font-size: 0.65rem; color: #fff;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); white-space: nowrap;
        }
        .tag-dom { background: #3b82f6; } /* å›½å†…è“ */
        .tag-int { background: #8b5cf6; } /* å›½é™…ç´« */
        
        .cal-status { 
            font-size: 0.7rem; padding: 2px; border-radius: 4px; text-align: center; 
            margin-top: auto; font-weight: 600; color: #64748b; background: #f1f5f9;
        }
        .status-stay { background: #fffbeb; color: #d97706; border: 1px solid #fcd34d; }

        /* åˆ—è¡¨ä¸æŒ‰é’® */
        .log-list { max-height: 400px; overflow-y: auto; padding-right: 5px; }
        .log-item { 
            background: #fff; border: 1px solid var(--border); border-radius: 8px; 
            padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
        }
        .btn { 
            padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; 
            font-weight: 600; font-size: 0.9rem; transition: 0.2s; display: inline-flex; align-items: center; gap: 6px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-danger { background: #fee2e2; color: #ef4444; padding: 6px 10px; font-size: 0.8rem; }
        .btn-ghost { background: transparent; color: #64748b; }
        
        /* ç™»å½•é®ç½© */
        .login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #3b82f6 0%, #1e3a8a 100%);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .login-card { background: white; padding: 40px; border-radius: 24px; width: 90%; max-width: 360px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); }

        @media (max-width: 600px) {
            .calendar-grid { gap: 3px; }
            .cal-day { min-height: 70px; font-size: 0.7rem; }
            .flight-tag span:last-child { display: none; } /* æ‰‹æœºç«¯éšè—å°æ—¶æ•° */
        }
    </style>
</head>
<body>

    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div style="font-size: 3rem; margin-bottom: 10px;">âœˆï¸</div>
            <h2 style="color: #1e40af; margin-bottom: 10px;">é£è¡Œå‘˜æ—¥å¿— Pro</h2>
            <p style="color: #64748b; margin-bottom: 30px; font-size: 0.9rem;">æ™ºèƒ½è¯†åˆ« Â· è–ªé…¬ç»Ÿè®¡ Â· æ‰§å‹¤ç®¡ç†</p>
            <button class="btn btn-primary" style="width: 100%; justify-content: center; padding: 12px;" onclick="loginWithGoogle()">
                <svg width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35 11.1h-9.17v2.73h6.51c-.33 3.81-3.5 5.44-6.5 5.44C8.36 19.27 5 16.25 5 12c0-4.1 3.2-7.27 7.2-7.27c3.09 0 4.9 1.97 4.9 1.97L19 4.72S16.56 2 12.1 2C6.42 2 2.03 6.8 2.03 12c0 5.05 4.13 10 10.22 10c5.35 0 9.25-3.67 9.25-9.09c0-1.15-.15-1.81-.15-1.81Z"/></svg>
                Google è´¦å·ç™»å½•
            </button>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ -->
    <div id="app" class="container" style="display: none;">
        <div class="top-bar">
            <div>
                <h1 style="font-size: 1.2rem; font-weight: 700;">æ§åˆ¶å°</h1>
                <div id="userInfo" class="user-pill">æœªç™»å½•</div>
            </div>
            <button class="btn btn-ghost" style="color: rgba(255,255,255,0.8); border: 1px solid rgba(255,255,255,0.3);" onclick="doLogout()">é€€å‡º</button>
        </div>

        <!-- 1. ç»Ÿè®¡æŠ¥è¡¨ -->
        <section class="card">
            <div class="card-header">
                <h2>ğŸ“Š æœˆåº¦ç»Ÿè®¡</h2>
                <input type="month" id="reportMonth" onchange="refreshAll()" style="border: 1px solid var(--border); padding: 6px; border-radius: 6px; outline:none;">
            </div>
            <div class="card-body">
                <div class="table-wrapper">
                    <table class="excel-table" id="reportTable">
                        <!-- JS å¡«å…… -->
                    </table>
                </div>
            </div>
        </section>

        <!-- 2. æ™ºèƒ½å½•å…¥ -->
        <section class="card">
            <div class="card-header">
                <h2>ğŸ“ æ™ºèƒ½å½•å…¥</h2>
                <button class="btn btn-primary" id="aiBtn" onclick="processAI()">âœ¨ AI è¯†åˆ« & è®¡ç®—</button>
            </div>
            <div class="card-body">
                <div class="ai-box">
                    <input type="password" id="innerApiKey" class="key-input" placeholder="è¾“å…¥ DeepSeek Key è‡ªåŠ¨ä¿å­˜">
                    <textarea id="ocrInput" placeholder="åœ¨æ­¤ç²˜è´´é£è¡Œä»»åŠ¡...&#10;ä¾‹ï¼š5æœˆ20æ—¥ CA1234 åŒ—äº¬-ä¸Šæµ· 10:00æ’¤è½®æŒ¡ 12:00æŒ¡è½®æŒ¡ é©»å¤–2å¤©&#10;ä¾‹ï¼š7,8,9å· ä¼‘å‡"></textarea>
                </div>

                <!-- ç¼–è¾‘è¡¨å• (é»˜è®¤éšè—) -->
                <div id="editForm" class="edit-form" style="display: none;">
                    <h3 style="margin-bottom: 15px; color: var(--primary);">âœï¸ ç¼–è¾‘/ç¡®è®¤æ•°æ®</h3>
                    <div class="form-grid">
                        <div class="form-group"><label>æ—¥æœŸ (è½åœ°)</label><input type="date" id="f_date"></div>
                        <div class="form-group"><label>èµ·é£åœ°</label><input type="text" id="f_dep"></div>
                        <div class="form-group"><label>è½åœ°åœ°</label><input type="text" id="f_arr"></div>
                        <div class="form-group"><label>åŒºåŸŸå±æ€§</label>
                            <select id="f_cat"><option value="å›½å†…">å›½å†…</option><option value="æ¸¯æ¾³å°">æ¸¯æ¾³å°</option><option value="äºšæ´²å›½é™…">äºšæ´²å›½é™…</option><option value="æ´²é™…">æ´²é™…</option></select>
                        </div>
                        <div class="form-group form-full"><label>æœºç»„åå•</label><input type="text" id="f_crew" placeholder="æœºé•¿/å‰¯é©¾/å­¦å‘˜"></div>

                        <!-- æ—¶åˆ»è®¡ç®—åŒº -->
                        <div class="form-full" style="background: #f1f5f9; padding: 15px; border-radius: 8px;">
                            <label style="margin-bottom: 10px; display:block; text-align:center; color:#475569">â±ï¸ è¿è¡Œæ—¶åˆ» (è‡ªåŠ¨è®¡ç®—æ—¶é•¿)</label>
                            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap:10px;">
                                <div class="form-group"><label>æ’¤è½®æŒ¡</label><input type="time" id="f_block_off" onchange="recalcTimes()"></div>
                                <div class="form-group"><label>èµ·é£</label><input type="time" id="f_takeoff" onchange="recalcTimes()"></div>
                                <div class="form-group"><label>è½åœ°</label><input type="time" id="f_landing" onchange="recalcTimes()"></div>
                                <div class="form-group"><label>æŒ¡è½®æŒ¡</label><input type="time" id="f_block_on" onchange="recalcTimes()"></div>
                            </div>
                        </div>

                        <div class="form-group"><label>ç©ºä¸­æ—¶é—´ (h)</label><input type="number" step="0.01" id="f_air"></div>
                        <div class="form-group"><label>æ€»æ—¶é—´ (h)</label><input type="number" step="0.01" id="f_total_time"></div>
                        
                        <div class="form-group"><label>å¤œèˆª 18:30+</label><input type="number" step="0.1" id="f_night1"></div>
                        <div class="form-group"><label>å¤œèˆª 00:00+</label><input type="number" step="0.1" id="f_night2"></div>
                        
                        <div class="form-group"><label>é©»å¤–ç±»å‹</label>
                            <select id="f_overnight">
                                <option value="æ— ">æ— </option>
                                <option value="å›½å†…æ— è¿‡å¤œ">å›½å†…æ— è¿‡å¤œ</option><option value="å›½å†…æœ‰è¿‡å¤œ">å›½å†…æœ‰è¿‡å¤œ</option>
                                <option value="å›½é™…æ— è¿‡å¤œ">å›½é™…æ— è¿‡å¤œ</option><option value="å›½é™…æœ‰è¿‡å¤œ">å›½é™…æœ‰è¿‡å¤œ</option>
                            </select>
                        </div>
                        <div class="form-group"><label>é©»å¤–åŸå¸‚</label><input type="text" id="f_overnight_city"></div>
                        <div class="form-group"><label>é©»å¤–å¤©æ•° (å‰æ¨)</label><input type="number" id="f_overnight_days" value="0"></div>
                        
                        <div class="form-group"><label>ç‰¹æ®Šæœºåœº(ä¸ª)</label><input type="number" id="f_special" value="0"></div>
                        <div class="form-group"><label>èŠ‚å‡æ—¥(ä¸ª)</label><input type="number" id="f_holiday" value="0"></div>
                        <div class="form-group"><label>æ»‘è¡Œ(æ¬¡)</label><input type="number" id="f_block_days" value="1"></div>
                    </div>
                    <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                        <button class="btn btn-ghost" onclick="document.getElementById('editForm').style.display='none'">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="saveRecord()">ğŸ’¾ ç¡®è®¤ä¿å­˜</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. æ‰§å‹¤æ—¥å† -->
        <section class="card">
            <div class="card-header">
                <h2>ğŸ“… æ‰§å‹¤æ—¥å†</h2>
                <span id="calTotal" style="font-size: 0.8rem; color: #64748b; font-weight: normal;"></span>
            </div>
            <div class="card-body calendar-wrapper">
                <div class="calendar-header">
                    <div>å‘¨æ—¥</div><div>å‘¨ä¸€</div><div>å‘¨äºŒ</div><div>å‘¨ä¸‰</div><div>å‘¨å››</div><div>å‘¨äº”</div><div>å‘¨å…­</div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
        </section>

        <!-- 4. å†å²è®°å½• -->
        <section class="card">
            <div class="card-header"><h2>ğŸ“‹ å†å²æ˜ç»†</h2></div>
            <div class="card-body">
                <div id="logList" class="log-list"></div>
            </div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // é…ç½®ä¿æŒä¸å˜
        const firebaseConfig = {
            apiKey: "AIzaSyCFk4f7bKUHlb3d1Cg1jyS1EM-SPC4pr40",
            authDomain: "myflightlog-1f4cb.firebaseapp.com",
            projectId: "myflightlog-1f4cb",
            storageBucket: "myflightlog-1f4cb.firebasestorage.app",
            messagingSenderId: "181072044112",
            appId: "1:181072044112:web:ca312da2d4780227cef155"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        let currentUser = null;
        let allRecords = [];
        let calendarData = {};

        // === è®¤è¯é€»è¾‘ ===
        window.loginWithGoogle = async () => { 
            try { await signInWithPopup(auth, provider); } 
            catch (e) { alert("ç™»å½•å¤±è´¥: " + e.message); } 
        };
        window.doLogout = async () => { await signOut(auth); };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userInfo').textContent = `ğŸ‘¨â€âœˆï¸ ${user.displayName}`;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                
                // é»˜è®¤é€‰ä¸­æœ¬æœˆ
                const now = new Date();
                document.getElementById('reportMonth').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                
                // æ¢å¤ API Key
                if(localStorage.getItem("openai_key")) document.getElementById("innerApiKey").value = localStorage.getItem("openai_key");

                // ç›‘å¬æ—¥å¿—æ•°æ®
                onSnapshot(query(collection(db, `users/${user.uid}/logs`), orderBy("date", "desc")), (snap) => {
                    allRecords = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    refreshAll();
                });
                
                // ç›‘å¬æ—¥å†çŠ¶æ€
                onSnapshot(collection(db, `users/${user.uid}/calendar_status`), (snap) => {
                    calendarData = {};
                    snap.docs.forEach(d => calendarData[d.id] = d.data().status);
                    renderCalendar();
                });
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
        });

        window.refreshAll = () => {
            renderList();
            renderReport();
            renderCalendar();
        };

        // === å·¥å…·å‡½æ•°ï¼šæ—¶é—´è®¡ç®— (å«è·¨æ—¥æ”¯æŒ) ===
        function calculateDuration(start, end) {
            if(!start || !end) return 0;
            let [h1, m1] = start.split(':').map(Number);
            let [h2, m2] = end.split(':').map(Number);
            let min1 = h1 * 60 + m1;
            let min2 = h2 * 60 + m2;
            
            // å¦‚æœç»“æŸæ—¶é—´å°äºå¼€å§‹æ—¶é—´ï¼Œå‡è®¾è·¨å¤©ï¼ˆ+24å°æ—¶ï¼‰
            if (min2 < min1) min2 += 24 * 60;
            
            return Number(((min2 - min1) / 60).toFixed(2));
        }

        window.recalcTimes = () => {
            const getVal = id => document.getElementById(id).value;
            const air = calculateDuration(getVal('f_takeoff'), getVal('f_landing'));
            const total = calculateDuration(getVal('f_block_off'), getVal('f_block_on'));
            
            document.getElementById('f_air').value = air > 0 ? air : '';
            document.getElementById('f_total_time').value = total > 0 ? total : '';
        };

        // === AI æ ¸å¿ƒé€»è¾‘ ===
        window.processAI = async () => {
            const text = document.getElementById('ocrInput').value.trim();
            const apiKey = document.getElementById('innerApiKey').value.trim();
            
            if (!text) return alert("è¯·å…ˆè¾“å…¥å†…å®¹");
            if (!apiKey) return alert("è¯·è¾“å…¥ DeepSeek API Key");
            localStorage.setItem("openai_key", apiKey);

            const btn = document.getElementById('aiBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = "â³ AI æ­£åœ¨æ€è€ƒ..."; btn.disabled = true;

            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªé£è¡Œæ—¥å¿—åŠ©æ‰‹ã€‚è¯·æå–ç”¨æˆ·è¾“å…¥ä¸­çš„ä¿¡æ¯å¹¶è¿”å›çº¯ JSONã€‚
            1. å¦‚æœæ˜¯ä¿®æ”¹çŠ¶æ€ï¼ˆå¦‚ï¼š7,8å· æ²ˆé˜³ï¼‰ï¼Œè¿”å› {"type":"calendar", "dates":["2025-XX-XX"], "status":"æ²ˆé˜³"}ï¼Œå¹´ä»½é»˜è®¤ä¸º2025å¹´ã€‚
            2. å¦‚æœæ˜¯é£è¡Œè®°å½•ï¼Œè¿”å› {"type":"flight", ...å­—æ®µ}ã€‚
            å­—æ®µè¦æ±‚ï¼š
            - date (YYYY-MM-DD), dep (èµ·é£åŸå¸‚), arr (è½åœ°åŸå¸‚)
            - category (å›½å†…/æ¸¯æ¾³å°/äºšæ´²å›½é™…/æ´²é™…)
            - crew (å­—ç¬¦ä¸²), time_off, time_takeoff, time_landing, time_on (HH:MMæ ¼å¼)
            - night1 (18:30åè½åœ°æ—¶é—´h), night2 (00:00åè½åœ°æ—¶é—´h)
            - overnight (æ— /å›½å†…æ— è¿‡å¤œ/å›½å†…æœ‰è¿‡å¤œ/å›½é™…æ— è¿‡å¤œ/å›½é™…æœ‰è¿‡å¤œ), overnight_city, overnight_days (int)
            - special_airport (int), holiday (int)
            æ³¨æ„ï¼šä¸è¦è¾“å‡ºMarkdownï¼Œåªè¾“å‡ºJSONå­—ç¬¦ä¸²ã€‚`;

            try {
                const res = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({ 
                        model: "deepseek-chat", 
                        messages: [
                            {role: "system", content: systemPrompt},
                            {role: "user", content: text}
                        ], 
                        temperature: 0.1 
                    })
                });
                
                const data = await res.json();
                if (data.error) throw new Error(data.error.message);

                let content = data.choices[0].message.content;
                // æ¸…æ´— Markdown ä»£ç å—æ ‡è®°
                content = content.replace(/```json/g, '').replace(/```/g, '').trim();
                
                const r = JSON.parse(content);

                if (r.type === 'calendar') {
                    // æ‰¹é‡æ›´æ–°æ—¥å†çŠ¶æ€
                    const batchPromises = r.dates.map(d => 
                        setDoc(doc(db, `users/${currentUser.uid}/calendar_status`, d), { status: r.status })
                    );
                    await Promise.all(batchPromises);
                    alert(`âœ… å·²æ›´æ–° ${r.dates.length} å¤©çŠ¶æ€ä¸ºï¼š${r.status}`);
                    document.getElementById('ocrInput').value = ''; // æ¸…ç©ºè¾“å…¥
                } else {
                    // å¡«å……è¡¨å•
                    const setVal = (id, val) => { 
                        const el = document.getElementById(id); 
                        if(el) el.value = val !== undefined ? val : ''; 
                    };
                    
                    setVal('f_date', r.date); setVal('f_dep', r.dep); setVal('f_arr', r.arr);
                    setVal('f_cat', r.category); setVal('f_crew', r.crew);
                    setVal('f_block_off', r.time_off); setVal('f_takeoff', r.time_takeoff);
                    setVal('f_landing', r.time_landing); setVal('f_block_on', r.time_on);
                    
                    recalcTimes(); // è‡ªåŠ¨è®¡ç®—ä¸€æ¬¡æ—¶é—´
                    
                    setVal('f_night1', r.night1); setVal('f_night2', r.night2);
                    setVal('f_overnight', r.overnight || 'æ— ');
                    setVal('f_overnight_city', r.overnight_city || (r.overnight!=='æ— '?r.dep:''));
                    setVal('f_overnight_days', r.overnight_days);
                    setVal('f_special', r.special_airport); setVal('f_holiday', r.holiday);
                    
                    document.getElementById('editForm').style.display = 'block';
                    document.getElementById('editForm').scrollIntoView({behavior: "smooth"});
                }
            } catch (e) { 
                console.error(e);
                alert("è¯†åˆ«å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Key æˆ–è¾“å…¥æ ¼å¼ã€‚\né”™è¯¯ä¿¡æ¯: " + e.message); 
            } finally { 
                btn.innerHTML = originalText; btn.disabled = false; 
            }
        };

        window.saveRecord = async () => {
            if(!document.getElementById('f_date').value) return alert("è¯·é€‰æ‹©æ—¥æœŸ");
            
            const getNum = (id) => parseFloat(document.getElementById(id).value) || 0;
            const getStr = (id) => document.getElementById(id).value;
            
            let ovCity = getStr('f_overnight_city');
            if(!ovCity && getStr('f_overnight') !== 'æ— ') ovCity = getStr('f_dep'); // é»˜è®¤é©»å¤–åœ°ä¸ºèµ·é£åœ°

            const record = {
                date: getStr('f_date'), 
                dep: getStr('f_dep'), arr: getStr('f_arr'), 
                category: getStr('f_cat'), crew: getStr('f_crew'),
                block_off: getStr('f_block_off'), takeoff: getStr('f_takeoff'), 
                landing: getStr('f_landing'), block_on: getStr('f_block_on'),
                air_time: getNum('f_air'), total_time: getNum('f_total_time'),
                block_days: getNum('f_block_days'), 
                night1: getNum('f_night1'), night2: getNum('f_night2'),
                overnight: getStr('f_overnight'), overnight_city: ovCity, overnight_days: getNum('f_overnight_days'),
                special_airport: getNum('f_special'), holiday: getNum('f_holiday'), 
                timestamp: new Date()
            };

            try {
                await addDoc(collection(db, `users/${currentUser.uid}/logs`), record);
                document.getElementById('editForm').style.display = 'none';
                document.getElementById('ocrInput').value = ''; // æˆåŠŸåæ¸…ç©º
                // ç®€å•çš„ Toast æç¤º
                const btn = document.querySelector('button[onclick="saveRecord()"]');
                const oldTxt = btn.innerText; btn.innerText = "âœ… å·²ä¿å­˜";
                setTimeout(()=>btn.innerText=oldTxt, 2000);
            } catch(e) { alert("ä¿å­˜å¤±è´¥: "+e.message); }
        };

        window.deleteItem = async (id) => { 
            if(confirm("ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) {
                await deleteDoc(doc(db, `users/${currentUser.uid}/logs`, id)); 
            }
        };

        // === æ¸²æŸ“é€»è¾‘ ===
        window.renderCalendar = () => {
            const grid = document.getElementById('calendarGrid'); 
            grid.innerHTML = '';
            
            const [y, m] = document.getElementById('reportMonth').value.split('-').map(Number);
            const daysInMonth = new Date(y, m, 0).getDate();
            const firstDayOfWeek = new Date(y, m - 1, 1).getDay(); // 0 æ˜¯å‘¨æ—¥
            const todayStr = new Date().toISOString().split('T')[0];

            // 1. è‡ªåŠ¨æ¨ç®—é©»å¤–çŠ¶æ€ (æ ¹æ®é£è¡Œè®°å½•çš„å‰æ¨å¤©æ•°)
            let autoCalendar = {};
            allRecords.forEach(r => {
                if (r.overnight !== 'æ— ' && r.overnight_days > 0) {
                    const flightDate = new Date(r.date);
                    for(let i=1; i<=r.overnight_days; i++) {
                        const prevDate = new Date(flightDate);
                        prevDate.setDate(flightDate.getDate() - i);
                        const iso = prevDate.toISOString().split('T')[0];
                        autoCalendar[iso] = r.overnight_city;
                    }
                }
            });

            // è¡¥ç™½
            for(let i=0; i<firstDayOfWeek; i++) {
                grid.innerHTML += `<div class="cal-day" style="background:#f8fafc; border:none;"></div>`;
            }

            // æ¸²æŸ“æ¯ä¸€å¤©
            let totalHours = 0;
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                
                // è·å–å½“å¤©é£è¡Œè®°å½•
                const flights = allRecords.filter(r => r.date === dateStr)
                                .sort((a,b) => (a.block_off||'').localeCompare(b.block_off||''));
                
                flights.forEach(f => totalHours += f.total_time || 0);

                // ç¡®å®šçŠ¶æ€ï¼šæ‰‹åŠ¨çŠ¶æ€ > è‡ªåŠ¨æ¨ç®— > é»˜è®¤æ²ˆé˜³
                let statusText = calendarData[dateStr] || autoCalendar[dateStr] || "æ²ˆé˜³";
                if(['æ²ˆé˜³','SHE','æ— ','åŸºåœ°'].includes(statusText)) statusText = "æ²ˆé˜³";

                const isToday = dateStr === todayStr;
                const cell = document.createElement('div'); 
                cell.className = `cal-day ${isToday ? 'today' : ''}`;
                
                // ç‚¹å‡»ä¿®æ”¹çŠ¶æ€
                cell.onclick = async (e) => {
                    if(e.target.closest('.flight-tag')) return; // é¿å…ç‚¹å‡»é£è¡Œæ¡ç›®è§¦å‘
                    const newStatus = prompt(`ä¿®æ”¹ ${dateStr} æ‰€åœ¨åœ°:`, statusText);
                    if(newStatus && newStatus !== statusText) {
                        await setDoc(doc(db, `users/${currentUser.uid}/calendar_status`, dateStr), {status: newStatus});
                    }
                };

                let flightsHtml = '';
                if(flights.length > 0) {
                    flightsHtml = `<div class="cal-flights">` + 
                    flights.map(f => {
                        const styleClass = (f.category.includes('å›½é™…') || f.category.includes('æ´²é™…')) ? 'tag-int' : 'tag-dom';
                        // ç®€åŒ–èˆªçº¿æ˜¾ç¤ºï¼šPEK-SHA
                        const simpleRoute = `${f.dep.split(' ')[0]}-${f.arr.split(' ')[0]}`; 
                        return `<div class="flight-tag ${styleClass}">
                            <span>${simpleRoute}</span>
                            <span>${f.total_time}h</span>
                        </div>`;
                    }).join('') + `</div>`;
                }

                cell.innerHTML = `
                    <div class="cal-num">
                        ${d} ${isToday ? '<span style="color:var(--primary);font-size:0.6rem">ä»Š</span>' : ''}
                    </div>
                    ${flightsHtml}
                    <div class="cal-status ${statusText!=='æ²ˆé˜³'?'status-stay':''}">${statusText}</div>
                `;
                grid.appendChild(cell);
            }
            
            document.getElementById('calTotal').textContent = `æœ¬æœˆæ€»æ‰§å‹¤: ${totalHours.toFixed(1)} å°æ—¶`;
        };

        window.renderList = () => {
            const listEl = document.getElementById('logList');
            const mStr = document.getElementById('reportMonth').value;
            // ä»…æ˜¾ç¤ºé€‰ä¸­æœˆä»½çš„è®°å½•
            const displayData = allRecords.filter(r => r.date.startsWith(mStr));

            if (displayData.length === 0) {
                listEl.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:20px;">æœ¬æœˆæ— è®°å½•</div>';
                return;
            }

            listEl.innerHTML = displayData.map(r => `
                <div class="log-item">
                    <div>
                        <div style="font-weight:700; color:#1e293b; display:flex; gap:10px; align-items:center;">
                            <span style="font-family:monospace; color:#64748b; background:#f1f5f9; padding:2px 6px; border-radius:4px;">${r.date.substring(5)}</span>
                            ${r.dep} â” ${r.arr}
                        </div>
                        <div style="font-size:0.8rem; color:#64748b; margin-top:4px;">
                            ${r.crew || 'æ— æœºç»„ä¿¡æ¯'} Â· ${r.category} Â· 
                            <span style="color:var(--primary); font-weight:bold;">${r.total_time}h</span>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="deleteItem('${r.id}')">ğŸ—‘ï¸</button>
                </div>
            `).join('');
        };

        window.renderReport = () => {
            const mStr = document.getElementById('reportMonth').value;
            const data = allRecords.filter(r => r.date.startsWith(mStr));
            
            const s = { d_a:0, d_b:0, h_a:0, h_b:0, a_a:0, a_b:0, i_a:0, i_b:0, n1:0, n2:0, spec:0, hol:0, o_d:0, o_i:0 };
            
            data.forEach(r => {
                if(r.category==='å›½å†…') { s.d_a+=r.air_time; s.d_b+=r.block_days; }
                else if(r.category==='æ¸¯æ¾³å°') { s.h_a+=r.air_time; s.h_b+=r.block_days; }
                else if(r.category==='äºšæ´²å›½é™…') { s.a_a+=r.air_time; s.a_b+=r.block_days; }
                else { s.i_a+=r.air_time; s.i_b+=r.block_days; }
                
                s.n1+=r.night1 || 0; 
                s.n2+=r.night2 || 0; 
                s.spec+=r.special_airport || 0; 
                s.hol+=r.holiday || 0;
                
                if(r.overnight && r.overnight.includes('å›½å†…æœ‰è¿‡å¤œ')) s.o_d += r.overnight_days;
                if(r.overnight && r.overnight.includes('å›½é™…æœ‰è¿‡å¤œ')) s.o_i += r.overnight_days;
            });

            document.getElementById('reportTable').innerHTML = `
                <thead>
                    <tr><th rowspan="2">ç±»åˆ«</th><th colspan="2">å›½å†…</th><th colspan="2">æ¸¯æ¾³å°</th><th colspan="2">äºšæ´²</th><th colspan="2">æ´²é™…</th></tr>
                    <tr><th>ç©ºæ—¶</th><th>æ»‘è¡Œ</th><th>ç©ºæ—¶</th><th>æ»‘è¡Œ</th><th>ç©ºæ—¶</th><th>æ»‘è¡Œ</th><th>ç©ºæ—¶</th><th>æ»‘è¡Œ</th></tr>
                </thead>
                <tbody>
                    <tr><td style="font-weight:bold">åˆè®¡</td>
                        <td>${s.d_a.toFixed(1)}</td><td>${s.d_b}</td>
                        <td>${s.h_a.toFixed(1)}</td><td>${s.h_b}</td>
                        <td>${s.a_a.toFixed(1)}</td><td>${s.a_b}</td>
                        <td>${s.i_a.toFixed(1)}</td><td>${s.i_b}</td>
                    </tr>
                    <tr><td colspan="9" style="height:10px; border:none; background:#fff"></td></tr>
                    <tr><th rowspan="2">è¡¥è´´</th><th colspan="2">å¤œèˆªè¡¥åŠ©</th><th colspan="2">ç‰¹æ®Š/èŠ‚æ—¥</th><th colspan="2">é©»å¤–å¤©æ•°</th><th colspan="2">æ€»è®¡</th></tr>
                    <tr><th>18:30</th><th>00:00</th><th class="bg-sub">ç‰¹æ®Š</th><th class="bg-sub">èŠ‚æ—¥</th><th>å›½å†…</th><th>å›½é™…</th><th>-</th><th>-</th></tr>
                    <tr><td style="font-weight:bold">æ•°é‡</td>
                        <td>${s.n1.toFixed(1)}</td><td>${s.n2.toFixed(1)}</td>
                        <td class="bg-sub">${s.spec}</td><td class="bg-sub">${s.hol}</td>
                        <td>${s.o_d}</td><td>${s.o_i}</td>
                        <td>-</td><td>-</td>
                    </tr>
                </tbody>`;
        };
    </script>
</body>
</html>
