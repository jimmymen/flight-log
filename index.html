<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£è¡Œæ—¥å¿— - å…¨æ™¯ä»ªè¡¨ç›˜</title>
    <style>
        /* === åŸºç¡€æ ·å¼ === */
        :root { --primary: #2563eb; --primary-dark: #1e40af; --bg: #f1f5f9; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg); color: #334155;
            padding: 20px; min-height: 100vh;
        }
        
        /* å®¹å™¨å¸ƒå±€ */
        .container {
            max-width: 1000px; margin: 0 auto;
            display: flex; flex-direction: column; gap: 25px;
        }

        /* é€šç”¨å¡ç‰‡æ ·å¼ */
        .card {
            background: white; border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden; border: 1px solid #e2e8f0;
        }
        .card-header {
            padding: 15px 20px; background: linear-gradient(to right, #f8fafc, #fff);
            border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;
        }
        .card-header h2 { font-size: 1.1rem; color: #1e293b; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .card-body { padding: 20px; }

        /* é¡¶éƒ¨å¯¼èˆªæ¡ */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--primary); color: white; padding: 15px 25px;
            border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3);
        }

        /* === æ¨¡å— 1: ç»Ÿè®¡æŠ¥è¡¨ === */
        .excel-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 800px; }
        .table-scroll { overflow-x: auto; border-radius: 8px; border: 1px solid #cbd5e1; }
        .excel-table th, .excel-table td { border: 1px solid #cbd5e1; padding: 8px; text-align: center; }
        .excel-table th { background: #f1f5f9; font-weight: 600; color: #475569; }
        .highlight-col { background-color: #eff6ff; color: var(--primary-dark); font-weight: 600; }

        /* === æ¨¡å— 2: æ™ºèƒ½å½•å…¥ === */
        .ai-input-area { position: relative; }
        .key-input { 
            position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9);
            padding: 5px 10px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 0.8rem; width: 200px;
        }
        textarea {
            width: 100%; height: 100px; padding: 15px; border: 2px dashed #cbd5e1;
            border-radius: 12px; resize: vertical; font-family: monospace; transition: 0.3s;
            background: #f8fafc;
        }
        textarea:focus { border-color: var(--primary); outline: none; background: white; }
        
        /* è¡¨å•ç½‘æ ¼ */
        .edit-form { background: #f8fafc; padding: 20px; border-radius: 12px; margin-top: 15px; border: 1px solid #e2e8f0; }
        .form-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px;
        }
        .form-group label { display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; }
        .highlight-field input { border-color: var(--primary); background: #eff6ff; color: var(--primary); font-weight: bold; }

        /* === æ¨¡å— 3: å†å²è®°å½• === */
        .log-list { max-height: 400px; overflow-y: auto; padding-right: 5px; }
        .log-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; border-bottom: 1px solid #f1f5f9; transition: 0.2s;
        }
        .log-item:last-child { border-bottom: none; }
        .log-item:hover { background: #f8fafc; }
        .log-details { display: flex; gap: 15px; align-items: center; }
        .log-date { font-family: monospace; font-weight: 600; color: #334155; width: 90px; }
        .log-route { font-weight: bold; color: var(--primary); width: 120px; }
        .log-meta { font-size: 0.85rem; color: #64748b; display: flex; gap: 10px; }
        .badge { padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; background: #e2e8f0; }
        .badge-days { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }

        /* æŒ‰é’® */
        .btn { padding: 8px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-icon { padding: 6px; border-radius: 6px; background: transparent; color: #94a3b8; cursor: pointer; }
        .btn-icon:hover { background: #fee2e2; color: #ef4444; }

        /* ç™»å½•é®ç½© */
        .login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            display: flex; justify-content: center; align-items: center; z-index: 999;
        }
        .login-box { background: white; padding: 40px; border-radius: 20px; text-align: center; width: 320px; }
    </style>
</head>
<body>

    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <h2 style="color: var(--primary); margin-bottom: 20px;">âœˆï¸ é£è¡Œæ—¥å¿—</h2>
            <button class="btn btn-primary" style="width: 100%; padding: 12px;" onclick="loginWithGoogle()">Google è´¦å·ç™»å½•</button>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢å®¹å™¨ -->
    <div id="app" class="container" style="display: none;">
        
        <!-- é¡¶éƒ¨æ  -->
        <div class="top-bar">
            <div>
                <h1 style="font-size: 1.25rem;">é£è¡Œå‘˜æ§åˆ¶å°</h1>
                <span id="userInfo" style="font-size: 0.8rem; opacity: 0.9;">æœªç™»å½•</span>
            </div>
            <button class="btn" style="background: rgba(255,255,255,0.2); color: white;" onclick="doLogout()">é€€å‡º</button>
        </div>

        <!-- ç¬¬ä¸€éƒ¨åˆ†ï¼šç»Ÿè®¡æŠ¥è¡¨ (Top) -->
        <section class="card">
            <div class="card-header">
                <h2>ğŸ“Š æœˆåº¦ç»Ÿè®¡æŠ¥è¡¨</h2>
                <div>
                    <label style="font-size: 0.85rem; color: #64748b;">ç»Ÿè®¡æœˆä»½ï¼š</label>
                    <input type="month" id="reportMonth" onchange="renderReport()" style="border: 1px solid #cbd5e1; padding: 4px; border-radius: 4px;">
                </div>
            </div>
            <div class="card-body">
                <div class="table-scroll">
                    <table class="excel-table" id="reportTable">
                        <!-- JSç”Ÿæˆå†…å®¹ -->
                    </table>
                </div>
            </div>
        </section>

        <!-- ç¬¬äºŒéƒ¨åˆ†ï¼šæ™ºèƒ½å½•å…¥ (Middle) -->
        <section class="card">
            <div class="card-header">
                <h2>ğŸ“ æ™ºèƒ½å½•å…¥</h2>
                <span style="font-size: 0.8rem; color: #64748b;">æ”¯æŒæ‰‹å†™è¯†åˆ«/ä»»åŠ¡ä¹¦OCR</span>
            </div>
            <div class="card-body">
                <div class="ai-input-area">
                    <input type="password" id="innerApiKey" class="key-input" placeholder="åœ¨æ­¤å¡«å…¥ DeepSeek Key">
                    <textarea id="ocrInput" placeholder="ç²˜è´´æ–‡æœ¬... ä¾‹ï¼š2025-05-20 åŒ—äº¬-ä¸Šæµ· 3.5h è¿‡å¤œ2å¤©"></textarea>
                </div>
                <div style="text-align: right; margin-top: 10px;">
                    <button id="aiBtn" class="btn btn-primary" onclick="processAI()">âœ¨ AI æå–æ•°æ®</button>
                </div>

                <!-- éšè—çš„ç¼–è¾‘è¡¨å• -->
                <div id="editForm" class="edit-form" style="display: none;">
                    <div class="form-grid">
                        <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="f_date"></div>
                        <div class="form-group"><label>èµ·é£</label><input type="text" id="f_dep"></div>
                        <div class="form-group"><label>è½åœ°</label><input type="text" id="f_arr"></div>
                        <div class="form-group"><label>åŒºåŸŸ</label>
                            <select id="f_cat">
                                <option value="å›½å†…">å›½å†…</option>
                                <option value="æ¸¯æ¾³å°">æ¸¯æ¾³å°</option>
                                <option value="äºšæ´²å›½é™…">äºšæ´²å›½é™…</option>
                                <option value="æ´²é™…">æ´²é™…</option>
                            </select>
                        </div>
                        <div class="form-group"><label>ç©ºä¸­æ—¶é—´(h)</label><input type="number" step="0.01" id="f_air"></div>
                        <div class="form-group"><label>æ»‘è¡Œæ¬¡æ•°</label><input type="number" id="f_block_days" value="1"></div>
                        <div class="form-group"><label>å¤œèˆª(18:30+)</label><input type="number" step="0.01" id="f_night1"></div>
                        <div class="form-group"><label>å¤œèˆª(00:00+)</label><input type="number" step="0.01" id="f_night2"></div>
                        
                        <div class="form-group"><label>é©»å¤–ç±»å‹</label>
                            <select id="f_overnight">
                                <option value="å›½å†…æ— è¿‡å¤œ">å›½å†…æ— è¿‡å¤œ</option>
                                <option value="å›½å†…æœ‰è¿‡å¤œ">å›½å†…æœ‰è¿‡å¤œ</option>
                                <option value="å›½é™…æ— è¿‡å¤œ">å›½é™…æ— è¿‡å¤œ</option>
                                <option value="å›½é™…æœ‰è¿‡å¤œ">å›½é™…æœ‰è¿‡å¤œ</option>
                            </select>
                        </div>
                        <div class="form-group highlight-field">
                            <label>é©»å¤–å¤©æ•°</label>
                            <input type="number" id="f_overnight_days" value="0">
                        </div>
                        
                        <div class="form-group"><label>æœºç»„é¤(å›½)</label><input type="number" id="f_meal_d" value="0"></div>
                        <div class="form-group"><label>æœºç»„é¤(å¤–)</label><input type="number" id="f_meal_i" value="0"></div>
                        <div class="form-group"><label>èŠ‚å‡æ—¥</label><input type="number" id="f_holiday" value="0"></div>
                    </div>
                    <div style="margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">
                        <button class="btn" style="background: #e2e8f0;" onclick="document.getElementById('editForm').style.display='none'">å–æ¶ˆ</button>
                        <button class="btn btn-primary" style="background: #10b981;" onclick="saveRecord()">ğŸ’¾ ç¡®è®¤ä¿å­˜</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ç¬¬ä¸‰éƒ¨åˆ†ï¼šå†å²è®°å½• (Bottom) -->
        <section class="card">
            <div class="card-header">
                <h2>ğŸ“‹ å†å²è®°å½•</h2>
                <span style="font-size: 0.8rem; color: #64748b;">å®æ—¶åŒæ­¥</span>
            </div>
            <div class="card-body">
                <div id="logList" class="log-list">
                    <!-- JS å¡«å……åˆ—è¡¨ -->
                </div>
            </div>
        </section>

    </div>

    <!-- é€»è¾‘è„šæœ¬ -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCFk4f7bKUHlb3d1Cg1jyS1EM-SPC4pr40",
            authDomain: "myflightlog-1f4cb.firebaseapp.com",
            projectId: "myflightlog-1f4cb",
            storageBucket: "myflightlog-1f4cb.firebasestorage.app",
            messagingSenderId: "181072044112",
            appId: "1:181072044112:web:ca312da2d4780227cef155"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let allRecords = [];

        // è®¤è¯é€»è¾‘
        window.loginWithGoogle = async () => { try { await signInWithPopup(auth, provider); } catch (e) { alert("Error: " + e.message); } };
        window.doLogout = async () => { await signOut(auth); };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userInfo').textContent = `ğŸ‘¨â€âœˆï¸ ${user.displayName}`;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                document.getElementById('reportMonth').value = new Date().toISOString().slice(0, 7);
                
                const savedKey = localStorage.getItem("openai_key");
                if(savedKey) document.getElementById("innerApiKey").value = savedKey;

                // æ ¸å¿ƒï¼šå®æ—¶ç›‘å¬
                const q = query(collection(db, `users/${user.uid}/logs`), orderBy("date", "desc"));
                onSnapshot(q, (snapshot) => {
                    allRecords = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    renderList();
                    renderReport();
                });
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
        });

        // AI å¤„ç†é€»è¾‘
        window.processAI = async () => {
            const text = document.getElementById('ocrInput').value;
            const apiKey = document.getElementById('innerApiKey').value;
            if (!apiKey || !text) return alert("è¯·æ£€æŸ¥ Key æˆ–è¾“å…¥å†…å®¹");
            localStorage.setItem("openai_key", apiKey);

            const btn = document.getElementById('aiBtn');
            btn.textContent = "â³ åˆ†æä¸­..."; btn.disabled = true;

            const prompt = `
            åˆ†æé£è¡Œä»»åŠ¡æ–‡æœ¬ï¼Œè¿”å›JSONã€‚
            å­—æ®µ: date(YYYY-MM-DD), dep, arr, category("å›½å†…"|"æ¸¯æ¾³å°"|"äºšæ´²å›½é™…"|"æ´²é™…"),
            air_time(å°æ—¶), block_days(æ»‘è¡Œæ¬¡æ•°,é»˜è®¤1), night1(18:30-24:00), night2(00:00-06:30),
            overnight("å›½å†…æ— è¿‡å¤œ"|"å›½å†…æœ‰è¿‡å¤œ"|"å›½é™…æ— è¿‡å¤œ"|"å›½é™…æœ‰è¿‡å¤œ"),
            overnight_days(int, é©»å¤–å¤©æ•°ï¼Œå¦‚'è¿‡å¤œ2å¤©'åˆ™ä¸º2ï¼Œæ— è¿‡å¤œä¸º0)
            æ–‡æœ¬: ${text}
            `;

            try {
                const res = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: "deepseek-chat", messages: [{role: "user", content: prompt}], temperature: 0.1 })
                });
                const data = await res.json();
                let content = data.choices[0].message.content;
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                const result = JSON.parse(jsonMatch ? jsonMatch[0] : content);

                // å¡«å……
                ['date','dep','arr','cat','air','block_days','night1','night2','overnight','overnight_days'].forEach(k => {
                    const el = document.getElementById(`f_${k === 'cat' ? 'cat' : k === 'air' ? 'air' : k === 'overnight' ? 'overnight' : k}`);
                    if(el) el.value = result[k] || (k === 'cat' ? 'å›½å†…' : 0);
                });
                // ç‰¹æ®Šå¤„ç†ä¸‹æ‹‰æ¡†é»˜è®¤å€¼
                if(result.category) document.getElementById('f_cat').value = result.category;
                if(result.overnight) document.getElementById('f_overnight').value = result.overnight;
                
                document.getElementById('editForm').style.display = 'block';
            } catch (e) { alert("AI Error: " + e.message); } 
            finally { btn.textContent = "âœ¨ AI æå–æ•°æ®"; btn.disabled = false; }
        };

        // ä¿å­˜
        window.saveRecord = async () => {
            const record = {
                date: document.getElementById('f_date').value,
                dep: document.getElementById('f_dep').value,
                arr: document.getElementById('f_arr').value,
                category: document.getElementById('f_cat').value,
                air_time: parseFloat(document.getElementById('f_air').value) || 0,
                block_days: parseInt(document.getElementById('f_block_days').value) || 0,
                night1: parseFloat(document.getElementById('f_night1').value) || 0,
                night2: parseFloat(document.getElementById('f_night2').value) || 0,
                overnight: document.getElementById('f_overnight').value,
                overnight_days: parseInt(document.getElementById('f_overnight_days').value) || 0,
                meal_d: parseInt(document.getElementById('f_meal_d').value) || 0,
                meal_i: parseInt(document.getElementById('f_meal_i').value) || 0,
                holiday: parseInt(document.getElementById('f_holiday').value) || 0,
                timestamp: new Date()
            };
            await addDoc(collection(db, `users/${currentUser.uid}/logs`), record);
            document.getElementById('editForm').style.display = 'none';
            document.getElementById('ocrInput').value = '';
        };

        // åˆ é™¤
        window.deleteItem = async (id) => {
            if(confirm("ç¡®å®šåˆ é™¤æ­¤è®°å½•ï¼ŸæŠ¥è¡¨å°†è‡ªåŠ¨æ›´æ–°ã€‚")) {
                await deleteDoc(doc(db, `users/${currentUser.uid}/logs`, id));
            }
        };

        // æ¸²æŸ“åˆ—è¡¨
        window.renderList = () => {
            const el = document.getElementById('logList');
            if(!allRecords.length) { el.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8">æš‚æ— æ•°æ®</div>'; return; }
            el.innerHTML = allRecords.map(r => `
                <div class="log-item">
                    <div class="log-details">
                        <div class="log-date">${r.date.slice(5)}</div>
                        <div class="log-route">${r.dep}-${r.arr}</div>
                        <div class="log-meta">
                            <span>â±ï¸ ${r.air_time}h</span>
                            <span class="badge">${r.category}</span>
                            ${r.overnight_days > 0 ? `<span class="badge badge-days">ğŸ  ${r.overnight_days}å¤©</span>` : ''}
                        </div>
                    </div>
                    <button class="btn-icon" onclick="deleteItem('${r.id}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                </div>
            `).join('');
        };

        // æ¸²æŸ“æŠ¥è¡¨
        window.renderReport = () => {
            const mStr = document.getElementById('reportMonth').value;
            const [y, m] = mStr.split('-');
            const data = allRecords.filter(r => r.date.startsWith(mStr));
            
            const s = { d_air:0,d_bk:0,h_air:0,h_bk:0,a_air:0,a_bk:0,i_air:0,i_bk:0, n1:0,n2:0, o_d0:0,o_d1:0,o_i0:0,o_i1:0, m_d:0,m_i:0 };
            
            data.forEach(r => {
                const catMap = {'å›½å†…':['d_air','d_bk'], 'æ¸¯æ¾³å°':['h_air','h_bk'], 'äºšæ´²å›½é™…':['a_air','a_bk'], 'æ´²é™…':['i_air','i_bk']};
                const [k_air, k_bk] = catMap[r.category] || ['d_air','d_bk'];
                s[k_air] += r.air_time; s[k_bk] += r.block_days;
                s.n1 += r.night1; s.n2 += r.night2;
                s.m_d += r.meal_d; s.m_i += r.meal_i;

                const days = r.overnight_days || 0;
                if(r.overnight==='å›½å†…æ— è¿‡å¤œ') s.o_d0 += days;
                if(r.overnight==='å›½å†…æœ‰è¿‡å¤œ') s.o_d1 += days;
                if(r.overnight==='å›½é™…æ— è¿‡å¤œ') s.o_i0 += days;
                if(r.overnight==='å›½é™…æœ‰è¿‡å¤œ') s.o_i1 += days;
            });

            document.getElementById('reportTable').innerHTML = `
                <thead>
                    <tr><th rowspan="2">ç±»å‹</th><th colspan="2">å›½å†…</th><th colspan="2">æ¸¯æ¾³å°</th><th colspan="2">äºšæ´²</th><th colspan="2">æ´²é™…</th></tr>
                    <tr><th>ç©º</th><th>æ»‘</th><th>ç©º</th><th>æ»‘</th><th>ç©º</th><th>æ»‘</th><th>ç©º</th><th>æ»‘</th></tr>
                </thead>
                <tbody>
                    <tr>
                        <td>é£è¡Œ</td>
                        <td>${s.d_air.toFixed(1)}</td><td>${s.d_bk}</td>
                        <td>${s.h_air.toFixed(1)}</td><td>${s.h_bk}</td>
                        <td>${s.a_air.toFixed(1)}</td><td>${s.a_bk}</td>
                        <td>${s.i_air.toFixed(1)}</td><td>${s.i_bk}</td>
                    </tr>
                    <tr><td colspan="9" style="background:#f8fafc;height:5px;padding:0"></td></tr>
                    <tr><th rowspan="2">è¡¥åŠ©</th><th colspan="2">å¤œèˆª</th><th colspan="4">é©»å¤–å¤©æ•°</th><th colspan="2">æœºç»„é¤</th></tr>
                    <tr><th>18:30+</th><th>00:00+</th><th>å›½æ— </th><th class="highlight-col">å›½æœ‰</th><th>å¤–æ— </th><th class="highlight-col">å¤–æœ‰</th><th>å›½</th><th>å¤–</th></tr>
                    <tr>
                        <td>ç»Ÿè®¡</td>
                        <td>${s.n1.toFixed(1)}</td><td>${s.n2.toFixed(1)}</td>
                        <td>${s.o_d0}</td><td class="highlight-col">${s.o_d1}</td>
                        <td>${s.o_i0}</td><td class="highlight-col">${s.o_i1}</td>
                        <td>${s.m_d}</td><td>${s.m_i}</td>
                    </tr>
                </tbody>
            `;
        };
    </script>
</body>
</html>
