<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£è¡Œæ—¥å¿— - 2025é«˜çº§ç»Ÿè®¡ç‰ˆ</title>
    <style>
        /* === ç•Œé¢æ ·å¼ === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            min-height: 100vh; padding: 20px; color: #333;
        }
        .container {
            max-width: 1100px; margin: 0 auto; background: white;
            border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            overflow: hidden; min-height: 80vh; display: flex; flex-direction: column;
        }
        
        /* å¤´éƒ¨ */
        .header {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            padding: 20px 25px; color: white;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-left h1 { font-size: 1.5rem; margin-bottom: 5px; }
        .header-right { text-align: right; }
        
        /* å¯¼èˆªæ  */
        .nav-tabs { display: flex; background: #f1f5f9; padding: 0 10px; order: 0; }
        .tab {
            flex: 1; padding: 15px; text-align: center; cursor: pointer;
            font-weight: 500; color: #64748b; transition: 0.3s; border-bottom: 3px solid transparent;
        }
        .tab.active { color: #2563eb; border-bottom-color: #2563eb; background: white; }
        .tab:hover:not(.active) { background: #e2e8f0; }

        /* å†…å®¹åŒº */
        .content-wrapper { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
        .tab-content { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* AI è¾“å…¥åŒº */
        .ai-box {
            border: 2px dashed #cbd5e1; padding: 20px; border-radius: 15px;
            background: #f8fafc; margin-bottom: 20px;
        }
        .key-input-group {
            margin-bottom: 15px; background: white; padding: 10px; 
            border-radius: 8px; border: 1px solid #e2e8f0;
            display: flex; align-items: center; gap: 10px;
        }

        textarea {
            width: 100%; height: 120px; padding: 15px; border: 1px solid #cbd5e1;
            border-radius: 10px; resize: vertical; font-family: monospace; margin-bottom: 15px;
        }
        
        /* æŒ‰é’®ç³»ç»Ÿ */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-outline { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.4); }
        .btn-sm { padding: 4px 10px; font-size: 0.8rem; }

        /* è¡¨å•ç½‘æ ¼ */
        .form-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px; background: #f1f5f9; padding: 20px; border-radius: 15px; margin-top: 15px;
        }
        .form-group label { display: block; font-size: 0.8rem; color: #64748b; margin-bottom: 4px; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; }
        
        /* åˆ—è¡¨å¡ç‰‡ */
        .log-card {
            background: white; border: 1px solid #e2e8f0; border-radius: 10px;
            padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between;
            align-items: center; transition: 0.2s; position: relative;
        }
        .log-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .log-info { flex: 1; padding-right: 10px; }
        .log-actions { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
        .tag { padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; background: #e2e8f0; color: #475569; display: inline-block; margin-top: 4px;}
        .tag.å›½å†… { background: #dbeafe; color: #1e40af; }

        /* æŠ¥è¡¨è¡¨æ ¼ */
        .table-container { overflow-x: auto; margin-top: 10px; }
        .excel-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; min-width: 1000px; }
        .excel-table th, .excel-table td { border: 1px solid #cbd5e1; padding: 8px 6px; text-align: center; }
        .excel-table th { background: #f8fafc; font-weight: 600; color: #334155; }
        .excel-table tr:hover { background-color: #f1f5f9; }
        .highlight-cell { background-color: #eff6ff; font-weight: bold; color: #1d4ed8; }

        /* ç™»å½•å±‚ */
        .login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            display: flex; justify-content: center; align-items: center; z-index: 100;
        }
        .login-box { background: white; padding: 40px; border-radius: 20px; text-align: center; width: 350px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        
        .spinner {
            width: 16px; height: 16px; border: 2px solid #ffffff;
            border-top: 2px solid transparent; border-radius: 50%;
            animation: spin 1s linear infinite; display: inline-block; margin-right: 5px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <h2 style="margin-bottom: 20px; color: #1e40af;">âœˆï¸ é£è¡Œæ—¥å¿—ç™»å½•</h2>
            <button class="btn btn-primary" style="width: 100%; padding: 12px; margin-bottom: 15px; font-size: 1rem;" onclick="loginWithGoogle()">
                Google è´¦å·ç™»å½•
            </button>
            <p style="font-size: 0.8rem; color: #64748b;">ç™»å½•ååœ¨åº”ç”¨å†…å¡«å†™ API Key</p>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ -->
    <div id="app" class="container" style="display: none;">
        <div class="header">
            <div class="header-left">
                <h1>é£è¡Œå°æ—¶æ˜ç»†è¡¨</h1>
                <p id="userInfo" style="opacity: 0.9; font-size: 0.85rem;">æœªç™»å½•</p>
            </div>
            <div class="header-right">
                <button class="btn btn-outline" onclick="doLogout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>

        <!-- å¯¼èˆªæ è°ƒæ•´ï¼šæŠ¥è¡¨åœ¨å‰ï¼Œå½•å…¥åœ¨å -->
        <div class="nav-tabs">
            <div class="tab active" onclick="switchTab('report')">ğŸ“Š ç»Ÿè®¡æŠ¥è¡¨</div>
            <div class="tab" onclick="switchTab('list')">ğŸ“‹ å†å²è®°å½•</div>
            <div class="tab" onclick="switchTab('input')">ğŸ“ æ™ºèƒ½å½•å…¥</div>
        </div>

        <div class="content-wrapper">
            
            <!-- 1. æŠ¥è¡¨é¡µ (é»˜è®¤æ˜¾ç¤º) -->
            <div id="reportTab" class="tab-content active">
                <div style="background: #f8fafc; padding: 15px; border-radius: 10px; display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <label style="font-weight: 600;">ç»Ÿè®¡æœˆä»½ï¼š</label>
                    <input type="month" id="reportMonth" onchange="renderReport()" style="padding: 5px 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                    <span style="flex:1"></span>
                    <button class="btn btn-primary btn-sm" onclick="renderReport()">ğŸ”„ åˆ·æ–°</button>
                </div>
                
                <div class="table-container">
                    <table class="excel-table" id="reportTable">
                        <!-- JS ç”Ÿæˆè¡¨å¤´ -->
                    </table>
                </div>
                <p style="margin-top: 15px; color: #64748b; font-size: 0.85rem;">* è¯´æ˜ï¼šç»Ÿè®¡è¡¨ä¼šè‡ªåŠ¨æ±‡æ€»é©»å¤–å¤©æ•°ï¼›åˆ é™¤å†å²è®°å½•ä¼šè‡ªåŠ¨æ›´æ–°æ­¤è¡¨ã€‚</p>
            </div>

            <!-- 2. åˆ—è¡¨é¡µ -->
            <div id="listTab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>å†å²è®°å½•æ˜ç»†</h3>
                    <span style="font-size: 0.8rem; color: #64748b;">æŒ‰æ—¥æœŸå€’åºæ’åˆ—</span>
                </div>
                <div id="logList">
                    <!-- JS ç”Ÿæˆåˆ—è¡¨ -->
                </div>
            </div>

            <!-- 3. å½•å…¥é¡µ (æ”¾åœ¨æœ€å) -->
            <div id="inputTab" class="tab-content">
                <div class="ai-box">
                    <h3 style="margin-bottom: 10px; color: #334155;">ğŸ¤– æ‰‹å†™è¯†åˆ«/ä»»åŠ¡ä¹¦å½•å…¥</h3>
                    
                    <div class="key-input-group">
                        <span style="font-size: 1.2rem;">ğŸ”‘</span>
                        <input type="password" id="innerApiKey" placeholder="åœ¨æ­¤å¡«å…¥ DeepSeek Key (sk-...)" style="border: none; outline: none; width: 100%; font-size: 0.9rem;">
                    </div>

                    <textarea id="ocrInput" placeholder="è¯·åœ¨æ­¤å¤„ç²˜è´´ OCR è¯†åˆ«åçš„ä¹±ç æˆ–æ–‡æœ¬...&#10;ä¾‹å¦‚ï¼š&#10;2025-05-01 PEK-SHA 3.5h è¿‡å¤œ2å¤©"></textarea>
                    <button id="aiBtn" class="btn btn-primary" onclick="processAI()">âœ¨ AI æ™ºèƒ½æå–</button>
                </div>

                <div id="editForm" style="display: none;">
                    <h3 style="color: #334155; padding-left: 5px; border-left: 4px solid #2563eb; margin-bottom:15px;">æ ¸å¯¹æ•°æ®</h3>
                    <div class="form-grid">
                        <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="f_date"></div>
                        <div class="form-group"><label>èµ·é£æœºåœº</label><input type="text" id="f_dep"></div>
                        <div class="form-group"><label>è½åœ°æœºåœº</label><input type="text" id="f_arr"></div>
                        <div class="form-group"><label>åŒºåŸŸåˆ†ç±»</label>
                            <select id="f_cat">
                                <option value="å›½å†…">å›½å†…</option>
                                <option value="æ¸¯æ¾³å°">æ¸¯æ¾³å°</option>
                                <option value="äºšæ´²å›½é™…">äºšæ´²å›½é™…(éæ¸¯æ¾³å°)</option>
                                <option value="æ´²é™…">æ´²é™…(äºšæ´²å¤–)</option>
                            </select>
                        </div>
                        <div class="form-group"><label>ç©ºä¸­æ—¶é—´ (h)</label><input type="number" step="0.01" id="f_air"></div>
                        <div class="form-group"><label>æ»‘è¡Œå¤©æ•°</label><input type="number" id="f_block_days" value="1"></div>
                        
                        <div class="form-group"><label>å¤œèˆª (18:30-24)</label><input type="number" step="0.01" id="f_night1"></div>
                        <div class="form-group"><label>å¤œèˆª (0-6:30)</label><input type="number" step="0.01" id="f_night2"></div>
                        
                        <!-- ä¿®æ”¹ï¼šé©»å¤–ç±»å‹ + å¤©æ•° -->
                        <div class="form-group"><label>é©»å¤–ç±»å‹</label>
                            <select id="f_overnight">
                                <option value="å›½å†…æ— è¿‡å¤œ">å›½å†…æ— è¿‡å¤œ</option>
                                <option value="å›½å†…æœ‰è¿‡å¤œ">å›½å†…æœ‰è¿‡å¤œ</option>
                                <option value="å›½é™…æ— è¿‡å¤œ">å›½é™…æ— è¿‡å¤œ</option>
                                <option value="å›½é™…æœ‰è¿‡å¤œ">å›½é™…æœ‰è¿‡å¤œ</option>
                            </select>
                        </div>
                        <div class="form-group highlight-cell" style="background: #eff6ff; border-radius:6px; padding:4px;">
                            <label style="color:#1d4ed8">é©»å¤–å¤©æ•°</label>
                            <input type="number" id="f_overnight_days" value="0" style="border:1px solid #2563eb;">
                        </div>

                        <div class="form-group"><label>å›½å†…æœºç»„é¤</label><input type="number" id="f_meal_d" value="0"></div>
                        <div class="form-group"><label>å›½é™…æœºç»„é¤</label><input type="number" id="f_meal_i" value="0"></div>
                        <div class="form-group"><label>æ³•å®šèŠ‚å‡æ—¥(å¤©)</label><input type="number" id="f_holiday" value="0"></div>
                        
                        <input type="hidden" id="f_takeoff"><input type="hidden" id="f_landing">
                    </div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn" style="background: #cbd5e1; margin-right: 10px;" onclick="document.getElementById('editForm').style.display='none'">å–æ¶ˆ</button>
                        <button class="btn btn-success" onclick="saveRecord()">ğŸ’¾ ç¡®è®¤ä¿å­˜</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, limit, getDocs, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCFk4f7bKUHlb3d1Cg1jyS1EM-SPC4pr40",
            authDomain: "myflightlog-1f4cb.firebaseapp.com",
            projectId: "myflightlog-1f4cb",
            storageBucket: "myflightlog-1f4cb.firebasestorage.app",
            messagingSenderId: "181072044112",
            appId: "1:181072044112:web:ca312da2d4780227cef155"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let allRecords = [];

        // ç™»å½•/é€€å‡º
        window.loginWithGoogle = async () => { try { await signInWithPopup(auth, provider); } catch (e) { alert("ç™»å½•å¤±è´¥: " + e.message); } };
        window.doLogout = async () => { try { await signOut(auth); } catch (e) { alert("é€€å‡ºå¤±è´¥: " + e.message); } };

        // æ ‡ç­¾åˆ‡æ¢
        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId + 'Tab').classList.add('active');
            if(tabId === 'report') renderReport();
        };

        // ç›‘å¬ç”¨æˆ·çŠ¶æ€
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userInfo').textContent = `ğŸ‘¤ ${user.email}`;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                document.getElementById('reportMonth').value = new Date().toISOString().slice(0, 7);

                // å®æ—¶ç›‘å¬æ•°æ®åº“ï¼šä»»ä½•å¢åˆ æ”¹éƒ½ä¼šè§¦å‘è¿™é‡Œï¼Œè‡ªåŠ¨æ›´æ–°åˆ—è¡¨å’ŒæŠ¥è¡¨
                const q = query(collection(db, `users/${user.uid}/logs`), orderBy("date", "desc"));
                onSnapshot(q, (snapshot) => {
                    allRecords = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    renderList();
                    renderReport();
                });
                
                const savedKey = localStorage.getItem("openai_key");
                if(savedKey) document.getElementById("innerApiKey").value = savedKey;
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
        });

        // AI æ ¸å¿ƒé€»è¾‘
        window.processAI = async () => {
            const text = document.getElementById('ocrInput').value;
            const apiKey = document.getElementById('innerApiKey').value;
            
            if (!apiKey) return alert("è¯·å…ˆè¾“å…¥ API Key");
            localStorage.setItem("openai_key", apiKey);

            if (!text.trim()) return alert("è¯·å…ˆç²˜è´´å†…å®¹");

            const btn = document.getElementById('aiBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner"></span> è¯†åˆ« OCR ä¸­...';
            btn.disabled = true;

            // ä¿®æ”¹åçš„æç¤ºè¯ï¼Œå¼ºè°ƒ OCR çº é”™å’Œæå–å¤©æ•°
            const prompt = `
            ä½ æ˜¯ä¸€ä¸ªé£è¡Œæ—¥å¿—åŠ©æ‰‹ã€‚è¯·åˆ†æä»¥ä¸‹å¯èƒ½åŒ…å«OCRé”™è¯¯çš„æ‰‹å†™è¯†åˆ«æ–‡æœ¬ï¼Œæå–æ•°æ®å¹¶è¿”å›çº¯JSONã€‚
            
            æ–‡æœ¬ï¼š${text}
            
            éœ€æå–å­—æ®µï¼š
            date (YYYY-MM-DD), 
            dep (èµ·é£ä¸‰å­—ç æˆ–ä¸­æ–‡), arr (è½åœ°ä¸‰å­—ç æˆ–ä¸­æ–‡), 
            category ("å›½å†…"|"æ¸¯æ¾³å°"|"äºšæ´²å›½é™…"|"æ´²é™…"),
            air_time (æ•°å­—å°æ—¶), block_days (æ»‘è¡Œå¤©æ•°,é»˜è®¤1),
            night1 (18:30-24:00æ—¶é•¿), night2 (00:00-06:30æ—¶é•¿),
            overnight ("å›½å†…æ— è¿‡å¤œ"|"å›½å†…æœ‰è¿‡å¤œ"|"å›½é™…æ— è¿‡å¤œ"|"å›½é™…æœ‰è¿‡å¤œ"),
            overnight_days (æ•°å­—ï¼Œé©»å¤–/è¿‡å¤œçš„å¤©æ•°ã€‚å¦‚æœæ–‡æœ¬æåˆ°"è¿‡å¤œ3å¤©"åˆ™ä¸º3ï¼Œæ— è¿‡å¤œåˆ™ä¸º0)
            
            æ³¨æ„ï¼šå¦‚æœæ˜¯ä¹±ç ï¼Œè¯·å°è¯•æ ¹æ®ä¸Šä¸‹æ–‡çŒœæµ‹æœºåœºä»£ç å’Œæ—¶é—´ã€‚
            è¿”å›æ ¼å¼ä»…åŒ…å«JSONï¼Œæ— Markdownã€‚
            `;

            try {
                const res = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: "deepseek-chat", 
                        messages: [{role: "user", content: prompt}], 
                        temperature: 0.1
                    })
                });
                
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                
                let content = data.choices[0].message.content.replace(/```json|```/g, '');
                // ç®€å•çš„ JSON æå–ä¿æŠ¤
                const jsonStart = content.indexOf('{');
                const jsonEnd = content.lastIndexOf('}');
                if (jsonStart !== -1 && jsonEnd !== -1) {
                    content = content.substring(jsonStart, jsonEnd + 1);
                }
                
                const result = JSON.parse(content);

                // å¡«å…¥è¡¨å•
                document.getElementById('f_date').value = result.date || '';
                document.getElementById('f_dep').value = result.dep || '';
                document.getElementById('f_arr').value = result.arr || '';
                document.getElementById('f_cat').value = result.category || 'å›½å†…';
                document.getElementById('f_air').value = result.air_time || 0;
                document.getElementById('f_block_days').value = result.block_days || 1;
                document.getElementById('f_night1').value = result.night1 || 0;
                document.getElementById('f_night2').value = result.night2 || 0;
                document.getElementById('f_overnight').value = result.overnight || 'å›½å†…æ— è¿‡å¤œ';
                // å¡«å…¥æ–°å¢çš„å¤©æ•°
                document.getElementById('f_overnight_days').value = result.overnight_days || 0;
                
                document.getElementById('editForm').style.display = 'block';
                // æ»šåŠ¨åˆ°è¡¨å•
                document.getElementById('editForm').scrollIntoView({ behavior: 'smooth' });
                
            } catch (e) {
                alert("AI è§£æå¤±è´¥: " + e.message);
                console.error(e);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // ä¿å­˜è®°å½•
        window.saveRecord = async () => {
            if (!currentUser) return;
            const record = {
                date: document.getElementById('f_date').value,
                dep: document.getElementById('f_dep').value,
                arr: document.getElementById('f_arr').value,
                category: document.getElementById('f_cat').value,
                air_time: parseFloat(document.getElementById('f_air').value) || 0,
                block_days: parseInt(document.getElementById('f_block_days').value) || 0,
                night1: parseFloat(document.getElementById('f_night1').value) || 0,
                night2: parseFloat(document.getElementById('f_night2').value) || 0,
                overnight: document.getElementById('f_overnight').value,
                overnight_days: parseInt(document.getElementById('f_overnight_days').value) || 0, // æ–°å¢å­—æ®µ
                meal_d: parseInt(document.getElementById('f_meal_d').value) || 0,
                meal_i: parseInt(document.getElementById('f_meal_i').value) || 0,
                holiday: parseInt(document.getElementById('f_holiday').value) || 0,
                timestamp: new Date()
            };

            try {
                await addDoc(collection(db, `users/${currentUser.uid}/logs`), record);
                document.getElementById('editForm').style.display = 'none';
                document.getElementById('ocrInput').value = '';
                // è‡ªåŠ¨è·³è½¬åˆ°æŠ¥è¡¨é¡µæŸ¥çœ‹ç»“æœ
                switchTab('report');
            } catch (e) { alert("ä¿å­˜å¤±è´¥: " + e.message); }
        };

        // åˆ é™¤æŒ‡å®šè®°å½•
        window.deleteItem = async (docId) => {
            if(confirm("âš ï¸ ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿåˆ é™¤åç»Ÿè®¡æŠ¥è¡¨ä¼šè‡ªåŠ¨æ›´æ–°ã€‚")) {
                try {
                    await deleteDoc(doc(db, `users/${currentUser.uid}/logs`, docId));
                    // ä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨ renderï¼ŒonSnapshot ä¼šè‡ªåŠ¨å¤„ç†
                } catch(e) { alert("åˆ é™¤å¤±è´¥: " + e.message); }
            }
        };

        // æ¸²æŸ“åˆ—è¡¨ (åŒ…å«åˆ é™¤æŒ‰é’®)
        window.renderList = () => {
            const listDiv = document.getElementById('logList');
            if (allRecords.length === 0) {
                listDiv.innerHTML = '<p style="text-align:center; color:#94a3b8; padding:20px;">æš‚æ— è®°å½•ï¼Œè¯·å»â€œæ™ºèƒ½å½•å…¥â€é¡µæ·»åŠ ã€‚</p>';
                return;
            }
            listDiv.innerHTML = allRecords.map(r => `
                <div class="log-card">
                    <div class="log-info">
                        <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px; display:flex; justify-content:space-between;">
                            <span>${r.date}</span>
                            <span style="color:#2563eb">${r.dep} â” ${r.arr}</span>
                        </div>
                        <div style="font-size: 0.85rem; color: #64748b; margin-bottom:4px;">
                            â±ï¸ ç©ºä¸­ ${r.air_time}h | ğŸŒ™ å¤œ ${(r.night1+r.night2).toFixed(2)}h
                        </div>
                        <div>
                            <span class="tag ${r.category}">${r.category}</span>
                            ${r.overnight_days > 0 ? `<span class="tag" style="background:#fef3c7; color:#d97706">ğŸ  ${r.overnight} ${r.overnight_days}å¤©</span>` : ''}
                        </div>
                    </div>
                    <div class="log-actions">
                        <button class="btn btn-danger btn-sm" onclick="deleteItem('${r.id}')" title="åˆ é™¤æ­¤æ¡">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        };

        // æ¸²æŸ“æŠ¥è¡¨ (æ›´æ–°ç»Ÿè®¡é€»è¾‘)
        window.renderReport = () => {
            const monthStr = document.getElementById('reportMonth').value;
            const [y, m] = monthStr.split('-');
            const data = allRecords.filter(r => r.date.startsWith(monthStr));

            // åˆå§‹åŒ–ç»Ÿè®¡
            const s = { 
                d_air:0, d_bk:0, h_air:0, h_bk:0, a_air:0, a_bk:0, i_air:0, i_bk:0,
                n1:0, n2:0, 
                o_d0:0, o_d1:0, o_i0:0, o_i1:0, // è¿™é‡Œç°åœ¨ç»Ÿè®¡çš„æ˜¯â€œå¤©æ•°â€
                m_d:0, m_i:0, hol:0 
            };

            data.forEach(r => {
                // é£è¡Œæ—¶é—´æ±‡æ€»
                if(r.category==='å›½å†…') { s.d_air+=r.air_time; s.d_bk+=r.block_days; }
                else if(r.category==='æ¸¯æ¾³å°') { s.h_air+=r.air_time; s.h_bk+=r.block_days; }
                else if(r.category==='äºšæ´²å›½é™…') { s.a_air+=r.air_time; s.a_bk+=r.block_days; }
                else { s.i_air+=r.air_time; s.i_bk+=r.block_days; }
                
                s.n1+=r.night1; s.n2+=r.night2;
                s.m_d+=r.meal_d; s.m_i+=r.meal_i;
                s.hol+=r.holiday;

                // é©»å¤–å¤©æ•°æ±‡æ€» (ä½¿ç”¨æ–°å­—æ®µ r.overnight_days)
                // å¦‚æœæ²¡æœ‰å¤©æ•°ä½†é€‰æ‹©äº†æœ‰è¿‡å¤œï¼Œé»˜è®¤+1ï¼Œæˆ–è€…æ ¹æ®æ‚¨çš„è§„åˆ™è¿™é‡Œæ”¹ä¸º +r.overnight_days
                const days = r.overnight_days || 0; 
                
                if(r.overnight==='å›½å†…æ— è¿‡å¤œ') s.o_d0 += days; // é€šå¸¸æ— è¿‡å¤œå¤©æ•°ä¸º0ï¼Œä½†ä»¥é˜²ä¸‡ä¸€
                if(r.overnight==='å›½å†…æœ‰è¿‡å¤œ') s.o_d1 += days;
                if(r.overnight==='å›½é™…æ— è¿‡å¤œ') s.o_i0 += days;
                if(r.overnight==='å›½é™…æœ‰è¿‡å¤œ') s.o_i1 += days;
            });

            const totalAir = s.d_air + s.h_air + s.a_air + s.i_air;

            document.getElementById('reportTable').innerHTML = `
                <thead>
                    <tr><th colspan="16" style="background:#e2e8f0; font-size:1.1rem; padding:10px;">
                        ${y}å¹´${m}æœˆ é£è¡Œæ•°æ®æ±‡æ€» (æ€»è®¡: ${totalAir.toFixed(2)}h)
                    </th></tr>
                    <tr>
                        <th rowspan="2" style="width:80px;">äººå‘˜</th>
                        <th colspan="2">å›½å†…é£è¡Œ</th><th colspan="2">æ¸¯æ¾³å°</th>
                        <th colspan="2">äºšæ´²(éæ¸¯æ¾³)</th><th colspan="2">äºšæ´²ä»¥å¤–</th>
                        <th colspan="2">å¤œèˆª(å›½å†…)</th>
                        <th colspan="4" class="highlight-cell">é©»å¤–è¡¥åŠ©(å¤©æ•°)</th>
                        <th colspan="2">æœºç»„é¤</th>
                    </tr>
                    <tr>
                        <th>ç©ºä¸­</th><th>æ»‘è¡Œ</th><th>ç©ºä¸­</th><th>æ»‘è¡Œ</th>
                        <th>ç©ºä¸­</th><th>æ»‘è¡Œ</th><th>ç©ºä¸­</th><th>æ»‘è¡Œ</th>
                        <th>18:30+</th><th>00:00+</th>
                        <th style="font-size:0.75rem">å›½æ— </th><th style="font-size:0.75rem">å›½æœ‰</th>
                        <th style="font-size:0.75rem">å¤–æ— </th><th style="font-size:0.75rem">å¤–æœ‰</th>
                        <th>å›½</th><th>å¤–</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="font-weight:bold">${currentUser ? currentUser.displayName.split(' ')[0] : '-'}</td>
                        <td>${s.d_air.toFixed(2)}</td><td>${s.d_bk}</td>
                        <td>${s.h_air.toFixed(2)}</td><td>${s.h_bk}</td>
                        <td>${s.a_air.toFixed(2)}</td><td>${s.a_bk}</td>
                        <td>${s.i_air.toFixed(2)}</td><td>${s.i_bk}</td>
                        <td>${s.n1.toFixed(2)}</td><td>${s.n2.toFixed(2)}</td>
                        
                        <!-- é©»å¤–å¤©æ•°æ˜¾ç¤ºåŒº -->
                        <td class="highlight-cell">${s.o_d0}</td>
                        <td class="highlight-cell">${s.o_d1}</td>
                        <td class="highlight-cell">${s.o_i0}</td>
                        <td class="highlight-cell">${s.o_i1}</td>
                        
                        <td>${s.m_d}</td><td>${s.m_i}</td>
                    </tr>
                </tbody>
            `;
        };
    </script>
</body>
</html>
