<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£è¡Œæ—¥å¿— - 2025 æ——èˆ°è¿›åŒ–ç‰ˆ</title>
    <style>
        /* === åŸºç¡€æ ·å¼ === */
        :root { --primary: #2563eb; --bg: #f1f5f9; --text: #334155; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg); color: var(--text);
            padding: 20px; min-height: 100vh;
        }
        .container { max-width: 1100px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }

        /* å¡ç‰‡ */
        .card {
            background: white; border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            overflow: hidden; border: 1px solid #e2e8f0;
        }
        .card-header {
            padding: 15px 20px; background: linear-gradient(to right, #f8fafc, #fff);
            border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;
        }
        .card-header h2 { font-size: 1.1rem; color: #1e293b; font-weight: 700; }
        .card-body { padding: 20px; }

        /* é¡¶éƒ¨æ  */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--primary); color: white; padding: 15px 25px;
            border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3);
        }

        /* æŠ¥è¡¨è¡¨æ ¼ */
        .table-scroll { overflow-x: auto; border-radius: 8px; border: 1px solid #cbd5e1; }
        .excel-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 900px; }
        .excel-table th, .excel-table td { border: 1px solid #cbd5e1; padding: 8px 6px; text-align: center; }
        .excel-table th { background: #f1f5f9; font-weight: 600; }
        .bg-sub { background-color: #fdf4ff; color: #86198f; font-weight: bold; }

        /* AI è¾“å…¥åŒº */
        .ai-input-area { position: relative; }
        .key-input { 
            position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9);
            padding: 5px 10px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 0.8rem; width: 200px;
        }
        textarea {
            width: 100%; height: 100px; padding: 15px; border: 2px dashed #cbd5e1;
            border-radius: 12px; resize: vertical; font-family: monospace; background: #f8fafc;
        }
        
        /* è¡¨å• */
        .edit-form { background: #f8fafc; padding: 20px; border-radius: 12px; margin-top: 15px; border: 1px solid #e2e8f0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
        .form-full-width { grid-column: 1 / -1; }
        .form-group label { display: block; font-size: 0.75rem; margin-bottom: 4px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; }
        
        /* æ—¶é—´æ˜¾ç¤ºè¾…åŠ©æ–‡å­— (å°æ—¶:åˆ†é’Ÿ) */
        .time-hint { font-size: 0.7rem; color: #2563eb; font-weight: bold; margin-left: 5px; }

        /* æ—¥å† */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
        .cal-header { text-align: center; font-size: 0.8rem; color: #64748b; }
        .cal-day {
            border: 1px solid #e2e8f0; border-radius: 6px; min-height: 60px; background: white;
            padding: 4px; cursor: pointer; display: flex; flex-direction: column;
        }
        .cal-day:hover { border-color: var(--primary); }
        .cal-num { font-size: 0.75rem; font-weight: bold; color: #94a3b8; }
        .cal-status { 
            font-size: 0.7rem; padding: 2px; border-radius: 3px; text-align: center; margin-top: auto; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .status-base { background: #f1f5f9; color: #94a3b8; }
        .status-stay { background: #fef3c7; color: #d97706; border: 1px solid #fcd34d; }

        /* å†å²åˆ—è¡¨ */
        .log-list { max-height: 500px; overflow-y: auto; }
        .log-item { background: white; border: 1px solid #e2e8f0; border-radius: 10px; margin-bottom: 10px; padding: 15px; }
        .log-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .log-route { font-weight: 700; color: #1e293b; }
        .btn-del { background: #fee2e2; color: #dc2626; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        
        /* æŒ‰é’® */
        .btn { padding: 8px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
        .btn-primary { background: var(--primary); color: white; }
        
        .login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            display: flex; justify-content: center; align-items: center; z-index: 999;
        }
        .login-box { background: white; padding: 40px; border-radius: 20px; text-align: center; width: 320px; }
    </style>
</head>
<body>

    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <h2 style="color: var(--primary); margin-bottom: 20px;">âœˆï¸ é£è¡Œæ—¥å¿—</h2>
            <button class="btn btn-primary" style="width: 100%; padding: 12px;" onclick="loginWithGoogle()">Google è´¦å·ç™»å½•</button>
        </div>
    </div>

    <div id="app" class="container" style="display: none;">
        <div class="top-bar">
            <div><h1 style="font-size: 1.25rem;">é£è¡Œå‘˜æ§åˆ¶å°</h1><span id="userInfo" style="font-size: 0.8rem; opacity: 0.9;">æœªç™»å½•</span></div>
            <button class="btn" style="background: rgba(255,255,255,0.2); color: white;" onclick="doLogout()">é€€å‡º</button>
        </div>

        <!-- 1. ç»Ÿè®¡ -->
        <section class="card">
            <div class="card-header">
                <h2>ğŸ“Š è–ªé…¬ç»Ÿè®¡</h2>
                <input type="month" id="reportMonth" onchange="refreshAll()" style="border: 1px solid #cbd5e1; padding: 4px; border-radius: 4px;">
            </div>
            <div class="card-body">
                <div class="table-scroll"><table class="excel-table" id="reportTable"></table></div>
            </div>
        </section>

        <!-- 2. å½•å…¥ -->
        <section class="card">
            <div class="card-header">
                <h2>ğŸ“ æ™ºèƒ½å½•å…¥</h2>
                <span style="font-size: 0.8rem; color: #64748b;">AI è‡ªåŠ¨è®¡ç®—æ—¶é—´ä¸è¯†åˆ«åŒºåŸŸ</span>
            </div>
            <div class="card-body">
                <div class="ai-input-area">
                    <input type="password" id="innerApiKey" class="key-input" placeholder="DeepSeek Key">
                    <textarea id="ocrInput" placeholder="ç¤ºä¾‹ï¼š5æœˆ20æ—¥ CA1234 åŒ—äº¬-ä¸Šæµ· æœºé•¿ç‹å†› å‰¯é©¾ææ˜&#10;10:00æ’¤è½®æŒ¡ 10:20èµ·é£ 12:20è½åœ° 12:30æŒ¡è½®æŒ¡&#10;é©»å¤–ä¸Šæµ·2å¤© ç‰¹æ®Šæœºåœº"></textarea>
                </div>
                <div style="text-align: right; margin-top: 10px;">
                    <button id="aiBtn" class="btn btn-primary" onclick="processAI()">âœ¨ AI è¯†åˆ« & è®¡ç®—</button>
                </div>

                <div id="editForm" class="edit-form" style="display: none;">
                    <div class="form-grid">
                        <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="f_date"></div>
                        <div class="form-group"><label>èµ·é£æœºåœº (ä»£ç +ä¸­æ–‡)</label><input type="text" id="f_dep"></div>
                        <div class="form-group"><label>è½åœ°æœºåœº (ä»£ç +ä¸­æ–‡)</label><input type="text" id="f_arr"></div>
                        <div class="form-group"><label>åŒºåŸŸ (AIè‡ªåŠ¨åˆ¤æ–­)</label>
                            <select id="f_cat"><option value="å›½å†…">å›½å†…</option><option value="æ¸¯æ¾³å°">æ¸¯æ¾³å°</option><option value="äºšæ´²å›½é™…">äºšæ´²å›½é™…</option><option value="æ´²é™…">æ´²é™…</option></select>
                        </div>
                        <div class="form-group form-full-width"><label>æœºç»„å…¨å‘˜</label><input type="text" id="f_crew"></div>
                        
                        <div class="form-group form-full-width" style="background:white; padding:10px; border-radius:8px; border:1px solid #e2e8f0;">
                            <label style="text-align:center; margin-bottom:8px;">â±ï¸ è¿è¡Œæ—¶åˆ» (æ›´æ”¹åè‡ªåŠ¨é‡ç®—æ—¶é•¿)</label>
                            <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:5px;">
                                <div><label style="text-align:center">å¼€è½¦</label><input type="time" id="f_block_off" onchange="recalcTimes()"></div>
                                <div><label style="text-align:center">èµ·é£</label><input type="time" id="f_takeoff" onchange="recalcTimes()"></div>
                                <div><label style="text-align:center">è½åœ°</label><input type="time" id="f_landing" onchange="recalcTimes()"></div>
                                <div><label style="text-align:center">å…³è½¦</label><input type="time" id="f_block_on" onchange="recalcTimes()"></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>ç©ºä¸­æ—¶é—´ <span id="air_hint" class="time-hint">(0h 0m)</span></label>
                            <input type="number" step="0.01" id="f_air">
                        </div>
                        <div class="form-group">
                            <label>æ€»æ—¶é—´ <span id="total_hint" class="time-hint">(0h 0m)</span></label>
                            <input type="number" step="0.01" id="f_total_time">
                        </div>
                        
                        <div class="form-group"><label>å¤œèˆª18:30+</label><input type="number" step="0.1" id="f_night1"></div>
                        <div class="form-group"><label>å¤œèˆª00:00+</label><input type="number" step="0.1" id="f_night2"></div>
                        
                        <div class="form-group"><label>é©»å¤–ç±»å‹</label>
                            <select id="f_overnight">
                                <option value="æ— ">æ—  (æœ¬æ¡ä¸è®¡)</option>
                                <option value="å›½å†…æ— è¿‡å¤œ">å›½å†…æ— è¿‡å¤œ</option><option value="å›½å†…æœ‰è¿‡å¤œ">å›½å†…æœ‰è¿‡å¤œ</option>
                                <option value="å›½é™…æ— è¿‡å¤œ">å›½é™…æ— è¿‡å¤œ</option><option value="å›½é™…æœ‰è¿‡å¤œ">å›½é™…æœ‰è¿‡å¤œ</option>
                            </select>
                        </div>
                        <div class="form-group"><label>é©»å¤–åŸå¸‚</label><input type="text" id="f_overnight_city"></div>
                        <div class="form-group"><label>é©»å¤–å¤©æ•°</label><input type="number" id="f_overnight_days" value="0"></div>
                        
                        <div class="form-group"><label>ç‰¹æ®Šæœºåœº</label><input type="number" id="f_special" value="0"></div>
                        <div class="form-group"><label>èŠ‚å‡æ—¥</label><input type="number" id="f_holiday" value="0"></div>
                        <div class="form-group"><label>æ»‘è¡Œ(æ¬¡)</label><input type="number" id="f_block_days" value="1"></div>
                    </div>
                    <div style="margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">
                        <button class="btn" style="background: #e2e8f0;" onclick="document.getElementById('editForm').style.display='none'">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="saveRecord()">ğŸ’¾ ä¿å­˜</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. æ—¥å† -->
        <section class="card">
            <div class="card-header">
                <h2>ğŸ“… æ‰§å‹¤æ—¥å†</h2>
                <span style="font-size:0.8rem; color:#64748b">ç‚¹å‡»æ—¥æœŸå¯æ‰‹åŠ¨ä¿®æ”¹</span>
            </div>
            <div class="card-body">
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
        </section>

        <!-- 4. å†å² -->
        <section class="card">
            <div class="card-header"><h2>ğŸ“‹ å†å²è®°å½•</h2></div>
            <div class="card-body"><div id="logList" class="log-list"></div></div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCFk4f7bKUHlb3d1Cg1jyS1EM-SPC4pr40",
            authDomain: "myflightlog-1f4cb.firebaseapp.com",
            projectId: "myflightlog-1f4cb",
            storageBucket: "myflightlog-1f4cb.firebasestorage.app",
            messagingSenderId: "181072044112",
            appId: "1:181072044112:web:ca312da2d4780227cef155"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        let currentUser = null, allRecords = [], calendarData = {};

        window.loginWithGoogle = async () => { try { await signInWithPopup(auth, provider); } catch (e) { alert(e.message); } };
        window.doLogout = async () => { await signOut(auth); };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userInfo').textContent = `ğŸ‘¨â€âœˆï¸ ${user.displayName}`;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                document.getElementById('reportMonth').value = new Date().toISOString().slice(0, 7);
                if(localStorage.getItem("openai_key")) document.getElementById("innerApiKey").value = localStorage.getItem("openai_key");

                onSnapshot(query(collection(db, `users/${user.uid}/logs`), orderBy("date", "desc")), (snap) => {
                    allRecords = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    refreshAll();
                });
                onSnapshot(collection(db, `users/${user.uid}/calendar_status`), (snap) => {
                    calendarData = {};
                    snap.docs.forEach(d => calendarData[d.id] = d.data().status);
                    renderCalendar();
                });
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
        });

        window.refreshAll = () => { renderList(); renderReport(); renderCalendar(); };

        // === æ ¸å¿ƒæ—¶é—´è®¡ç®—å‡½æ•° ===
        // å°† HH:MM è½¬æ¢ä¸º å°æ—¶å°æ•°ï¼Œå¹¶å¤„ç†è·¨å¤©é€»è¾‘
        function calculateDuration(start, end) {
            if(!start || !end) return 0;
            let [h1, m1] = start.split(':').map(Number);
            let [h2, m2] = end.split(':').map(Number);
            let min1 = h1 * 60 + m1;
            let min2 = h2 * 60 + m2;
            if (min2 < min1) min2 += 24 * 60; // è·¨å¤©å¤„ç†
            return Number(((min2 - min1) / 60).toFixed(2));
        }

        // å°†å°æ•°å°æ—¶è½¬æ¢ä¸ºæ˜¾ç¤ºæ–‡å­— (2.5 -> 2h 30m)
        function formatDuration(hours) {
            if(!hours) return "(0h 0m)";
            let h = Math.floor(hours);
            let m = Math.round((hours - h) * 60);
            return `(${h}å°æ—¶ ${m}åˆ†)`;
        }

        // é¡µé¢ä¸Šæ‰‹åŠ¨ä¿®æ”¹æ—¶é—´è§¦å‘é‡ç®—
        window.recalcTimes = () => {
            const t_off = document.getElementById('f_block_off').value;
            const t_to = document.getElementById('f_takeoff').value;
            const t_ldg = document.getElementById('f_landing').value;
            const t_on = document.getElementById('f_block_on').value;

            // è®¡ç®—ç©ºä¸­ï¼šè½åœ° - èµ·é£
            const air = calculateDuration(t_to, t_ldg);
            document.getElementById('f_air').value = air;
            document.getElementById('air_hint').textContent = formatDuration(air);

            // è®¡ç®—æ€»æ—¶é—´ï¼šå…³è½¦ - å¼€è½¦
            const total = calculateDuration(t_off, t_on);
            document.getElementById('f_total_time').value = total;
            document.getElementById('total_hint').textContent = formatDuration(total);
        };

        // === AI è¯†åˆ« ===
        window.processAI = async () => {
            const text = document.getElementById('ocrInput').value;
            const apiKey = document.getElementById('innerApiKey').value;
            if (!apiKey) return alert("è¯·è¾“å…¥Key");
            localStorage.setItem("openai_key", apiKey);

            const btn = document.getElementById('aiBtn');
            btn.textContent = "â³ è¿ç®—ä¸­..."; btn.disabled = true;

            const prompt = `
            è¯†åˆ«æ–‡æœ¬ã€‚è‹¥æ˜¯æ’ç­æŒ‡ä»¤(7,8 æ²ˆé˜³)è¿”å›type="calendar"ã€‚
            è‹¥æ˜¯é£è¡Œ:
            1. æœºåœº dep/arr æ ¼å¼ä¸º"ä»£ç  ä¸­æ–‡å" (å¦‚ "ZBAA åŒ—äº¬é¦–éƒ½")ã€‚è‹¥åªæä¾›ä¸€ä¸ªï¼Œè¯·è¡¥å…¨å¦ä¸€ä¸ªã€‚
            2. category è‡ªåŠ¨åˆ¤æ–­: å›½å†…/æ¸¯æ¾³å°/äºšæ´²å›½é™…/æ´²é™…ã€‚
            3. crew æå–æ‰€æœ‰æœºç»„äººå‘˜ã€‚
            4. time_off/takeoff/landing/on æå– HH:MMã€‚
            5. æå– overnight_days (å¤©æ•°)ã€‚
            
            è¿”å›JSONã€‚
            å­—æ®µ: type, dates[], status, date, dep, arr, category, crew, time_off, time_takeoff, time_landing, time_on, night1, night2, overnight, overnight_city, overnight_days, special_airport, holiday.
            `;

            try {
                const res = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: "deepseek-chat", messages: [{role: "user", content: prompt}], temperature: 0.1 })
                });
                const data = await res.json();
                const r = JSON.parse(data.choices[0].message.content.match(/\{[\s\S]*\}/)[0]);

                if (r.type === 'calendar') {
                    await Promise.all(r.dates.map(d => setDoc(doc(db, `users/${currentUser.uid}/calendar_status`, d), { status: r.status })));
                    alert("âœ… æ—¥å†å·²æ›´æ–°");
                } else {
                    const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
                    setVal('f_date', r.date); setVal('f_dep', r.dep); setVal('f_arr', r.arr);
                    setVal('f_cat', r.category); setVal('f_crew', r.crew);
                    
                    // å¡«å…¥æ—¶é—´
                    setVal('f_block_off', r.time_off); setVal('f_takeoff', r.time_takeoff);
                    setVal('f_landing', r.time_landing); setVal('f_block_on', r.time_on);
                    
                    // â˜…â˜…â˜… æ ¸å¿ƒï¼šè°ƒç”¨ JS é‡ç®—é€»è¾‘ï¼Œä¿è¯æ•°å­¦ç²¾å‡† â˜…â˜…â˜…
                    recalcTimes(); 

                    setVal('f_night1', r.night1); setVal('f_night2', r.night2);
                    setVal('f_overnight', r.overnight || 'æ— ');
                    setVal('f_overnight_city', r.overnight_city || (r.overnight!=='æ— '?r.dep:''));
                    setVal('f_overnight_days', r.overnight_days);
                    setVal('f_special', r.special_airport); setVal('f_holiday', r.holiday);
                    document.getElementById('editForm').style.display = 'block';
                }
            } catch (e) { alert("é”™è¯¯: " + e.message); } 
            finally { btn.textContent = "âœ¨ AI è¯†åˆ« & è®¡ç®—"; btn.disabled = false; }
        };

        window.saveRecord = async () => {
            const getNum = (id) => parseFloat(document.getElementById(id).value) || 0;
            const getStr = (id) => document.getElementById(id).value;
            let ovCity = getStr('f_overnight_city');
            if(!ovCity && getStr('f_overnight') !== 'æ— ') ovCity = getStr('f_dep'); // æ™ºèƒ½é»˜è®¤

            const record = {
                date: getStr('f_date'), dep: getStr('f_dep'), arr: getStr('f_arr'), category: getStr('f_cat'), crew: getStr('f_crew'),
                block_off: getStr('f_block_off'), takeoff: getStr('f_takeoff'), landing: getStr('f_landing'), block_on: getStr('f_block_on'),
                air_time: getNum('f_air'), total_time: getNum('f_total_time'),
                block_days: getNum('f_block_days'), night1: getNum('f_night1'), night2: getNum('f_night2'),
                overnight: getStr('f_overnight'), overnight_city: ovCity, overnight_days: getNum('f_overnight_days'),
                special_airport: getNum('f_special'), holiday: getNum('f_holiday'), timestamp: new Date()
            };
            await addDoc(collection(db, `users/${currentUser.uid}/logs`), record);
            document.getElementById('editForm').style.display = 'none';
            document.getElementById('ocrInput').value = '';
        };

        window.deleteItem = async (id) => { if(confirm("åˆ é™¤?")) try{ await deleteDoc(doc(db, `users/${currentUser.uid}/logs`, id)); }catch(e){alert(e.message)} };

        // æ—¥å†é€»è¾‘
        window.renderCalendar = () => {
            const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
            const [y, m] = document.getElementById('reportMonth').value.split('-').map(Number);
            const daysInMonth = new Date(y, m, 0).getDate();
            const firstDay = new Date(y, m - 1, 1).getDay();
            
            for(let i=0; i<firstDay; i++) grid.innerHTML += '<div></div>';
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const flights = allRecords.filter(r => r.date === dateStr);
                let statusText = calendarData[dateStr] || (flights.find(r=>r.overnight!=='æ— ')?.overnight_city) || "æ²ˆé˜³";
                if(['æ²ˆé˜³','SHE','æ— ','åŸºåœ°'].includes(statusText)) statusText = "æ²ˆé˜³";

                const cell = document.createElement('div'); cell.className = 'cal-day';
                cell.onclick = async () => {
                    const n = prompt("ä¿®æ”¹é©»å¤–:", statusText);
                    if(n && n!==statusText) await setDoc(doc(db, `users/${currentUser.uid}/calendar_status`, dateStr), {status:n});
                };
                cell.innerHTML = `<div class="cal-num">${d}</div>
                    <div style="flex:1;display:flex;flex-direction:column;gap:2px">
                        ${flights.length?'<div style="background:#2563eb;height:4px;width:4px;border-radius:50%;align-self:center"></div>':''}
                        <div class="cal-status ${statusText==='æ²ˆé˜³'?'status-base':'status-stay'}">${statusText}</div>
                    </div>`;
                grid.appendChild(cell);
            }
        };

        window.renderList = () => {
            const el = document.getElementById('logList');
            el.innerHTML = allRecords.length ? allRecords.map(r => `
                <div class="log-item">
                    <div class="log-header">
                        <div><span style="color:#64748b;font-family:monospace;margin-right:10px">${r.date}</span><span class="log-route">${r.dep} â” ${r.arr}</span></div>
                        <button class="btn-del" onclick="deleteItem('${r.id}')">åˆ é™¤</button>
                    </div>
                    <div style="font-size:0.85rem;color:#475569;margin-bottom:5px">ğŸ‘¨â€âœˆï¸ ${r.crew||'-'}</div>
                    <div style="font-size:0.85rem;color:#475569;display:flex;gap:15px">
                        <span>â˜ï¸${r.air_time}h</span> <span>âŒš${r.total_time}h</span>
                        <span>${r.category}</span>
                        ${r.overnight!=='æ— '?`<span style="background:#e0f2fe;color:#0284c7;padding:1px 4px;border-radius:4px">ğŸ ${r.overnight_city} ${r.overnight_days}å¤©</span>`:''}
                    </div>
                </div>`).join('') : '<div style="text-align:center;color:#ccc">æ— è®°å½•</div>';
        };

        window.renderReport = () => {
            const mStr = document.getElementById('reportMonth').value;
            const data = allRecords.filter(r => r.date.startsWith(mStr));
            const s = { d_a:0, d_b:0, h_a:0, h_b:0, a_a:0, a_b:0, i_a:0, i_b:0, n1:0, n2:0, spec:0, hol:0, o_d:0, o_i:0 };
            
            data.forEach(r => {
                if(r.category==='å›½å†…') { s.d_a+=r.air_time; s.d_b+=r.block_days; }
                else if(r.category==='æ¸¯æ¾³å°') { s.h_a+=r.air_time; s.h_b+=r.block_days; }
                else if(r.category==='äºšæ´²å›½é™…') { s.a_a+=r.air_time; s.a_b+=r.block_days; }
                else { s.i_a+=r.air_time; s.i_b+=r.block_days; }
                
                s.n1+=r.night1; s.n2+=r.night2; s.spec+=r.special_airport; s.hol+=r.holiday;
                if(r.overnight.includes('å›½å†…æœ‰è¿‡å¤œ')) s.o_d += r.overnight_days;
                if(r.overnight.includes('å›½é™…æœ‰è¿‡å¤œ')) s.o_i += r.overnight_days;
            });

            document.getElementById('reportTable').innerHTML = `
                <thead>
                    <tr><th rowspan="2">ç±»å‹</th><th colspan="2">å›½å†…</th><th colspan="2">æ¸¯æ¾³å°</th><th colspan="2">äºšæ´²</th><th colspan="2">æ´²é™…</th></tr>
                    <tr><th>ç©º</th><th>æ»‘</th><th>ç©º</th><th>æ»‘</th><th>ç©º</th><th>æ»‘</th><th>ç©º</th><th>æ»‘</th></tr>
                </thead>
                <tbody>
                    <tr><td>é£è¡Œ</td><td>${s.d_a.toFixed(2)}</td><td>${s.d_b}</td><td>${s.h_a.toFixed(2)}</td><td>${s.h_b}</td><td>${s.a_a.toFixed(2)}</td><td>${s.a_b}</td><td>${s.i_a.toFixed(2)}</td><td>${s.i_b}</td></tr>
                    <tr><td colspan="9" style="background:#f8fafc;height:5px;padding:0"></td></tr>
                    <tr><th rowspan="2">è¡¥åŠ©</th><th colspan="2">å¤œèˆª</th><th colspan="2">ç‰¹æ®Š/èŠ‚å‡</th><th colspan="2">é©»å¤–å¤©æ•°</th><th colspan="2"></th></tr>
                    <tr><th>18:30</th><th>00:00</th><th class="bg-sub">ç‰¹æ®Š</th><th class="bg-sub">å‡æ—¥</th><th>å›½æœ‰</th><th>å¤–æœ‰</th><th>-</th><th>-</th></tr>
                    <tr><td>ç»Ÿè®¡</td><td>${s.n1.toFixed(1)}</td><td>${s.n2.toFixed(1)}</td><td class="bg-sub">${s.spec}</td><td class="bg-sub">${s.hol}</td><td>${s.o_d}</td><td>${s.o_i}</td><td>-</td><td>-</td></tr>
                </tbody>`;
        };
    </script>
</body>
</html>
