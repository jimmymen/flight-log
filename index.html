<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£è¡Œæ—¥å¿— Pro - 2025 ç»ˆæç‰ˆ</title>
    <style>
        /* === åŸºç¡€å˜é‡ === */
        :root {
            --primary: #2563eb; --primary-dark: #1e40af;
            --bg: #f8fafc; --text: #334155; --border: #e2e8f0;
            --success: #10b981; --success-bg: #d1fae5; --success-text: #065f46;
            --danger: #ef4444; --warning: #f59e0b;
            --stay: #d97706; --stay-bg: #fffbeb; --stay-border: #fcd34d;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg); color: var(--text);
            padding: 15px; min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; padding-bottom: 40px; }

        /* é€šç”¨ç»„ä»¶ */
        .card {
            background: white; border-radius: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            border: 1px solid var(--border); overflow: hidden;
        }
        .card-header {
            padding: 15px 20px; background: #fff; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;
        }
        .card-header h2 { font-size: 1.1rem; color: #0f172a; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .card-body { padding: 20px; }
        
        /* é¡¶éƒ¨æ  */
        .top-bar {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; padding: 16px 24px; border-radius: 16px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 10px -2px rgba(37, 99, 235, 0.3);
        }
        .user-pill { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; backdrop-filter: blur(4px); }

        /* æŠ¥è¡¨è¡¨æ ¼ */
        .table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); }
        .excel-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 800px; }
        .excel-table th, .excel-table td { border: 1px solid var(--border); padding: 10px 8px; text-align: center; }
        .excel-table th { background: #f8fafc; font-weight: 600; color: #475569; }
        .bg-sub { background-color: #fdf4ff; color: #86198f; font-weight: bold; }

        /* AI è¾“å…¥åŒº */
        .ai-box { position: relative; border: 2px dashed var(--border); border-radius: 12px; padding: 10px; background: #f8fafc; transition: 0.2s; }
        .ai-box:focus-within { border-color: var(--primary); background: #eff6ff; }
        .key-input { 
            position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.95);
            padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); font-size: 0.75rem; width: 180px;
        }
        textarea {
            width: 100%; height: 100px; padding: 15px; border: none; background: transparent;
            font-family: monospace; font-size: 0.95rem; resize: none; outline: none;
        }

        /* è¡¨å• */
        .edit-form { background: #fff; padding: 20px; border-radius: 12px; margin-top: 20px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.05); position: relative; }
        .form-tag { position: absolute; top: -10px; left: 20px; background: var(--primary); color: white; padding: 4px 12px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .form-full { grid-column: 1 / -1; }
        .form-group label { display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 6px; font-weight: 600; }
        .form-group input, .form-group select { 
            width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; 
            font-size: 0.9rem; outline: none; transition: 0.2s; background: #fdfdfd;
        }
        .form-group input:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        
        /* === å¢å¼ºæ—¥å† === */
        .calendar-wrapper { user-select: none; }
        .calendar-header { 
            display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; 
            font-size: 0.8rem; color: #94a3b8; font-weight: 600; padding: 10px 0;
        }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .cal-day {
            background: #fff; border: 1px solid var(--border); border-radius: 10px; min-height: 95px;
            padding: 6px; display: flex; flex-direction: column; position: relative; cursor: pointer;
            transition: all 0.2s ease;
        }
        .cal-day:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); z-index: 10; }
        .cal-day.today { border: 2px solid var(--primary); background: #eff6ff; }
        
        .cal-num { font-size: 0.85rem; font-weight: 700; color: #cbd5e1; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .cal-day.today .cal-num { color: var(--primary); }
        
        /* é£è¡Œæ¡ç›® */
        .cal-flights { flex: 1; display: flex; flex-direction: column; gap: 3px; margin-bottom: 4px; overflow: hidden; }
        .flight-tag {
            padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; color: #fff;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); white-space: nowrap;
        }
        .tag-dom { background: #3b82f6; } 
        .tag-int { background: #8b5cf6; } 
        
        /* åº•éƒ¨çŠ¶æ€æ¡ */
        .cal-status { 
            font-size: 0.65rem; padding: 2px 4px; border-radius: 4px; text-align: center; 
            margin-top: auto; font-weight: 600; color: #64748b; background: #f1f5f9;
        }
        .status-stay { background: var(--stay-bg); color: var(--stay); border: 1px solid var(--stay-border); }
        .status-return { background: var(--success-bg); color: var(--success-text); border: 1px solid #a7f3d0; }

        /* åˆ—è¡¨ä¸æŒ‰é’® */
        .log-list { max-height: 450px; overflow-y: auto; padding-right: 5px; }
        .log-item { 
            background: #fff; border: 1px solid var(--border); border-radius: 10px; 
            padding: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;
            transition: 0.2s;
        }
        .log-item:hover { border-color: var(--primary); }
        .log-info { display: flex; flex-direction: column; gap: 4px; }
        .log-actions { display: flex; gap: 8px; }
        
        .btn { 
            padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; 
            font-weight: 600; font-size: 0.9rem; transition: 0.2s; display: inline-flex; align-items: center; gap: 6px; justify-content: center;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); box-shadow: 0 4px 12px rgba(37,99,235,0.3); }
        .btn-edit { background: #eff6ff; color: var(--primary); padding: 6px 12px; font-size: 0.8rem; }
        .btn-danger { background: #fee2e2; color: #ef4444; padding: 6px 12px; font-size: 0.8rem; }
        .btn-ghost { background: transparent; color: #64748b; }
        
        /* ç™»å½•é®ç½© */
        .login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #3b82f6 0%, #1e3a8a 100%);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .login-card { background: white; padding: 40px; border-radius: 24px; width: 90%; max-width: 360px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); }

        @media (max-width: 600px) {
            .calendar-grid { gap: 4px; }
            .cal-day { min-height: 75px; }
            .flight-tag span:last-child { display: none; }
        }
    </style>
</head>
<body>

    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div style="font-size: 3.5rem; margin-bottom: 10px;">âœˆï¸</div>
            <h2 style="color: #1e40af; margin-bottom: 10px;">é£è¡Œå‘˜æ—¥å¿— Pro</h2>
            <p style="color: #64748b; margin-bottom: 30px; font-size: 0.9rem;">æ™ºèƒ½è¯†åˆ« Â· è–ªé…¬ç»Ÿè®¡ Â· æ‰§å‹¤ç®¡ç†</p>
            <button class="btn btn-primary" style="width: 100%; padding: 14px;" onclick="loginWithGoogle()">
                Google è´¦å·ç™»å½•
            </button>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ -->
    <div id="app" class="container" style="display: none;">
        <div class="top-bar">
            <div>
                <h1 style="font-size: 1.3rem; font-weight: 800; letter-spacing: -0.5px;">æ§åˆ¶å°</h1>
                <div id="userInfo" class="user-pill">æœªç™»å½•</div>
            </div>
            <button class="btn btn-ghost" style="color: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.3);" onclick="doLogout()">é€€å‡º</button>
        </div>

        <!-- 1. ç»Ÿè®¡æŠ¥è¡¨ -->
        <section class="card">
            <div class="card-header">
                <h2>ğŸ“Š æœˆåº¦ç»Ÿè®¡</h2>
                <input type="month" id="reportMonth" onchange="refreshAll()" style="border: 1px solid var(--border); padding: 6px; border-radius: 6px; outline:none; color:#475569; font-weight:600;">
            </div>
            <div class="card-body">
                <div class="table-wrapper">
                    <table class="excel-table" id="reportTable">
                        <!-- JS å¡«å…… -->
                    </table>
                </div>
            </div>
        </section>

        <!-- 2. æ™ºèƒ½å½•å…¥ -->
        <section class="card">
            <div class="card-header">
                <h2>ğŸ“ æ™ºèƒ½å½•å…¥</h2>
                <button class="btn btn-primary" id="aiBtn" onclick="processAI()">âœ¨ AI è¯†åˆ« & è®¡ç®—</button>
            </div>
            <div class="card-body">
                <div class="ai-box">
                    <input type="password" id="innerApiKey" class="key-input" placeholder="è¾“å…¥ DeepSeek Key è‡ªåŠ¨ä¿å­˜">
                    <textarea id="ocrInput" placeholder="åœ¨æ­¤ç²˜è´´é£è¡Œä»»åŠ¡...&#10;ä¾‹ï¼š11.13 å›æ²ˆé˜³ (å°†è‡ªåŠ¨æ ‡è®°12æ—¥é©»å¤–ï¼Œ13æ—¥æ— è¿‡å¤œ)&#10;ä¾‹ï¼šCA1234 åŒ—äº¬-ä¸Šæµ· 10:00æ’¤è½®æŒ¡ 12:00æŒ¡è½®æŒ¡ é©»å¤–2å¤©"></textarea>
                </div>

                <!-- ç¼–è¾‘è¡¨å• (é»˜è®¤éšè—) -->
                <div id="editForm" class="edit-form" style="display: none;">
                    <div class="form-tag" id="formModeTag">æ–°å¢æ¨¡å¼</div>
                    <input type="hidden" id="edit_doc_id"> <!-- å­˜å‚¨å½“å‰ç¼–è¾‘çš„ID -->
                    
                    <div class="form-grid">
                        <div class="form-group"><label>æ—¥æœŸ (è½åœ°)</label><input type="date" id="f_date"></div>
                        <div class="form-group"><label>èµ·é£åœ°</label><input type="text" id="f_dep"></div>
                        <div class="form-group"><label>è½åœ°åœ°</label><input type="text" id="f_arr"></div>
                        <div class="form-group"><label>åŒºåŸŸå±æ€§</label>
                            <select id="f_cat"><option value="å›½å†…">å›½å†…</option><option value="æ¸¯æ¾³å°">æ¸¯æ¾³å°</option><option value="äºšæ´²å›½é™…">äºšæ´²å›½é™…</option><option value="æ´²é™…">æ´²é™…</option></select>
                        </div>
                        <div class="form-group form-full"><label>æœºç»„åå•</label><input type="text" id="f_crew" placeholder="æœºé•¿/å‰¯é©¾/å­¦å‘˜"></div>

                        <!-- æ—¶åˆ»è®¡ç®—åŒº -->
                        <div class="form-full" style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px dashed var(--border);">
                            <label style="margin-bottom: 10px; display:block; text-align:center; color:#475569">â±ï¸ è¿è¡Œæ—¶åˆ» (è‡ªåŠ¨è®¡ç®—æ—¶é•¿)</label>
                            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap:10px;">
                                <div class="form-group"><label>æ’¤è½®æŒ¡</label><input type="time" id="f_block_off" onchange="recalcTimes()"></div>
                                <div class="form-group"><label>èµ·é£</label><input type="time" id="f_takeoff" onchange="recalcTimes()"></div>
                                <div class="form-group"><label>è½åœ°</label><input type="time" id="f_landing" onchange="recalcTimes()"></div>
                                <div class="form-group"><label>æŒ¡è½®æŒ¡</label><input type="time" id="f_block_on" onchange="recalcTimes()"></div>
                            </div>
                        </div>

                        <div class="form-group"><label>ç©ºä¸­æ—¶é—´ (h)</label><input type="number" step="0.01" id="f_air"></div>
                        <div class="form-group"><label>æ€»æ—¶é—´ (h)</label><input type="number" step="0.01" id="f_total_time"></div>
                        
                        <div class="form-group"><label>å¤œèˆª 18:30+</label><input type="number" step="0.1" id="f_night1"></div>
                        <div class="form-group"><label>å¤œèˆª 00:00+</label><input type="number" step="0.1" id="f_night2"></div>
                        
                        <div class="form-group"><label>é©»å¤–ç±»å‹</label>
                            <select id="f_overnight">
                                <option value="æ— ">æ— </option>
                                <option value="å›½å†…æ— è¿‡å¤œ">å›½å†…æ— è¿‡å¤œ</option><option value="å›½å†…æœ‰è¿‡å¤œ">å›½å†…æœ‰è¿‡å¤œ</option>
                                <option value="å›½é™…æ— è¿‡å¤œ">å›½é™…æ— è¿‡å¤œ</option><option value="å›½é™…æœ‰è¿‡å¤œ">å›½é™…æœ‰è¿‡å¤œ</option>
                            </select>
                        </div>
                        <div class="form-group"><label>é©»å¤–åŸå¸‚</label><input type="text" id="f_overnight_city"></div>
                        <div class="form-group"><label>é©»å¤–å¤©æ•° (å‰æ¨)</label><input type="number" id="f_overnight_days" value="0"></div>
                        
                        <div class="form-group"><label>ç‰¹æ®Šæœºåœº</label><input type="number" id="f_special" value="0"></div>
                        <div class="form-group"><label>èŠ‚å‡æ—¥</label><input type="number" id="f_holiday" value="0"></div>
                        <div class="form-group"><label>æ»‘è¡Œ(æ¬¡)</label><input type="number" id="f_block_days" value="1"></div>
                    </div>
                    <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                        <button class="btn btn-ghost" onclick="closeForm()">å–æ¶ˆ</button>
                        <button class="btn btn-primary" id="saveBtn" onclick="saveRecord()">ğŸ’¾ ç¡®è®¤ä¿å­˜</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. æ‰§å‹¤æ—¥å† -->
        <section class="card">
            <div class="card-header">
                <h2>ğŸ“… æ‰§å‹¤æ—¥å†</h2>
                <span id="calTotal" style="font-size: 0.8rem; color: #64748b; font-weight: normal;"></span>
            </div>
            <div class="card-body calendar-wrapper">
                <div class="calendar-header">
                    <div>å‘¨æ—¥</div><div>å‘¨ä¸€</div><div>å‘¨äºŒ</div><div>å‘¨ä¸‰</div><div>å‘¨å››</div><div>å‘¨äº”</div><div>å‘¨å…­</div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
        </section>

        <!-- 4. é£è¡Œè®°å½• (åŸå†å²æ˜ç»†) -->
        <section class="card">
            <div class="card-header"><h2>ğŸ“‹ é£è¡Œè®°å½•</h2></div>
            <div class="card-body">
                <div id="logList" class="log-list"></div>
            </div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCFk4f7bKUHlb3d1Cg1jyS1EM-SPC4pr40",
            authDomain: "myflightlog-1f4cb.firebaseapp.com",
            projectId: "myflightlog-1f4cb",
            storageBucket: "myflightlog-1f4cb.firebasestorage.app",
            messagingSenderId: "181072044112",
            appId: "1:181072044112:web:ca312da2d4780227cef155"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        let currentUser = null;
        let allRecords = [];
        let calendarData = {};

        // === è®¤è¯ä¸åˆå§‹åŒ– ===
        window.loginWithGoogle = async () => { try { await signInWithPopup(auth, provider); } catch (e) { alert("ç™»å½•å¤±è´¥: " + e.message); } };
        window.doLogout = async () => { await signOut(auth); };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userInfo').textContent = `ğŸ‘¨â€âœˆï¸ ${user.displayName}`;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                
                // é»˜è®¤æœ¬æœˆ
                const now = new Date();
                document.getElementById('reportMonth').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                
                if(localStorage.getItem("openai_key")) document.getElementById("innerApiKey").value = localStorage.getItem("openai_key");

                onSnapshot(query(collection(db, `users/${user.uid}/logs`), orderBy("date", "desc")), (snap) => {
                    allRecords = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    refreshAll();
                });
                onSnapshot(collection(db, `users/${user.uid}/calendar_status`), (snap) => {
                    calendarData = {};
                    snap.docs.forEach(d => calendarData[d.id] = d.data().status);
                    renderCalendar();
                });
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
        });

        window.refreshAll = () => { renderList(); renderReport(); renderCalendar(); };

        // === å·¥å…·å‡½æ•° ===
        function calculateDuration(start, end) {
            if(!start || !end) return 0;
            let [h1, m1] = start.split(':').map(Number);
            let [h2, m2] = end.split(':').map(Number);
            let min1 = h1 * 60 + m1;
            let min2 = h2 * 60 + m2;
            if (min2 < min1) min2 += 24 * 60; // è·¨æ—¥å¤„ç†
            return Number(((min2 - min1) / 60).toFixed(2));
        }

        window.recalcTimes = () => {
            const getVal = id => document.getElementById(id).value;
            const air = calculateDuration(getVal('f_takeoff'), getVal('f_landing'));
            const total = calculateDuration(getVal('f_block_off'), getVal('f_block_on'));
            document.getElementById('f_air').value = air > 0 ? air : '';
            document.getElementById('f_total_time').value = total > 0 ? total : '';
        };

        // === AI å¤„ç†é€»è¾‘ (å«å›ç¨‹æ¨æ–­) ===
        window.processAI = async () => {
            const text = document.getElementById('ocrInput').value.trim();
            const apiKey = document.getElementById('innerApiKey').value.trim();
            if (!text || !apiKey) return alert("è¯·è¾“å…¥å†…å®¹å’Œ API Key");
            localStorage.setItem("openai_key", apiKey);

            const btn = document.getElementById('aiBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = "â³ æ¨æ¼”ä¸­..."; btn.disabled = true;

            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªé£è¡Œæ—¥å¿—åŠ©æ‰‹ã€‚è¯·æå–ä¿¡æ¯å¹¶è¿”å›çº¯ JSONã€‚
            
            1. å¦‚æœè¾“å…¥å¦‚ "11.13 å›æ²ˆé˜³"ï¼Œæ„ä¸ºç»“æŸé©»å¤–ã€‚
               è¿”å›ï¼š{"type":"return_base", "date":"2025-11-13", "base":"æ²ˆé˜³"} (å¹´ä»½é»˜è®¤2025)ã€‚
            
            2. å¦‚æœæ˜¯ä¿®æ”¹æ—¥å†çŠ¶æ€ï¼ˆå¦‚ï¼š7,8å· æ²ˆé˜³ï¼‰ï¼Œè¿”å› {"type":"calendar", "dates":["2025-XX-XX"], "status":"æ²ˆé˜³"}ã€‚
            
            3. å¦‚æœæ˜¯æ™®é€šé£è¡Œï¼Œè¿”å› {"type":"flight", ...å­—æ®µ}ã€‚
               å­—æ®µ: date, dep, arr, category, crew, time_off, time_takeoff, time_landing, time_on, night1, night2, 
               overnight (æ— /å›½å†…æ— è¿‡å¤œ/å›½å†…æœ‰è¿‡å¤œ/å›½é™…æ— è¿‡å¤œ/å›½é™…æœ‰è¿‡å¤œ), overnight_city, overnight_days, special_airport, holiday.
            
            åªè¾“å‡º JSONã€‚`;

            try {
                const res = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: "deepseek-chat", messages: [{role: "system", content: systemPrompt}, {role: "user", content: text}], temperature: 0.1 })
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error.message);

                let content = data.choices[0].message.content.replace(/```json|```/g, '').trim();
                const r = JSON.parse(content);

                // æ¸…ç©ºç¼–è¾‘IDï¼Œå¼€å¯æ–°å½•å…¥
                resetForm();

                if (r.type === 'return_base') {
                    // å›ç¨‹é€»è¾‘ï¼šå‰ä¸€å¤©è®¾ä¸ºé©»å¤–
                    const today = new Date(r.date);
                    const prevDay = new Date(today); prevDay.setDate(today.getDate() - 1);
                    const prevDateStr = prevDay.toISOString().split('T')[0];

                    await setDoc(doc(db, `users/${currentUser.uid}/calendar_status`, prevDateStr), { status: "é©»å¤–" });

                    // å¡«å……ä»Šæ—¥è¡¨å•
                    setFormValues({
                        date: r.date, arr: r.base, dep: 'é©»å¤–åœ°', 
                        overnight: 'å›½å†…æ— è¿‡å¤œ', overnight_days: 0, category: 'å›½å†…'
                    });
                    alert(`ğŸ¤– å·²å°† ${prevDateStr} æ ‡è®°ä¸º[é©»å¤–]ã€‚\nè¯·è¡¥å…¨ä»Šæ—¥å›ç¨‹æ—¶åˆ»ã€‚`);
                    showForm();

                } else if (r.type === 'calendar') {
                    await Promise.all(r.dates.map(d => setDoc(doc(db, `users/${currentUser.uid}/calendar_status`, d), { status: r.status })));
                    alert(`âœ… å·²æ›´æ–°æ—¥å†çŠ¶æ€`);
                } else {
                    setFormValues(r);
                    recalcTimes();
                    showForm();
                }
            } catch (e) { alert("å¤„ç†å¤±è´¥: " + e.message); } 
            finally { btn.innerHTML = originalText; btn.disabled = false; }
        };

        // === è¡¨å•æ“ä½œ (æ–°å¢/ç¼–è¾‘/ä¿å­˜) ===
        function setFormValues(data) {
            const setVal = (id, val) => { const el = document.getElementById('f_'+id); if(el) el.value = val !== undefined ? val : ''; };
            setVal('date', data.date); setVal('dep', data.dep); setVal('arr', data.arr);
            setVal('cat', data.category); setVal('crew', data.crew);
            setVal('block_off', data.time_off||data.block_off); setVal('takeoff', data.time_takeoff||data.takeoff);
            setVal('landing', data.time_landing||data.landing); setVal('block_on', data.time_on||data.block_on);
            setVal('air', data.air_time); setVal('total_time', data.total_time);
            setVal('night1', data.night1); setVal('night2', data.night2);
            setVal('overnight', data.overnight || 'æ— ');
            setVal('overnight_city', data.overnight_city || (data.overnight!=='æ— ' && data.overnight ? data.dep : ''));
            setVal('overnight_days', data.overnight_days);
            setVal('special', data.special_airport); setVal('holiday', data.holiday);
            setVal('block_days', data.block_days);
        }

        function resetForm() {
            document.getElementById('edit_doc_id').value = '';
            document.getElementById('formModeTag').textContent = 'æ–°å¢æ¨¡å¼';
            document.getElementById('formModeTag').style.background = '#2563eb';
            document.getElementById('saveBtn').textContent = 'ğŸ’¾ ç¡®è®¤ä¿å­˜';
            const inputs = document.querySelectorAll('.edit-form input, .edit-form select');
            inputs.forEach(i => { if(i.type!=='hidden') i.value = ''; });
            document.getElementById('f_block_days').value = 1;
            document.getElementById('f_overnight_days').value = 0;
        }

        window.editRecord = (id) => {
            const rec = allRecords.find(r => r.id === id);
            if(!rec) return;
            
            resetForm();
            document.getElementById('edit_doc_id').value = id;
            document.getElementById('formModeTag').textContent = 'âœï¸ ç¼–è¾‘æ¨¡å¼';
            document.getElementById('formModeTag').style.background = '#f59e0b';
            document.getElementById('saveBtn').textContent = 'ğŸ”„ æ›´æ–°è®°å½•';
            
            setFormValues(rec);
            showForm();
        };

        window.closeForm = () => { document.getElementById('editForm').style.display = 'none'; };
        function showForm() { 
            document.getElementById('editForm').style.display = 'block'; 
            document.getElementById('editForm').scrollIntoView({behavior: "smooth"});
        }

        window.saveRecord = async () => {
            const docId = document.getElementById('edit_doc_id').value;
            const getNum = (id) => parseFloat(document.getElementById('f_'+id).value) || 0;
            const getStr = (id) => document.getElementById('f_'+id).value;
            
            let ovCity = getStr('overnight_city');
            if(!ovCity && getStr('overnight') !== 'æ— ') ovCity = getStr('dep');

            const record = {
                date: getStr('date'), dep: getStr('dep'), arr: getStr('arr'), 
                category: getStr('cat'), crew: getStr('crew'),
                block_off: getStr('block_off'), takeoff: getStr('takeoff'), 
                landing: getStr('landing'), block_on: getStr('block_on'),
                air_time: getNum('air'), total_time: getNum('total_time'),
                block_days: getNum('block_days'), night1: getNum('night1'), night2: getNum('night2'),
                overnight: getStr('overnight'), overnight_city: ovCity, overnight_days: getNum('overnight_days'),
                special_airport: getNum('special'), holiday: getNum('holiday'), 
                timestamp: new Date()
            };

            if(!record.date) return alert("è¯·é€‰æ‹©æ—¥æœŸ");

            try {
                if(docId) {
                    // æ›´æ–°
                    await updateDoc(doc(db, `users/${currentUser.uid}/logs`, docId), record);
                } else {
                    // æ–°å¢
                    await addDoc(collection(db, `users/${currentUser.uid}/logs`), record);
                }
                closeForm();
                document.getElementById('ocrInput').value = '';
            } catch(e) { alert("ä¿å­˜å¤±è´¥: " + e.message); }
        };

        window.deleteItem = async (id) => { 
            if(confirm("ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) await deleteDoc(doc(db, `users/${currentUser.uid}/logs`, id)); 
        };

        // === æ¸²æŸ“æ—¥å† (å«é©»å¤–æ— è¿‡å¤œç»¿è‰²æ˜¾ç¤º) ===
        window.renderCalendar = () => {
            const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
            const [y, m] = document.getElementById('reportMonth').value.split('-').map(Number);
            const daysInMonth = new Date(y, m, 0).getDate();
            const firstDay = new Date(y, m - 1, 1).getDay();
            const todayStr = new Date().toISOString().split('T')[0];

            // è‡ªåŠ¨æ¨ç®—é©»å¤–
            let autoCalendar = {};
            allRecords.forEach(r => {
                if (r.overnight && r.overnight !== 'æ— ' && r.overnight_days > 0) {
                    const flightDate = new Date(r.date);
                    for(let i=1; i<=r.overnight_days; i++) {
                        const p = new Date(flightDate); p.setDate(flightDate.getDate() - i);
                        autoCalendar[p.toISOString().split('T')[0]] = r.overnight_city;
                    }
                }
            });

            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div class="cal-day" style="background:#f8fafc; border:none"></div>`;

            let totalHours = 0;
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const flights = allRecords.filter(r => r.date === dateStr).sort((a,b)=>(a.block_off||'').localeCompare(b.block_off||''));
                flights.forEach(f => totalHours += f.total_time || 0);

                // === å…³é”®é€»è¾‘ï¼šçŠ¶æ€åˆ¤æ–­ ===
                // 1. æ˜¯å¦æ‰‹åŠ¨è®¾ç½®äº†çŠ¶æ€ï¼Ÿ
                let statusText = calendarData[dateStr];
                let statusClass = "";

                // 2. å¦‚æœæ²¡æœ‰æ‰‹åŠ¨è®¾ç½®ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯â€œå›ç¨‹æ—¥â€(æ— è¿‡å¤œçš„é£è¡Œ)
                if (!statusText) {
                    const returnFlight = flights.find(f => f.overnight && f.overnight.includes('æ— è¿‡å¤œ'));
                    if (returnFlight) {
                        statusText = "é©»å¤–æ— è¿‡å¤œ";
                        statusClass = "status-return"; // ç»¿è‰²æ ·å¼
                    } else {
                        // 3. æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªåŠ¨æ¨ç®—çš„é©»å¤–æ—¥
                        statusText = autoCalendar[dateStr] || "æ²ˆé˜³";
                    }
                }
                
                // æ ·å¼æ˜ å°„
                if(statusText === 'æ²ˆé˜³' || statusText === 'SHE' || statusText === 'åŸºåœ°') {
                    statusText = 'æ²ˆé˜³'; // é»˜è®¤æ˜¾ç¤º
                } else if (!statusClass) {
                    statusClass = "status-stay"; // é»„è‰²æ ·å¼ (æ™®é€šçš„é©»å¤–)
                }

                const isToday = dateStr === todayStr;
                const cell = document.createElement('div'); 
                cell.className = `cal-day ${isToday ? 'today' : ''}`;
                
                // ç‚¹å‡»æ”¹çŠ¶æ€
                cell.onclick = async (e) => {
                    if(e.target.closest('.flight-tag')) return;
                    const n = prompt(`ä¿®æ”¹ ${dateStr} æ‰€åœ¨åœ°:`, statusText);
                    if(n && n !== statusText) await setDoc(doc(db, `users/${currentUser.uid}/calendar_status`, dateStr), {status:n});
                };

                let flightHtml = flights.length ? `<div class="cal-flights">` + flights.map(f => {
                    const cls = (f.category.includes('å›½é™…')||f.category.includes('æ´²é™…')) ? 'tag-int' : 'tag-dom';
                    return `<div class="flight-tag ${cls}"><span>${f.dep.split(' ')[0]}-${f.arr.split(' ')[0]}</span><span>${f.total_time}h</span></div>`
                }).join('') + `</div>` : '';

                cell.innerHTML = `<div class="cal-num">${d}${isToday?'<span style="color:var(--primary)">ä»Š</span>':''}</div>${flightHtml}<div class="cal-status ${statusClass}">${statusText}</div>`;
                grid.appendChild(cell);
            }
            document.getElementById('calTotal').textContent = `æœ¬æœˆæ‰§å‹¤: ${totalHours.toFixed(1)} å°æ—¶`;
        };

        // === æ¸²æŸ“åˆ—è¡¨ (å«ç¼–è¾‘æŒ‰é’®) ===
        window.renderList = () => {
            const listEl = document.getElementById('logList');
            const mStr = document.getElementById('reportMonth').value;
            const displayData = allRecords.filter(r => r.date.startsWith(mStr));

            if (!displayData.length) { listEl.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:20px">æœ¬æœˆæš‚æ— è®°å½•</div>'; return; }

            listEl.innerHTML = displayData.map(r => `
                <div class="log-item">
                    <div class="log-info">
                        <div style="font-weight:700;color:#1e293b;display:flex;gap:8px;align-items:center">
                            <span style="font-family:monospace;color:#64748b;background:#f1f5f9;padding:2px 6px;border-radius:4px;font-size:0.8rem">${r.date.substring(5)}</span>
                            ${r.dep} <span style="color:#cbd5e1">âœ</span> ${r.arr}
                        </div>
                        <div style="font-size:0.8rem;color:#64748b">
                            ${r.category} Â· <span style="color:var(--primary);font-weight:bold">${r.total_time}h</span>
                            ${r.overnight!=='æ— '?`<span style="margin-left:5px;background:#eff6ff;color:var(--primary);padding:1px 4px;border-radius:3px">${r.overnight}</span>`:''}
                        </div>
                    </div>
                    <div class="log-actions">
                        <button class="btn btn-edit" onclick="editRecord('${r.id}')">âœï¸</button>
                        <button class="btn btn-danger" onclick="deleteItem('${r.id}')">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        };

        window.renderReport = () => {
            const mStr = document.getElementById('reportMonth').value;
            const data = allRecords.filter(r => r.date.startsWith(mStr));
            const s = { d_a:0, d_b:0, h_a:0, h_b:0, a_a:0, a_b:0, i_a:0, i_b:0, n1:0, n2:0, spec:0, hol:0, o_d:0, o_i:0 };
            data.forEach(r => {
                if(r.category==='å›½å†…') { s.d_a+=r.air_time; s.d_b+=r.block_days; }
                else if(r.category==='æ¸¯æ¾³å°') { s.h_a+=r.air_time; s.h_b+=r.block_days; }
                else if(r.category==='äºšæ´²å›½é™…') { s.a_a+=r.air_time; s.a_b+=r.block_days; }
                else { s.i_a+=r.air_time; s.i_b+=r.block_days; }
                s.n1+=r.night1||0; s.n2+=r.night2||0; s.spec+=r.special_airport||0; s.hol+=r.holiday||0;
                if(r.overnight&&r.overnight.includes('å›½å†…æœ‰è¿‡å¤œ')) s.o_d += r.overnight_days;
                if(r.overnight&&r.overnight.includes('å›½é™…æœ‰è¿‡å¤œ')) s.o_i += r.overnight_days;
            });
            document.getElementById('reportTable').innerHTML = `
                <thead><tr><th rowspan="2">ç±»åˆ«</th><th colspan="2">å›½å†…</th><th colspan="2">æ¸¯æ¾³å°</th><th colspan="2">äºšæ´²</th><th colspan="2">æ´²é™…</th></tr>
                <tr><th>ç©ºæ—¶</th><th>æ»‘è¡Œ</th><th>ç©ºæ—¶</th><th>æ»‘è¡Œ</th><th>ç©ºæ—¶</th><th>æ»‘è¡Œ</th><th>ç©ºæ—¶</th><th>æ»‘è¡Œ</th></tr></thead>
                <tbody>
                    <tr><td style="font-weight:bold">åˆè®¡</td><td>${s.d_a.toFixed(1)}</td><td>${s.d_b}</td><td>${s.h_a.toFixed(1)}</td><td>${s.h_b}</td><td>${s.a_a.toFixed(1)}</td><td>${s.a_b}</td><td>${s.i_a.toFixed(1)}</td><td>${s.i_b}</td></tr>
                    <tr><td colspan="9" style="height:10px;border:none;background:white"></td></tr>
                    <tr><th rowspan="2">è¡¥è´´</th><th colspan="2">å¤œèˆª</th><th colspan="2">ç‰¹æ®Š/èŠ‚æ—¥</th><th colspan="2">é©»å¤–å¤©æ•°</th><th colspan="2"></th></tr>
                    <tr><th>18:30</th><th>00:00</th><th class="bg-sub">ç‰¹æ®Š</th><th class="bg-sub">èŠ‚æ—¥</th><th>å›½å†…</th><th>å›½é™…</th><th>-</th><th>-</th></tr>
                    <tr><td style="font-weight:bold">æ•°é‡</td><td>${s.n1.toFixed(1)}</td><td>${s.n2.toFixed(1)}</td><td class="bg-sub">${s.spec}</td><td class="bg-sub">${s.hol}</td><td>${s.o_d}</td><td>${s.o_i}</td><td>-</td><td>-</td></tr>
                </tbody>`;
        };
    </script>
</body>
</html>
