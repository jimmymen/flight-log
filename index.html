<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æœºé•¿é£è¡Œæ—¥å¿— Pro - ç¨åŠ¡ç²¾ç®—ç‰ˆ</title>
    <style>
        /* === æ ¸å¿ƒæ ·å¼å˜é‡ === */
        :root {
            --primary: #1e40af; --accent: #dc2626; --success: #16a34a;
            --bg: #f1f5f9; --card-bg: #ffffff; --text-main: #0f172a; --text-sub: #64748b;
            --border: #e2e8f0;
            --tag-dom: #eff6ff; --tag-dom-text: #1d4ed8;
            --tag-int: #f3e8ff; --tag-int-text: #7e22ce;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text-main); padding-bottom: 80px; }
        
        .app-container { max-width: 800px; margin: 0 auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        
        /* å¡ç‰‡é€šç”¨æ ·å¼ */
        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        .card-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .card-title { font-size: 1.1rem; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        
        /* è–ªèµ„ä»ªè¡¨ç›˜ */
        .salary-dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .salary-box { background: #f8fafc; padding: 12px; border-radius: 10px; border: 1px solid var(--border); text-align: center; }
        .salary-label { font-size: 0.75rem; color: var(--text-sub); margin-bottom: 4px; }
        .salary-val { font-size: 1.1rem; font-weight: 800; color: var(--text-main); font-family: monospace; }
        .val-green { color: var(--success); }
        .val-red { color: var(--accent); }
        
        .tax-alert { background: #fef2f2; border: 1px solid #fecaca; color: #991b1b; padding: 10px; border-radius: 8px; font-size: 0.85rem; margin-top: 10px; display: flex; align-items: center; gap: 8px; }

        /* è¡¨æ ¼æ ·å¼ */
        .detail-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .detail-table td { padding: 8px 0; border-bottom: 1px dashed var(--border); }
        .detail-table tr:last-child td { border-bottom: none; }
        .dt-label { color: var(--text-sub); }
        .dt-val { text-align: right; font-weight: 600; font-family: monospace; }
        
        /* å½•å…¥ä¸æŒ‰é’® */
        .btn { border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; width: 100%; box-shadow: 0 4px 12px rgba(30,64,175,0.2); }
        .btn-ghost { background: transparent; color: var(--text-sub); border: 1px solid var(--border); }
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.8rem; color: var(--text-sub); margin-bottom: 6px; font-weight: 600; }
        .input-control { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; background: #fff; transition: 0.2s; }
        .input-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(30,64,175,0.1); }

        /* åˆ—è¡¨é¡¹ */
        .log-list { display: flex; flex-direction: column; gap: 10px; }
        .log-item { background: #fff; border: 1px solid var(--border); border-radius: 10px; padding: 12px; display: flex; justify-content: space-between; align-items: center; position: relative; overflow: hidden; }
        .log-left { display: flex; flex-direction: column; gap: 4px; }
        .route-tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; margin-right: 6px; }
        .tag-dom { background: var(--tag-dom); color: var(--tag-dom-text); }
        .tag-int { background: var(--tag-int); color: var(--tag-int-text); }
        .log-time { font-family: monospace; font-weight: 700; font-size: 1.1rem; color: var(--text-main); }
        .log-money { font-size: 0.85rem; color: var(--success); font-weight: 600; }
        .log-sub { font-size: 0.75rem; color: var(--text-sub); }

        /* è®¾ç½®é¢æ¿ */
        .settings-panel { display: none; background: #fff; padding: 20px; border-radius: 16px; margin-bottom: 15px; border: 1px solid var(--primary); animation: slideDown 0.3s; }
        @keyframes slideDown { from {opacity:0; transform:translateY(-10px);} to {opacity:1; transform:translateY(0);} }

        /* AI è¾“å…¥æ¡† */
        .ai-area { width: 100%; height: 80px; border: 2px dashed var(--border); border-radius: 10px; padding: 10px; margin-bottom: 10px; font-size: 0.9rem; resize: none; background: #f8fafc; }
        .ai-area:focus { border-color: var(--primary); background: #fff; }
    </style>
</head>
<body>

<div class="app-container">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1 style="font-size:1.4rem; color:var(--primary); font-weight:800;">ğŸ‘¨â€âœˆï¸ æœºé•¿è–ªèµ„åŠ©æ‰‹</h1>
        <button class="btn btn-ghost" style="padding:6px 12px;" onclick="toggleSettings()">âš™ï¸ ç¨åŠ¡å‚æ•°</button>
    </div>

    <!-- ç¨åŠ¡å‚æ•°è®¾ç½® (é»˜è®¤éšè—) -->
    <div id="settingsPanel" class="settings-panel">
        <h3 style="margin-bottom:15px; color:var(--primary);">ğŸ“Š ç¨åŠ¡åˆå§‹åŒ–é…ç½® (2025)</h3>
        <p style="font-size:0.75rem; color:#64748b; margin-bottom:15px;">ç”¨äºè®¡ç®—å†å²è¡¥ç¨ã€‚è¯·æ ¹æ®ä¸ªç¨APPå¡«å†™æˆªè‡³ä¸Šä¸ªæœˆçš„æ•°æ®ã€‚</p>
        
        <div class="input-group">
            <label>å½“å‰æœˆä»½</label>
            <input type="month" id="cfg_month" class="input-control" onchange="renderAll()">
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div class="input-group">
                <label>å¹´åˆè‡³ä»Šç´¯è®¡åº”ç¨æ”¶å…¥</label>
                <input type="number" id="cfg_cum_income" class="input-control" placeholder="ä¾‹: 942692">
            </div>
            <div class="input-group">
                <label>å¹´åˆè‡³ä»Šå·²ç¼´ä¸ªç¨</label>
                <input type="number" id="cfg_cum_tax" class="input-control" placeholder="ä¾‹: 244022">
            </div>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div class="input-group">
                <label>ä¸“é¡¹é™„åŠ æ‰£é™¤ (æ¯æœˆ)</label>
                <input type="number" id="cfg_deduction" class="input-control" value="0" placeholder="å¡«3000çœå¤§é’±">
            </div>
            <div class="input-group">
                <label>ç¤¾ä¿å…¬ç§¯é‡‘ (ä¸ªäºº)</label>
                <input type="number" id="cfg_social" class="input-control" value="5217.09">
            </div>
        </div>
        <button class="btn btn-primary" onclick="toggleSettings(); renderAll()">ä¿å­˜å¹¶è®¡ç®—</button>
    </div>

    <!-- æ ¸å¿ƒè–ªèµ„å¡ç‰‡ -->
    <div class="card">
        <div class="card-head">
            <div class="card-title">ğŸ’° æœ¬æœˆé¢„è®¡åˆ°æ‰‹</div>
            <span class="route-tag tag-int" id="taxRateTag">ç¨ç‡ 35%</span>
        </div>
        
        <div style="text-align:center; margin-bottom:20px;">
            <h1 style="font-size:2.5rem; color:var(--success); letter-spacing:-1px;" id="disp_net_total">Â¥0.00</h1>
            <p style="font-size:0.85rem; color:var(--text-sub);">å«å›ºå®š+å˜åŠ¨+è¡¥åŠ©-ä¸ªç¨</p>
        </div>

        <div class="salary-dashboard">
            <div class="salary-box">
                <div class="salary-label">å˜åŠ¨å·¥èµ„(ç¨å‰)</div>
                <div class="salary-val" id="disp_gross_var">0</div>
            </div>
            <div class="salary-box">
                <div class="salary-label">å…ç¨è¡¥åŠ©(çº¯åˆ©)</div>
                <div class="salary-val val-green" id="disp_allowance">0</div>
            </div>
            <div class="salary-box">
                <div class="salary-label">ä¸ªäººæ‰¿æ‹…ä¸ªç¨</div>
                <div class="salary-val val-red" id="disp_tax_self">0</div>
            </div>
            <div class="salary-box">
                <div class="salary-label">è¡¥ç¼´/è·¨æ¡£ç¨é¢</div>
                <div class="salary-val val-red" style="font-size:0.9rem" id="disp_tax_catchup">0</div>
            </div>
        </div>

        <div id="taxAlert" class="tax-alert" style="display:none;">
            âš ï¸ è­¦å‘Šï¼šæœ¬æœˆç´¯è®¡æ”¶å…¥è·¨è¶Š 96ä¸‡ é—¨æ§›ï¼Œç¨ç‡è·³æ¶¨è‡³ 45%ï¼Œå¹¶è§¦å‘å†å²æ”¶å…¥è¡¥ç¨ï¼
        </div>

        <div style="background:#f8fafc; border-radius:8px; padding:15px; margin-top:15px;">
            <table class="detail-table">
                <tr><td class="dt-label">å›ºå®šå·¥èµ„ (å…¬å¸åŒ…ç¨)</td><td class="dt-val">96,522.91</td></tr>
                <tr><td class="dt-label">å˜åŠ¨å·¥èµ„ (å°æ—¶è´¹+åŠ ç­)</td><td class="dt-val" id="row_var">0.00</td></tr>
                <tr><td class="dt-label">å…ç¨è¡¥åŠ© (é¤+é©»)</td><td class="dt-val" id="row_allow">0.00</td></tr>
                <tr><td class="dt-label" style="color:var(--accent)">å‡: æœ¬æœˆåº”ç¼´ä¸ªç¨æ€»é¢</td><td class="dt-val" style="color:var(--accent)" id="row_tax_total">0.00</td></tr>
                <tr><td class="dt-label" style="color:var(--success)">åŠ : å…¬å¸æ‰¿æ‹…ä¸ªç¨éƒ¨åˆ†</td><td class="dt-val" style="color:var(--success)" id="row_tax_comp">0.00</td></tr>
            </table>
        </div>
    </div>

    <!-- å½•å…¥åŒºåŸŸ -->
    <div class="card">
        <div class="card-head">
            <div class="card-title">ğŸ“ é£è¡Œè®°å½•å½•å…¥</div>
            <button class="btn btn-ghost" style="font-size:0.8rem; padding:4px 8px;" onclick="addHoliday()">+ èŠ‚å‡æ—¥(3å€)</button>
        </div>
        
        <textarea id="aiInput" class="ai-area" placeholder="æ™ºèƒ½è¯†åˆ«ï¼šç²˜è´´é£è¡Œä»»åŠ¡çŸ­ä¿¡æˆ–æ‰‹åŠ¨è¾“å…¥&#10;ä¾‹ï¼š11.9 æ²ˆé˜³-æ›¼è°· 14.5å°æ—¶ å›½é™…æœ‰è¿‡å¤œ"></textarea>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <input type="date" id="in_date" class="input-control">
            <select id="in_type" class="input-control">
                <option value="dom">å›½å†… (æ— å°æ—¶è´¹)</option>
                <option value="int">å›½é™…/åœ°åŒº (Â¥640)</option>
            </select>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
            <input type="number" id="in_hours" class="input-control" placeholder="é£è¡Œå°æ—¶" step="0.1">
            <select id="in_meal" class="input-control">
                <option value="60">å›½å†…é¤ (Â¥60)</option>
                <option value="180">å›½é™…é¤ (Â¥180)</option>
                <option value="0">æ— é¤è¡¥</option>
            </select>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
             <select id="in_stay" class="input-control">
                <option value="0">æ— è¿‡å¤œ</option>
                <option value="200">å›½æ—  (Â¥200)</option>
                <option value="500">å›½æœ‰ (Â¥500)</option>
                <option value="400">å¤–æ—  (Â¥400)</option>
                <option value="900">å¤–æœ‰ (Â¥900)</option>
            </select>
             <input type="number" id="in_other" class="input-control" placeholder="å¤œèˆª/ç‰¹æ®Š (Â¥)" value="0">
        </div>
        
        <button class="btn btn-primary" style="margin-top:15px;" onclick="addRecord()">æ·»åŠ è®°å½•</button>
    </div>

    <!-- åˆ—è¡¨ -->
    <div class="log-list" id="logList">
        <!-- JS ç”Ÿæˆ -->
    </div>
    
    <button class="btn btn-ghost" onclick="clearData()" style="width:100%; margin-top:20px; color:#ef4444;">æ¸…ç©ºæœ¬æœˆæ•°æ®</button>

</div>

<script>
    // === é…ç½®å¸¸é‡ ===
    const BASE_SALARY_GROSS = 101740.00; // ç¨å‰ç”³æŠ¥åŸºæ•°
    const BASE_SALARY_NET = 96522.91;    // å›ºå®šåˆ°æ‰‹
    const RATE_INT = 640;                // å›½é™…å°æ—¶è´¹
    const RATE_HOLIDAY_DAY = 7262;       // èŠ‚å‡æ—¥æ¯å¤©ä¸‰å€å·¥èµ„ä¼°ç®—å€¼ (29048/4)
    
    // ä¸ªç¨ç¨ç‡è¡¨ (2025)
    const TAX_BRACKETS = [
        { limit: 36000, rate: 0.03, quick: 0 },
        { limit: 144000, rate: 0.10, quick: 2520 },
        { limit: 300000, rate: 0.20, quick: 16920 },
        { limit: 420000, rate: 0.25, quick: 31920 },
        { limit: 660000, rate: 0.30, quick: 52920 },
        { limit: 960000, rate: 0.35, quick: 85920 },
        { limit: Infinity, rate: 0.45, quick: 181920 }
    ];

    // === æ•°æ®çŠ¶æ€ ===
    let logs = JSON.parse(localStorage.getItem('pilot_logs')) || [];
    let config = JSON.parse(localStorage.getItem('pilot_config')) || {
        month: new Date().toISOString().slice(0, 7),
        cum_income: 942692, // é»˜è®¤ä½ çš„10æœˆåº•æ•°æ®
        cum_tax: 244022,    // é»˜è®¤ä½ çš„10æœˆåº•æ•°æ®
        deduction: 0,
        social: 5217.09
    };

    // åˆå§‹åŒ–ç•Œé¢
    document.getElementById('cfg_month').value = config.month;
    document.getElementById('cfg_cum_income').value = config.cum_income;
    document.getElementById('cfg_cum_tax').value = config.cum_tax;
    document.getElementById('cfg_deduction').value = config.deduction;
    document.getElementById('cfg_social').value = config.social;
    document.getElementById('in_date').valueAsDate = new Date();

    // === æ ¸å¿ƒè®¡ç®—å‡½æ•° ===
    function calculateTax(cumIncome) {
        // è®¡ç®—åº”çº³ç¨é¢
        for (let b of TAX_BRACKETS) {
            if (cumIncome <= b.limit) {
                return cumIncome * b.rate - b.quick;
            }
        }
        return cumIncome * 0.45 - 181920;
    }

    function renderAll() {
        const monthFilter = document.getElementById('cfg_month').value;
        const currentLogs = logs.filter(l => l.date.startsWith(monthFilter));
        
        // 1. ç»Ÿè®¡æœ¬æœˆå˜åŠ¨æ”¶å…¥ (å°æ—¶è´¹ + åŠ ç­ + å…¶ä»–)
        let varGross = 0;      // å˜åŠ¨å·¥èµ„(ç¨å‰)
        let allowance = 0;     // å…ç¨è¡¥åŠ©
        
        currentLogs.forEach(l => {
            // ç¨å‰å˜åŠ¨æ”¶å…¥
            if (l.type === 'int') varGross += l.hours * RATE_INT;
            if (l.type === 'holiday') varGross += l.count * RATE_HOLIDAY_DAY;
            varGross += (l.other || 0);
            
            // å…ç¨è¡¥åŠ©
            allowance += (l.meal || 0);
            allowance += (l.stay || 0);
        });

        // 2. ç¨åŠ¡æ ¸ç®— (æœ€å¤æ‚çš„éƒ¨åˆ†)
        // ç´¯è®¡æ•°æ®è¯»å–
        const prevCumIncome = parseFloat(document.getElementById('cfg_cum_income').value) || 0;
        const prevCumTax = parseFloat(document.getElementById('cfg_cum_tax').value) || 0;
        const social = parseFloat(document.getElementById('cfg_social').value) || 0;
        const deduction = parseFloat(document.getElementById('cfg_deduction').value) || 0;

        // æœ¬æœˆåº”çº³ç¨æ‰€å¾—é¢å¢åŠ é‡
        // å…¬å¼ï¼š(å›ºå®šç¨å‰ + å˜åŠ¨ç¨å‰) - ç¤¾ä¿ - å…¬ç§¯é‡‘ - æ‰£é™¤é¡¹ - èµ·å¾ç‚¹(5000)
        // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬æ¨¡æ‹Ÿæ•´ä¸ªæœˆçš„ç´¯è®¡çŠ¶æ€
        const monthTaxableAdd = (BASE_SALARY_GROSS + varGross) - social - deduction - 5000;
        
        // æ–°çš„ç´¯è®¡åº”çº³ç¨æ‰€å¾—é¢
        const newCumIncome = prevCumIncome + monthTaxableAdd;
        
        // æ–°çš„ç´¯è®¡åº”çº³ç¨é¢
        const newTotalTax = calculateTax(newCumIncome);
        
        // æœ¬æœˆåº”ç¼´ä¸ªç¨æ€»é¢ (Total Tax for this month)
        const monthTotalTax = newTotalTax - prevCumTax;

        // 3. åˆ†æ‘Šè®¡ç®— (å…¬å¸äº¤å¤šå°‘ï¼Œä½ äº¤å¤šå°‘)
        // é€»è¾‘ï¼šå…¬å¸åªæ‰¿æ‹…å›ºå®šå·¥èµ„äº§ç”Ÿçš„ç¨é¢ã€‚
        // æˆ‘ä»¬éœ€è¦å‡è®¾å¦‚æœæ²¡æœ‰å°æ—¶è´¹ï¼Œç¨æ˜¯å¤šå°‘ã€‚
        
        const baseTaxableAdd = BASE_SALARY_GROSS - social - deduction - 5000;
        const baseCumIncome = prevCumIncome + baseTaxableAdd;
        const baseTotalTax = calculateTax(baseCumIncome);
        const companyTaxShare = baseTotalTax - prevCumTax; // è¿™æ˜¯å…¬å¸ä¼šå¸®ä½ äº¤çš„éƒ¨åˆ†

        // ä½ æ‰¿æ‹…çš„éƒ¨åˆ† = æ€»ç¨ - å…¬å¸æ‰¿æ‹…çš„éƒ¨åˆ†
        let selfTaxShare = monthTotalTax - companyTaxShare;
        if(selfTaxShare < 0) selfTaxShare = 0; // é˜²æ­¢è®¡ç®—è¯¯å·®

        // 4. è®¡ç®—åˆ°æ‰‹
        // å…¬å¼ï¼šå›ºå®šåˆ°æ‰‹(96522) + å…ç¨è¡¥åŠ© + (å˜åŠ¨ç¨å‰ - ä¸ªäººä¸ªç¨)
        const netVar = varGross - selfTaxShare;
        const totalNet = BASE_SALARY_NET + allowance + netVar;

        // 5. æ›´æ–°UI
        document.getElementById('disp_net_total').innerText = 'Â¥' + totalNet.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.getElementById('disp_gross_var').innerText = Math.round(varGross).toLocaleString();
        document.getElementById('disp_allowance').innerText = Math.round(allowance).toLocaleString();
        document.getElementById('disp_tax_self').innerText = Math.round(selfTaxShare).toLocaleString();
        
        // è­¦å‘Šåˆ¤å®š
        const taxRate = newCumIncome > 960000 ? 0.45 : (newCumIncome > 660000 ? 0.35 : 0.30);
        document.getElementById('taxRateTag').innerText = `å½“å‰ç¨ç‡ ${(taxRate*100).toFixed(0)}%`;
        if (taxRate === 0.45 && prevCumIncome < 960000) {
            document.getElementById('taxAlert').style.display = 'flex';
            document.getElementById('taxAlert').innerHTML = `âš ï¸ <b>æ¸¡åŠ«é¢„è­¦ï¼š</b> æœ¬æœˆè·¨å…¥45%ç¨ç‡ï¼Œè¡¥ç¼´å·®é¢å¯¼è‡´ä¸ªäººç¨æ¬¾æ¿€å¢ï¼`;
        } else {
            document.getElementById('taxAlert').style.display = 'none';
        }

        // è¯¦æƒ…è¡¨
        document.getElementById('row_var').innerText = varGross.toLocaleString(undefined, {minimumFractionDigits:2});
        document.getElementById('row_allow').innerText = allowance.toLocaleString(undefined, {minimumFractionDigits:2});
        document.getElementById('row_tax_total').innerText = '-' + monthTotalTax.toLocaleString(undefined, {minimumFractionDigits:2});
        document.getElementById('row_tax_comp').innerText = '+' + companyTaxShare.toLocaleString(undefined, {minimumFractionDigits:2});
        document.getElementById('disp_tax_catchup').innerText = (monthTotalTax - (monthTaxableAdd * taxRate)).toFixed(0); // ç²—ç•¥ä¼°ç®—è¡¥ç¼´éƒ¨åˆ†

        // æ¸²æŸ“åˆ—è¡¨
        renderList(currentLogs);
        
        // ä¿å­˜é…ç½®
        config.month = monthFilter;
        config.cum_income = prevCumIncome;
        config.cum_tax = prevCumTax;
        config.deduction = deduction;
        config.social = social;
        localStorage.setItem('pilot_config', JSON.stringify(config));
    }

    function renderList(list) {
        const el = document.getElementById('logList');
        el.innerHTML = '';
        list.sort((a,b) => new Date(b.date) - new Date(a.date));
        
        list.forEach((l, index) => {
            const div = document.createElement('div');
            div.className = 'log-item';
            let title = '', money = 0;
            
            if (l.type === 'holiday') {
                title = `ğŸ§§ èŠ‚å‡æ—¥åŠ ç­ (${l.count}å¤©)`;
                money = l.count * RATE_HOLIDAY_DAY;
            } else {
                title = `${l.date.slice(5)} ${l.type==='dom'?'å›½å†…':'å›½é™…'}é£è¡Œ`;
                if(l.type==='int') money += l.hours * RATE_INT;
            }
            money += (l.other || 0);
            
            // æ ‡ç­¾å¤„ç†
            let tags = '';
            if(l.type==='dom') tags += `<span class="route-tag tag-dom">å›½å†…</span>`;
            if(l.type==='int') tags += `<span class="route-tag tag-int">å›½é™…</span>`;
            if(l.meal > 0) tags += `<span class="route-tag" style="background:#fff7ed;color:#c2410c">é¤${l.meal}</span>`;
            if(l.stay > 0) tags += `<span class="route-tag" style="background:#f0fdf4;color:#15803d">è¡¥${l.stay}</span>`;

            div.innerHTML = `
                <div class="log-left">
                    <div style="font-weight:600">${title}</div>
                    <div>${tags} <span style="font-size:0.8rem;color:#64748b">${l.hours?l.hours+'å°æ—¶':''}</span></div>
                </div>
                <div style="text-align:right">
                    <div class="log-money">+Â¥${money.toLocaleString()}</div>
                    <div class="log-sub">å…ç¨: Â¥${((l.meal||0)+(l.stay||0))}</div>
                </div>
                <button onclick="delRecord(${l.id})" style="position:absolute; right:0; top:0; height:100%; width:40px; opacity:0; cursor:pointer;">del</button>
            `;
            el.appendChild(div);
        });
    }

    // === æ“ä½œå‡½æ•° ===
    function addRecord() {
        const date = document.getElementById('in_date').value;
        if(!date) return alert('è¯·é€‰æ‹©æ—¥æœŸ');
        
        const rec = {
            id: Date.now(),
            date: date,
            type: document.getElementById('in_type').value,
            hours: parseFloat(document.getElementById('in_hours').value) || 0,
            meal: parseFloat(document.getElementById('in_meal').value) || 0,
            stay: parseFloat(document.getElementById('in_stay').value) || 0,
            other: parseFloat(document.getElementById('in_other').value) || 0
        };
        
        logs.push(rec);
        saveAndRender();
    }

    function addHoliday() {
        const count = prompt("è¾“å…¥åŠ ç­å¤©æ•°ï¼ˆä¾‹å¦‚å›½åº†å¡«4ï¼‰ï¼š", "4");
        if(count) {
            logs.push({
                id: Date.now(),
                date: document.getElementById('in_date').value || new Date().toISOString().slice(0,10),
                type: 'holiday',
                count: parseFloat(count),
                hours: 0, meal: 0, stay: 0, other: 0
            });
            saveAndRender();
        }
    }

    function delRecord(id) {
        if(confirm('ç¡®å®šåˆ é™¤æ­¤è®°å½•ï¼Ÿ')) {
            logs = logs.filter(l => l.id !== id);
            saveAndRender();
        }
    }

    function clearData() {
        if(confirm('æ¸…ç©ºæœ¬æœˆæ‰€æœ‰è®°å½•ï¼Ÿ(ä¸å¯æ¢å¤)')) {
            const m = document.getElementById('cfg_month').value;
            logs = logs.filter(l => !l.date.startsWith(m));
            saveAndRender();
        }
    }

    function saveAndRender() {
        localStorage.setItem('pilot_logs', JSON.stringify(logs));
        renderAll();
    }
    
    function toggleSettings() {
        const el = document.getElementById('settingsPanel');
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    // åˆå§‹æ¸²æŸ“
    renderAll();

</script>
</body>
</html>
