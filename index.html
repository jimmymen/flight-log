<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£è¡Œæ—¥å¿— - å…¨èƒ½ä»ªè¡¨ç›˜</title>
    <style>
        /* === åŸºç¡€æ ·å¼ === */
        :root { --primary: #2563eb; --primary-dark: #1e40af; --bg: #f1f5f9; --accent: #db2777; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg); color: #334155;
            padding: 20px; min-height: 100vh;
        }
        
        .container {
            max-width: 1100px; margin: 0 auto;
            display: flex; flex-direction: column; gap: 25px;
        }

        /* å¡ç‰‡é€šç”¨ */
        .card {
            background: white; border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden; border: 1px solid #e2e8f0;
        }
        .card-header {
            padding: 15px 20px; background: linear-gradient(to right, #f8fafc, #fff);
            border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;
        }
        .card-header h2 { font-size: 1.1rem; color: #1e293b; font-weight: 700; }
        .card-body { padding: 20px; }

        /* é¡¶éƒ¨æ  */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--primary); color: white; padding: 15px 25px;
            border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3);
        }

        /* === æ¨¡å— 1: ç»Ÿè®¡æŠ¥è¡¨ === */
        .table-scroll { overflow-x: auto; border-radius: 8px; border: 1px solid #cbd5e1; }
        .excel-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 900px; }
        .excel-table th, .excel-table td { border: 1px solid #cbd5e1; padding: 8px 6px; text-align: center; }
        .excel-table th { background: #f1f5f9; font-weight: 600; color: #475569; }
        .bg-sub { background-color: #fdf4ff; color: #86198f; font-weight: bold; } /* è¡¥åŠ©åˆ—é«˜äº® */
        .bg-total { background-color: #eff6ff; font-weight: bold; }

        /* === æ¨¡å— 2: å½•å…¥ === */
        .ai-input-area { position: relative; }
        .key-input { 
            position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9);
            padding: 5px 10px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 0.8rem; width: 200px;
        }
        textarea {
            width: 100%; height: 100px; padding: 15px; border: 2px dashed #cbd5e1;
            border-radius: 12px; resize: vertical; font-family: monospace; transition: 0.3s;
            background: #f8fafc;
        }
        textarea:focus { border-color: var(--primary); outline: none; background: white; }
        
        /* è¡¨å•ç½‘æ ¼ */
        .edit-form { background: #f8fafc; padding: 20px; border-radius: 12px; margin-top: 15px; border: 1px solid #e2e8f0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; }
        .form-group label { display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 4px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; }
        
        /* ç‰¹æ®Šå­—æ®µæ ·å¼ */
        .field-special input { border-color: #db2777; background: #fdf2f8; color: #db2777; }
        .field-holiday input { border-color: #dc2626; background: #fef2f2; color: #dc2626; }

        /* === æ¨¡å— 3: å†å² === */
        .log-list { max-height: 400px; overflow-y: auto; }
        .log-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; border-bottom: 1px solid #f1f5f9; transition: 0.2s;
        }
        .log-item:hover { background: #f8fafc; }
        .log-info { display: flex; flex-direction: column; gap: 4px; }
        .log-row-1 { font-weight: 600; color: #334155; font-size: 0.95rem; }
        .log-row-2 { font-size: 0.8rem; color: #64748b; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        
        .tag { padding: 1px 6px; border-radius: 4px; font-size: 0.7rem; background: #e2e8f0; }
        .tag-special { background: #fce7f3; color: #be185d; border: 1px solid #fbcfe8; } /* ç‰¹æ®Š */
        .tag-holiday { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; } /* èŠ‚å‡æ—¥ */

        /* æŒ‰é’® */
        .btn { padding: 8px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-icon { padding: 6px; border-radius: 6px; background: transparent; color: #94a3b8; cursor: pointer; }
        .btn-icon:hover { background: #fee2e2; color: #ef4444; }

        /* ç™»å½•å±‚ */
        .login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            display: flex; justify-content: center; align-items: center; z-index: 999;
        }
        .login-box { background: white; padding: 40px; border-radius: 20px; text-align: center; width: 320px; }
    </style>
</head>
<body>

    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <h2 style="color: var(--primary); margin-bottom: 20px;">âœˆï¸ é£è¡Œæ—¥å¿—</h2>
            <button class="btn btn-primary" style="width: 100%; padding: 12px;" onclick="loginWithGoogle()">Google è´¦å·ç™»å½•</button>
        </div>
    </div>

    <div id="app" class="container" style="display: none;">
        <div class="top-bar">
            <div><h1 style="font-size: 1.25rem;">é£è¡Œå‘˜æ§åˆ¶å°</h1><span id="userInfo" style="font-size: 0.8rem; opacity: 0.9;">æœªç™»å½•</span></div>
            <button class="btn" style="background: rgba(255,255,255,0.2); color: white;" onclick="doLogout()">é€€å‡º</button>
        </div>

        <!-- 1. æŠ¥è¡¨ -->
        <section class="card">
            <div class="card-header">
                <h2>ğŸ“Š è–ªé…¬ç»Ÿè®¡æŠ¥è¡¨</h2>
                <div>
                    <label style="font-size: 0.85rem;">æœˆä»½ï¼š</label>
                    <input type="month" id="reportMonth" onchange="renderReport()" style="border: 1px solid #cbd5e1; padding: 4px; border-radius: 4px;">
                </div>
            </div>
            <div class="card-body">
                <div class="table-scroll">
                    <table class="excel-table" id="reportTable"></table>
                </div>
            </div>
        </section>

        <!-- 2. å½•å…¥ -->
        <section class="card">
            <div class="card-header">
                <h2>ğŸ“ æ™ºèƒ½å½•å…¥</h2>
                <span style="font-size: 0.8rem; color: #64748b;">æ”¯æŒä¹±ç çº é”™ / è‡ªåŠ¨è¯†åˆ«èŠ‚å‡æ—¥</span>
            </div>
            <div class="card-body">
                <div class="ai-input-area">
                    <input type="password" id="innerApiKey" class="key-input" placeholder="DeepSeek Key (sk-...)">
                    <textarea id="ocrInput" placeholder="ç²˜è´´ç¤ºä¾‹ï¼š2025-10-01 PEK-LSA 4.2h ç‰¹æ®Šæœºåœº è¿‡å¤œ2å¤© å›½åº†åŠ ç­"></textarea>
                </div>
                <div style="text-align: right; margin-top: 10px;">
                    <button id="aiBtn" class="btn btn-primary" onclick="processAI()">âœ¨ AI è¯†åˆ«</button>
                </div>

                <div id="editForm" class="edit-form" style="display: none;">
                    <div class="form-grid">
                        <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="f_date"></div>
                        <div class="form-group"><label>èµ·é£</label><input type="text" id="f_dep"></div>
                        <div class="form-group"><label>è½åœ°</label><input type="text" id="f_arr"></div>
                        <div class="form-group"><label>åŒºåŸŸ</label>
                            <select id="f_cat">
                                <option value="å›½å†…">å›½å†…</option>
                                <option value="æ¸¯æ¾³å°">æ¸¯æ¾³å°</option>
                                <option value="äºšæ´²å›½é™…">äºšæ´²å›½é™…</option>
                                <option value="æ´²é™…">æ´²é™…</option>
                            </select>
                        </div>
                        <div class="form-group"><label>ç©ºä¸­(h)</label><input type="number" step="0.1" id="f_air"></div>
                        <div class="form-group"><label>æ»‘è¡Œ(æ¬¡)</label><input type="number" id="f_block_days" value="1"></div>
                        
                        <div class="form-group"><label>å¤œèˆª(18:30+)</label><input type="number" step="0.1" id="f_night1"></div>
                        <div class="form-group"><label>å¤œèˆª(00:00+)</label><input type="number" step="0.1" id="f_night2"></div>
                        
                        <div class="form-group"><label>é©»å¤–ç±»å‹</label>
                            <select id="f_overnight">
                                <option value="å›½å†…æ— è¿‡å¤œ">å›½å†…æ— è¿‡å¤œ</option>
                                <option value="å›½å†…æœ‰è¿‡å¤œ">å›½å†…æœ‰è¿‡å¤œ</option>
                                <option value="å›½é™…æ— è¿‡å¤œ">å›½é™…æ— è¿‡å¤œ</option>
                                <option value="å›½é™…æœ‰è¿‡å¤œ">å›½é™…æœ‰è¿‡å¤œ</option>
                            </select>
                        </div>
                        <div class="form-group bg-total" style="border-radius:6px; padding:2px;"><label>é©»å¤–å¤©æ•°</label><input type="number" id="f_overnight_days" value="0"></div>
                        
                        <!-- æ–°å¢/å¼ºè°ƒçš„å­—æ®µ -->
                        <div class="form-group field-special"><label>ç‰¹æ®Šæœºåœº(æ¬¡)</label><input type="number" id="f_special" value="0"></div>
                        <div class="form-group field-holiday"><label>æ³•å®šå‡æ—¥(å¤©)</label><input type="number" id="f_holiday" value="0"></div>
                        
                        <div class="form-group"><label>é¤(å›½)</label><input type="number" id="f_meal_d" value="0"></div>
                        <div class="form-group"><label>é¤(å¤–)</label><input type="number" id="f_meal_i" value="0"></div>
                    </div>
                    <div style="margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">
                        <button class="btn" style="background: #e2e8f0;" onclick="document.getElementById('editForm').style.display='none'">å–æ¶ˆ</button>
                        <button class="btn btn-primary" style="background: #10b981;" onclick="saveRecord()">ğŸ’¾ ä¿å­˜</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. å†å² -->
        <section class="card">
            <div class="card-header"><h2>ğŸ“‹ å†å²è®°å½•</h2></div>
            <div class="card-body">
                <div id="logList" class="log-list"></div>
            </div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCFk4f7bKUHlb3d1Cg1jyS1EM-SPC4pr40",
            authDomain: "myflightlog-1f4cb.firebaseapp.com",
            projectId: "myflightlog-1f4cb",
            storageBucket: "myflightlog-1f4cb.firebasestorage.app",
            messagingSenderId: "181072044112",
            appId: "1:181072044112:web:ca312da2d4780227cef155"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        let currentUser = null, allRecords = [];

        window.loginWithGoogle = async () => { try { await signInWithPopup(auth, provider); } catch (e) { alert(e.message); } };
        window.doLogout = async () => { await signOut(auth); };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userInfo').textContent = `ğŸ‘¨â€âœˆï¸ ${user.displayName}`;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                document.getElementById('reportMonth').value = new Date().toISOString().slice(0, 7);
                if(localStorage.getItem("openai_key")) document.getElementById("innerApiKey").value = localStorage.getItem("openai_key");

                onSnapshot(query(collection(db, `users/${user.uid}/logs`), orderBy("date", "desc")), (snapshot) => {
                    allRecords = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    renderList(); renderReport();
                });
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
        });

        // AI å¤„ç†
        window.processAI = async () => {
            const text = document.getElementById('ocrInput').value;
            const apiKey = document.getElementById('innerApiKey').value;
            if (!apiKey) return alert("è¯·è¾“å…¥ API Key");
            localStorage.setItem("openai_key", apiKey);

            const btn = document.getElementById('aiBtn');
            btn.textContent = "â³ åˆ†æä¸­..."; btn.disabled = true;

            // å‡çº§åçš„ Promptï¼Œå¢åŠ ç‰¹æ®Šæœºåœºå’ŒèŠ‚å‡æ—¥è¯†åˆ«
            const prompt = `
            åˆ†æé£è¡Œæ–‡æœ¬ï¼Œè¿”å›JSONã€‚
            å­—æ®µ: date, dep, arr, category("å›½å†…"|"æ¸¯æ¾³å°"|"äºšæ´²å›½é™…"|"æ´²é™…"),
            air_time(float), block_days(int,é»˜è®¤1), night1(18:30-24:00), night2(00:00-06:30),
            overnight, overnight_days(int),
            special_airport(int, 1ä¸ºæ˜¯ï¼Œ0ä¸ºå¦ã€‚è¯†åˆ«'ç‰¹æ®Šæœºåœº','é«˜é«˜åŸ'ç­‰),
            holiday(int, èŠ‚å‡æ—¥å¤©æ•°ã€‚è¯†åˆ«'æ˜¥èŠ‚','å›½åº†','åŠ ç­'ç­‰)
            æ–‡æœ¬: ${text}
            `;

            try {
                const res = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: "deepseek-chat", messages: [{role: "user", content: prompt}], temperature: 0.1 })
                });
                const data = await res.json();
                let content = data.choices[0].message.content;
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                const r = JSON.parse(jsonMatch ? jsonMatch[0] : content);

                // å¡«å……è¡¨å•
                const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
                setVal('f_date', r.date); setVal('f_dep', r.dep); setVal('f_arr', r.arr);
                setVal('f_cat', r.category || 'å›½å†…'); setVal('f_air', r.air_time || 0);
                setVal('f_block_days', r.block_days || 1); 
                setVal('f_night1', r.night1 || 0); setVal('f_night2', r.night2 || 0);
                setVal('f_overnight', r.overnight || 'å›½å†…æ— è¿‡å¤œ'); setVal('f_overnight_days', r.overnight_days || 0);
                // æ–°å¢å­—æ®µå¡«å……
                setVal('f_special', r.special_airport || 0);
                setVal('f_holiday', r.holiday || 0);

                document.getElementById('editForm').style.display = 'block';
            } catch (e) { alert("AI Error: " + e.message); } 
            finally { btn.textContent = "âœ¨ AI è¯†åˆ«"; btn.disabled = false; }
        };

        // ä¿å­˜
        window.saveRecord = async () => {
            const getNum = (id) => parseFloat(document.getElementById(id).value) || 0;
            const record = {
                date: document.getElementById('f_date').value,
                dep: document.getElementById('f_dep').value, arr: document.getElementById('f_arr').value,
                category: document.getElementById('f_cat').value,
                air_time: getNum('f_air'), block_days: getNum('f_block_days'),
                night1: getNum('f_night1'), night2: getNum('f_night2'),
                overnight: document.getElementById('f_overnight').value, overnight_days: getNum('f_overnight_days'),
                // æ–°å¢å­—æ®µä¿å­˜
                special_airport: getNum('f_special'), holiday: getNum('f_holiday'),
                meal_d: getNum('f_meal_d'), meal_i: getNum('f_meal_i'),
                timestamp: new Date()
            };
            await addDoc(collection(db, `users/${currentUser.uid}/logs`), record);
            document.getElementById('editForm').style.display = 'none';
            document.getElementById('ocrInput').value = '';
        };

        window.deleteItem = async (id) => { if(confirm("åˆ é™¤æ­¤è®°å½•ï¼Ÿ")) await deleteDoc(doc(db, `users/${currentUser.uid}/logs`, id)); };

        // æ¸²æŸ“åˆ—è¡¨ (åŒ…å«ç‰¹æ®Šæ ‡ç­¾)
        window.renderList = () => {
            const el = document.getElementById('logList');
            el.innerHTML = allRecords.length ? allRecords.map(r => `
                <div class="log-item">
                    <div class="log-info">
                        <div class="log-row-1">${r.date.slice(5)} &nbsp; ${r.dep} â” ${r.arr}</div>
                        <div class="log-row-2">
                            <span>â±ï¸${r.air_time}h</span>
                            <span class="tag">${r.category}</span>
                            ${r.overnight_days > 0 ? `<span class="tag">ğŸ ${r.overnight_days}d</span>` : ''}
                            ${r.special_airport > 0 ? `<span class="tag tag-special">ğŸ”ï¸ç‰¹æ®Š</span>` : ''}
                            ${r.holiday > 0 ? `<span class="tag tag-holiday">ğŸ§§èŠ‚å‡</span>` : ''}
                        </div>
                    </div>
                    <button class="btn-icon" onclick="deleteItem('${r.id}')">ğŸ—‘ï¸</button>
                </div>
            `).join('') : '<div style="text-align:center;color:#ccc;padding:20px">æ— è®°å½•</div>';
        };

        // æ¸²æŸ“æŠ¥è¡¨ (å¢åŠ ç‰¹æ®Š/èŠ‚å‡æ—¥åˆ—)
        window.renderReport = () => {
            const mStr = document.getElementById('reportMonth').value;
            const data = allRecords.filter(r => r.date.startsWith(mStr));
            
            const s = { 
                d_air:0, d_bk:0, h_air:0, h_bk:0, a_air:0, a_bk:0, i_air:0, i_bk:0, 
                n1:0, n2:0, o_d0:0, o_d1:0, o_i0:0, o_i1:0, m_d:0, m_i:0, 
                spec:0, hol:0 // æ–°å¢ç»Ÿè®¡å˜é‡
            };
            
            data.forEach(r => {
                if(r.category==='å›½å†…') { s.d_air+=r.air_time; s.d_bk+=r.block_days; }
                else if(r.category==='æ¸¯æ¾³å°') { s.h_air+=r.air_time; s.h_bk+=r.block_days; }
                else if(r.category==='äºšæ´²å›½é™…') { s.a_air+=r.air_time; s.a_bk+=r.block_days; }
                else { s.i_air+=r.air_time; s.i_bk+=r.block_days; }

                s.n1 += r.night1; s.n2 += r.night2;
                s.m_d += r.meal_d; s.m_i += r.meal_i;
                
                const days = r.overnight_days || 0;
                if(r.overnight==='å›½å†…æ— è¿‡å¤œ') s.o_d0+=days; else if(r.overnight==='å›½å†…æœ‰è¿‡å¤œ') s.o_d1+=days;
                else if(r.overnight==='å›½é™…æ— è¿‡å¤œ') s.o_i0+=days; else s.o_i1+=days;

                // ç´¯åŠ æ–°å­—æ®µ
                s.spec += (r.special_airport || 0);
                s.hol += (r.holiday || 0);
            });

            document.getElementById('reportTable').innerHTML = `
                <thead>
                    <tr><th rowspan="2">ç±»å‹</th><th colspan="2">å›½å†…</th><th colspan="2">æ¸¯æ¾³å°</th><th colspan="2">äºšæ´²</th><th colspan="2">æ´²é™…</th></tr>
                    <tr><th>ç©º</th><th>æ»‘</th><th>ç©º</th><th>æ»‘</th><th>ç©º</th><th>æ»‘</th><th>ç©º</th><th>æ»‘</th></tr>
                </thead>
                <tbody>
                    <tr>
                        <td>é£è¡Œ</td>
                        <td>${s.d_air.toFixed(1)}</td><td>${s.d_bk}</td>
                        <td>${s.h_air.toFixed(1)}</td><td>${s.h_bk}</td>
                        <td>${s.a_air.toFixed(1)}</td><td>${s.a_bk}</td>
                        <td>${s.i_air.toFixed(1)}</td><td>${s.i_bk}</td>
                    </tr>
                    <tr><td colspan="9" style="background:#f8fafc;height:8px;padding:0"></td></tr>
                    <tr><th rowspan="2">è¡¥åŠ©</th><th colspan="2">å¤œèˆª</th><th colspan="2">ç‰¹æ®Š/èŠ‚å‡</th><th colspan="2">é©»å¤–(æœ‰)</th><th colspan="2">æœºç»„é¤</th></tr>
                    <tr><th>18:30</th><th>00:00</th><th class="bg-sub">ç‰¹æ®Š</th><th class="bg-sub">å‡æ—¥</th><th>å›½æœ‰</th><th>å¤–æœ‰</th><th>å›½</th><th>å¤–</th></tr>
                    <tr>
                        <td>ç»Ÿè®¡</td>
                        <td>${s.n1.toFixed(1)}</td><td>${s.n2.toFixed(1)}</td>
                        <td class="bg-sub">${s.spec}</td><td class="bg-sub">${s.hol}</td>
                        <td>${s.o_d1}</td><td>${s.o_i1}</td>
                        <td>${s.m_d}</td><td>${s.m_i}</td>
                    </tr>
                </tbody>
            `;
        };
    </script>
</body>
</html>
