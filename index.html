<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é£è¡Œæ—¥å¿— Pro - æœºé•¿å…¨èƒ½ç‰ˆ</title>
    <title>é£è¡Œæ—¥å¿— Pro - CCAR-91 æœºé•¿åˆè§„ç‰ˆ</title>
    <style>
        /* === åŸºç¡€å˜é‡ === */
        :root {
@@ -17,6 +17,8 @@
            --meal-bg: #fff7ed; --meal-text: #c2410c; --meal-border: #ffedd5;
            --night-bg: #0f172a; --night-text: #fcd34d;
            --tax-red: #dc2626; --income-green: #16a34a;
            --warn-bg: #fee2e2; --warn-text: #991b1b;
            --ok-green: #16a34a;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
@@ -35,6 +37,20 @@
        .top-bar { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 16px 24px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(37,99,235,0.3); margin-bottom: 10px; }
        .user-pill { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; backdrop-filter: blur(4px); margin-top: 5px; display: inline-block; }

        /* === åˆè§„ç›‘æ§ä»ªè¡¨ç›˜ (New) === */
        .comp-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .comp-panel { background: #f8fafc; border: 1px solid var(--border); border-radius: 10px; padding: 15px; }
        .comp-head { font-size: 0.85rem; font-weight: 700; color: #475569; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .comp-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.9rem; }
        .comp-label { color: #64748b; font-size: 0.8rem; }
        .comp-val { font-weight: 700; font-family: monospace; }
        .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        .dot-ok { background: var(--ok-green); box-shadow: 0 0 0 2px #dcfce7; }
        .dot-warn { background: #f59e0b; box-shadow: 0 0 0 2px #fef3c7; }
        .dot-err { background: var(--warn-text); box-shadow: 0 0 0 2px #fee2e2; }
        .progress-track { height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .progress-bar { height: 100%; transition: width 0.3s; }

        /* === è–ªèµ„è¡¨æ ¼æ ·å¼ === */
        .salary-summary-box { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; background: #eff6ff; padding: 15px; border-radius: 12px; border: 1px solid #bfdbfe; }
        .ss-item { text-align: center; }
@@ -125,6 +141,8 @@
        .meal-badge { font-size: 0.7rem; background: var(--meal-bg); color: var(--meal-text); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--meal-border); font-weight: bold; margin-left: 5px;}
        .ac-badge { font-size: 0.7rem; background: #e0e7ff; color: #3730a3; padding: 1px 5px; border-radius: 3px; font-family: monospace; }
        .crew-badge { font-size: 0.75rem; color: #475569; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; display: inline-block; }
        .warn-tag { display: inline-block; background: var(--warn-bg); color: var(--warn-text); font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-top: 4px; }
        .landing-tag { font-family: monospace; font-size: 0.7rem; background: #f1f5f9; color: #475569; padding: 1px 4px; border-radius: 3px; margin-left: 4px; border: 1px solid #cbd5e1; }

        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
@@ -202,7 +220,7 @@ <h3 style="margin-bottom:15px; text-align:center; color:#0f172a;">âš™ï¸ è–ªèµ„
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <h1 style="font-size: 3rem; margin-bottom: 10px;">âœˆï¸</h1>
            <h2 style="color: #1e40af; margin-bottom: 30px;">é£è¡Œæ—¥å¿— Pro<br><span style="font-size:0.9rem;color:#64748b;font-weight:normal">2025 æœºé•¿å¹´è–ªç»“ç®—ç‰ˆ</span></h2>
            <h2 style="color: #1e40af; margin-bottom: 30px;">é£è¡Œæ—¥å¿— Pro<br><span style="font-size:0.9rem;color:#64748b;font-weight:normal">CCAR-91 æœºé•¿åˆè§„ç‰ˆ</span></h2>
            <button class="btn btn-primary" style="width: 100%; padding: 14px;" onclick="loginWithGoogle()">Google ç™»å½•</button>
        </div>
    </div>
@@ -217,6 +235,19 @@ <h2 style="color: #1e40af; margin-bottom: 30px;">é£è¡Œæ—¥å¿— Pro<br><span style
            </div>
        </div>

        <!-- ğŸ›¡ï¸ CCAR-91 åˆè§„ç›‘æ§ä»ªè¡¨ç›˜ (New) -->
        <section class="card">
            <div class="card-header">
                <h2>ğŸ›¡ï¸ åˆè§„ä¸èµ„è´¨ç›‘æ§</h2>
                <span style="font-size:0.75rem; color:#64748b;">æ•°æ®å®æ—¶åŒæ­¥</span>
            </div>
            <div class="card-body">
                <div class="comp-grid" id="complianceDashboard">
                    <div style="text-align:center;color:#94a3b8;padding:10px;">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </section>

        <!-- ğŸ’° è–ªèµ„æ ¸ç®— -->
        <section class="card">
            <div class="card-header">
@@ -285,7 +316,7 @@ <h2>ğŸ“… æ‰§å‹¤æ—¥å†</h2>
                        </label>
                    </div>
                    <input type="password" id="innerApiKey" class="key-input" placeholder="DeepSeek API Key">
                    <textarea id="ocrInput" placeholder="åœ¨æ­¤ç²˜è´´æ–‡æœ¬...&#10;ä¾‹ï¼š11.9 æ²ˆé˜³-æ›¼è°· å›½é™…æœ‰è¿‡å¤œ æ»‘è¡Œ2å¤©&#10;ä¾‹ï¼š10æœˆ1æ—¥ åŠ ç­ èŠ‚å‡æ—¥ 4å¤©"></textarea>
                    <textarea id="ocrInput" placeholder="åœ¨æ­¤ç²˜è´´æ–‡æœ¬...&#10;ä¾‹ï¼š11.9 G650ER æ²ˆé˜³-æ›¼è°· 3èµ·è½ å›½é™…æœ‰è¿‡å¤œ æ»‘è¡Œ2å¤©&#10;ä¾‹ï¼š10æœˆ1æ—¥ CL850 è®­ç»ƒ 4å¤œé—´èµ·è½"></textarea>
                </div>

                <!-- ç¼–è¾‘è¡¨å• -->
@@ -294,13 +325,15 @@ <h2>ğŸ“… æ‰§å‹¤æ—¥å†</h2>
                    <input type="hidden" id="edit_doc_id">
                    <div class="form-grid">
                        <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="f_date"></div>
                        <div class="form-group"><label>èˆªç­å·</label><input type="text" id="f_flight_no"></div>
                        <div class="form-group"><label>æœºå‹(èµ„è´¨èµ›é“)</label><select id="f_ac_type" style="font-weight:bold;color:var(--primary)"><option value="G650ER">G650ER</option><option value="CL850">CL850</option></select></div>
                        <div class="form-group"><label>èµ·é£åœ°</label><input type="text" id="f_dep"></div>
                        <div class="form-group"><label>è½åœ°åœ°</label><input type="text" id="f_arr"></div>
                        <div class="form-group"><label>èˆªçº¿å±æ€§</label><select id="f_cat"><option value="å›½å†…">å›½å†…</option><option value="æ¸¯æ¾³å°">æ¸¯æ¾³å°</option><option value="äºšæ´²å›½é™…">äºšæ´²å›½é™…</option><option value="æ´²é™…">æ´²é™…</option></select></div>
                        <div class="form-group form-full"><label>æœºç»„æˆå‘˜</label><input type="text" id="f_crew"></div>
                        <div class="form-group"><label>æœºå‹</label><input type="text" id="f_ac_type" list="ac_list"></div>
                        <datalist id="ac_list"><option value="G650ER"><option value="CL850"><option value="G550"></datalist>
                        <div class="form-group"><label>æœºç»„æˆå‘˜</label><input type="text" id="f_crew"></div>
                        <div class="form-group"><label>èˆªç­å·</label><input type="text" id="f_flight_no"></div>

                        <div class="form-group" style="background:#f1f5f9;border:1px dashed #cbd5e1;padding:5px;border-radius:6px;"><label>æ—¥é—´èµ·è½(æ¬¡)</label><input type="number" id="f_landings_day" value="0"></div>
                        <div class="form-group" style="background:#1e293b;border:1px dashed #475569;padding:5px;border-radius:6px;"><label style="color:#fcd34d">å¤œé—´èµ·è½(æ¬¡)</label><input type="number" id="f_landings_night" value="0" style="background:#334155;color:#fff;border-color:#475569"></div>

                        <div class="form-full" style="background:#f8fafc; padding:10px; border-radius:8px; border:1px dashed #e2e8f0; display:grid; grid-template-columns:repeat(4,1fr); gap:8px;">
                            <div><label style="font-size:0.7rem;text-align:center;display:block">æ’¤è½®</label><input type="time" id="f_block_off" oninput="recalcTimes()"></div>
@@ -444,11 +477,103 @@ <h2>ğŸ“… æ‰§å‹¤æ—¥å†</h2>
        });

        window.refreshAll = () => { 
            // æ¯ä¸€ä¸ªæ¸²æŸ“å‡½æ•°éƒ½åŒ…è£¹ try-catchï¼Œé˜²æ­¢ä¸€ä¸ªæ¨¡å—çš„é”™è¯¯å¯¼è‡´å…¨å±ç©ºç™½
            try { renderList(); } catch(e) { console.error("Render List Error", e); }
            try { renderReport(); } catch(e) { console.error("Render Report Error", e); }
            try { renderCalendar(); } catch(e) { console.error("Render Calendar Error", e); }
            try { renderSalary(); } catch(e) { console.error("Render Salary Error", e); }
            try { renderCompliance(); } catch(e) { console.error("Render Compliance Error", e); }
        };

        // === æ ¸å¿ƒï¼šåˆè§„ä¸èµ„è´¨ç›‘æ§é€»è¾‘ (CCAR-91) ===
        function checkCompliance(records) {
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            const start90 = new Date(); start90.setDate(now.getDate() - 90);
            
            // 1. èµ„è´¨ç›‘æ§ (90å¤©èµ·è½)
            let stats = {
                g650: { total: 0, night: 0 },
                cl850: { total: 0, night: 0 }
            };

            records.forEach(r => {
                const d = new Date(r.date);
                if (d >= start90 && d <= now) {
                    // å®‰å…¨è§£ææ•°å­—
                    const dayL = parseInt(r.landings_day) || 0;
                    const nightL = parseInt(r.landings_night) || 0;
                    const type = r.ac_type; // G650ER æˆ– CL850
                    
                    if (type === 'G650ER') {
                        stats.g650.total += (dayL + nightL);
                        stats.g650.night += nightL;
                    } else if (type === 'CL850') {
                        stats.cl850.total += (dayL + nightL);
                        stats.cl850.night += nightL;
                    }
                }
            });

            // 2. ç–²åŠ³ç›‘æ§ (è¿‡å»7å¤© 40å°æ—¶é™åˆ¶)
            // è®¡ç®—æˆªæ­¢åˆ°ä»Šå¤©çš„ç´¯è®¡å€¼ (Dashboardç”¨)
            const start7 = new Date(); start7.setDate(now.getDate() - 6);
            let fatigue7 = 0;
            records.forEach(r => {
                const d = new Date(r.date);
                if (d >= start7 && d <= now) {
                    fatigue7 += (parseFloat(r.total_time) || 0);
                }
            });

            return { recency: stats, fatigue: fatigue7 };
        }

        // æ¸²æŸ“åˆè§„ä»ªè¡¨ç›˜
        window.renderCompliance = () => {
            const data = checkCompliance(allRecords);
            const r = data.recency;
            
            const getStatus = (val, target, isFatigue=false) => {
                if(isFatigue) return val > target ? 'dot-err' : (val > target*0.8 ? 'dot-warn' : 'dot-ok');
                return val >= target ? 'dot-ok' : (val > 0 ? 'dot-warn' : 'dot-err');
            };

            const html = `
                <!-- ç–²åŠ³ç›‘æ§ (äºº) -->
                <div class="comp-panel">
                    <div class="comp-head"><span>ğŸ‘¨â€âœˆï¸ ç–²åŠ³ç›‘æ§ (7å¤©æ»šåŠ¨)</span><span class="${getStatus(data.fatigue, 40, true)} status-dot"></span></div>
                    <div class="comp-row"><span class="comp-label">æ‰§å‹¤æ—¶é—´</span><span class="comp-val" style="color:${data.fatigue>40?'#ef4444':'#0f172a'}">${data.fatigue.toFixed(1)} / 40h</span></div>
                    <div class="progress-track"><div class="progress-bar ${data.fatigue>40?'bg-err':''}" style="width:${Math.min((data.fatigue/40)*100, 100)}%; background:${data.fatigue>40?'#ef4444':'var(--primary)'}"></div></div>
                    <div style="font-size:0.7rem;color:#94a3b8;margin-top:5px;text-align:right">${data.fatigue>40?'âš ï¸ å·²è¶…é™ï¼Œéœ€åºŸå¼ƒå·¥æ—¶':'è¿è¡Œæ­£å¸¸'}</div>
                </div>

                <!-- G650ER èµ„è´¨ -->
                <div class="comp-panel">
                    <div class="comp-head"><span>âœˆï¸ G650ER èµ„è´¨</span></div>
                    <div class="comp-row">
                        <span class="comp-label">90å¤©è½½å®¢ (â‰¥3)</span>
                        <span class="comp-val"><span class="${getStatus(r.g650.total, 3)} status-dot"></span>${r.g650.total}</span>
                    </div>
                    <div class="comp-row">
                        <span class="comp-label">90å¤©å¤œèˆª (â‰¥3)</span>
                        <span class="comp-val"><span class="${getStatus(r.g650.night, 3)} status-dot"></span>${r.g650.night}</span>
                    </div>
                </div>

                <!-- CL850 èµ„è´¨ -->
                <div class="comp-panel">
                    <div class="comp-head"><span>ğŸ›©ï¸ CL850 èµ„è´¨</span></div>
                    <div class="comp-row">
                        <span class="comp-label">90å¤©è½½å®¢ (â‰¥3)</span>
                        <span class="comp-val"><span class="${getStatus(r.cl850.total, 3)} status-dot"></span>${r.cl850.total}</span>
                    </div>
                    <div class="comp-row">
                        <span class="comp-label">90å¤©å¤œèˆª (â‰¥3)</span>
                        <span class="comp-val"><span class="${getStatus(r.cl850.night, 3)} status-dot"></span>${r.cl850.night}</span>
                    </div>
                </div>
            `;
            document.getElementById('complianceDashboard').innerHTML = html;
        };

        function calculateTax(amount) {
@@ -471,13 +596,21 @@ <h2>ğŸ“… æ‰§å‹¤æ—¥å†</h2>

            let s = { dom_air:0, hk_air:0, asia_air:0, out_air:0, n1:0, n2:0, spec_cnt:0, holiday_days:0, dom_stay:0, dom_no:0, int_stay:0, int_no:0, meal_dom_cnt:0, meal_int_cnt:0 };
            let block = { dom:0, hk:0, asia:0, out:0 };
            let midnight_bonus_cnt = 0; // è·¨é›¶ç‚¹è®¡æ•°

            data.forEach(r => {
                // å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œé˜²æ­¢ç©ºå­—ç¬¦ä¸²å¯¼è‡´è®¡ç®—NaN
                const air = parseFloat(r.air_time) || 0;
                const bDays = parseFloat(r.block_days) || 0;

                if(r.category==='å›½å†…') { s.dom_air += air; block.dom += bDays; } 
                if(r.category==='å›½å†…') { 
                    s.dom_air += air; 
                    block.dom += bDays;
                    // === æ–°å¢ï¼šå›½å†…è·¨é›¶ç‚¹åˆ¤å®š ===
                    // é€»è¾‘ï¼šè½åœ°æ—¶é—´ < èµ·é£æ—¶é—´ (è§†ä¸ºè·¨è¶Š24:00) ä¸” å¿…é¡»æ˜¯å›½å†…èˆªç­
                    if (r.takeoff && r.landing && r.landing < r.takeoff) {
                        midnight_bonus_cnt++;
                    }
                } 
                else if(r.category==='æ¸¯æ¾³å°') { s.hk_air += air; block.hk += bDays; } 
                else if(r.category==='äºšæ´²å›½é™…') { s.asia_air += air; block.asia += bDays; } 
                else { s.out_air += air; block.out += bDays; }
@@ -490,7 +623,7 @@ <h2>ğŸ“… æ‰§å‹¤æ—¥å†</h2>
                s.meal_int_cnt += parseFloat(r.crew_meal_int)||0;
            });

            // è‡ªåŠ¨è®¡ç®—é©»å¤–ç»Ÿè®¡ (å¢åŠ å®‰å…¨æ£€æŸ¥)
            // è‡ªåŠ¨è®¡ç®—é©»å¤–ç»Ÿè®¡
            let autoStatus = {};
            allRecords.forEach(r => { 
                if(r.overnight && !r.overnight.includes('æ— ') && (parseFloat(r.overnight_days) || 0) > 0) { 
@@ -508,7 +641,7 @@ <h2>ğŸ“… æ‰§å‹¤æ—¥å†</h2>
            for(let d=1; d<=daysInMonth; d++) { 
                const dStr = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; 
                let type = null; 
                let raw = calendarData[dStr] || {}; // å®‰å…¨è®¿é—®
                let raw = calendarData[dStr] || {}; 

                if (raw.type) type = raw.type; 
                else { 
@@ -528,10 +661,12 @@ <h2>ğŸ“… æ‰§å‹¤æ—¥å†</h2>
            rows += `<tr><td class="col-name">å›ºå®šå·¥èµ„ (ç¨å)</td><td class="col-proc">åŒ…å«å›½å†…é£è¡Œ/æ»‘è¡Œè´¹<br><span style="color:#059669">å…¬å¸å…¨é¢æ‰¿æ‹…ä¸ªç¨</span></td><td class="col-amt">${fmt(FIXED_BASE_NET)}</td></tr>`;

            let gross_var = 0;
            // å°æ—¶è´¹
            if(s.hk_air > 0) { const r = isSigned?cfg.hk.s:cfg.hk.u; const amt = s.hk_air * r; gross_var += amt; rows += `<tr><td class="col-name">æ¸¯æ¾³å°ç©ºæ—¶</td><td class="col-proc"><span class="calc-tag">${s.hk_air.toFixed(1)}h</span>Ã— ${r}</td><td class="col-amt">${fmt(amt)}</td></tr>`; }
            if(s.asia_air > 0) { const r = isSigned?cfg.asia.s:cfg.asia.u; const amt = s.asia_air * r; gross_var += amt; rows += `<tr><td class="col-name">äºšæ´²ç©ºæ—¶</td><td class="col-proc"><span class="calc-tag">${s.asia_air.toFixed(1)}h</span>Ã— ${r}</td><td class="col-amt">${fmt(amt)}</td></tr>`; }
            if(s.out_air > 0) { const r = isSigned?cfg.out.s:cfg.out.u; const amt = s.out_air * r; gross_var += amt; rows += `<tr><td class="col-name">æ´²é™…ç©ºæ—¶</td><td class="col-proc"><span class="calc-tag">${s.out_air.toFixed(1)}h</span>Ã— ${r}</td><td class="col-amt">${fmt(amt)}</td></tr>`; }

            // æ»‘è¡Œè´¹
            if(block.hk > 0) { const r = isSigned?cfg.hk.s:cfg.hk.u; const amt = block.hk * r * 0.6; gross_var += amt; rows += `<tr><td class="col-name">æ¸¯æ¾³å°æ»‘è¡Œ</td><td class="col-proc"><span class="calc-tag">${block.hk}å¤©</span>Ã— ${r} Ã— 0.6</td><td class="col-amt">${fmt(amt)}</td></tr>`; }
            if(block.asia > 0) { const r = isSigned?cfg.asia.s:cfg.asia.u; const amt = block.asia * r * 0.6; gross_var += amt; rows += `<tr><td class="col-name">äºšæ´²æ»‘è¡Œ</td><td class="col-proc"><span class="calc-tag">${block.asia}å¤©</span>Ã— ${r} Ã— 0.6</td><td class="col-amt">${fmt(amt)}</td></tr>`; }
            if(block.out > 0) { const r = isSigned?cfg.out.s:cfg.out.u; const amt = block.out * r * 0.6; gross_var += amt; rows += `<tr><td class="col-name">æ´²é™…æ»‘è¡Œ</td><td class="col-proc"><span class="calc-tag">${block.out}å¤©</span>Ã— ${r} Ã— 0.6</td><td class="col-amt">${fmt(amt)}</td></tr>`; }
@@ -541,6 +676,13 @@ <h2>ğŸ“… æ‰§å‹¤æ—¥å†</h2>
            if(s.n2 > 0) { const amt = s.n2 * cfg.n2; gross_var += amt; rows += `<tr><td class="col-name">å¤œèˆª(å)</td><td class="col-proc">${s.n2.toFixed(1)}h Ã— ${cfg.n2}</td><td class="col-amt">${fmt(amt)}</td></tr>`; }
            if(s.spec_cnt > 0) { const amt = s.spec_cnt * cfg.spec; gross_var += amt; rows += `<tr><td class="col-name">ç‰¹æ®Šæœºåœº</td><td class="col-proc">${s.spec_cnt}æ¬¡ Ã— ${cfg.spec}</td><td class="col-amt">${fmt(amt)}</td></tr>`; }

            // === æ–°å¢ï¼šå›½å†…è·¨é›¶ç‚¹è¡¥åŠ© ===
            if(midnight_bonus_cnt > 0) {
                const amt = midnight_bonus_cnt * 200;
                gross_var += amt;
                rows += `<tr><td class="col-name" style="color:#d97706">å›½å†…è·¨é›¶ç‚¹</td><td class="col-proc">${midnight_bonus_cnt}æ¬¡ Ã— 200 (è½åœ°<èµ·é£)</td><td class="col-amt">${fmt(amt)}</td></tr>`;
            }

            // è¡¥åŠ©æ˜ç»†æ‹¼æ¥é€»è¾‘
            const allowances = (s.meal_dom_cnt*60) + (s.meal_int_cnt*180) + (s.dom_stay * cfg.dom_stay) + (s.dom_no * cfg.dom_no) + (s.int_stay * cfg.int_stay) + (s.int_no * cfg.int_no);
            if(allowances > 0) {
@@ -594,7 +736,6 @@ <h2>ğŸ“… æ‰§å‹¤æ—¥å†</h2>
        };

        function formatTimePair(decimal) {
            // å®‰å…¨å¤„ç† NaN
            if (!decimal || isNaN(decimal)) return `<div class="time-dual"><span class="time-dec">0.00</span></div>`;
            let h = Math.floor(decimal); let m = Math.round((decimal - h) * 60); if (m === 60) { h++; m = 0; }
            return `<div class="time-dual"><div class="time-dec">${decimal.toFixed(2)}</div><div class="time-hm">(${h}:${String(m).padStart(2, '0')})</div></div>`;
@@ -630,20 +771,17 @@ <h2>ğŸ“… æ‰§å‹¤æ—¥å†</h2>

        window.openStatusModal = (dateStr) => { 
            currentModalDate = dateStr; document.getElementById('modalDateStr').innerText = dateStr; 
            const currentData = calendarData[dateStr] || {}; // å®‰å…¨è®¿é—®
            const currentData = calendarData[dateStr] || {}; 
            document.getElementById('modalCityInput').value = (currentData && currentData.city) ? currentData.city : '';
            document.getElementById('statusModal').style.display = 'flex'; 
        };
        window.closeStatusModal = () => { document.getElementById('statusModal').style.display = 'none'; };
        window.saveCalendarStatus = async (type) => { if(currentUser && currentModalDate) { const city = document.getElementById('modalCityInput').value.trim(); await setDoc(doc(db, `users/${currentUser.uid}/calendar_status`, currentModalDate), type ? { type: type, city: city } : { type: null, city: null }, { merge: true }); closeStatusModal(); } };

        // è‡ªåŠ¨è®¡ç®—é€»è¾‘ (å¢åŠ äº†æ—¶åˆ†æ˜¾ç¤º)
        window.recalcTimes = () => { 
            // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œé˜²æ­¢æŠ¥é”™ä¸­æ–­
            const t_tk_el = document.getElementById('f_takeoff');
            const hint_air_el = document.getElementById('hint_air');
            
            if (!t_tk_el || !hint_air_el) return; // å¦‚æœå…ƒç´ æœªåŠ è½½å®Œå…¨ï¼Œç›´æ¥é€€å‡º
            if (!t_tk_el || !hint_air_el) return; 

            const t_tk = t_tk_el.value; 
            const t_ld = document.getElementById('f_landing').value; 
@@ -653,10 +791,6 @@ <h2>ğŸ“… æ‰§å‹¤æ—¥å†</h2>
            let air = calculateDuration(t_tk, t_ld);
            let total = calculateDuration(t_off, t_on);

            const manualAir = parseFloat(document.getElementById('f_air').value);
            const manualTotal = parseFloat(document.getElementById('f_total_time').value);
            
            // ä¿®æ­£ï¼šå¼ºåˆ¶æ›´æ–°ç©ºæ—¶å’Œæ€»æ—¶ï¼Œç§»é™¤ !manualAir åˆ¤æ–­ï¼Œä»¥ä¾¿æ‰‹åŠ¨è°ƒæ•´æ—¶é—´åæ•°å€¼è·Ÿéšå˜åŒ–
            if(air > 0) document.getElementById('f_air').value = air;
            if(total > 0) document.getElementById('f_total_time').value = total;

@@ -673,7 +807,7 @@ <h2>ğŸ“… æ‰§å‹¤æ—¥å†</h2>
            } 
        };

        // === AI è¯†åˆ« (å¢åŠ  UTC é€‰é¡¹) ===
        // === AI è¯†åˆ« (Prompt æ›´æ–°) ===
        window.processAI = async () => {
            const text = document.getElementById('ocrInput').value.trim();
            const apiKey = document.getElementById('innerApiKey').value.trim();
@@ -692,7 +826,14 @@ <h2>ğŸ“… æ‰§å‹¤æ—¥å†</h2>

            let timeInstruction = isUTC ? "è¯†åˆ«åˆ°çš„æ‰€æœ‰æ—¶é—´ç‚¹ï¼ˆèµ·é£ã€è½åœ°ã€æ’¤è½®ã€æŒ¡è½®ï¼‰å‡ä¸º UTC æ—¶é—´ï¼Œè¯·è‡ªåŠ¨å°†å…¶è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´ï¼ˆUTC+8ï¼‰åå†è¿”å› JSON æ•°æ®ã€‚" : "æ—¶é—´ä¿æŒåŸæ ·ï¼Œæ— éœ€è½¬æ¢æ—¶åŒºã€‚";

            const prompt = `è¯·åˆ†æé£è¡Œè®°å½•å¹¶è¿”å› JSON æ ¼å¼æ•°æ®ã€‚${timeInstruction} è§„åˆ™ï¼šèŠ‚å‡æ—¥åŠ ç­éœ€è¯†åˆ«å…³é”®å­—è¿”å›holidayå­—æ®µ(å¤©æ•°)ã€‚æ»‘è¡Œå¤©æ•°è¿”å›block_days(é»˜è®¤1)ã€‚å›½å†…é£è¡Œhoursè®¡è´¹ä¸º0ä½†éœ€è®°å½•æ—¶é—´ã€‚å­—æ®µ: date, dep, arr, category(å›½å†…/æ¸¯æ¾³å°/äºšæ´²å›½é™…/æ´²é™…), crew, flight_no, ac_type, time_off, time_takeoff, time_landing, time_on, night1, night2, overnight, overnight_city, overnight_days, special_airport, holiday(int), block_days(int), crew_meal_dom, crew_meal_int.`;
            // Prompt ä¸­å¢åŠ äº† landings_day å’Œ landings_nightï¼Œä»¥åŠ ac_type çš„è§„èŒƒåŒ–
            const prompt = `è¯·åˆ†æé£è¡Œè®°å½•å¹¶è¿”å› JSON æ ¼å¼æ•°æ®ã€‚${timeInstruction} è§„åˆ™ï¼š
            1. æœºå‹ ac_type å¿…é¡»æ˜ å°„ä¸º "G650ER" æˆ– "CL850"ï¼Œå¦‚æœæ²¡æœ‰æ˜ç¡®æŒ‡å‡ºï¼Œè¯·æ ¹æ®ä¸Šä¸‹æ–‡æˆ–é»˜è®¤ä¸º "G650ER"ã€‚
            2. è¯†åˆ«æ—¥é—´èµ·è½æ¬¡æ•°(landings_day)å’Œå¤œé—´èµ·è½æ¬¡æ•°(landings_night)ã€‚å¦‚æœåªè¯´äº†â€œ3ä¸ªèµ·è½â€ï¼Œä¸”æ²¡æœ‰æå¤œé—´ï¼Œåˆ™landings_day=3, landings_night=0ã€‚
            3. èŠ‚å‡æ—¥åŠ ç­è¿”å›holidayå­—æ®µ(å¤©æ•°)ã€‚
            4. æ»‘è¡Œå¤©æ•°è¿”å›block_days(é»˜è®¤1)ã€‚
            5. å›½å†…é£è¡Œhoursè®¡è´¹ä¸º0ä½†éœ€è®°å½•æ—¶é—´ã€‚
            å­—æ®µ: date, dep, arr, category(å›½å†…/æ¸¯æ¾³å°/äºšæ´²å›½é™…/æ´²é™…), crew, flight_no, ac_type, landings_day, landings_night, time_off, time_takeoff, time_landing, time_on, night1, night2, overnight, overnight_city, overnight_days, special_airport, holiday(int), block_days(int), crew_meal_dom, crew_meal_int.`;

            try {
                const res = await fetch("https://api.deepseek.com/chat/completions", { 
@@ -714,11 +855,10 @@ <h2>ğŸ“… æ‰§å‹¤æ—¥å†</h2>
                const rawData = await res.json();

                if (!res.ok) {
                    const errMsg = rawData.error ? rawData.error.message : "æœªçŸ¥é”™è¯¯";
                    throw new Error(`APIè¯·æ±‚å¤±è´¥ (${res.status}): ${errMsg}`);
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${rawData.error ? rawData.error.message : "æœªçŸ¥é”™è¯¯"}`);
                }
                if (!rawData.choices || rawData.choices.length === 0) {
                    throw new Error("AI æœªè¿”å›æœ‰æ•ˆå†…å®¹ï¼Œè¯·æ£€æŸ¥ Key æˆ–ä½™é¢");
                    throw new Error("AI æœªè¿”å›æœ‰æ•ˆå†…å®¹");
                }

                const r = JSON.parse(rawData.choices[0].message.content);
@@ -744,6 +884,7 @@ <h2>ğŸ“… æ‰§å‹¤æ—¥å†</h2>
            const set = (k, v) => { const el=document.getElementById('f_'+k); if(el) el.value = v!==undefined?v:''; };
            set('date',d.date); set('dep',d.dep); set('arr',d.arr); set('cat',d.category); set('crew',d.crew);
            set('flight_no',d.flight_no); set('tail_no',d.tail_no); set('ac_type',d.ac_type);
            set('landings_day',d.landings_day); set('landings_night',d.landings_night); // è®¾ç½®èµ·è½
            set('block_off',d.time_off||d.block_off); set('takeoff',d.time_takeoff||d.takeoff); 
            set('landing',d.time_landing||d.landing); set('block_on',d.time_on||d.block_on);
            set('air',d.air_time); set('total_time',d.total_time); set('night1',d.night1); set('night2',d.night2);
@@ -754,9 +895,11 @@ <h2>ğŸ“… æ‰§å‹¤æ—¥å†</h2>
        function resetForm() { 
            document.getElementById('edit_doc_id').value=''; 
            document.querySelectorAll('.edit-form input, .edit-form select').forEach(i=>i.value=''); 
            // ä¿®æ­£ï¼šé‡ç½®æ—¶æ»‘è¡Œå¤©æ•°é»˜è®¤ä¸ºç©ºï¼Œè€Œä¸æ˜¯1
            document.getElementById('f_block_days').value=''; 
            // å®‰å…¨é‡ç½®æç¤º
            // é»˜è®¤å€¼é‡ç½®
            document.getElementById('f_landings_day').value = '0';
            document.getElementById('f_landings_night').value = '0';
            document.getElementById('f_ac_type').value = 'G650ER'; // é»˜è®¤æœºå‹
            const ha = document.getElementById('hint_air'); if(ha) ha.innerText='';
            const ht = document.getElementById('hint_total'); if(ht) ht.innerText='';
        }
@@ -770,16 +913,19 @@ <h2>ğŸ“… æ‰§å‹¤æ—¥å†</h2>

                const getV = (k) => { const el = document.getElementById('f_'+k); return el ? el.value.trim() : ''; };
                const getN = (k) => parseFloat(getV(k))||0;
                const getI = (k) => parseInt(getV(k))||0;

                if (!getV('date')) throw new Error("æ—¥æœŸä¸èƒ½ä¸ºç©º");
                if (!getV('dep') || !getV('arr')) throw new Error("èµ·é™åœ°ä¸èƒ½ä¸ºç©º");
                if (!getV('ac_type')) throw new Error("å¿…é¡»é€‰æ‹©æœºå‹");

                let ovCity = getV('overnight_city');
                if(!ovCity && getV('overnight')!=='æ— ') ovCity = getV('arr');

                const d = {
                    date: getV('date'), dep: getV('dep'), arr: getV('arr'), category: getV('cat'), crew: getV('crew'),
                    flight_no: getV('flight_no'), ac_type: getV('ac_type'),
                    landings_day: getI('landings_day'), landings_night: getI('landings_night'), // ä¿å­˜èµ·è½
                    block_off: getV('block_off'), takeoff: getV('takeoff'), landing: getV('landing'), block_on: getV('block_on'),
                    air_time: getN('air'), total_time: getN('total_time'), block_days: getN('block_days'), night1: getN('night1'), night2: getN('night2'),
                    overnight: getV('overnight'), overnight_city: ovCity, overnight_days: getN('overnight_days'),
@@ -826,7 +972,6 @@ <h2>ğŸ“… æ‰§å‹¤æ—¥å†</h2>

            let autoStatus = {};
            allRecords.forEach(r => {
                // å®‰å…¨å¤„ç†æ•°å­—
                const ovDays = parseFloat(r.overnight_days) || 0;
                if(r.overnight && !r.overnight.includes('æ— ') && ovDays > 0) {
                    const d = new Date(r.date);
@@ -904,15 +1049,60 @@ <h2>ğŸ“… æ‰§å‹¤æ—¥å†</h2>
            }
            document.getElementById('reportTable').innerHTML = `<thead><tr><th rowspan="2">ç±»åˆ«</th><th colspan="2">å›½å†…</th><th colspan="2">æ¸¯æ¾³å°</th><th colspan="2">äºšæ´²</th><th colspan="2">æ´²é™…</th></tr><tr><th>ç©ºæ—¶</th><th>æ»‘è¡Œ</th><th>ç©ºæ—¶</th><th>æ»‘è¡Œ</th><th>ç©ºæ—¶</th><th>æ»‘è¡Œ</th><th>ç©ºæ—¶</th><th>æ»‘è¡Œ</th></tr></thead><tbody><tr><td style="font-weight:bold">åˆè®¡</td><td>${formatTimePair(s.d_a)}</td><td>${s.d_b}</td><td>${formatTimePair(s.h_a)}</td><td>${s.h_b}</td><td>${formatTimePair(s.a_a)}</td><td>${s.a_b}</td><td>${formatTimePair(s.i_a)}</td><td>${s.i_b}</td></tr><tr><td colspan="9" style="height:8px;border:none;background:white"></td></tr><tr><th rowspan="2">è¡¥è´´</th><th colspan="2">æœºç»„é¤(ä»½)</th><th colspan="2">é©»å¤–-å›½å†…</th><th colspan="2">é©»å¤–-å›½é™…</th><th colspan="2">å…¶ä»–</th></tr><tr><th class="bg-meal">å›½å†…</th><th class="bg-meal">å›½é™…</th><th class="bg-cal-stat">å›½æœ‰(å¤©)</th><th class="bg-cal-stat">å›½æ— (æ¬¡)</th><th class="bg-cal-stat">å¤–æœ‰(å¤©)</th><th class="bg-cal-stat">å¤–æ— (æ¬¡)</th><th class="bg-sub">ç‰¹æ®Š</th><th class="bg-sub">èŠ‚æ—¥</th></tr><tr><td style="font-weight:bold">ç»Ÿè®¡</td><td class="bg-meal">${s.meal_d}</td><td class="bg-meal">${s.meal_i}</td><td class="bg-cal-stat" style="font-size:1.1rem">${s.cal_dom_stay}</td><td class="bg-cal-stat" style="font-size:1.1rem">${s.cal_dom_no}</td><td class="bg-cal-stat" style="font-size:1.1rem">${s.cal_int_stay}</td><td class="bg-cal-stat" style="font-size:1.1rem">${s.cal_int_no}</td><td class="bg-sub">${s.spec}</td><td class="bg-sub">${s.hol}</td></tr><tr><td colspan="9" style="font-size:0.7rem;color:#94a3b8;text-align:right;padding:4px;border:none">å¤œèˆª: 18:30(${s.n1.toFixed(1)}) / 00:00(${s.n2.toFixed(1)})</td></tr></tbody>`;
        };

        window.renderList = () => {
            const listEl = document.getElementById('logList'); const mStr = document.getElementById('reportMonth').value; 
            const listEl = document.getElementById('logList'); 
            const mStr = document.getElementById('reportMonth').value; 
            const displayData = allRecords.filter(r => r.date.startsWith(mStr));
            
            if (!displayData.length) { listEl.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:20px">æœ¬æœˆæ— é£è¡Œè®°å½•</div>'; return; }
            
            listEl.innerHTML = displayData.map(r => {
                const ms=[]; 
                if((parseFloat(r.crew_meal_dom)||0)>0) ms.push(`${r.crew_meal_dom}å›½`); 
                if((parseFloat(r.crew_meal_int)||0)>0) ms.push(`${r.crew_meal_int}å¤–`);
                return `<div class="log-item"><div class="log-info"><div class="log-header"><div style="font-weight:700;color:#1e293b;display:flex;gap:8px;align-items:center"><span style="font-family:monospace;color:#64748b;background:#f1f5f9;padding:2px 6px;border-radius:4px;font-size:0.8rem">${r.date.substring(5)}</span>${r.dep} <span style="color:#cbd5e1">âœ</span> ${r.arr} ${r.ac_type?`<span class="ac-badge">${r.ac_type}</span>`:''}</div>${ms.length?`<span class="meal-badge">ğŸ± ${ms.join('+')}</span>`:''}</div><div style="font-size:0.8rem;color:#64748b;margin-top:4px;display:flex;flex-wrap:wrap;gap:6px;align-items:center"><span style="color:var(--primary);font-weight:bold">${r.total_time}h</span> Â· ${r.category} ${r.flight_no?`Â· ${r.flight_no}`:''} ${r.crew?`<div class="crew-badge">ğŸ‘¨â€âœˆï¸ ${r.crew}</div>`:''}</div></div><div class="log-actions" style="display:flex;gap:5px;margin-left:5px;"><button class="btn btn-edit" onclick="editRecord('${r.id}')">âœï¸</button><button class="btn btn-danger" onclick="deleteItem('${r.id}')">ğŸ—‘ï¸</button></div></div>`;
                
                // èµ·è½æ˜¾ç¤º
                const lDay = parseInt(r.landings_day) || 0;
                const lNight = parseInt(r.landings_night) || 0;
                let landingBadge = '';
                if(lDay > 0 || lNight > 0) landingBadge = `<span class="landing-tag">ğŸ›¬ ${lDay}æ—¥/${lNight}å¤œ</span>`;

                // 7å¤©ç–²åŠ³è®¡ç®— (List Item ç»´åº¦)
                let fatigueWarning = '';
                const d = new Date(r.date);
                const start7 = new Date(d); start7.setDate(d.getDate() - 6);
                let sum7 = 0;
                allRecords.forEach(ar => {
                    const ad = new Date(ar.date);
                    if (ad >= start7 && ad <= d) sum7 += (parseFloat(ar.total_time)||0);
                });
                if (sum7 > 40) {
                    fatigueWarning = `<div class="warn-tag">âš ï¸ 7å¤©è¶…é™ (åºŸå¼ƒ ${(sum7-40).toFixed(1)}h)</div>`;
                }

                return `<div class="log-item">
                    <div class="log-info">
                        <div class="log-header">
                            <div style="font-weight:700;color:#1e293b;display:flex;gap:8px;align-items:center">
                                <span style="font-family:monospace;color:#64748b;background:#f1f5f9;padding:2px 6px;border-radius:4px;font-size:0.8rem">${r.date.substring(5)}</span>
                                ${r.dep} <span style="color:#cbd5e1">âœ</span> ${r.arr} 
                                ${r.ac_type?`<span class="ac-badge">${r.ac_type}</span>`:''}
                            </div>
                            ${ms.length?`<span class="meal-badge">ğŸ± ${ms.join('+')}</span>`:''}
                        </div>
                        <div style="font-size:0.8rem;color:#64748b;margin-top:4px;display:flex;flex-wrap:wrap;gap:6px;align-items:center">
                            <span style="color:var(--primary);font-weight:bold">${r.total_time}h</span> Â· ${r.category} 
                            ${r.flight_no?`Â· ${r.flight_no}`:''} 
                            ${landingBadge}
                        </div>
                        ${fatigueWarning}
                    </div>
                    <div class="log-actions" style="display:flex;gap:5px;margin-left:5px;">
                        <button class="btn btn-edit" onclick="editRecord('${r.id}')">âœï¸</button>
                        <button class="btn btn-danger" onclick="deleteItem('${r.id}')">ğŸ—‘ï¸</button>
                    </div>
                </div>`;
            }).join('');
        };
    </script>
