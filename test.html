<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é£è¡Œæ—¥å¿— Pro - CCAR-91 æœºé•¿åˆè§„ç‰ˆ</title>
    <style>
        /* === åŸºç¡€å˜é‡ === */
        :root {
            --primary: #2563eb; --primary-dark: #1e40af; 
            --bg: #f8fafc; --text: #334155; --border: #cbd5e1;
            /* çŠ¶æ€é¢œè‰² */
            --dom-stay-bg: #dbeafe; --dom-stay-text: #1e40af;
            --dom-no-bg: #d1fae5; --dom-no-text: #065f46;
            --int-stay-bg: #f3e8ff; --int-stay-text: #6b21a8;
            --int-no-bg: #fef3c7; --int-no-text: #92400e;
            --meal-bg: #fff7ed; --meal-text: #c2410c; --meal-border: #ffedd5;
            --night-bg: #0f172a; --night-text: #fcd34d;
            --tax-red: #dc2626; --income-green: #16a34a;
            --warn-bg: #fee2e2; --warn-text: #991b1b;
            --ok-green: #16a34a;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg); color: var(--text);
            padding: 15px; min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; padding-bottom: 60px; }

        /* é€šç”¨ç»„ä»¶ */
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border); overflow: hidden; }
        .card-header { padding: 15px 20px; background: #fff; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .card-header h2 { font-size: 1.1rem; font-weight: 700; color: #0f172a; }
        .card-body { padding: 20px; }
        
        .top-bar { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 16px 24px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(37,99,235,0.3); margin-bottom: 10px; }
        .user-pill { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; backdrop-filter: blur(4px); margin-top: 5px; display: inline-block; }

        /* === ä»ªè¡¨ç›˜ === */
        .comp-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .comp-panel { background: #f8fafc; border: 1px solid var(--border); border-radius: 10px; padding: 15px; }
        .comp-head { font-size: 0.85rem; font-weight: 700; color: #475569; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .comp-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.9rem; }
        .comp-label { color: #64748b; font-size: 0.8rem; }
        .comp-val { font-weight: 700; font-family: monospace; }
        .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        .dot-ok { background: var(--ok-green); box-shadow: 0 0 0 2px #dcfce7; }
        .dot-warn { background: #f59e0b; box-shadow: 0 0 0 2px #fef3c7; }
        .dot-err { background: var(--warn-text); box-shadow: 0 0 0 2px #fee2e2; }
        .progress-track { height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .progress-bar { height: 100%; transition: width 0.3s; }

        /* æ–°å¢ï¼šèµ·è½èµ„å†æ ·å¼ */
        .recency-list { margin-top: 10px; border-top: 1px dashed var(--border); padding-top: 10px; }
        .recency-item { display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 4px; color: #64748b; }
        .expiry-box { margin-top: 10px; padding: 10px; border-radius: 8px; text-align: center; }
        .expiry-ok { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .expiry-warn { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .expiry-err { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

        /* === è–ªèµ„ === */
        .salary-summary-box { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; background: #eff6ff; padding: 15px; border-radius: 12px; border: 1px solid #bfdbfe; }
        .ss-item { text-align: center; }
        .ss-label { font-size: 0.75rem; color: #64748b; margin-bottom: 4px; }
        .ss-val { font-size: 1.1rem; font-weight: 800; font-family: monospace; }
        .ss-total { grid-column: 1/-1; border-top: 1px dashed #bfdbfe; padding-top: 10px; margin-top: 5px; }
        .salary-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .salary-table th { text-align: left; padding: 10px 8px; border-bottom: 2px solid #e2e8f0; color: #64748b; font-size: 0.8rem; background: #f8fafc; }
        .salary-table td { padding: 12px 8px; border-bottom: 1px dashed #e2e8f0; vertical-align: top; }
        .col-name { width: 25%; font-weight: 600; color: #334155; }
        .col-proc { width: 50%; font-family: monospace; color: #64748b; font-size: 0.8rem; line-height: 1.5; }
        .col-amt { width: 25%; text-align: right; font-family: monospace; font-weight: 700; font-size: 0.95rem; color: #0f172a; }

        /* === æŠ¥è¡¨ === */
        .table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); -webkit-overflow-scrolling: touch; }
        .excel-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; min-width: 900px; }
        .excel-table th, .excel-table td { border: 1px solid var(--border); padding: 8px 6px; text-align: center; vertical-align: middle; }
        .excel-table th { background: #f1f5f9; font-weight: 600; color: #475569; }
        
        .mobile-report-view { display: none; gap: 10px; }
        .m-card { background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 12px; }

        /* === æ—¥å† === */
        .calendar-wrapper { user-select: none; }
        .calendar-header { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 0.8rem; color: #94a3b8; padding: 10px 0; font-weight: 600; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .cal-day { background: #fff; border: 1px solid var(--border); border-radius: 10px; min-height: 90px; padding: 4px; display: flex; flex-direction: column; cursor: pointer; transition: 0.2s; position: relative; }
        .cal-day.today { border: 2px solid var(--primary); background: #eff6ff; }
        .cal-num { font-size: 0.85rem; font-weight: 700; color: #cbd5e1; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .flight-tag { padding: 3px 4px; border-radius: 3px; font-size: 0.65rem; color: #fff; display: flex; justify-content: space-between; align-items: center; line-height: 1.2; }
        .tag-dom { background: #3b82f6; } .tag-int { background: #8b5cf6; } .tag-dh { background: #64748b; }
        .st-dom-stay { background: var(--dom-stay-bg); color: var(--dom-stay-text); border: 1px solid #bfdbfe; }
        .st-dom-no { background: var(--dom-no-bg); color: var(--dom-no-text); border: 1px solid #a7f3d0; }
        .st-int-stay { background: var(--int-stay-bg); color: var(--int-stay-text); border: 1px solid #e9d5ff; }
        .st-int-no { background: var(--int-no-bg); color: var(--int-no-text); border: 1px solid #fde68a; }

        /* AI & Form */
        .ai-box { position: relative; border: 2px dashed var(--border); border-radius: 12px; padding: 10px; background: #f8fafc; }
        textarea { width: 100%; height: 100px; padding: 15px; border: none; background: transparent; resize: none; outline: none; font-size: 1rem; }
        .edit-form { background: #fff; padding: 20px; border-radius: 12px; margin-top: 20px; border: 1px solid var(--primary); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .form-group label { display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 6px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: flex-end; z-index: 1000; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 25px; display: flex; flex-direction: column; gap: 15px; }

        /* Utils */
        .log-list { max-height: 450px; overflow-y: auto; }
        .log-item { background: #fff; border: 1px solid var(--border); border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
        .btn-primary { background: var(--primary); color: white; }
        .login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #3b82f6 0%, #1e3a8a 100%); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-card { background: white; padding: 40px; border-radius: 24px; width: 90%; max-width: 320px; text-align: center; }

        @media (max-width: 768px) {
            .cal-day { min-height: 50px; align-items: center; }
            .cal-flights, .cal-status { display: none; }
            .mobile-dots { display: flex; gap: 3px; margin-top: 4px; }
            .m-dot { width: 6px; height: 6px; border-radius: 50%; }
            .mobile-report-view { display: grid; }
            .table-wrapper { display: none; }
            .mobile-detail-card { display: block; margin-top: 15px; background: white; border-radius: 12px; border: 1px solid var(--primary); padding: 15px; }
        }
    </style>
</head>
<body>

    <div id="settingsModal" class="modal-overlay" onclick="if(event.target===this) document.getElementById('settingsModal').style.display='none'">
        <div style="background: white; padding: 25px; border-radius: 16px; width: 320px; margin: auto; position: relative; top: 50%; transform: translateY(-50%);">
            <h3 style="margin-bottom:15px; text-align:center;">âš™ï¸ è–ªèµ„ä¸ç¨åŠ¡é…ç½®</h3>
            <div class="form-group"><label>ç´¯è®¡åº”çº³ç¨æ‰€å¾—é¢</label><input type="number" id="set_cum_income"></div>
            <div class="form-group"><label>ç´¯è®¡å·²ç”³æŠ¥ç¨é¢</label><input type="number" id="set_cum_tax"></div>
            <div class="form-group"><label>èŒçº§</label><select id="set_rank"><option value="æ•™å‘˜">æ•™å‘˜</option><option value="æœºé•¿" selected>æœºé•¿</option><option value="å‰¯é©¾é©¶">å‰¯é©¾é©¶</option></select></div>
            <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
        </div>
    </div>

    <div id="statusModal" class="modal-overlay" onclick="if(event.target===this) closeStatusModal()">
        <div class="modal-content">
            <h3 style="text-align:center">ä¿®æ”¹ <span id="modalDateStr" style="color:var(--primary)"></span></h3>
            <input type="text" id="modalCityInput" placeholder="è¾“å…¥é©»å¤–åŸå¸‚" style="padding:10px; border-radius:8px; border:1px solid var(--border); text-align:center">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button class="btn" style="background:#dbeafe; color:#1e40af;" onclick="saveCalendarStatus('å›½å†…æœ‰è¿‡å¤œ')">ğŸ”µ å›½å†…è¿‡å¤œ</button>
                <button class="btn" style="background:#d1fae5; color:#065f46;" onclick="saveCalendarStatus('å›½å†…æ— è¿‡å¤œ')">ğŸŸ¢ å›½å†…æ— è¿‡</button>
                <button class="btn" style="background:#f3e8ff; color:#6b21a8;" onclick="saveCalendarStatus('å›½é™…æœ‰è¿‡å¤œ')">ğŸŸ£ å›½é™…è¿‡å¤œ</button>
                <button class="btn" style="background:#fef3c7; color:#92400e;" onclick="saveCalendarStatus('å›½é™…æ— è¿‡å¤œ')">ğŸŸ¡ å›½é™…æ— è¿‡</button>
            </div>
            <button class="btn" style="background:#f1f5f9" onclick="saveCalendarStatus(null)">ğŸ  å›æ²ˆé˜³/ä¼‘æ¯</button>
            <button class="btn" style="background:#eee" onclick="closeStatusModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <h1 style="font-size: 3rem; margin-bottom: 10px;">âœˆï¸</h1>
            <h2 style="color: #1e40af; margin-bottom: 30px;">é£è¡Œæ—¥å¿— Pro</h2>
            <button class="btn btn-primary" style="width: 100%; padding: 14px;" onclick="loginWithGoogle()">Google ç™»å½•</button>
        </div>
    </div>

    <div id="app" class="container" style="display: none;">
        <div class="top-bar">
            <div><h1 style="font-size: 1.3rem;">æ§åˆ¶å°</h1><div id="userInfo" class="user-pill">è½½å…¥ä¸­...</div></div>
            <div>
                <button class="btn" style="background:rgba(255,255,255,0.2); color:white;" onclick="document.getElementById('settingsModal').style.display='block'">âš™ï¸ è®¾ç½®</button>
                <button class="btn" style="background:rgba(255,255,255,0.2); color:white;" onclick="doLogout()">é€€å‡º</button>
            </div>
        </div>

        <section class="card">
            <div class="card-header"><h2>ğŸ›¡ï¸ åˆè§„ä¸èµ„è´¨ç›‘æ§</h2></div>
            <div class="card-body"><div class="comp-grid" id="complianceDashboard"></div></div>
        </section>

        <section class="card">
            <div class="card-header"><h2>ğŸ’° æœ¬æœˆå®å‘ç»“ç®—å•</h2></div>
            <div class="card-body">
                <div class="salary-summary-box">
                    <div class="ss-item"><div class="ss-label">å˜åŠ¨å®å‘(ç¨å)</div><div class="ss-val" id="disp_net_var">0</div></div>
                    <div class="ss-item"><div class="ss-label">è¡¥åŠ©å®å‘(å…ç¨)</div><div class="ss-val" id="disp_net_allow">0</div></div>
                    <div class="ss-item ss-total"><div class="ss-label">æœ¬æœˆé¢„ä¼°åˆè®¡</div><div class="ss-val" style="font-size:1.5rem; color:#1e40af;" id="disp_total_bank">Â¥0.00</div></div>
                </div>
                <table class="salary-table"><thead><tr><th>é¡¹ç›®</th><th>è®¡ç®—</th><th>é‡‘é¢</th></tr></thead><tbody id="salaryTableBody"></tbody></table>
            </div>
        </section>

        <section class="card">
            <div class="card-header"><h2>ğŸ“Š æœˆåº¦ç»Ÿè®¡</h2><input type="month" id="reportMonth" onchange="refreshAll()"></div>
            <div class="card-body">
                <div class="table-wrapper"><table class="excel-table" id="reportTable"></table></div>
                <div class="mobile-report-view" id="mobileReportCards"></div>
            </div>
        </section>

        <section class="card">
            <div class="card-header"><h2>ğŸ“… æ‰§å‹¤æ—¥å†</h2><span id="calTotal"></span></div>
            <div class="card-body">
                <div class="calendar-header"><div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div></div>
                <div class="calendar-grid" id="calendarGrid"></div>
                <div id="mobileDetailContainer" class="mobile-detail-card" style="display:none">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
                        <strong id="mdDateStr">æ—¥æœŸ</strong>
                        <button class="btn btn-primary" style="font-size:0.7rem" onclick="openStatusModal(document.getElementById('mdDateStr').innerText)">âœ ä¿®æ”¹çŠ¶æ€</button>
                    </div>
                    <div id="mdFlightList"></div>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header"><h2>ğŸ“ æ™ºèƒ½å½•å…¥</h2><button class="btn btn-primary" id="aiBtn" onclick="processAI()">âœ¨ AI è¯†åˆ«</button></div>
            <div class="card-body">
                <div class="ai-box">
                    <textarea id="ocrInput" placeholder="åœ¨æ­¤ç²˜è´´èˆªç­æ–‡æœ¬..."></textarea>
                </div>
                <div id="editForm" class="edit-form" style="display: none;">
                    <div class="form-grid" id="formContainer">
                        <input type="hidden" id="edit_doc_id">
                        <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="f_date"></div>
                        <div class="form-group"><label>æœºå‹</label><select id="f_ac_type"><option value="G650ER">G650ER</option><option value="CL850">CL850</option></select></div>
                        <div class="form-group"><label>èµ·é£åœ°</label><input type="text" id="f_dep"></div>
                        <div class="form-group"><label>è½åœ°åœ°</label><input type="text" id="f_arr"></div>
                        <div class="form-group"><label>èˆªç­å·</label><input type="text" id="f_flight_no"></div>
                        <div class="form-group"><label>å±æ€§</label><select id="f_cat"><option value="å›½å†…">å›½å†…</option><option value="æ¸¯æ¾³å°">æ¸¯æ¾³å°</option><option value="äºšæ´²å›½é™…">äºšæ´²å›½é™…</option><option value="æ´²é™…">æ´²é™…</option></select></div>
                        <div class="form-group"><label>ç©ºæ—¶</label><input type="number" step="0.01" id="f_air"></div>
                        <div class="form-group"><label>æ€»æ—¶</label><input type="number" step="0.01" id="f_total_time"></div>
                        <div class="form-group"><label>æ—¥è½</label><input type="number" id="f_landings_day" value="0"></div>
                        <div class="form-group"><label>å¤œè½</label><input type="number" id="f_landings_night" value="0"></div>
                        <div class="form-group"><label>é©»å¤–</label><select id="f_overnight"><option value="æ— ">æ— </option><option value="å›½å†…æœ‰è¿‡å¤œ">å›½å†…æœ‰è¿‡å¤œ</option><option value="å›½é™…æœ‰è¿‡å¤œ">å›½é™…æœ‰è¿‡å¤œ</option></select></div>
                        <div class="form-group"><label>é©»å¤–åŸå¸‚</label><input type="text" id="f_overnight_city"></div>
                        <div class="form-group"><label>é©»å¤–å¤©æ•°</label><input type="number" id="f_overnight_days" value="0"></div>
                        <div class="form-group"><label>å›½é¤</label><input type="number" id="f_meal_dom" value="0"></div>
                        <div class="form-group"><label>å¤–é¤</label><input type="number" id="f_meal_int" value="0"></div>
                    </div>
                    <div style="margin-top:15px; display:flex; justify-content:flex-end; gap:10px;">
                        <button class="btn" onclick="closeForm()">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="saveRecord()">ä¿å­˜</button>
                    </div>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header"><h2>ğŸ“‹ æœ€è¿‘è®°å½•</h2></div>
            <div class="card-body"><div id="logList" class="log-list"></div></div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, setDoc, updateDoc, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = { 
            apiKey: "AIzaSyCFk4f7bKUHlb3d1Cg1jyS1EM-SPC4pr40", 
            authDomain: "myflightlog-1f4cb.firebaseapp.com", 
            projectId: "myflightlog-1f4cb", 
            storageBucket: "myflightlog-1f4cb.firebasestorage.app", 
            messagingSenderId: "181072044112", 
            appId: "1:181072044112:web:ca312da2d4780227cef155" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let allRecords = [];
        let calendarData = {};

        // åŸºç¡€é…ç½®
        const FIXED_NET = 96080.65;
        const TAX_BRACKETS = [ { limit: 36000, rate: 0.03, quick: 0 }, { limit: 144000, rate: 0.10, quick: 2520 }, { limit: 300000, rate: 0.20, quick: 16920 }, { limit: 420000, rate: 0.25, quick: 31920 }, { limit: 660000, rate: 0.30, quick: 52920 }, { limit: 960000, rate: 0.35, quick: 85920 }, { limit: Infinity, rate: 0.45, quick: 181920 } ];

        window.loginWithGoogle = () => signInWithPopup(auth, provider);
        window.doLogout = () => signOut(auth).then(() => window.location.reload());

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userInfo').textContent = user.displayName;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                document.getElementById('reportMonth').value = new Date().toISOString().slice(0, 7);
                initData();
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
        });

        function initData() {
            onSnapshot(query(collection(db, `users/${currentUser.uid}/logs`), orderBy("date", "desc")), (snap) => {
                allRecords = snap.docs.map(d => ({id: d.id, ...d.data()}));
                refreshAll();
            });
            onSnapshot(collection(db, `users/${currentUser.uid}/calendar_status`), (snap) => {
                calendarData = {};
                snap.docs.forEach(d => calendarData[d.id] = d.data());
                refreshAll();
            });
        }

        window.refreshAll = () => {
            renderCompliance();
            renderSalary();
            renderReport();
            renderCalendar();
            renderList();
        };

        // === æ ¸å¿ƒé€»è¾‘ï¼šåˆè§„ä¸èµ·è½é¢„æµ‹ ===
        function renderCompliance() {
            const now = new Date();
            const start7 = new Date(); start7.setDate(now.getDate() - 6);
            const start90 = new Date(); start90.setDate(now.getDate() - 90);

            // 1. ç–²åŠ³ç›‘æ§
            let fatigue7 = 0;
            allRecords.forEach(r => {
                const d = new Date(r.date);
                if (d >= start7 && d <= now) fatigue7 += (parseFloat(r.total_time) || 0);
            });

            // 2. æå–æœ€å 3 ä¸ªèµ·è½è®°å½• (æ–°å¢åŠŸèƒ½)
            const landingRecords = allRecords
                .filter(r => (parseInt(r.landings_day) || 0) + (parseInt(r.landings_night) || 0) > 0)
                .sort((a, b) => b.date.localeCompare(a.date));

            const last3 = landingRecords.slice(0, 3);
            let expiryDateStr = "æ— èµ·è½æ•°æ®";
            let daysRemaining = -999;
            let expiryClass = 'expiry-err';

            if (landingRecords.length >= 3) {
                // CCARè§„å®šï¼šå‰90å¤©å†…å®Œæˆ3ä¸ªèµ·è½ã€‚å¤±æ•ˆæ—¥æœŸæ˜¯ç¬¬3ä¸ªèµ·è½æ—¥æœŸçš„ç¬¬91å¤©ã€‚
                const thirdLandingDate = new Date(landingRecords[2].date);
                const expiryDate = new Date(thirdLandingDate);
                expiryDate.setDate(thirdLandingDate.getDate() + 90);
                expiryDateStr = expiryDate.toISOString().split('T')[0];
                
                daysRemaining = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
                expiryClass = daysRemaining > 15 ? 'expiry-ok' : (daysRemaining > 0 ? 'expiry-warn' : 'expiry-err');
            }

            const getStatusDot = (v, limit) => v > limit ? 'dot-err' : (v > limit*0.8 ? 'dot-warn' : 'dot-ok');

            document.getElementById('complianceDashboard').innerHTML = `
                <div class="comp-panel">
                    <div class="comp-head"><span>ğŸ‘¨â€âœˆï¸ ç–²åŠ³ç›‘æ§ (7å¤©)</span><span class="status-dot ${getStatusDot(fatigue7, 40)}"></span></div>
                    <div class="comp-row"><span class="comp-label">æ‰§å‹¤æ—¶é—´</span><span class="comp-val">${fatigue7.toFixed(1)} / 40h</span></div>
                    <div class="progress-track"><div class="progress-bar" style="width:${Math.min(fatigue7/40*100, 100)}%; background:${fatigue7 > 40 ? '#ef4444' : 'var(--primary)'}"></div></div>
                </div>
                <div class="comp-panel">
                    <div class="comp-head"><span>ğŸ›¬ èµ·è½èµ„å†è¿½è¸ª (æœ€å3æ¬¡)</span></div>
                    <div class="recency-list">
                        ${last3.length > 0 ? last3.map(l => `
                            <div class="recency-item">
                                <span>${l.date.substring(5)} ${l.arr}</span>
                                <span style="font-weight:bold">${l.ac_type} (${(parseInt(l.landings_day)||0) + (parseInt(l.landings_night)||0)}è½)</span>
                            </div>
                        `).join('') : '<div style="font-size:0.7rem; color:#94a3b8">æš‚æ— èµ·è½è®°å½•</div>'}
                    </div>
                    <div class="expiry-box ${expiryClass}">
                        <div style="font-size:0.7rem; opacity:0.8">èµ„è´¨é¢„æµ‹å¤±æ•ˆæ—¥æœŸ</div>
                        <div style="font-size:1.1rem; font-weight:800; font-family:monospace">${expiryDateStr}</div>
                        <div style="font-size:0.75rem; margin-top:4px">
                            ${daysRemaining === -999 ? 'è¯·è¡¥å…¨èµ·è½è®°å½•' : (daysRemaining >= 0 ? `å‰©ä½™ ${daysRemaining} å¤©` : `å·²è¿‡æœŸ ${Math.abs(daysRemaining)} å¤©`)}
                        </div>
                    </div>
                </div>
            `;
        }

        // === è–ªèµ„è®¡ç®— ===
        function calculateTax(income) {
            for (let b of TAX_BRACKETS) { if (income <= b.limit) return income * b.rate - b.quick; }
            return income * 0.45 - 181920;
        }

        function renderSalary() {
            const mStr = document.getElementById('reportMonth').value;
            const data = allRecords.filter(r => r.date.startsWith(mStr));
            let gross_var = 0; let allowance = 0;
            const rank = localStorage.getItem('user_rank') || 'æœºé•¿';

            data.forEach(r => {
                const air = parseFloat(r.air_time) || 0;
                // ç®€åŒ–é€»è¾‘ï¼šéå›½å†…é£è¡Œæ‰è®¡ç®—å˜åŠ¨å°æ—¶è´¹
                if(r.category !== 'å›½å†…') {
                    const rate = rank === 'æœºé•¿' ? 640 : (rank === 'æ•™å‘˜' ? 720 : 320);
                    gross_var += air * rate;
                }
                allowance += (parseInt(r.crew_meal_dom)||0)*60 + (parseInt(r.crew_meal_int)||0)*180;
            });

            // æ¨¡æ‹Ÿä¸ªç¨è®¡ç®—
            const cum_inc = parseFloat(localStorage.getItem('user_cum_income')) || 940000;
            const cum_tax = parseFloat(localStorage.getItem('user_cum_tax')) || 240000;
            const total_tax = calculateTax(cum_inc + gross_var);
            const self_tax = Math.max(0, total_tax - cum_tax);
            const net_var = gross_var - self_tax;

            document.getElementById('disp_net_var').innerText = net_var.toLocaleString();
            document.getElementById('disp_net_allow').innerText = allowance.toLocaleString();
            document.getElementById('disp_total_bank').innerText = 'Â¥' + (FIXED_NET + net_var + allowance).toLocaleString();
        }

        // === æ—¥å†é€»è¾‘ ===
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            const [y, m] = document.getElementById('reportMonth').value.split('-').map(Number);
            const daysInMonth = new Date(y, m, 0).getDate();
            const firstDay = new Date(y, m-1, 1).getDay();

            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;

            for(let d=1; d<=daysInMonth; d++) {
                const dStr = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const flights = allRecords.filter(r => r.date === dStr);
                const status = calendarData[dStr] || {};
                
                let stClass = '';
                if(status.type === 'å›½å†…æœ‰è¿‡å¤œ') stClass = 'st-dom-stay';
                else if(status.type === 'å›½é™…æœ‰è¿‡å¤œ') stClass = 'st-int-stay';

                const cell = document.createElement('div');
                cell.className = `cal-day ${stClass}`;
                cell.innerHTML = `<div class="cal-num">${d}</div><div class="cal-flights">${flights.map(f=>`<div class="flight-tag tag-dom">${f.arr}</div>`).join('')}</div>`;
                cell.onclick = () => {
                    if(window.innerWidth <= 768) {
                        showMobileDetail(dStr, flights, status);
                    } else {
                        openStatusModal(dStr);
                    }
                };
                grid.appendChild(cell);
            }
        }

        function showMobileDetail(date, flights, status) {
            const container = document.getElementById('mobileDetailContainer');
            container.style.display = 'block';
            document.getElementById('mdDateStr').innerText = date;
            document.getElementById('mdFlightList').innerHTML = flights.length ? flights.map(f=>`<div style="font-size:0.85rem; margin-bottom:5px; border-bottom:1px solid #eee; padding-bottom:5px">${f.dep} - ${f.arr} (${f.total_time}h)</div>`).join('') : '<div style="color:#94a3b8">æ— é£è¡Œä»»åŠ¡</div>';
        }

        // === æŠ¥è¡¨ä¸å…¶å®ƒ ===
        function renderReport() {
            const mStr = document.getElementById('reportMonth').value;
            const data = allRecords.filter(r => r.date.startsWith(mStr));
            let stats = { air: 0, total: 0, blk: 0 };
            data.forEach(r => { stats.air += parseFloat(r.air_time)||0; stats.total += parseFloat(r.total_time)||0; });
            document.getElementById('reportTable').innerHTML = `<tr><th>é¡¹ç›®</th><th>åˆè®¡</th></tr><tr><td>ç©ºæ—¶åˆè®¡</td><td>${stats.air.toFixed(2)}</td></tr><tr><td>æ€»æ—¶åˆè®¡</td><td>${stats.total.toFixed(2)}</td></tr>`;
        }

        function renderList() {
            const list = document.getElementById('logList');
            list.innerHTML = allRecords.slice(0, 5).map(r => `
                <div class="log-item">
                    <div><strong>${r.date}</strong> ${r.dep} - ${r.arr}</div>
                    <button class="btn" style="background:#fee2e2; color:#ef4444" onclick="deleteItem('${r.id}')">ğŸ—‘ï¸</button>
                </div>
            `).join('');
        }

        // çª—å£ä¸è¡¨å•
        window.openStatusModal = (date) => {
            document.getElementById('modalDateStr').innerText = date;
            document.getElementById('statusModal').style.display = 'flex';
        }
        window.closeStatusModal = () => document.getElementById('statusModal').style.display = 'none';
        window.saveCalendarStatus = async (type) => {
            const date = document.getElementById('modalDateStr').innerText;
            const city = document.getElementById('modalCityInput').value;
            await setDoc(doc(db, `users/${currentUser.uid}/calendar_status`, date), { type, city });
            closeStatusModal();
        }

        window.saveSettings = () => {
            localStorage.setItem('user_cum_income', document.getElementById('set_cum_income').value);
            localStorage.setItem('user_cum_tax', document.getElementById('set_cum_tax').value);
            localStorage.setItem('user_rank', document.getElementById('set_rank').value);
            document.getElementById('settingsModal').style.display = 'none';
            refreshAll();
        }

        window.processAI = async () => {
            const text = document.getElementById('ocrInput').value;
            const btn = document.getElementById('aiBtn');
            btn.innerText = "è¯†åˆ«ä¸­...";
            // æ¨¡æ‹ŸAIå¤„ç†ï¼Œé€šå¸¸ä½ ä¼šè°ƒç”¨DeepSeekæ¥å£
            const mockRes = { date: new Date().toISOString().split('T')[0], dep: "VHHH", arr: "ZYTX", ac_type: "G650ER", air: 2.5, total: 3.2, landings_day: 1 };
            document.getElementById('editForm').style.display = 'block';
            document.getElementById('f_date').value = mockRes.date;
            document.getElementById('f_dep').value = mockRes.dep;
            document.getElementById('f_arr').value = mockRes.arr;
            document.getElementById('f_ac_type').value = mockRes.ac_type;
            document.getElementById('f_air').value = mockRes.air;
            document.getElementById('f_total_time').value = mockRes.total;
            document.getElementById('f_landings_day').value = mockRes.landings_day;
            btn.innerText = "âœ¨ AI è¯†åˆ«";
        }

        window.saveRecord = async () => {
            const data = {
                date: document.getElementById('f_date').value,
                dep: document.getElementById('f_dep').value,
                arr: document.getElementById('f_arr').value,
                ac_type: document.getElementById('f_ac_type').value,
                air_time: document.getElementById('f_air').value,
                total_time: document.getElementById('f_total_time').value,
                landings_day: document.getElementById('f_landings_day').value,
                landings_night: document.getElementById('f_landings_night').value,
                category: document.getElementById('f_cat').value,
                crew_meal_dom: document.getElementById('f_meal_dom').value,
                crew_meal_int: document.getElementById('f_meal_int').value
            };
            await addDoc(collection(db, `users/${currentUser.uid}/logs`), data);
            document.getElementById('editForm').style.display = 'none';
        }

        window.deleteItem = async (id) => {
            if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) await deleteDoc(doc(db, `users/${currentUser.uid}/logs`, id));
        }

        window.closeForm = () => document.getElementById('editForm').style.display = 'none';

    </script>
</body>
</html>
