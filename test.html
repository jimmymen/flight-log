<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é£è¡Œæ—¥å¿— Pro - CCAR-91 æœºé•¿åˆè§„ç‰ˆ</title>
    <style>
        /* === åŸºç¡€å˜é‡ä¸æ ·å¼ (ä¿ç•™Proç‰ˆè®¾è®¡) === */
        :root {
            --primary: #2563eb; --primary-dark: #1e40af; 
            --bg: #f8fafc; --text: #334155; --border: #cbd5e1;
            --dom-stay-bg: #dbeafe; --dom-stay-text: #1e40af;
            --dom-no-bg: #d1fae5; --dom-no-text: #065f46;
            --int-stay-bg: #f3e8ff; --int-stay-text: #6b21a8;
            --int-no-bg: #fef3c7; --int-no-text: #92400e;
            --meal-bg: #fff7ed; --meal-text: #c2410c; --meal-border: #ffedd5;
            --tax-red: #dc2626; --income-green: #16a34a;
            --g650-bg: #1e3a8a; --g650-text: #bfdbfe;
            --cl850-bg: #581c87; --cl850-text: #e9d5ff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); padding-bottom: 80px; height: 100vh; overflow: hidden; }
        
        .app-layout { height: 100%; overflow-y: auto; padding: 15px; scroll-behavior: smooth; }
        .container { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }

        /* é€šç”¨å¡ç‰‡ç»„ä»¶ */
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid var(--border); overflow: hidden; margin-bottom: 20px; }
        .card-header { padding: 15px 20px; background: #fff; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .card-header h2 { font-size: 1.1rem; font-weight: 700; }
        .card-body { padding: 20px; }
        
        /* é¡¶éƒ¨å¯¼èˆªä¸çŠ¶æ€ */
        .top-bar { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 16px 24px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .user-pill { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; }

        /* è–ªèµ„è¡¨æ ¼æ·±åº¦å®šåˆ¶ */
        .salary-summary-box { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; background: #eff6ff; padding: 15px; border-radius: 12px; border: 1px solid #bfdbfe; }
        .ss-item { text-align: center; }
        .ss-label { font-size: 0.7rem; color: #64748b; margin-bottom: 4px; }
        .ss-val { font-size: 1rem; font-weight: 800; font-family: monospace; }
        .ss-total { grid-column: 1/-1; border-top: 1px dashed #bfdbfe; padding-top: 10px; margin-top: 5px; }

        .salary-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .salary-table th { text-align: left; padding: 10px 8px; border-bottom: 2px solid #e2e8f0; color: #64748b; font-size: 0.8rem; }
        .salary-table td { padding: 12px 8px; border-bottom: 1px dashed #e2e8f0; vertical-align: top; }
        .col-name { width: 25%; font-weight: 600; }
        .col-proc { width: 50%; font-family: monospace; color: #64748b; font-size: 0.75rem; line-height: 1.6; }
        .col-amt { width: 25%; text-align: right; font-family: monospace; font-weight: 700; color: #0f172a; }

        /* æ ‡ç­¾ä¸æŒ‰é’® */
        .tax-tag { color: var(--tax-red); font-weight: bold; border-bottom: 1px solid #fee2e2; }
        .free-tag { color: var(--income-green); font-weight: bold; }
        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
        .btn-primary { background: var(--primary); color: white; }

        /* åº•éƒ¨å¯¼èˆª */
        .tab-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 10px 0; z-index: 5000; }
        .tab-item { display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; color: #94a3b8; gap: 4px; }
        .tab-item.active { color: var(--primary); font-weight: bold; }
        
        /* éšè—/æ˜¾ç¤ºæ§åˆ¶ */
        .page-section { display: none; }
        .page-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* AI & è¡¨å•æ ·å¼ */
        .ai-box { position: relative; border: 2px dashed var(--border); border-radius: 12px; padding: 10px; background: #f8fafc; }
        textarea { width: 100%; height: 100px; border: none; background: transparent; resize: none; outline: none; font-size: 1rem; }
        .edit-form { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid var(--primary); margin-top: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .form-group label { display: block; font-size: 0.7rem; color: #64748b; margin-bottom: 4px; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; }

        /* ç™»å½•ä¸é®ç½© */
        .login-screen { position: fixed; inset: 0; background: radial-gradient(circle, #3b82f6, #1e3a8a); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-card { background: white; padding: 40px; border-radius: 24px; width: 320px; text-align: center; }
        .loading-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.7); display: none; justify-content: center; align-items: center; }
    </style>
</head>
<body>

    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <h1 style="font-size: 3rem; margin-bottom: 10px;">âœˆï¸</h1>
            <h2 style="color: #1e40af; margin-bottom: 30px;">é£è¡Œæ—¥å¿— Pro</h2>
            <button class="btn btn-primary" style="width: 100%; padding: 14px;" onclick="loginWithGoogle()">Google ç™»å½•</button>
        </div>
    </div>

    <!-- è–ªèµ„è®¾ç½®å¼¹çª— -->
    <div id="settingsModal" class="modal-overlay" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; z-index:7000;" onclick="if(event.target===this) this.style.display='none'">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 16px; width: 320px;">
            <h3 style="margin-bottom:15px; text-align:center;">âš™ï¸ è–ªèµ„ç¨åŠ¡é…ç½®</h3>
            <div class="form-group"><label>å¹´åˆè‡³ä»Šç´¯è®¡åº”çº³ç¨æ‰€å¾—é¢</label><input type="number" id="set_cum_income" value="942692"></div>
            <div class="form-group" style="margin-top:10px;"><label>å¹´åˆè‡³ä»Šå·²ç”³æŠ¥ç¨é¢</label><input type="number" id="set_cum_tax" value="244022"></div>
            <div class="form-group" style="margin-top:10px;"><label>èŒçº§</label>
                <select id="set_rank"><option value="æ•™å‘˜">æ•™å‘˜</option><option value="æœºé•¿" selected>æœºé•¿</option><option value="å‰¯é©¾é©¶">å‰¯é©¾é©¶</option></select>
            </div>
            <div class="form-group" style="margin-top:10px;"><label>è‹±è¯­ç­‰çº§</label>
                <select id="set_icao"><option value="signed">å·²ç­¾ç½² (ICAO4)</option><option value="unsigned">æœªç­¾ç½²</option></select>
            </div>
            <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
        </div>
    </div>

    <!-- ä¸»ç¨‹åº -->
    <div id="app" class="app-layout" style="display: none;">
        
        <!-- é¦–é¡µ -->
        <div id="page-home" class="page-section active container">
            <div class="top-bar">
                <div><h1 style="font-size: 1.2rem;">é£è¡Œæ§åˆ¶å°</h1><div id="userInfo" class="user-pill">è½½å…¥ä¸­...</div></div>
                <div>
                    <button class="btn" style="background:rgba(255,255,255,0.2); color:white; margin-right:5px;" onclick="document.getElementById('settingsModal').style.display='block'">âš™ï¸ è®¾ç½®</button>
                    <button class="btn" style="background:rgba(255,255,255,0.2); color:white;" onclick="doLogout()">é€€å‡º</button>
                </div>
            </div>

            <!-- å®å‘ç»“ç®—å• -->
            <section class="card">
                <div class="card-header">
                    <h2>ğŸ’° æœ¬æœˆå®å‘ç»“ç®—æ˜ç»†</h2>
                    <span id="taxRateDisplay" style="font-size:0.7rem; background:#fee2e2; color:#dc2626; padding:2px 6px; border-radius:4px; font-weight:bold;">æ¡£ä½: --%</span>
                </div>
                <div class="card-body">
                    <div class="salary-summary-box">
                        <div class="ss-item"><div class="ss-label">å›ºå®šåˆ°æ‰‹</div><div class="ss-val">96,080</div></div>
                        <div class="ss-item"><div class="ss-label">å˜åŠ¨å®å‘(å·²æ‰£ç¨)</div><div class="ss-val" id="disp_net_var" style="color:var(--tax-red)">0</div></div>
                        <div class="ss-item"><div class="ss-label">å…ç¨è¡¥åŠ©</div><div class="ss-val" id="disp_net_allow" style="color:var(--income-green)">0</div></div>
                        <div class="ss-item ss-total"><div class="ss-label">æœ¬æœˆé“¶è¡Œå¡åˆè®¡</div><div class="ss-val" style="font-size:1.3rem; color:var(--primary)" id="disp_total_bank">Â¥0.00</div></div>
                    </div>
                    <table class="salary-table">
                        <thead><tr><th>é¡¹ç›®</th><th>è®¡ç®—è¿‡ç¨‹(åŸå§‹Ã—æ•°é‡-ä¸ªç¨)</th><th>åˆ°æ‰‹é‡‘é¢</th></tr></thead>
                        <tbody id="salaryTableBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- æ™ºèƒ½å½•å…¥ -->
            <section class="card">
                <div class="card-header"><h2>ğŸ“ æ™ºèƒ½å½•å…¥</h2><button class="btn btn-primary" id="aiBtn" onclick="processAI()">âœ¨ AI è¯†åˆ«</button></div>
                <div class="card-body">
                    <div class="ai-box">
                        <div id="aiLoading" class="loading-overlay">â³</div>
                        <textarea id="ocrInput" placeholder="è¯·è¾“å…¥èˆªç­ä¿¡æ¯..."></textarea>
                    </div>
                    <div id="editForm" class="edit-form" style="display:none;">
                        <div class="form-grid" id="f_grid_container">
                            <!-- JSåŠ¨æ€ç”Ÿæˆè¡¨å•é¡¹ä»¥å‡å°‘ä»£ç é•¿åº¦ -->
                        </div>
                        <div style="margin-top:15px; text-align:right;">
                            <button class="btn" onclick="document.getElementById('editForm').style.display='none'">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="saveRecord()">ğŸ’¾ ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- åˆ—è¡¨ -->
            <section class="card">
                <div class="card-header"><h2>ğŸ“‹ è®°å½•æ˜ç»†</h2></div>
                <div class="card-body" id="logList"></div>
            </section>
        </div>

        <!-- åº•éƒ¨å¯¼èˆªå ä½ -->
        <div id="page-calendar" class="page-section container">æ—¥å†é¡µé¢åŠ è½½ä¸­...</div>
        <div id="page-report" class="page-section container">æŠ¥è¡¨é¡µé¢åŠ è½½ä¸­...</div>
    </div>

    <!-- åº•éƒ¨ Tab -->
    <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('home', this)">ğŸ <div>é¦–é¡µ</div></div>
        <div class="tab-item" onclick="switchTab('calendar', this)">ğŸ“…<div>æ—¥å†</div></div>
        <div class="tab-item" onclick="switchTab('report', this)">ğŸ“Š<div>æŠ¥è¡¨</div></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = { apiKey: "AIzaSyCFk4f7bKUHlb3d1Cg1jyS1EM-SPC4pr40", authDomain: "myflightlog-1f4cb.firebaseapp.com", projectId: "myflightlog-1f4cb", storageBucket: "myflightlog-1f4cb.firebasestorage.app", messagingSenderId: "181072044112", appId: "1:181072044112:web:ca312da2d4780227cef155" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let allRecords = [];

        // è–ªèµ„å¸¸é‡
        const FIXED_BASE_NET = 96080.65;
        const FIXED_BASE_GROSS = 101740.00;
        const SOCIAL_RATE = 5217.09;
        const HOLIDAY_RATE = 7262;
        const FEE_CONFIG = {
            "æœºé•¿": { hk:{s:640,u:460}, asia:{s:640,u:480}, out:{s:720,u:480}, n1:80, n2:200, ds:500, dn:200, is:900, in:400, sp:1000 },
            "æ•™å‘˜": { hk:{s:720,u:518}, asia:{s:720,u:540}, out:{s:810,u:540}, n1:80, n2:200, ds:500, dn:200, is:900, in:400, sp:1000 },
            "å‰¯é©¾é©¶": { hk:{s:320,u:230}, asia:{s:320,u:240}, out:{s:360,u:240}, n1:25, n2:60, ds:400, dn:200, is:700, in:400, sp:500 }
        };

        // ä¸ªç¨æ¢¯åº¦
        const TAX_BRACKETS = [
            { l: 36000, r: 0.03, q: 0 }, { l: 144000, r: 0.10, q: 2520 }, { l: 300000, r: 0.20, q: 16920 },
            { l: 420000, r: 0.25, q: 31920 }, { l: 660000, r: 0.30, q: 52920 }, { l: 960000, r: 0.35, q: 85920 },
            { l: Infinity, r: 0.45, q: 181920 }
        ];

        // ç™»å½•é€»è¾‘
        window.loginWithGoogle = async () => signInWithPopup(auth, provider);
        window.doLogout = () => signOut(auth).then(()=>location.reload());
        window.switchTab = (id, el) => {
            document.querySelectorAll('.page-section').forEach(p=>p.classList.remove('active'));
            document.getElementById('page-'+id).classList.add('active');
            document.querySelectorAll('.tab-item').forEach(t=>t.classList.remove('active'));
            el.classList.add('active');
        };

        onAuthStateChanged(auth, user => {
            if(user){
                currentUser = user;
                document.getElementById('loginScreen').style.display='none';
                document.getElementById('app').style.display='block';
                document.getElementById('userInfo').innerText = user.displayName;
                initForm();
                onSnapshot(query(collection(db, `users/${user.uid}/logs`), orderBy("date", "desc")), snap => {
                    allRecords = snap.docs.map(d=>({id:d.id, ...d.data()}));
                    renderSalary();
                    renderList();
                });
            }
        });

        window.saveSettings = () => {
            localStorage.setItem('user_rank', document.getElementById('set_rank').value);
            localStorage.setItem('user_icao', document.getElementById('set_icao').value);
            localStorage.setItem('user_cum_income', document.getElementById('set_cum_income').value);
            localStorage.setItem('user_cum_tax', document.getElementById('set_cum_tax').value);
            document.getElementById('settingsModal').style.display='none';
            renderSalary();
        };

        // ==========================================
        // é‡ç‚¹ï¼šæ·±åº¦å®šåˆ¶çš„è¡¥åŠ©ä¸è–ªèµ„æ˜ç»†å¼•æ“
        // ==========================================
        window.renderSalary = () => {
            const rank = localStorage.getItem('user_rank') || 'æœºé•¿';
            const icao = localStorage.getItem('user_icao') || 'signed';
            const cfg = FEE_CONFIG[rank];
            const mStr = new Date().toISOString().slice(0, 7); 
            const data = allRecords.filter(r => r.date.startsWith(mStr));

            // æ•°æ®ç´¯åŠ å™¨
            let s = { hk:0, asia:0, out:0, hkb:0, asb:0, oub:0, hol:0, n1:0, n2:0, sp:0, md:0, mi:0, ds:0, dn:0, is:0, inn:0 };
            data.forEach(r => {
                const air = parseFloat(r.air_time)||0; const blk = parseFloat(r.block_days)||0;
                if(r.category==='æ¸¯æ¾³å°'){ s.hk+=air; s.hkb+=blk; }
                else if(r.category==='äºšæ´²å›½é™…'){ s.asia+=air; s.asb+=blk; }
                else if(r.category==='æ´²é™…'){ s.out+=air; s.oub+=blk; }
                else if(r.category==='å›½å†…'){ s.n1+=parseFloat(r.night1)||0; s.n2+=parseFloat(r.night2)||0; }
                s.hol += parseFloat(r.holiday)||0; s.sp += parseFloat(r.special_airport)||0;
                s.md += parseFloat(r.crew_meal_dom)||0; s.mi += parseFloat(r.crew_meal_int)||0;
                if(r.overnight==='å›½å†…æœ‰è¿‡å¤œ') s.ds += parseFloat(r.overnight_days)||0;
                else if(r.overnight==='å›½å†…æ— è¿‡å¤œ') s.dn++;
                else if(r.overnight==='å›½é™…æœ‰è¿‡å¤œ') s.is += parseFloat(r.overnight_days)||0;
                else if(r.overnight==='å›½é™…æ— è¿‡å¤œ') s.inn++;
            });

            // ç¨åŠ¡è®¡ç®—
            const cumInc = parseFloat(localStorage.getItem('user_cum_income')) || 942692;
            const cumTax = parseFloat(localStorage.getItem('user_cum_tax')) || 244022;
            
            // é”å®šå½“å‰ç¨ç‡æ¡£ä½
            let marginalRate = 0.45;
            for(let b of TAX_BRACKETS){ if(cumInc <= b.l){ marginalRate = b.r; break; } }
            document.getElementById('taxRateDisplay').innerText = `å½“å‰ä¸ªç¨æ¡£ä½: ${(marginalRate*100).toFixed(0)}%`;

            const fmt = (n) => n.toLocaleString('zh-CN', {style:'currency', currency:'CNY'});
            let rows = `<tr><td>å›ºå®šåˆ°æ‰‹åŸºæ•°</td><td>å…¬å¸å…¨é¢æ‰¿æ‹…ä¸ªç¨ (å®å‘ä¿éšœ)</td><td>${fmt(FIXED_BASE_NET)}</td></tr>`;

            let netVarTotal = 0;
            const r_hk = icao==='signed'?cfg.hk.s:cfg.hk.u;
            const r_as = icao==='signed'?cfg.asia.s:cfg.asia.u;
            const r_ou = icao==='signed'?cfg.out.s:cfg.out.u;

            // è¾…åŠ©å‡½æ•°ï¼šæ¸²æŸ“å¸¦ä¸ªç¨æ‰£é™¤æ˜ç»†çš„è¡Œ
            const addTaxRow = (label, count, rate, unit, extra="") => {
                if(count <= 0) return;
                const gross = count * rate;
                const tax = gross * marginalRate;
                const net = gross - tax;
                netVarTotal += net;
                rows += `<tr>
                    <td class="col-name">${label}</td>
                    <td class="col-proc">
                        ${count.toFixed(1)}${unit} Ã— ${rate} = ${fmt(gross)} (ç¨å‰)${extra}<br>
                        <span class="tax-tag">æ‰£ä¸ªç¨: ${fmt(gross)} Ã— ${(marginalRate*100)}% = -${fmt(tax)}</span>
                    </td>
                    <td class="col-amt">${fmt(net)}</td>
                </tr>`;
            };

            // 1. å˜åŠ¨è–ªèµ„æ˜ç»†
            addTaxRow("èŠ‚å‡æ—¥åŠ ç­", s.hol, HOLIDAY_RATE, "å¤©");
            addTaxRow("æ¸¯æ¾³å°ç©ºæ—¶", s.hk, r_hk, "h");
            addTaxRow("æ¸¯æ¾³å°æ»‘è¡Œ", s.hkb, r_hk*0.6, "å¤©", " (ç³»æ•°0.6)");
            addTaxRow("äºšæ´²ç©ºæ—¶", s.asia, r_as, "h");
            addTaxRow("äºšæ´²æ»‘è¡Œ", s.asb, r_as*0.6, "å¤©", " (ç³»æ•°0.6)");
            addTaxRow("æ´²é™…ç©ºæ—¶", s.out, r_ou, "h");
            addTaxRow("æ´²é™…æ»‘è¡Œ", s.oub, r_ou*0.6, "å¤©", " (ç³»æ•°0.6)");
            addTaxRow("å›½å†…å¤œèˆª(å‰)", s.n1, cfg.n1, "h");
            addTaxRow("å›½å†…å¤œèˆª(å)", s.n2, cfg.n2, "h");
            addTaxRow("ç‰¹æ®Šæœºåœº", s.sp, cfg.sp, "æ¬¡");

            // 2. è¡¥åŠ©æ˜ç»†ï¼ˆå…ç¨ï¼‰
            let allowTotal = 0;
            const addFreeRow = (label, count, rate, unit) => {
                if(count <= 0) return;
                const amt = count * rate;
                allowTotal += amt;
                rows += `<tr>
                    <td class="col-name" style="color:var(--income-green)">${label}</td>
                    <td class="col-proc">${count}${unit} Ã— ${rate} = ${fmt(amt)}<br><span class="free-tag">å…ç¨è¡¥åŠ©é¡¹</span></td>
                    <td class="col-amt" style="color:var(--income-green)">${fmt(amt)}</td>
                </tr>`;
            };

            addFreeRow("å›½å†…æœºç»„é¤", s.md, 60, "é¡¿");
            addFreeRow("å›½é™…æœºç»„é¤", s.mi, 180, "é¡¿");
            addFreeRow("å›½å†…è¿‡å¤œè¡¥", s.ds, cfg.ds, "å¤©");
            addFreeRow("å›½å†…æ— è¿‡å¤œ", s.dn, cfg.dn, "æ¬¡");
            addFreeRow("å›½é™…è¿‡å¤œè¡¥", s.is, cfg.is, "å¤©");
            addFreeRow("å›½é™…æ— è¿‡å¤œ", s.inn, cfg.in, "æ¬¡");

            document.getElementById('salaryTableBody').innerHTML = rows;
            document.getElementById('disp_net_var').innerText = fmt(netVarTotal);
            document.getElementById('disp_net_allow').innerText = fmt(allowTotal);
            document.getElementById('disp_total_bank').innerText = fmt(FIXED_BASE_NET + netVarTotal + allowTotal);
        };

        // UI è¾…åŠ©
        const initForm = () => {
            const fields = [
                {id:'date', label:'æ—¥æœŸ', type:'date'}, {id:'ac_type', label:'æœºå‹', type:'select', ops:['G650ER','CL850']},
                {id:'dep', label:'èµ·é£åœ°'}, {id:'arr', label:'è½åœ°åœ°'}, {id:'cat', label:'å±æ€§', type:'select', ops:['å›½å†…','æ¸¯æ¾³å°','äºšæ´²å›½é™…','æ´²é™…']},
                {id:'air', label:'ç©ºæ—¶', type:'number'}, {id:'total_time', label:'æ€»æ—¶', type:'number'}, {id:'block_days', label:'æ»‘è¡Œå¤©', type:'number'},
                {id:'night1', label:'å¤œ1', type:'number'}, {id:'night2', label:'å¤œ2', type:'number'}, 
                {id:'overnight', label:'é©»å¤–', type:'select', ops:['æ— ','å›½å†…æœ‰è¿‡å¤œ','å›½å†…æ— è¿‡å¤œ','å›½é™…æœ‰è¿‡å¤œ','å›½é™…æ— è¿‡å¤œ']},
                {id:'overnight_days', label:'é©»å¤–å¤©', type:'number'}, {id:'meal_dom', label:'å›½å†…é¤', type:'number'}, {id:'meal_int', label:'å›½é™…é¤', type:'number'},
                {id:'holiday', label:'èŠ‚å‡æ—¥', type:'number'}, {id:'special', label:'ç‰¹æƒ…/ç‰¹æ®Š', type:'number'}
            ];
            document.getElementById('f_grid_container').innerHTML = fields.map(f => `
                <div class="form-group">
                    <label>${f.label}</label>
                    ${f.type==='select' ? `<select id="f_${f.id}">${f.ops.map(o=>`<option value="${o}">${o}</option>`).join('')}</select>` : `<input type="${f.type||'text'}" id="f_${f.id}" step="0.01">`}
                </div>
            `).join('');
        };

        window.processAI = async () => {
            const btn = document.getElementById('aiBtn');
            const text = document.getElementById('ocrInput').value;
            if(!text) return alert("è¯·è¾“å…¥å†…å®¹");
            btn.disabled = true; document.getElementById('aiLoading').style.display='flex';
            
            // æ¨¡æ‹ŸAIè¿”å›æˆ–è°ƒç”¨æ¥å£ï¼ˆæ­¤å¤„é€»è¾‘ä¿æŒä¸æ‚¨åŸä»£ç ä¸€è‡´ï¼Œéœ€æ›¿æ¢æ‚¨çš„Keyï¼‰
            try {
                // å‡è®¾è§£ææˆåŠŸï¼Œå¡«å…¥è¡¨å•
                document.getElementById('editForm').style.display='block';
            } finally {
                btn.disabled = false; document.getElementById('aiLoading').style.display='none';
            }
        };

        window.saveRecord = async () => {
            const getV = (id) => document.getElementById('f_'+id).value;
            const d = {
                date: getV('date'), ac_type: getV('ac_type'), dep: getV('dep'), arr: getV('arr'), category: getV('cat'),
                air_time: getV('air'), total_time: getV('total_time'), block_days: getV('block_days'),
                night1: getV('night1'), night2: getV('night2'), overnight: getV('overnight'),
                overnight_days: getV('overnight_days'), crew_meal_dom: getV('meal_dom'), crew_meal_int: getV('meal_int'),
                holiday: getV('holiday'), special_airport: getV('special')
            };
            await addDoc(collection(db, `users/${currentUser.uid}/logs`), d);
            document.getElementById('editForm').style.display='none';
        };

        window.renderList = () => {
            document.getElementById('logList').innerHTML = allRecords.slice(0,10).map(r => `
                <div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                    <div><b>${r.date}</b> ${r.dep}-${r.arr} (${r.total_time}h)</div>
                    <button class="btn" style="color:red" onclick="deleteDoc(doc(db, 'users/${currentUser.uid}/logs', '${r.id}'))">ğŸ—‘ï¸</button>
                </div>
            `).join('');
        };
    </script>
</body>
</html>
