<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é£è¡Œæ—¥å¿— Pro - CCAR-91 æœºé•¿åˆè§„ç‰ˆ</title>
    <style>
        /* === åŸºç¡€å˜é‡ === */
        :root {
            --primary: #2563eb; --primary-dark: #1e40af; 
            --bg: #f8fafc; --text: #334155; --border: #cbd5e1;
            /* çŠ¶æ€é¢œè‰² */
            --dom-stay-bg: #dbeafe; --dom-stay-text: #1e40af;
            --dom-no-bg: #d1fae5; --dom-no-text: #065f46;
            --int-stay-bg: #f3e8ff; --int-stay-text: #6b21a8;
            --int-no-bg: #fef3c7; --int-no-text: #92400e;
            --meal-bg: #fff7ed; --meal-text: #c2410c; --meal-border: #ffedd5;
            --tax-red: #dc2626; --income-green: #16a34a;
            --g650-bg: #1e3a8a; --g650-text: #bfdbfe;
            --cl850-bg: #581c87; --cl850-text: #e9d5ff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); padding-bottom: 80px; height: 100vh; overflow: hidden; }

        .app-layout { height: 100%; overflow-y: auto; padding: 15px; scroll-behavior: smooth; }
        .container { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }

        /* å¡ç‰‡ç»„ä»¶ */
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border); overflow: hidden; margin-bottom: 20px; }
        .card-header { padding: 15px 20px; background: #fff; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .card-header h2 { font-size: 1.1rem; font-weight: 700; color: #0f172a; }
        .card-body { padding: 20px; }
        
        .top-bar { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 16px 24px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .user-pill { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; backdrop-filter: blur(4px); }

        /* è–ªèµ„è¡¨æ ¼æ ·å¼ */
        .salary-summary-box { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; background: #eff6ff; padding: 15px; border-radius: 12px; border: 1px solid #bfdbfe; }
        .ss-item { text-align: center; }
        .ss-label { font-size: 0.7rem; color: #64748b; margin-bottom: 4px; }
        .ss-val { font-size: 1rem; font-weight: 800; font-family: monospace; }
        .ss-total { grid-column: 1/-1; border-top: 1px dashed #bfdbfe; padding-top: 10px; margin-top: 5px; }
        
        .salary-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .salary-table th { text-align: left; padding: 10px 8px; border-bottom: 2px solid #e2e8f0; color: #64748b; font-size: 0.8rem; background: #f8fafc; }
        .salary-table td { padding: 12px 8px; border-bottom: 1px dashed #e2e8f0; vertical-align: top; }
        
        .col-name { width: 25%; font-weight: 600; color: #334155; }
        .col-proc { width: 50%; font-family: monospace; color: #64748b; font-size: 0.75rem; line-height: 1.6; }
        .col-amt { width: 25%; text-align: right; font-family: monospace; font-weight: 700; color: #0f172a; }
        
        .tax-calc-red { color: var(--tax-red); font-weight: bold; }
        .free-calc-green { color: var(--income-green); font-weight: bold; }

        /* æ—¥å†æ ·å¼ (å¼ºåˆ¶å®½å±é€‚é…æ»šåŠ¨) */
        .calendar-scroll-view { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .calendar-fixed-container { min-width: 1000px; padding: 5px; }
        .calendar-header { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 0.85rem; color: #94a3b8; padding: 10px 0; font-weight: 600; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .cal-day { background: #fff; border: 1px solid var(--border); border-radius: 8px; min-height: 110px; padding: 6px; display: flex; flex-direction: column; cursor: pointer; transition: 0.2s; }
        .cal-day.today { border: 2px solid var(--primary); background: #eff6ff; }
        .cal-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px; }
        .cal-status-pill { font-size: 0.7rem; padding: 2px 5px; border-radius: 4px; font-weight: 700; }
        .cal-mid { flex: 1; font-size: 0.75rem; color: #334155; }
        .type-tag { font-size: 0.65rem; padding: 1px 4px; border-radius: 3px; color: white; margin-top: 2px; display: inline-block; }
        .tag-g650 { background: var(--g650-bg); }
        .tag-cl850 { background: var(--cl850-bg); }

        /* æŠ¥è¡¨ç»Ÿè®¡è¡¨æ ¼ */
        .table-wrapper { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 15px; }
        .excel-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .excel-table th, .excel-table td { border: 1px solid var(--border); padding: 8px; text-align: center; }
        .excel-table th { background: #f1f5f9; color: #475569; }

        /* åº•éƒ¨å¯¼èˆª */
        .tab-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 10px 0; z-index: 5000; box-shadow: 0 -4px 10px rgba(0,0,0,0.05); }
        .tab-item { display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; color: #94a3b8; gap: 4px; cursor: pointer; }
        .tab-item.active { color: var(--primary); font-weight: bold; transform: scale(1.05); }
        .tab-icon { font-size: 1.3rem; }

        .page-section { display: none; }
        .page-section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* å„ç§å¼¹çª— */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 6000; backdrop-filter: blur(2px); }
        .settings-modal { background: white; padding: 25px; border-radius: 16px; width: 320px; }
        .status-modal { background: white; width: 100%; max-width: 400px; border-radius: 20px 20px 0 0; padding: 25px; position: fixed; bottom: 0; }

        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 4px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; }
        .btn { padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
        .btn-primary { background: var(--primary); color: white; }
        .login-screen { position: fixed; inset: 0; background: radial-gradient(circle, #3b82f6, #1e3a8a); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-card { background: white; padding: 40px; border-radius: 24px; text-align: center; width: 300px; }
    </style>
</head>
<body>

    <!-- ç™»å½•å±å¹• -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <h1 style="font-size: 3rem; margin-bottom: 10px;">âœˆï¸</h1>
            <h2 style="color: #1e40af; margin-bottom: 30px;">é£è¡Œæ—¥å¿— Pro</h2>
            <button class="btn btn-primary" style="width: 100%;" onclick="loginWithGoogle()">Google ç™»å½•</button>
        </div>
    </div>

    <!-- è–ªèµ„è®¾ç½® -->
    <div id="settingsModal" class="modal-overlay" onclick="if(event.target===this) this.style.display='none'">
        <div class="settings-modal" onclick="event.stopPropagation()">
            <h3 style="margin-bottom:15px; text-align:center;">âš™ï¸ è–ªèµ„ç¨åŠ¡é…ç½®</h3>
            <div class="form-group"><label>èŒçº§</label><select id="set_rank"><option value="æ•™å‘˜">æ•™å‘˜</option><option value="æœºé•¿" selected>æœºé•¿</option><option value="å‰¯é©¾é©¶">å‰¯é©¾é©¶</option></select></div>
            <div class="form-group"><label>ICAO4 ç­¾ç½²</label><select id="set_icao"><option value="signed">å·²ç­¾ç½²</option><option value="unsigned">æœªç­¾ç½²</option></select></div>
            <div class="form-group"><label>ç´¯è®¡åº”çº³ç¨æ‰€å¾—é¢(æˆªè‡³ä¸Šæœˆ)</label><input type="number" id="set_cum_income" value="942692"></div>
            <div class="form-group"><label>ç´¯è®¡å·²ç”³æŠ¥ç¨é¢(æˆªè‡³ä¸Šæœˆ)</label><input type="number" id="set_cum_tax" value="244022"></div>
            <button class="btn btn-primary" style="width:100%;" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
        </div>
    </div>

    <!-- é©»å¤–çŠ¶æ€ä¿®æ”¹ -->
    <div id="statusModal" class="modal-overlay" onclick="if(event.target===this) this.style.display='none'">
        <div class="status-modal" onclick="event.stopPropagation()">
            <h3 id="modalDateStr" style="margin-bottom:15px; color:var(--primary)"></h3>
            <div class="form-group"><label>é©»å¤–åŸå¸‚</label><input type="text" id="modalCityInput" placeholder="è¾“å…¥åŸå¸‚å"></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn" style="background:#dbeafe;" onclick="saveCalendarStatus('å›½å†…æœ‰è¿‡å¤œ')">ğŸ”µ å›½å†…è¿‡å¤œ</button>
                <button class="btn" style="background:#d1fae5;" onclick="saveCalendarStatus('å›½å†…æ— è¿‡å¤œ')">ğŸŸ¢ å›½å†…æ— è¿‡å¤œ</button>
                <button class="btn" style="background:#f3e8ff;" onclick="saveCalendarStatus('å›½é™…æœ‰è¿‡å¤œ')">ğŸŸ£ å›½é™…è¿‡å¤œ</button>
                <button class="btn" style="background:#fef3c7;" onclick="saveCalendarStatus('å›½é™…æ— è¿‡å¤œ')">ğŸŸ¡ å›½é™…æ— è¿‡å¤œ</button>
                <button class="btn" style="grid-column: 1/-1; background:#f1f5f9;" onclick="saveCalendarStatus(null)">ğŸ  å›æ²ˆé˜³/ä¼‘æ¯</button>
            </div>
            <button class="btn" style="width:100%; margin-top:15px;" onclick="document.getElementById('statusModal').style.display='none'">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨å®¹å™¨ -->
    <div id="app" class="app-layout" style="display: none;">
        
        <!-- é¡µé¢ 1: é¦–é¡µ -->
        <div id="page-home" class="page-section active container">
            <div class="top-bar">
                <div><h1 style="font-size: 1.2rem;">æ§åˆ¶å°</h1><div id="userInfo" class="user-pill">è½½å…¥ä¸­...</div></div>
                <div>
                    <button class="btn" style="background:rgba(255,255,255,0.2); color:white; margin-right:5px;" onclick="document.getElementById('settingsModal').style.display='block'">âš™ï¸ è®¾ç½®</button>
                    <button class="btn" style="background:rgba(255,255,255,0.2); color:white;" onclick="doLogout()">é€€å‡º</button>
                </div>
            </div>

            <!-- è–ªèµ„å¡ç‰‡ -->
            <section class="card">
                <div class="card-header">
                    <h2>ğŸ’° æœ¬æœˆå®å‘ç»“ç®—å•</h2>
                    <span id="taxRateDisplay" style="font-size:0.75rem; background:#fee2e2; color:#dc2626; padding:2px 6px; border-radius:4px; font-weight:bold;">å½“å‰ç¨ç‡ --%</span>
                </div>
                <div class="card-body">
                    <div class="salary-summary-box">
                        <div class="ss-item"><div class="ss-label">å›ºå®šå®å‘</div><div class="ss-val">96,080</div></div>
                        <div class="ss-item"><div class="ss-label">å˜åŠ¨(ç¨å)</div><div class="ss-val" id="disp_net_var" style="color:var(--tax-red)">0</div></div>
                        <div class="ss-item"><div class="ss-label">è¡¥åŠ©(å…ç¨)</div><div class="ss-val" id="disp_net_allow" style="color:var(--income-green)">0</div></div>
                        <div class="ss-item ss-total"><div class="ss-label">é¢„è®¡å®å‘åˆè®¡</div><div class="ss-val" style="font-size:1.4rem; color:var(--primary)" id="disp_total_bank">Â¥0.00</div></div>
                    </div>
                    <table class="salary-table">
                        <thead><tr><th>é¡¹ç›®</th><th>è®¡ç®—æ˜ç»†ä¸ä¸ªç¨è¿‡ç¨‹</th><th>åˆ°æ‰‹å®å‘</th></tr></thead>
                        <tbody id="salaryTableBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- å½•å…¥å¡ç‰‡ -->
            <section class="card">
                <div class="card-header"><h2>ğŸ“ æ™ºèƒ½å½•å…¥</h2><button class="btn btn-primary" onclick="processAI()">âœ¨ AI è¯†åˆ«</button></div>
                <div class="card-body">
                    <div class="ai-box"><textarea id="ocrInput" placeholder="ç²˜è´´èˆªç­ä¿¡æ¯ï¼Œå¦‚ï¼š10.20 G650ER æ²ˆé˜³-åŒ—äº¬ 2.5h..."></textarea></div>
                    <div id="editForm" class="edit-form" style="display:none; margin-top:15px; padding:15px; border:1px solid var(--primary); border-radius:12px;">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;" id="formContainer"></div>
                        <div style="margin-top:15px; text-align:right;">
                            <button class="btn" onclick="this.parentElement.parentElement.style.display='none'">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="saveRecord()">ğŸ’¾ ä¿å­˜è®°å½•</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- è®°å½•åˆ—è¡¨ -->
            <section class="card">
                <div class="card-header"><h2>ğŸ“‹ æœ€è¿‘è®°å½•</h2></div>
                <div class="card-body" id="logList"></div>
            </section>
        </div>

        <!-- é¡µé¢ 2: æ—¥å† -->
        <div id="page-calendar" class="page-section container">
            <section class="card">
                <div class="card-header"><h2>ğŸ“… é©»å¤–ä¸å…¨æ™¯æ—¥å†</h2><span id="calMonthTitle" style="font-weight:bold;"></span></div>
                <div class="card-body calendar-scroll-view">
                    <div class="calendar-fixed-container">
                        <div class="calendar-header"><div>å‘¨æ—¥</div><div>å‘¨ä¸€</div><div>å‘¨äºŒ</div><div>å‘¨ä¸‰</div><div>å‘¨å››</div><div>å‘¨äº”</div><div>å‘¨å…­</div></div>
                        <div class="calendar-grid" id="calendarGrid"></div>
                    </div>
                </div>
            </section>
        </div>

        <!-- é¡µé¢ 3: æŠ¥è¡¨ -->
        <div id="page-report" class="page-section container">
            <section class="card">
                <div class="card-header"><h2>ğŸ“Š æœˆåº¦æ•°æ®ç»Ÿè®¡</h2><input type="month" id="reportMonthSelect" onchange="refreshAll()"></div>
                <div class="card-body">
                    <h3 style="margin-bottom:10px;">1. é£è¡Œæ—¶é•¿ç»Ÿè®¡</h3>
                    <div class="table-wrapper"><table class="excel-table" id="reportFly"></table></div>
                    <h3 style="margin-top:20px; margin-bottom:10px;">2. è¡¥åŠ©æ˜ç»†æ±‡æ€»</h3>
                    <div class="table-wrapper"><table class="excel-table" id="reportMoney"></table></div>
                </div>
            </section>
        </div>

    </div>

    <!-- åº•éƒ¨ Tab -->
    <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('home', this)"><div class="tab-icon">ğŸ </div>é¦–é¡µ</div>
        <div class="tab-item" onclick="switchTab('calendar', this)"><div class="tab-icon">ğŸ“…</div>æ—¥å†</div>
        <div class="tab-item" onclick="switchTab('report', this)"><div class="tab-icon">ğŸ“Š</div>æŠ¥è¡¨</div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = { apiKey: "AIzaSyCFk4f7bKUHlb3d1Cg1jyS1EM-SPC4pr40", authDomain: "myflightlog-1f4cb.firebaseapp.com", projectId: "myflightlog-1f4cb", storageBucket: "myflightlog-1f4cb.firebasestorage.app", messagingSenderId: "181072044112", appId: "1:181072044112:web:ca312da2d4780227cef155" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let allRecords = [];
        let calendarStatus = {};
        let currentModalDate = "";

        const FIXED_BASE_NET = 96080.65;
        const FIXED_BASE_GROSS = 101740.00;
        const SOCIAL_RATE = 5217.09;
        const HOLIDAY_RATE = 7262;

        const FEE_CONFIG = {
            "æ•™å‘˜": { hk:{s:720,u:518}, as:{s:720,u:540}, ou:{s:810,u:540}, n1:80, n2:200, ds:500, dn:200, is:900, in:400, sp:1000 },
            "æœºé•¿": { hk:{s:640,u:460}, as:{s:640,u:480}, ou:{s:720,u:480}, n1:80, n2:200, ds:500, dn:200, is:900, in:400, sp:1000 },
            "å‰¯é©¾é©¶": { hk:{s:320,u:230}, as:{s:320,u:240}, ou:{s:360,u:240}, n1:25, n2:60, ds:400, dn:200, is:700, in:400, sp:500 }
        };

        const TAX_BRACKETS = [
            { l: 36000, r: 0.03, q: 0 }, { l: 144000, r: 0.10, q: 2520 }, { l: 300000, r: 0.20, q: 16920 },
            { l: 420000, r: 0.25, q: 31920 }, { l: 660000, r: 0.30, q: 52920 }, { l: 960000, r: 0.35, q: 85920 },
            { l: Infinity, r: 0.45, q: 181920 }
        ];

        // åŸºç¡€é€»è¾‘
        window.loginWithGoogle = () => signInWithPopup(auth, provider);
        window.doLogout = () => signOut(auth).then(()=>location.reload());
        window.switchTab = (id, el) => {
            document.querySelectorAll('.page-section').forEach(p=>p.classList.remove('active'));
            document.getElementById('page-'+id).classList.add('active');
            document.querySelectorAll('.tab-item').forEach(t=>t.classList.remove('active'));
            el.classList.add('active');
            refreshAll();
        };

        window.saveSettings = () => {
            localStorage.setItem('user_rank', document.getElementById('set_rank').value);
            localStorage.setItem('user_icao', document.getElementById('set_icao').value);
            localStorage.setItem('user_cum_income', document.getElementById('set_cum_income').value);
            localStorage.setItem('user_cum_tax', document.getElementById('set_cum_tax').value);
            document.getElementById('settingsModal').style.display='none';
            refreshAll();
        };

        onAuthStateChanged(auth, user => {
            if(user){
                currentUser = user;
                document.getElementById('loginScreen').style.display='none';
                document.getElementById('app').style.display='block';
                document.getElementById('userInfo').innerText = user.displayName;
                document.getElementById('reportMonthSelect').value = new Date().toISOString().slice(0, 7);
                initForm();
                onSnapshot(query(collection(db, `users/${user.uid}/logs`), orderBy("date", "desc")), snap => {
                    allRecords = snap.docs.map(d=>({id:d.id, ...d.data()}));
                    refreshAll();
                });
                onSnapshot(collection(db, `users/${user.uid}/calendar_status`), snap => {
                    calendarStatus = {};
                    snap.docs.forEach(d => calendarStatus[d.id] = d.data());
                    refreshAll();
                });
            }
        });

        const refreshAll = () => {
            renderSalary();
            renderList();
            renderCalendar();
            renderReport();
        };

        const calculateTax = (amt) => {
            for(let b of TAX_BRACKETS){ if(amt <= b.l) return amt * b.r - b.q; }
            return amt * 0.45 - 181920;
        };

        // ==========================================
        // 1. è–ªèµ„æ˜ç»†å¼•æ“ (æ ¸å¿ƒéœ€æ±‚)
        // ==========================================
        window.renderSalary = () => {
            const rank = localStorage.getItem('user_rank') || 'æœºé•¿';
            const icao = localStorage.getItem('user_icao') || 'signed';
            const mStr = document.getElementById('reportMonthSelect').value;
            const cfg = FEE_CONFIG[rank];
            const data = allRecords.filter(r => r.date.startsWith(mStr));

            let s = { hk:0, as:0, ou:0, hkb:0, asb:0, oub:0, hol:0, n1:0, n2:0, sp:0, md:0, mi:0, ds:0, dn:0, is:0, inn:0 };
            data.forEach(r => {
                const air = parseFloat(r.air_time)||0; const blk = parseFloat(r.block_days)||0;
                if(r.category==='æ¸¯æ¾³å°'){ s.hk+=air; s.hkb+=blk; }
                else if(r.category==='äºšæ´²å›½é™…'){ s.as+=air; s.asb+=blk; }
                else if(r.category==='æ´²é™…'){ s.ou+=air; s.oub+=blk; }
                else if(r.category==='å›½å†…'){ s.n1+=parseFloat(r.night1)||0; s.n2+=parseFloat(r.night2)||0; }
                s.hol += parseFloat(r.holiday)||0; s.sp += parseFloat(r.special_airport)||0;
                s.md += parseFloat(r.crew_meal_dom)||0; s.mi += parseFloat(r.crew_meal_int)||0;
            });

            // è‡ªåŠ¨ç»Ÿè®¡é©»å¤– (æ—¥å†ä¸­é€»è¾‘)
            const [y, m] = mStr.split('-').map(Number);
            const daysInMonth = new Date(y, m, 0).getDate();
            for(let d=1; d<=daysInMonth; d++){
                const dStr = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const stat = calendarStatus[dStr]?.type;
                if(stat==='å›½å†…æœ‰è¿‡å¤œ') s.ds++; else if(stat==='å›½å†…æ— è¿‡å¤œ') s.dn++;
                else if(stat==='å›½é™…æœ‰è¿‡å¤œ') s.is++; else if(stat==='å›½é™…æ— è¿‡å¤œ') s.inn++;
            }

            const cumInc = parseFloat(localStorage.getItem('user_cum_income')) || 942692;
            const cumTax = parseFloat(localStorage.getItem('user_cum_tax')) || 244022;
            let marginalRate = 0.45;
            for(let b of TAX_BRACKETS){ if(cumInc <= b.l){ marginalRate = b.r; break; } }
            document.getElementById('taxRateDisplay').innerText = `å½“å‰ç¨ç‡æ¡£ä½: ${(marginalRate*100).toFixed(0)}%`;

            const fmt = (n) => n.toLocaleString('zh-CN', {style:'currency', currency:'CNY'});
            let rows = `<tr><td class="col-name">å›ºå®šå®å‘</td><td class="col-proc">å›ºå®šå·¥èµ„(å«äº”é™©ä¸€é‡‘ä¸ªç¨ç”±å…¬å¸ç»Ÿç­¹)</td><td class="col-amt">${fmt(FIXED_BASE_NET)}</td></tr>`;

            let netVarTotal = 0;
            const addTaxedRow = (label, count, rate, unit, extra="") => {
                if(count <= 0) return;
                const gross = count * rate;
                const tax = gross * marginalRate;
                const net = gross - tax;
                netVarTotal += net;
                rows += `<tr>
                    <td class="col-name">${label}</td>
                    <td class="col-proc">
                        ${count.toFixed(1)}${unit} Ã— ${rate} = ${fmt(gross)} (ç¨å‰)${extra}<br>
                        <span class="tax-calc-red">æ‰£ä¸ªç¨: ${fmt(gross)} Ã— ${(marginalRate*100)}% = -${fmt(tax)}</span>
                    </td>
                    <td class="col-amt">${fmt(net)}</td>
                </tr>`;
            };

            const r_hk = icao==='signed'?cfg.hk.s:cfg.hk.u;
            const r_as = icao==='signed'?cfg.as.s:cfg.as.u;
            const r_ou = icao==='signed'?cfg.ou.s:cfg.ou.u;

            addTaxedRow("èŠ‚å‡æ—¥åŠ ç­", s.hol, HOLIDAY_RATE, "å¤©");
            addTaxedRow("æ¸¯æ¾³å°å°æ—¶", s.hk, r_hk, "h");
            addTaxedRow("æ¸¯æ¾³å°æ»‘è¡Œ", s.hkb, r_hk*0.6, "å¤©", "(ç³»æ•°0.6)");
            addTaxedRow("äºšæ´²å°æ—¶", s.as, r_as, "h");
            addTaxedRow("äºšæ´²æ»‘è¡Œ", s.asb, r_as*0.6, "å¤©", "(ç³»æ•°0.6)");
            addTaxedRow("æ´²é™…å°æ—¶", s.ou, r_ou, "h");
            addTaxedRow("æ´²é™…æ»‘è¡Œ", s.oub, r_ou*0.6, "å¤©", "(ç³»æ•°0.6)");
            addTaxedRow("å›½å†…å¤œèˆª(å‰)", s.n1, cfg.n1, "h");
            addTaxedRow("å›½å†…å¤œèˆª(å)", s.n2, cfg.n2, "h");
            addTaxedRow("ç‰¹æ®Šæœºåœº", s.sp, cfg.sp, "æ¬¡");

            let allowTotal = 0;
            const addFreeRow = (label, count, rate, unit) => {
                if(count <= 0) return;
                const amt = count * rate;
                allowTotal += amt;
                rows += `<tr>
                    <td class="col-name" style="color:var(--income-green)">${label}</td>
                    <td class="col-proc">${count}${unit} Ã— ${rate} = ${fmt(amt)}<br><span class="free-calc-green">å…ç¨è¡¥åŠ©é¡¹</span></td>
                    <td class="col-amt" style="color:var(--income-green)">${fmt(amt)}</td>
                </tr>`;
            };

            addFreeRow("å›½å†…æœºç»„é¤", s.md, 60, "é¡¿");
            addFreeRow("å›½é™…æœºç»„é¤", s.mi, 180, "é¡¿");
            addFreeRow("å›½å†…è¿‡å¤œè¡¥", s.ds, cfg.ds, "å¤©");
            addFreeRow("å›½å†…æ— è¿‡å¤œ", s.dn, cfg.dn, "æ¬¡");
            addFreeRow("å›½é™…è¿‡å¤œè¡¥", s.is, cfg.is, "å¤©");
            addFreeRow("å›½é™…æ— è¿‡å¤œ", s.inn, cfg.in, "æ¬¡");

            document.getElementById('salaryTableBody').innerHTML = rows;
            document.getElementById('disp_net_var').innerText = fmt(netVarTotal);
            document.getElementById('disp_net_allow').innerText = fmt(allowTotal);
            document.getElementById('disp_total_bank').innerText = fmt(FIXED_BASE_NET + netVarTotal + allowTotal);
        };

        // ==========================================
        // 2. æ—¥å†ç”Ÿæˆå¼•æ“
        // ==========================================
        window.renderCalendar = () => {
            const grid = document.getElementById('calendarGrid');
            const mStr = document.getElementById('reportMonthSelect').value;
            const [y, m] = mStr.split('-').map(Number);
            grid.innerHTML = '';
            document.getElementById('calMonthTitle').innerText = `${y}å¹´${m}æœˆ`;

            const firstDay = new Date(y, m-1, 1).getDay();
            const daysInMonth = new Date(y, m, 0).getDate();

            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;

            for(let d=1; d<=daysInMonth; d++){
                const dStr = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const logs = allRecords.filter(r => r.date === dStr);
                const stat = calendarStatus[dStr] || {type:null, city:''};
                
                let stCls = '';
                if(stat.type==='å›½å†…æœ‰è¿‡å¤œ') stCls = 'st-dom-stay';
                else if(stat.type==='å›½å†…æ— è¿‡å¤œ') stCls = 'st-dom-no';
                else if(stat.type==='å›½é™…æœ‰è¿‡å¤œ') stCls = 'st-int-stay';
                else if(stat.type==='å›½é™…æ— è¿‡å¤œ') stCls = 'st-int-no';

                const cell = document.createElement('div');
                cell.className = `cal-day ${stCls}`;
                cell.onclick = () => openStatusModal(dStr);
                
                let logHtml = logs.map(l => `<div class="cal-mid">${l.dep}-${l.arr}</div><div class="type-tag ${l.ac_type==='G650ER'?'tag-g650':'tag-cl850'}">${l.ac_type}</div>`).join('');

                cell.innerHTML = `
                    <div class="cal-top"><span class="cal-num">${d}</span><span class="cal-status-pill">${stat.city || (stat.type?'å·²æ ‡':'')}</span></div>
                    ${logHtml}
                `;
                grid.appendChild(cell);
            }
        };

        window.openStatusModal = (dateStr) => {
            currentModalDate = dateStr;
            document.getElementById('modalDateStr').innerText = dateStr;
            document.getElementById('modalCityInput').value = calendarStatus[dateStr]?.city || '';
            document.getElementById('statusModal').style.display = 'flex';
        };

        window.saveCalendarStatus = async (type) => {
            const city = document.getElementById('modalCityInput').value;
            await setDoc(doc(db, `users/${currentUser.uid}/calendar_status`, currentModalDate), {type, city});
            document.getElementById('statusModal').style.display = 'none';
        };

        // ==========================================
        // 3. æŠ¥è¡¨å¼•æ“
        // ==========================================
        window.renderReport = () => {
            const mStr = document.getElementById('reportMonthSelect').value;
            const data = allRecords.filter(r => r.date.startsWith(mStr));
            
            let fly = { dom:0, hk:0, as:0, ou:0, g_time:0, c_time:0 };
            data.forEach(r => {
                const t = parseFloat(r.air_time)||0;
                if(r.category==='å›½å†…') fly.dom += t;
                else if(r.category==='æ¸¯æ¾³å°') fly.hk += t;
                else if(r.category==='äºšæ´²å›½é™…') fly.as += t;
                else fly.ou += t;
                if(r.ac_type==='G650ER') fly.g_time += t; else fly.c_time += t;
            });

            document.getElementById('reportFly').innerHTML = `
                <tr><th>åˆ†ç±»</th><th>æ—¶é•¿(h)</th><th>æœºå‹</th><th>æ—¶é•¿(h)</th></tr>
                <tr><td>å›½å†…</td><td>${fly.dom.toFixed(1)}</td><td>G650ER</td><td>${fly.g_time.toFixed(1)}</td></tr>
                <tr><td>æ¸¯æ¾³å°</td><td>${fly.hk.toFixed(1)}</td><td>CL850</td><td>${fly.c_time.toFixed(1)}</td></tr>
                <tr><td>äºšæ´²/æ´²é™…</td><td>${(fly.as+fly.ou).toFixed(1)}</td><td>åˆè®¡</td><td>${(fly.g_time+fly.c_time).toFixed(1)}</td></tr>
            `;

            // è¡¥åŠ©æ±‡æ€»å¯æ ¹æ®salaryé€»è¾‘å»¶ä¼¸
            document.getElementById('reportMoney').innerHTML = `<tr><td>æ˜ç»†è¯·å‚è€ƒé¦–é¡µç»“ç®—å•ï¼Œæœ¬è¡¨å¼€å‘ä¸­</td></tr>`;
        };

        // å½•å…¥è¾…åŠ©
        const initForm = () => {
            const fields = [
                {id:'date', label:'æ—¥æœŸ', type:'date'}, {id:'ac_type', label:'æœºå‹', type:'select', ops:['G650ER','CL850']},
                {id:'dep', label:'èµ·é£'}, {id:'arr', label:'è½åœ°'}, {id:'cat', label:'èˆªçº¿æ€§è´¨', type:'select', ops:['å›½å†…','æ¸¯æ¾³å°','äºšæ´²å›½é™…','æ´²é™…']},
                {id:'air', label:'å°æ—¶è´¹æ—¶é•¿', type:'number'}, {id:'block_days', label:'æ»‘è¡Œå¤©æ•°', type:'number'},
                {id:'night1', label:'å¤œèˆª1', type:'number'}, {id:'night2', label:'å¤œèˆª2', type:'number'},
                {id:'meal_dom', label:'å›½å†…é¤', type:'number'}, {id:'meal_int', label:'å›½é™…é¤', type:'number'},
                {id:'holiday', label:'èŠ‚å‡æ—¥å¤©', type:'number'}, {id:'special', label:'ç‰¹æ®Šæœºåœº', type:'number'}
            ];
            document.getElementById('formContainer').innerHTML = fields.map(f => `
                <div class="form-group">
                    <label>${f.label}</label>
                    ${f.type==='select' ? `<select id="f_${f.id}">${f.ops.map(o=>`<option value="${o}">${o}</option>`).join('')}</select>` : `<input type="${f.type}" id="f_${f.id}" step="0.1">`}
                </div>
            `).join('');
        };

        window.processAI = () => {
            const txt = document.getElementById('ocrInput').value;
            if(!txt) return;
            // ç®€å•æ¨¡æ‹Ÿè¯†åˆ«é€»è¾‘
            document.getElementById('editForm').style.display = 'block';
            document.getElementById('f_date').value = new Date().toISOString().slice(0,10);
        };

        window.saveRecord = async () => {
            const getV = (id) => document.getElementById('f_'+id).value;
            const d = {
                date: getV('date'), ac_type: getV('ac_type'), dep: getV('dep'), arr: getV('arr'), category: getV('cat'),
                air_time: getV('air'), block_days: getV('block_days'), night1: getV('night1'), night2: getV('night2'),
                crew_meal_dom: getV('meal_dom'), crew_meal_int: getV('meal_int'), holiday: getV('holiday'), special_airport: getV('special')
            };
            await addDoc(collection(db, `users/${currentUser.uid}/logs`), d);
            document.getElementById('editForm').style.display = 'none';
        };

        window.renderList = () => {
            const list = document.getElementById('logList');
            list.innerHTML = allRecords.slice(0,5).map(r => `
                <div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                    <div><b>${r.date}</b> ${r.dep}-${r.arr} (${r.air_time}h)</div>
                    <button style="color:red; border:none; background:none;" onclick="deleteRecord('${r.id}')">ğŸ—‘ï¸</button>
                </div>
            `).join('');
        };

        window.deleteRecord = async (id) => { if(confirm('ç¡®å®šåˆ é™¤?')) await deleteDoc(doc(db, `users/${currentUser.uid}/logs`, id)); };

    </script>
</body>
</html>
