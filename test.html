<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é£è¡Œæ—¥å¿— Pro - CCAR-91 æœºé•¿åˆè§„ç‰ˆ</title>
    <style>
        /* === åŸºç¡€å˜é‡ === */
        :root {
            --primary: #2563eb; --primary-dark: #1e40af; 
            --bg: #f8fafc; --text: #334155; --border: #cbd5e1;
            /* çŠ¶æ€é¢œè‰² */
            --dom-stay-bg: #dbeafe; --dom-stay-text: #1e40af;
            --dom-no-bg: #d1fae5; --dom-no-text: #065f46;
            --int-stay-bg: #f3e8ff; --int-stay-text: #6b21a8;
            --int-no-bg: #fef3c7; --int-no-text: #92400e;
            --meal-bg: #fff7ed; --meal-text: #c2410c; --meal-border: #ffedd5;
            --night-bg: #0f172a; --night-text: #fcd34d;
            --tax-red: #dc2626; --income-green: #16a34a;
            --warn-bg: #fee2e2; --warn-text: #991b1b;
            --ok-green: #16a34a;
            /* æœºå‹é¢œè‰² */
            --g650-bg: #1e3a8a; --g650-text: #bfdbfe;
            --cl850-bg: #581c87; --cl850-text: #e9d5ff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg); color: var(--text);
            padding-bottom: 80px; 
            height: 100vh;
            overflow: hidden;
        }
        .app-layout { height: 100%; overflow-y: auto; padding: 15px; scroll-behavior: smooth; }
        .container { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }
        .tab-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 10px 0; z-index: 5000; box-shadow: 0 -4px 10px rgba(0,0,0,0.05); }
        .tab-item { display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; color: #94a3b8; gap: 4px; cursor: pointer; transition: 0.2s; }
        .tab-item.active { color: var(--primary); font-weight: bold; transform: scale(1.05); }
        .tab-icon { font-size: 1.4rem; }
        .page-section { display: none; animation: fadeIn 0.3s ease; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border); overflow: hidden; margin-bottom: 20px; }
        .card-header { padding: 15px 20px; background: #fff; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .card-header h2 { font-size: 1.1rem; font-weight: 700; color: #0f172a; }
        .card-body { padding: 20px; }
        .top-bar { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 16px 24px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(37,99,235,0.3); margin-bottom: 20px; }
        .user-pill { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; backdrop-filter: blur(4px); margin-top: 5px; display: inline-block; }
        .comp-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .comp-panel { background: #f8fafc; border: 1px solid var(--border); border-radius: 10px; padding: 15px; }
        .comp-head { font-size: 0.85rem; font-weight: 700; color: #475569; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .comp-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.9rem; }
        .comp-label { color: #64748b; font-size: 0.8rem; }
        .comp-val { font-weight: 700; font-family: monospace; }
        .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        .dot-ok { background: var(--ok-green); box-shadow: 0 0 0 2px #dcfce7; }
        .dot-warn { background: #f59e0b; box-shadow: 0 0 0 2px #fef3c7; }
        .dot-err { background: var(--warn-text); box-shadow: 0 0 0 2px #fee2e2; }
        .progress-track { height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .progress-bar { height: 100%; transition: width 0.3s; }
        .salary-summary-box { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; background: #eff6ff; padding: 15px; border-radius: 12px; border: 1px solid #bfdbfe; }
        .ss-item { text-align: center; }
        .ss-label { font-size: 0.75rem; color: #64748b; margin-bottom: 4px; }
        .ss-val { font-size: 1.1rem; font-weight: 800; font-family: monospace; }
        .ss-total { grid-column: 1/-1; border-top: 1px dashed #bfdbfe; padding-top: 10px; margin-top: 5px; }
        .salary-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .salary-table th { text-align: left; padding: 10px 8px; border-bottom: 2px solid #e2e8f0; color: #64748b; font-size: 0.8rem; background: #f8fafc; }
        .salary-table td { padding: 12px 8px; border-bottom: 1px dashed #e2e8f0; vertical-align: top; }
        .salary-table tr:last-child td { border-bottom: none; }
        .col-name { width: 25%; font-weight: 600; color: #334155; }
        .col-proc { width: 55%; font-family: monospace; color: #64748b; font-size: 0.75rem; line-height: 1.6; }
        .col-amt { width: 20%; text-align: right; font-family: monospace; font-weight: 700; font-size: 0.9rem; color: #0f172a; }
        .table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); -webkit-overflow-scrolling: touch; margin-bottom: 15px; }
        .excel-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; min-width: 600px; }
        .excel-table th, .excel-table td { border: 1px solid var(--border); padding: 8px 6px; text-align: center; vertical-align: middle; }
        .excel-table th { background: #f1f5f9; font-weight: 600; color: #475569; }
        .bg-cal-stat { background-color: #ecfdf5; color: #047857; font-weight: bold; }
        .bg-sub { background-color: #fdf4ff; color: #86198f; font-weight: bold; }
        .bg-meal { background-color: var(--meal-bg); color: var(--meal-text); font-weight: bold; }
        .bg-g650 { background-color: #eff6ff; color: #1e3a8a; font-weight: bold; }
        .bg-cl850 { background-color: #faf5ff; color: #581c87; font-weight: bold; }
        .calendar-scroll-view { overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 20px; }
        .calendar-fixed-container { min-width: 1100px; padding: 5px; }
        .calendar-header { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 0.9rem; color: #94a3b8; padding: 10px 0; font-weight: 600; background: #fff; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid #e2e8f0; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .cal-day { background: #fff; border: 1px solid var(--border); border-radius: 8px; min-height: 120px; padding: 6px; display: flex; flex-direction: column; cursor: pointer; transition: 0.2s; position: relative; }
        .cal-day:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); z-index: 5; }
        .cal-day.today { border: 2px solid var(--primary); background: #eff6ff; }
        .cal-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px; }
        .cal-num { font-size: 1rem; font-weight: 800; color: #94a3b8; }
        .cal-status-pill { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 80px; }
        .cal-mid { flex: 1; display: flex; flex-direction: column; gap: 2px; margin-bottom: 4px; }
        .cal-route { font-size: 0.8rem; color: #334155; font-weight: 600; line-height: 1.2; }
        .cal-bot { display: flex; flex-wrap: wrap; gap: 3px; margin-top: auto; }
        .type-tag { font-size: 0.7rem; padding: 2px 5px; border-radius: 4px; color: white; display: flex; align-items: center; gap: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .tag-g650 { background: var(--g650-bg); color: var(--g650-text); }
        .tag-cl850 { background: var(--cl850-bg); color: var(--cl850-text); }
        .st-dom-stay { background: var(--dom-stay-bg); color: var(--dom-stay-text); border: 1px solid #bfdbfe; }
        .st-dom-no { background: var(--dom-no-bg); color: var(--dom-no-text); border: 1px solid #a7f3d0; }
        .st-int-stay { background: var(--int-stay-bg); color: var(--int-stay-text); border: 1px solid #e9d5ff; }
        .st-int-no { background: var(--int-no-bg); color: var(--int-no-text); border: 1px solid #fde68a; }
        .ai-box { position: relative; border: 2px dashed var(--border); border-radius: 12px; padding: 10px; background: #f8fafc; transition: border-color 0.3s; }
        textarea { width: 100%; height: 100px; padding: 15px; border: none; background: transparent; resize: none; outline: none; font-size: 1rem; line-height: 1.5; }
        .edit-form { background: #fff; padding: 20px; border-radius: 12px; margin-top: 20px; border: 1px solid var(--primary); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); position: relative; animation: slideIn 0.3s ease; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .form-full { grid-column: 1 / -1; }
        .form-group label { display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 6px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; outline: none; transition: 0.2s; font-size: 0.9rem; background: #fff; }
        .log-list { max-height: 450px; overflow-y: auto; padding-right: 5px; }
        .log-item { background: #fff; border: 1px solid var(--border); border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: flex-end; z-index: 6000; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 25px; animation: slideUp 0.3s ease; display: flex; flex-direction: column; gap: 15px; }
        .login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #3b82f6 0%, #1e3a8a 100%); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-card { background: white; padding: 40px; border-radius: 24px; width: 90%; max-width: 320px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

    <!-- è–ªèµ„/ç¨åŠ¡è®¾ç½®å¼¹çª— -->
    <div id="settingsModal" class="modal-overlay" onclick="if(event.target===this) document.getElementById('settingsModal').style.display='none'">
        <div class="settings-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 7000; width: 320px;" onclick="event.stopPropagation()">
            <h3 style="margin-bottom:15px; text-align:center; color:#0f172a;">âš™ï¸ è–ªèµ„ä¸ç¨åŠ¡é…ç½®</h3>
            <div style="background:#f1f5f9; padding:10px; border-radius:8px; margin-bottom:15px;">
                <p style="font-size:0.75rem; color:#64748b; margin-bottom:5px;">è¯·å¡«å…¥ä¸ªç¨APPä¸­<b>æˆªè‡³ä¸Šä¸ªæœˆ</b>çš„æ•°æ®ï¼š</p>
                <div class="form-group"><label>å¹´åˆè‡³ä»Šç´¯è®¡åº”çº³ç¨æ‰€å¾—é¢</label><input type="number" id="set_cum_income" placeholder="ä¾‹: 942692" style="font-family:monospace; font-weight:bold;"></div>
                <div class="form-group"><label>å¹´åˆè‡³ä»Šå·²ç”³æŠ¥ç¨é¢</label><input type="number" id="set_cum_tax" placeholder="ä¾‹: 244022" style="font-family:monospace; font-weight:bold;"></div>
            </div>
            <div class="form-group"><label>èŒçº§</label><select id="set_rank" style="width:100%; padding:10px; border-radius:8px;"><option value="æ•™å‘˜">æ•™å‘˜</option><option value="æœºé•¿" selected>æœºé•¿</option><option value="å‰¯é©¾é©¶">å‰¯é©¾é©¶</option></select></div>
            <div class="form-group" style="margin-top:10px;"><label>è‹±è¯­ç­‰çº§</label><select id="set_icao" style="width:100%; padding:10px; border-radius:8px;"><option value="signed" selected>å·²ç­¾ç½² (ICAO4)</option><option value="unsigned">æœªç­¾ç½²</option></select></div>
            <button class="btn btn-primary" style="width:100%; margin-top:20px; padding:12px;" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
        </div>
    </div>

    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <h1 style="font-size: 3rem; margin-bottom: 10px;">âœˆï¸</h1>
            <h2 style="color: #1e40af; margin-bottom: 30px;">é£è¡Œæ—¥å¿— Pro<br><span style="font-size:0.9rem;color:#64748b;font-weight:normal">CCAR-91 æœºé•¿åˆè§„ç‰ˆ</span></h2>
            <button class="btn btn-primary" style="width: 100%; padding: 14px;" onclick="loginWithGoogle()">Google ç™»å½•</button>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨å¸ƒå±€ -->
    <div id="app" class="app-layout" style="display: none;">
        <div id="page-home" class="page-section active container">
            <div class="top-bar">
                <div><h1 style="font-size: 1.3rem;">æ§åˆ¶å°</h1><div id="userInfo" class="user-pill">æœªç™»å½•</div></div>
                <div>
                    <button class="btn" style="background:rgba(255,255,255,0.2); color:white; margin-right:5px;" onclick="document.getElementById('settingsModal').style.display='block'">âš™ï¸ è®¾ç½®</button>
                    <button class="btn" style="background:rgba(255,255,255,0.2); color:white;" onclick="doLogout()">é€€å‡º</button>
                </div>
            </div>

            <!-- è–ªèµ„å¡ç‰‡ -->
            <section class="card">
                <div class="card-header">
                    <h2>ğŸ’° æœ¬æœˆå®å‘ç»“ç®—å•</h2>
                    <span id="taxRateDisplay" style="font-size:0.75rem; background:#f3e8ff; color:#6b21a8; padding:2px 6px; border-radius:4px; font-weight:bold;">å½“å‰ç¨ç‡ --%</span>
                </div>
                <div class="card-body">
                    <div class="salary-summary-box">
                        <div class="ss-item"><div class="ss-label">å›ºå®šå®å‘</div><div class="ss-val" style="color:#0f172a">96,080</div></div>
                        <div class="ss-item"><div class="ss-label">å˜åŠ¨å®å‘(ç¨å)</div><div class="ss-val" style="color:var(--tax-red)" id="disp_net_var">0</div></div>
                        <div class="ss-item"><div class="ss-label">è¡¥åŠ©å®å‘(å…ç¨)</div><div class="ss-val" style="color:var(--income-green)" id="disp_net_allow">0</div></div>
                        <div class="ss-item ss-total"><div class="ss-label">æœ¬æœˆé“¶è¡Œå¡åˆè®¡</div><div class="ss-val" style="font-size:1.5rem; color:#1e40af;" id="disp_total_bank">Â¥0.00</div></div>
                    </div>
                    <table class="salary-table"><thead><tr><th class="col-name">é¡¹ç›®</th><th class="col-proc">è®¡ç®—å…¬å¼ / ä¸ªç¨è¿‡ç¨‹</th><th class="col-amt">ç¨åå®å‘</th></tr></thead><tbody id="salaryTableBody"></tbody></table>
                </div>
            </section>

            <!-- æ™ºèƒ½å½•å…¥ -->
            <section class="card">
                <div class="card-header"><h2>ğŸ“ æ™ºèƒ½å½•å…¥</h2><button class="btn btn-primary" id="aiBtn" onclick="processAI()">âœ¨ AI è¯†åˆ«</button></div>
                <div class="card-body">
                    <div class="ai-box">
                        <div id="aiLoading" class="loading-overlay" style="display:none; position:absolute; inset:0; background:rgba(255,255,255,0.7); justify-content:center; align-items:center; z-index:20;"><div class="spinner"></div></div>
                        <div class="ai-options"><label style="cursor:pointer; display:flex; align-items:center;"><input type="checkbox" id="isUTC" checked style="margin-right:4px;"> åŸæ•°æ®ä¸º UTC æ—¶é—´ (è‡ªåŠ¨è½¬åŒ—äº¬æ—¶é—´)</label></div>
                        <input type="password" id="innerApiKey" style="position: absolute; top: 10px; right: 10px; padding: 6px; border-radius: 6px; border: 1px solid var(--border); width: 120px; font-size: 0.75rem; background: rgba(255,255,255,0.9);" placeholder="DeepSeek API Key">
                        <textarea id="ocrInput" placeholder="ä¾‹ï¼š11.9 G650ER æ²ˆé˜³-æ›¼è°· 3èµ·è½ å›½é™…æœ‰è¿‡å¤œ&#10;ä¾‹ï¼š10æœˆ1æ—¥ CL850 è®­ç»ƒ 4å¤œé—´èµ·è½"></textarea>
                    </div>

                    <!-- ç¼–è¾‘è¡¨å• -->
                    <div id="editForm" class="edit-form" style="display: none;">
                        <div class="form-tag" style="position: absolute; top: -10px; left: 20px; background: var(--primary); color: white; padding: 4px 12px; border-radius: 4px; font-size: 0.75rem; font-weight: bold;">æ–°å¢/ç¼–è¾‘</div>
                        <input type="hidden" id="edit_doc_id">
                        <div class="form-grid">
                            <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="f_date"></div>
                            <div class="form-group"><label>æœºå‹</label><select id="f_ac_type"><option value="G650ER">G650ER</option><option value="CL850">CL850</option></select></div>
                            <div class="form-group"><label>èµ·é£åœ°</label><input type="text" id="f_dep"></div>
                            <div class="form-group"><label>è½åœ°åœ°</label><input type="text" id="f_arr"></div>
                            <div class="form-group"><label>èˆªçº¿å±æ€§</label><select id="f_cat"><option value="å›½å†…">å›½å†…</option><option value="æ¸¯æ¾³å°">æ¸¯æ¾³å°</option><option value="äºšæ´²å›½é™…">äºšæ´²å›½é™…</option><option value="æ´²é™…">æ´²é™…</option></select></div>
                            <div class="form-group"><label>æœºç»„æˆå‘˜</label><input type="text" id="f_crew"></div>
                            <div class="form-group"><label>èˆªç­å·</label><input type="text" id="f_flight_no"></div>
                            <div class="form-group"><label>æ—¥èµ·è½</label><input type="number" id="f_landings_day" value="0"></div>
                            <div class="form-group"><label>å¤œèµ·è½</label><input type="number" id="f_landings_night" value="0"></div>
                            <div class="form-group"><label>æ’¤è½®</label><input type="time" id="f_block_off" oninput="recalcTimes()"></div>
                            <div class="form-group"><label>èµ·é£</label><input type="time" id="f_takeoff" oninput="recalcTimes()"></div>
                            <div class="form-group"><label>è½åœ°</label><input type="time" id="f_landing" oninput="recalcTimes()"></div>
                            <div class="form-group"><label>æŒ¡è½®</label><input type="time" id="f_block_on" oninput="recalcTimes()"></div>
                            <div class="form-group"><label>ç©ºæ—¶</label><input type="number" step="0.01" id="f_air" oninput="recalcTimes()"></div>
                            <div class="form-group"><label>æ€»æ—¶</label><input type="number" step="0.01" id="f_total_time" oninput="recalcTimes()"></div>
                            <div class="form-group"><label>æ»‘è¡Œå¤©æ•°</label><input type="number" id="f_block_days"></div>
                            <div class="form-group"><label>å¤œ(18:30-24:00)</label><input type="number" step="0.1" id="f_night1"></div>
                            <div class="form-group"><label>å¤œ(24:00+)</label><input type="number" step="0.1" id="f_night2"></div>
                            <div class="form-group"><label>é©»å¤–ç±»å‹</label><select id="f_overnight"><option value="æ— ">æ— </option><option value="å›½å†…æœ‰è¿‡å¤œ">å›½å†…æœ‰è¿‡å¤œ</option><option value="å›½å†…æ— è¿‡å¤œ">å›½å†…æ— è¿‡å¤œ</option><option value="å›½é™…æœ‰è¿‡å¤œ">å›½é™…æœ‰è¿‡å¤œ</option><option value="å›½é™…æ— è¿‡å¤œ">å›½é™…æ— è¿‡å¤œ</option></select></div>
                            <div class="form-group"><label>é©»å¤–åŸå¸‚</label><input type="text" id="f_overnight_city"></div>
                            <div class="form-group"><label>é©»å¤–å¤©æ•°</label><input type="number" id="f_overnight_days" value="0"></div>
                            <div class="form-group"><label>å›½å†…é¤ (60)</label><input type="number" id="f_meal_dom" value="0"></div>
                            <div class="form-group"><label>å›½é™…é¤ (180)</label><input type="number" id="f_meal_int" value="0"></div>
                            <div class="form-group"><label>èŠ‚å‡æ—¥å¤©æ•°</label><input type="number" id="f_holiday"></div>
                            <div class="form-group"><label>ç‰¹æ®Šæœºåœº</label><input type="number" id="f_special" value="0"></div>
                        </div>
                        <div style="margin-top:15px; display:flex; justify-content:flex-end; gap:10px; border-top:1px solid #f1f5f9; padding-top:15px;">
                            <button class="btn" style="background:transparent; color:#64748b;" onclick="closeForm()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="saveRecord()">ğŸ’¾ ä¿å­˜è®°å½•</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- è®°å½•æ˜ç»† -->
            <section class="card">
                <div class="card-header"><h2>ğŸ“‹ è®°å½•æ˜ç»†</h2></div>
                <div class="card-body"><div id="logList" class="log-list"></div></div>
            </section>
        </div>
        <!-- å…¶ä»–é¡µé¢å ä½... -->
        <div id="page-calendar" class="page-section">æ—¥å†å¼€å‘ä¸­...</div>
        <div id="page-report" class="page-section">æŠ¥è¡¨å¼€å‘ä¸­...</div>
    </div>

    <!-- åº•éƒ¨ Tab æ  -->
    <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('home', this)"><div class="tab-icon">ğŸ </div><div>é¦–é¡µ</div></div>
        <div class="tab-item" onclick="switchTab('calendar', this)"><div class="tab-icon">ğŸ“…</div><div>æ—¥å†</div></div>
        <div class="tab-item" onclick="switchTab('report', this)"><div class="tab-icon">ğŸ“Š</div><div>æŠ¥è¡¨</div></div>
    </div>

    <!-- Firebase & Logic -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = { 
            apiKey: "AIzaSyCFk4f7bKUHlb3d1Cg1jyS1EM-SPC4pr40", 
            authDomain: "myflightlog-1f4cb.firebaseapp.com", 
            projectId: "myflightlog-1f4cb", 
            storageBucket: "myflightlog-1f4cb.firebasestorage.app", 
            messagingSenderId: "181072044112", 
            appId: "1:181072044112:web:ca312da2d4780227cef155" 
        };

        const app = initializeApp(firebaseConfig); 
        const db = getFirestore(app); 
        const auth = getAuth(app); 
        const provider = new GoogleAuthProvider();
        
        let currentUser = null;
        let allRecords = []; 
        let calendarData = {}; 

        const HOLIDAY_RATE = 7262; 
        const FIXED_BASE_NET = 96080.65;
        const FIXED_BASE_GROSS = 101740.00;
        const SOCIAL_RATE = 5217.09;

        const FEE_CONFIG = {
            "æ•™å‘˜": { hk:{s:720, u:518}, asia:{s:720, u:540}, out:{s:810, u:540}, n1:80, n2:200, dom_no:200, dom_stay:500, int_no:400, int_stay:900, spec:1000 },
            "æœºé•¿": { hk:{s:640, u:460}, asia:{s:640, u:480}, out:{s:720, u:480}, n1:80, n2:200, dom_no:200, dom_stay:500, int_no:400, int_stay:900, spec:1000 },
            "å‰¯é©¾é©¶": { hk:{s:320, u:230}, asia:{s:320, u:240}, out:{s:360, u:240}, n1:25, n2:60, dom_no:200, dom_stay:400, int_no:400, int_stay:700, spec:500 },
        };

        const TAX_BRACKETS = [
            { limit: 36000, rate: 0.03, quick: 0 },
            { limit: 144000, rate: 0.10, quick: 2520 },
            { limit: 300000, rate: 0.20, quick: 16920 },
            { limit: 420000, rate: 0.25, quick: 31920 },
            { limit: 660000, rate: 0.30, quick: 52920 },
            { limit: 960000, rate: 0.35, quick: 85920 },
            { limit: Infinity, rate: 0.45, quick: 181920 }
        ];

        window.loginWithGoogle = async () => { try { await signInWithPopup(auth, provider); } catch (e) { alert("ç™»å½•å¤±è´¥: " + e.message); } };
        window.doLogout = async () => { await signOut(auth); window.location.reload(); };
        window.switchTab = (pageId, el) => {
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user; 
                document.getElementById('userInfo').textContent = user.displayName;
                document.getElementById('loginScreen').style.display = 'none'; 
                document.getElementById('app').style.display = 'block';
                onSnapshot(query(collection(db, `users/${user.uid}/logs`), orderBy("date", "desc")), (snap) => { 
                    allRecords = snap.docs.map(d => ({id: d.id, ...d.data()})); 
                    renderSalary(); 
                    renderList();
                });
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
        });

        function calculateTax(amount) {
            for (let b of TAX_BRACKETS) { if (amount <= b.limit) return amount * b.rate - b.quick; }
            return amount * 0.45 - 181920;
        }

        // ==========================================
        // æ ¸å¿ƒä¿®æ”¹ï¼šè¯¦ç»†è–ªèµ„æ˜ç»†è®¡ç®—è¿‡ç¨‹
        // ==========================================
        window.renderSalary = () => {
            const rank = localStorage.getItem('user_rank') || 'æœºé•¿';
            const isSigned = localStorage.getItem('user_icao') === 'signed' || true;
            const cfg = FEE_CONFIG[rank];
            const mStr = new Date().toISOString().slice(0, 7); // ç¤ºä¾‹ï¼šå½“å‰æœˆä»½
            const data = allRecords.filter(r => r.date.startsWith(mStr));
            
            // ç´¯è®¡æ•°æ®æ±‡æ€»
            let s = { hk_air:0, asia_air:0, out_air:0, hk_blk:0, asia_blk:0, out_blk:0, n1_pay:0, n2_pay:0, spec_cnt:0, holiday_days:0, midnight:0, meal_dom:0, meal_int:0, dom_stay:0, dom_no:0, int_stay:0, int_no:0 };

            data.forEach(r => {
                const air = parseFloat(r.air_time) || 0; const blk = parseFloat(r.block_days) || 0;
                if(r.category==='æ¸¯æ¾³å°'){ s.hk_air+=air; s.hk_blk+=blk; }
                else if(r.category==='äºšæ´²å›½é™…'){ s.asia_air+=air; s.asia_blk+=blk; }
                else if(r.category==='æ´²é™…'){ s.out_air+=air; s.out_blk+=blk; }
                else if(r.category==='å›½å†…'){ 
                    s.n1_pay += parseFloat(r.night1)||0; s.n2_pay += parseFloat(r.night2)||0; 
                    if(r.takeoff && r.landing && r.landing < r.takeoff) s.midnight++;
                }
                s.holiday_days += parseFloat(r.holiday)||0;
                s.spec_cnt += parseFloat(r.special_airport)||0;
                s.meal_dom += parseFloat(r.crew_meal_dom)||0;
                s.meal_int += parseFloat(r.crew_meal_int)||0;
                if(r.overnight === 'å›½å†…æœ‰è¿‡å¤œ') s.dom_stay += parseFloat(r.overnight_days)||0;
                else if(r.overnight === 'å›½å†…æ— è¿‡å¤œ') s.dom_no++;
                else if(r.overnight === 'å›½é™…æœ‰è¿‡å¤œ') s.int_stay += parseFloat(r.overnight_days)||0;
                else if(r.overnight === 'å›½é™…æ— è¿‡å¤œ') s.int_no++;
            });

            // ç¨åŠ¡è®¡ç®—åŸºå‡†
            const prevCumIncome = parseFloat(localStorage.getItem('user_cum_income')) || 942692;
            const prevCumTax = parseFloat(localStorage.getItem('user_cum_tax')) || 244022;
            
            // 1. å…ˆç®—å‡ºæœ¬æœˆæ‰€æœ‰å˜åŠ¨è–ªèµ„çš„æ€»é¢(ç¨å‰)
            let gross_var_total = 0;
            const rate_hk = isSigned ? cfg.hk.s : cfg.hk.u;
            const rate_asia = isSigned ? cfg.asia.s : cfg.asia.u;
            const rate_out = isSigned ? cfg.out.s : cfg.out.u;

            gross_var_total += (s.hk_air * rate_hk) + (s.hk_blk * rate_hk * 0.6);
            gross_var_total += (s.asia_air * rate_asia) + (s.asia_blk * rate_asia * 0.6);
            gross_var_total += (s.out_air * rate_out) + (s.out_blk * rate_out * 0.6);
            gross_var_total += (s.n1_pay * cfg.n1) + (s.n2_pay * cfg.n2) + (s.midnight * 200);
            gross_var_total += (s.holiday_days * HOLIDAY_RATE);
            gross_var_total += (s.spec_cnt * cfg.spec);

            // 2. è®¡ç®—æœ¬æœˆåˆå¹¶åçš„ä¸ªç¨
            const month_taxable_fixed = (FIXED_BASE_GROSS - SOCIAL_RATE - 5000);
            const total_taxable_this_month = month_taxable_fixed + gross_var_total;
            const new_cum_income = prevCumIncome + total_taxable_this_month;
            const new_total_tax = calculateTax(new_cum_income);
            const month_total_tax = new_total_tax - prevCumTax;
            
            // è®¡ç®—å½“å‰ç¨ç‡æ¡£ä½ (è¾¹é™…ç¨ç‡)
            let current_marginal_rate = 0.45;
            for(let b of TAX_BRACKETS) { if(new_cum_income <= b.limit) { current_marginal_rate = b.rate; break; } }
            document.getElementById('taxRateDisplay').innerText = `æœ¬æœˆè¾¹é™…ç¨ç‡: ${(current_marginal_rate*100).toFixed(0)}%`;

            const fmt = (n) => n.toLocaleString('zh-CN', {style:'currency', currency:'CNY'});
            
            // 3. æ„é€ è¡¨æ ¼è¡Œ
            let rows = `<tr><td class="col-name">å›ºå®šå®å‘è–ªèµ„</td><td class="col-proc">åŸºæ•°${fmt(FIXED_BASE_GROSS)} - äº”é™©ä¸€é‡‘${fmt(SOCIAL_RATE)} - èµ·å¾ç‚¹5000<br>ä¸ªç¨ç”±å…¬å¸æ‰¿æ‹…ï¼Œå®å‘åˆ°æ‰‹ä¸å˜</td><td class="col-amt">${fmt(FIXED_BASE_NET)}</td></tr>`;

            // è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆå¸¦æ‰£ç¨è¿‡ç¨‹çš„è¡Œ
            const addTaxedRow = (name, count, rate, unit, extraProc = "") => {
                if(count <= 0) return;
                const gross = count * rate;
                const tax = gross * current_marginal_rate;
                const net = gross - tax;
                rows += `<tr>
                    <td class="col-name">${name}</td>
                    <td class="col-proc">
                        ${count.toFixed(1)}${unit} Ã— ${rate} = ${fmt(gross)} (ç¨å‰)${extraProc}<br>
                        <span style="color:var(--tax-red)">æ‰£ä¸ªç¨: ${fmt(gross)} Ã— ${(current_marginal_rate*100).toFixed(0)}% = -${fmt(tax)}</span>
                    </td>
                    <td class="col-amt">${fmt(net)}</td>
                </tr>`;
            };

            // é£è¡Œå˜åŠ¨éƒ¨åˆ†
            addTaxedRow("æ¸¯æ¾³å°ç©ºæ—¶", s.hk_air, rate_hk, "h");
            addTaxedRow("æ¸¯æ¾³å°æ»‘è¡Œ", s.hk_blk, rate_hk * 0.6, "å¤©", ` (ç³»æ•°0.6)`);
            addTaxedRow("äºšæ´²ç©ºæ—¶", s.asia_air, rate_asia, "h");
            addTaxedRow("äºšæ´²æ»‘è¡Œ", s.asia_blk, rate_asia * 0.6, "å¤©", ` (ç³»æ•°0.6)`);
            addTaxedRow("æ´²é™…ç©ºæ—¶", s.out_air, rate_out, "h");
            addTaxedRow("æ´²é™…æ»‘è¡Œ", s.out_blk, rate_out * 0.6, "å¤©", ` (ç³»æ•°0.6)`);
            addTaxedRow("èŠ‚å‡æ—¥åŠ ç­", s.holiday_days, HOLIDAY_RATE, "å¤©");
            addTaxedRow("å›½å†…å¤œèˆª(å‰)", s.n1_pay, cfg.n1, "h");
            addTaxedRow("å›½å†…å¤œèˆª(å)", s.n2_pay, cfg.n2, "h");
            addTaxedRow("ç‰¹æ®Šæœºåœº", s.spec_cnt, cfg.spec, "æ¬¡");

            // 4. è¡¥åŠ©éƒ¨åˆ† (å…ç¨)
            const addFreeRow = (name, count, rate, unit) => {
                if(count <= 0) return;
                const amt = count * rate;
                rows += `<tr>
                    <td class="col-name" style="color:var(--income-green)">${name}</td>
                    <td class="col-proc">${count}${unit} Ã— ${rate} = ${fmt(amt)}<br><span style="color:var(--income-green)">å…ç¨é¡¹ç›®</span></td>
                    <td class="col-amt" style="color:var(--income-green)">${fmt(amt)}</td>
                </tr>`;
                return amt;
            };

            let total_allowance = 0;
            total_allowance += addFreeRow("å›½å†…æœºç»„é¤è´´", s.meal_dom, 60, "é¡¿") || 0;
            total_allowance += addFreeRow("å›½é™…æœºç»„é¤è´´", s.meal_int, 180, "é¡¿") || 0;
            total_allowance += addFreeRow("å›½å†…è¿‡å¤œè¡¥åŠ©", s.dom_stay, cfg.dom_stay, "å¤©") || 0;
            total_allowance += addFreeRow("å›½å†…æ— è¿‡å¤œè¡¥", s.dom_no, cfg.dom_no, "æ¬¡") || 0;
            total_allowance += addFreeRow("å›½é™…è¿‡å¤œè¡¥åŠ©", s.int_stay, cfg.int_stay, "å¤©") || 0;
            total_allowance += addFreeRow("å›½é™…æ— è¿‡å¤œè¡¥", s.int_no, cfg.int_no, "æ¬¡") || 0;

            // æ›´æ–°ä»ªè¡¨ç›˜æ•°å€¼
            const net_var_total = gross_var_total * (1 - current_marginal_rate);
            document.getElementById('salaryTableBody').innerHTML = rows;
            document.getElementById('disp_net_var').innerText = fmt(net_var_total);
            document.getElementById('disp_net_allow').innerText = fmt(total_allowance);
            document.getElementById('disp_total_bank').innerText = fmt(FIXED_BASE_NET + net_var_total + total_allowance);
        };

        // ... å…¶ä½™ processAI, saveRecord, renderList å‡½æ•°é€»è¾‘ä¿æŒä¸å˜ ...
        window.closeForm = () => document.getElementById('editForm').style.display='none';
        window.recalcTimes = () => { /* è®¡ç®—é€»è¾‘... */ };
        window.renderList = () => {
            const listEl = document.getElementById('logList');
            listEl.innerHTML = allRecords.map(r => `<div class="log-item"><div>${r.date} ${r.dep}-${r.arr}</div></div>`).join('');
        };
    </script>
</body>
</html>
